<!DOCTYPE html>
<html lang="vi" class="h-full antialiased">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ZALO: 0352803379 - STUDIO V35.80 (FULL ISO RESTORE)</title>
    
    <!-- Fonts: Professional & Modern -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- COPYRIGHT PROTECTION -->
    <script>
        (function() {
            document.addEventListener('contextmenu', function(e) { e.preventDefault(); return false; });
            document.onkeydown = function(e) {
                if (e.keyCode == 123) return false;
                if (e.ctrlKey && e.shiftKey && (e.keyCode == 'I'.charCodeAt(0) || e.keyCode == 'C'.charCodeAt(0) || e.keyCode == 'J'.charCodeAt(0))) return false;
                if (e.ctrlKey && (e.keyCode == 'U'.charCodeAt(0) || e.keyCode == 'S'.charCodeAt(0))) { e.preventDefault(); return false; }
            };
        })();
    </script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['"Plus Jakarta Sans"', 'sans-serif'],
                        body: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        background: '#02040a',
                        surface: '#0f111a',
                        surface2: '#1e202e',
                        primary: { 500: '#6366f1', 600: '#4f46e5' },
                        accent: { 400: '#38bdf8', 500: '#0ea5e9' },
                        success: '#10b981',
                        glass: 'rgba(15, 17, 26, 0.75)',
                        border: 'rgba(255, 255, 255, 0.08)'
                    },
                    animation: {
                        'float': 'float 8s ease-in-out infinite',
                        'pulse-soft': 'pulseSoft 3s infinite',
                        'slide-up': 'slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1)',
                        'fade-in': 'fadeIn 0.3s ease-out forwards',
                    },
                    keyframes: {
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } },
                        pulseSoft: { '0%, 100%': { opacity: '0.6' }, '50%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(100%)' }, '100%': { transform: 'translateY(0)' } },
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } }
                    }
                }
            }
        }
    </script>

    <style>
        :root { --safe-area-bottom: env(safe-area-inset-bottom); }
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: #02040a; color: #e2e8f0; font-family: 'Inter', sans-serif; -webkit-font-smoothing: antialiased; }
        
        body::before {
            content: ''; position: fixed; inset: 0; z-index: -1;
            background: radial-gradient(circle at 50% 0%, rgba(99, 102, 241, 0.15), transparent 60%),
                        radial-gradient(circle at 85% 30%, rgba(56, 189, 248, 0.1), transparent 50%);
            pointer-events: none;
        }

        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 10px; }
        
        .glass-panel {
            background: rgba(15, 17, 26, 0.85);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .pro-input {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            color: #f1f5f9;
            font-size: 12px;
            border-radius: 8px;
            padding: 0 10px;
            height: 36px;
            width: 100%;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .pro-input:focus {
            background: rgba(255, 255, 255, 0.06);
            border-color: #6366f1;
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.1);
            outline: none;
        }
        textarea.pro-input { height: auto; padding-top: 8px; padding-bottom: 8px; line-height: 1.5; font-family: 'JetBrains Mono', monospace; }
        
        select.pro-input {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%2394a3b8' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.2em 1.2em;
            padding-right: 2rem;
            appearance: none;
        }
        select option { background-color: #1e202e; color: #f1f5f9; padding: 10px; }

        .chk-pro { appearance: none; width: 16px; height: 16px; border-radius: 4px; border: 1.5px solid rgba(148, 163, 184, 0.4); background: transparent; display: grid; place-content: center; cursor: pointer; transition: all 0.2s; position: relative; margin-top: 1px; }
        .chk-pro::after { content: ""; width: 8px; height: 8px; border-radius: 2px; background: white; transform: scale(0); transition: transform 0.2s; }
        .chk-pro:checked { border-color: #6366f1; background: #6366f1; }
        .chk-pro:checked::after { transform: scale(1); }
        .chk-gold:checked { border-color: #f59e0b; background: #f59e0b; }
        .chk-red:checked { border-color: #ef4444; background: #ef4444; }

        .module-group { background: rgba(30, 32, 46, 0.4); border: 1px solid rgba(255, 255, 255, 0.05); border-radius: 12px; margin-bottom: 8px; overflow: hidden; transition: all 0.3s ease; }
        .module-header { padding: 10px 12px; background: rgba(255,255,255,0.02); display: flex; align-items: center; justify-content: space-between; cursor: pointer; user-select: none; }
        .module-header:hover { background: rgba(255,255,255,0.04); }
        .module-content { display: grid; grid-template-rows: 0fr; transition: grid-template-rows 0.3s ease; opacity: 0.5; }
        .module-content.open { grid-template-rows: 1fr; opacity: 1; }
        .module-inner { min-height: 0; padding: 0 12px 12px 12px; }
        
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; margin: 8px 0; }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 14px; width: 14px; border-radius: 50%; background: #fff; box-shadow: 0 0 10px rgba(0,0,0,0.3); margin-top: -5px; transition: transform 0.1s; cursor: grab; }
        input[type=range]:active::-webkit-slider-thumb { transform: scale(1.2); cursor: grabbing; }
        .slider-flux::-webkit-slider-thumb { background: #8b5cf6; }
        .slider-pink::-webkit-slider-thumb { background: #ec4899; }
        .slider-red::-webkit-slider-thumb { background: #ef4444; }
        
        .mobile-image-frame {
            border: 1px solid rgba(255,255,255,0.1); 
            box-shadow: 0 20px 50px -12px rgba(0, 0, 0, 0.8);
            background: #000;
            border-radius: 16px;
            overflow: hidden;
            width: auto; height: auto;
            max-width: 96vw; max-height: 72vh;
            display: flex; align-items: center; justify-content: center;
            margin: 0 auto; position: relative;
        }

        .btn-primary-soft {
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.25);
            border: 1px solid rgba(255,255,255,0.1);
        }
        .btn-primary-soft:active { transform: scale(0.98); box-shadow: 0 2px 8px rgba(79, 70, 229, 0.2); }

        .comp-label { position: absolute; bottom: 12px; padding: 4px 10px; background: rgba(0,0,0,0.75); color: #f8fafc; font-size: 10px; font-weight: 600; letter-spacing: 0.5px; border-radius: 20px; pointer-events: none; z-index: 25; backdrop-filter: blur(4px); border: 1px solid rgba(255,255,255,0.15); }
        .comp-label.before { right: 12px; } .comp-label.after { left: 12px; } 
        
        .scan-beam { position: absolute; top: 0; left: 0; width: 100%; height: 2px; background: linear-gradient(90deg, transparent, #6366f1, #38bdf8, transparent); opacity: 0; box-shadow: 0 0 15px #6366f1; z-index: 50; pointer-events: none; }
        .scan-beam.active { opacity: 1; animation: scanMove 2s cubic-bezier(0.4, 0, 0.2, 1) infinite; }
        @keyframes scanMove { 0% { top: 0; } 100% { top: 100%; } }

        .text-label { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; color: #94a3b8; margin-bottom: 4px; display: block; }
        .section-gap { margin-bottom: 10px; }
        
        @media (max-width: 1024px) {
            #sidebar { position: fixed; inset: 0; z-index: 100; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); border-radius: 20px 20px 0 0; border-right: none; border-top: 1px solid rgba(255,255,255,0.1); background: #0f111a; top: 50px; }
            #sidebar.open { transform: translateY(0); }
        }
        
        .shimmer-text { background: linear-gradient(90deg, #fff 0%, #a78bfa 50%, #fff 100%); background-size: 200% auto; -webkit-background-clip: text; -webkit-text-fill-color: transparent; animation: shine 3s linear infinite; }
        @keyframes shine { to { background-position: 200% center; } }
    </style>
</head>

<body class="select-none" oncontextmenu="return false;">
    
    <!-- === SECURITY GATE === -->
    <div id="security-gate" class="fixed inset-0 z-[9999] flex items-center justify-center bg-[#02040a] transition-opacity duration-500">
        <div class="absolute inset-0 bg-[url('https://grainy-gradients.vercel.app/noise.svg')] opacity-20 pointer-events-none"></div>
        <div class="relative z-10 w-full max-w-[360px] p-6 flex flex-col items-center animate-fade-in">
            <div class="w-16 h-16 rounded-2xl bg-gradient-to-br from-indigo-500 to-violet-600 p-[1px] mb-6 shadow-2xl shadow-indigo-500/20 rotate-3">
                 <div class="w-full h-full rounded-2xl bg-[#0a0a0f] flex items-center justify-center relative overflow-hidden">
                     <div class="absolute inset-0 bg-indigo-500/20 blur-xl"></div>
                     <svg class="w-8 h-8 text-white relative z-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                 </div>
            </div>
            
            <h1 class="text-2xl font-bold text-white tracking-tight mb-2">PH·ª§C CH·∫æ ·∫¢NH V35.80</h1>
            <p class="text-xs text-slate-400 font-medium mb-8 tracking-wide">PROFESSIONAL AI RESTORATION</p>
            
            <div class="w-full bg-[#1e202e] border border-white/5 rounded-xl p-1 mb-4 flex items-center shadow-lg">
                <div class="flex-1 px-4 py-3 flex items-center justify-center gap-2">
                    <span id="gate-ip-display" class="font-mono text-xs font-bold text-indigo-300 shimmer-text">ƒêang k·∫øt n·ªëi...</span>
                    <div id="gate-loading-spinner" class="w-3 h-3 border-2 border-indigo-500/30 border-t-indigo-500 rounded-full animate-spin"></div>
                </div>
            </div>
            
            <button id="gate-submit" class="w-full py-3.5 bg-white text-black rounded-xl text-xs font-bold tracking-widest shadow-xl shadow-white/5 transition-transform active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                V√ÄO PH·ª§C CH·∫æ ·∫¢NH
            </button>
            <p id="gate-status" class="mt-4 text-[10px] text-slate-600 font-medium">ƒêang qu√©t th√¥ng tin thi·∫øt b·ªã...</p>
        </div>
        <div class="absolute bottom-6 left-0 w-full text-center"><p class="text-[9px] text-slate-700 font-mono">SECURE CONNECTION V35.80</p></div>
    </div>
    
    <!-- === TOAST NOTIFICATIONS === -->
    <div id="toast-container" class="fixed top-4 left-4 right-4 z-[100] flex flex-col gap-2 pointer-events-none"></div>
    
    <!-- === MAIN APP STRUCTURE === -->
    <div class="flex w-full h-full relative z-10" id="fullscreen-target">
        
        <!-- SIDEBAR -->
        <aside id="sidebar" class="w-full lg:w-[380px] flex-shrink-0 flex flex-col glass-panel lg:static lg:border-r lg:border-t-0 shadow-2xl">
            <!-- Header -->
            <div class="h-14 px-4 flex items-center justify-between border-b border-white/5 bg-white/[0.01]">
                <div>
                    <h1 class="text-xs font-bold tracking-widest text-indigo-400">V35.80 (PRO ISO)</h1>
                    <div class="flex items-center gap-2 mt-0.5">
                        <span id="top-bar-ip" class="text-[9px] text-slate-400 font-mono">IP: Loading...</span>
                        <span class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span>
                    </div>
                </div>
                
                <div class="flex items-center gap-3">
                    <div class="px-2 py-1 bg-[#1e202e] rounded border border-white/5 cursor-pointer hover:border-yellow-500/30 transition-colors group" id="credit-display">
                        <span class="text-[9px] text-slate-400 font-bold mr-1">CREDITS</span>
                        <span class="text-xs font-mono font-bold text-yellow-400 group-hover:text-yellow-300" id="credit-count">---</span>
                    </div>
                    <button id="close-sidebar-mobile" class="lg:hidden p-1.5 bg-slate-800 rounded-lg text-white"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
                </div>
            </div>

            <!-- Scrollable Content -->
            <div class="flex-1 overflow-y-auto p-3 lg:p-4 scroll-smooth custom-scrollbar pb-32 lg:pb-6">
                
                <!-- 1. DRAG & DROP ZONE -->
                <div class="hidden lg:block relative group mb-4">
                    <input type="file" id="image-upload" accept="image/*" class="hidden">
                    <label id="drop-zone" for="image-upload" class="flex flex-col items-center justify-center w-full h-24 border border-dashed border-slate-700 rounded-xl cursor-pointer bg-white/[0.01] hover:bg-white/[0.03] hover:border-indigo-500/50 transition-all">
                        <div class="flex flex-col items-center pointer-events-none">
                            <svg class="w-5 h-5 text-indigo-500 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l-1.586-1.586a2 2 0 00-2.828 0L6 18H4a2 2 0 01-2-2V6a2 2 0 01-2-2V6a2 2 0 012-2h16a2 2 0 012 2v8a2 2 0 01-2 2h-2m-4-4l-3 3m0 0l-3-3m3 3V4"></path></svg>
                            <span class="text-[10px] font-bold text-slate-400 uppercase">T·∫£i ·∫£nh g·ªëc (Click/Drop)</span>
                        </div>
                    </label>
                </div>

                <!-- 2. AUTO-PILOT BUTTON -->
                <button id="btn-auto-pilot" class="w-full py-3 mb-4 btn-primary-soft rounded-xl text-white flex items-center justify-center gap-2 transition-all relative overflow-hidden group">
                    <div class="absolute inset-0 bg-white/10 translate-y-full group-hover:translate-y-0 transition-transform duration-300"></div>
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
                    <span class="text-[11px] font-bold tracking-widest relative z-10">AUTO SCAN V35 (AI DETECT)</span>
                </button>

                <!-- MODULE: WORKFLOW (FLUX KONTEXT) -->
                <div class="module-group" id="kontext-module-container">
                    <div class="p-3 bg-gradient-to-br from-indigo-500/10 to-transparent">
                        <div class="flex items-center justify-between mb-2">
                             <div>
                                <span class="text-[10px] font-bold text-indigo-300 block">üöÄ FLUX / QWEN ENGINE</span>
                                <span class="text-[9px] text-slate-500 block">Core: Qwen-VL, Kontext, InvSR</span>
                             </div>
                             <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="mode-flux" class="sr-only peer" checked>
                                <div class="w-8 h-4 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:bg-indigo-500 transition-colors"><div class="absolute top-[2px] left-[2px] bg-white h-3 w-3 rounded-full transition-all peer-checked:translate-x-full"></div></div>
                            </label>
                        </div>
                        <div id="workflow-container">
                            <label class="text-label">Ch·ªçn Quy Tr√¨nh (Workflow)</label>
                            <select id="kontext-workflow" class="pro-input cursor-pointer bg-[#151720]">
                                <option value="qwen_edit_pro" class="text-cyan-300" selected>‚ö° Qwen Edit Pro (Khuy√™n d√πng)</option>
                                <option value="replica_pro" class="text-yellow-400">üß¨ Si√™u Th·ª±c (Replica Pro)</option>
                                <option value="invsr_deblur" class="text-green-400">üî™ InvSR Deblur (Ch·ªëng Rung)</option>
                                <option value="ancient_restore" class="text-purple-400">üèØ Ph·ª•c ch·∫ø Tranh/T∆∞·ª£ng C·ªï</option>
                                <option value="wedding_kontext_v2" class="text-pink-400">üë∞ Wedding Professional</option>
                                <option value="default">‚ú® M·∫∑c ƒë·ªãnh (Kontext Base)</option>
                                <option value="realvis_v5" class="text-orange-400">ü¶Å RealVisXL V5</option>
                                <option value="outdoor_mode">üèûÔ∏è Ngo·∫°i C·∫£nh (Outdoor)</option>
                                <option value="product_mode">üõçÔ∏è S·∫£n ph·∫©m (Ecommerce)</option>
                                <option value="white_bg">‚¨ú T√°ch N·ªÅn (ID Photo)</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- MODULE: REPLICA MODE -->
                <div class="bg-[#1e202e]/60 border border-white/5 rounded-xl p-2.5 mb-2 flex items-center justify-between">
                    <div>
                        <span class="text-[10px] font-bold text-yellow-500 block">üíé CH·∫æ ƒê·ªò SAO Y B·∫¢N CH√çNH (ALIGN LOCK)</span>
                        <span class="text-[9px] text-slate-500">Kh√≥a g√≥c m·∫∑t - Ch·ªëng l·∫≠t h√¨nh</span>
                    </div>
                     <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="mode-replica" class="sr-only peer">
                        <div class="w-8 h-4 bg-slate-700 rounded-full peer peer-checked:bg-yellow-500 transition-colors"><div class="absolute top-[2px] left-[2px] bg-white h-3 w-3 rounded-full transition-all peer-checked:translate-x-full"></div></div>
                    </label>
                </div>

                <!-- MODULE: QU√ÇN S·ª¨ VI·ªÜT NAM (RESTORED FULL) -->
                <div class="module-group" id="module-military">
                    <div id="toggle-military" class="module-header">
                        <span class="text-[10px] font-bold text-yellow-500 tracking-wide uppercase flex items-center gap-2">üáªüá≥ QU√ÇN S·ª¨ & K·ª∂ V·∫¨T</span>
                        <svg class="w-3 h-3 text-slate-500" id="icon-military" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                    <div id="content-military" class="module-content">
                        <div class="module-inner">
                            <div class="section-gap">
                                <label class="text-label">Qu√¢n ch·ªßng / L·ª±c l∆∞·ª£ng</label>
                                <select id="mil-branch" class="pro-input save-input">
                                    <option value="">-- T·ª± ƒë·ªông / Kh√¥ng ch·ªçn --</option>
                                    <option value="vietnamese army ground force, red collar tabs">üü• L·ª•c qu√¢n (H√†m ƒê·ªè)</option>
                                    <option value="vietnamese air force, blue collar tabs">üü¶ PK - Kh√¥ng Qu√¢n (H√†m Xanh)</option>
                                    <option value="vietnamese navy, navy blue uniform, white striped collar">‚öì H·∫£i qu√¢n (T√≠m than)</option>
                                    <option value="vietnamese border guard, green collar tabs">üü© B·ªô ƒë·ªôi Bi√™n ph√≤ng</option>
                                    <option value="vietnamese public security, green uniform, red collar tabs">üëÆ C√¥ng an Nh√¢n d√¢n</option>
                                    <option value="vietnamese youth volunteer force, dark green uniform">‚≠ê Thanh ni√™n Xung phong</option>
                                </select>
                            </div>
                            <div class="section-gap">
                                <label class="text-label">Qu√¢n ph·ª•c / Th·ªùi k·ª≥</label>
                                <select id="mil-uniform" class="pro-input save-input">
                                    <option value="">-- T·ª± ƒë·ªông --</option>
                                    <option value="wearing tran thu shirt, padded cotton jacket, viet minh era">√Åo Tr·∫•n Th·ªß (Ch·ªëng Ph√°p)</option>
                                    <option value="wearing to chau uniform, plain green fatigue, vietnam war era">T√¥ Ch√¢u (Ch·ªëng M·ªπ)</option>
                                    <option value="wearing K82 uniform, formal military tunic">K82 (Bao c·∫•p)</option>
                                    <option value="wearing K94 uniform, modern formal suit">K94/K03 (Hi·ªán ƒë·∫°i)</option>
                                </select>
                            </div>
                            <div class="section-gap">
                                <label class="text-label">M≈© & N√≥n</label>
                                <select id="hat-select" class="pro-input save-input" data-key="hatSelect">
                                    <option value="">-- Kh√¥ng x·ª≠ l√Ω M≈© --</option>
                                    <option value="wear vietnamese pith helmet, hard pith helmet, dark green color, rounded shape, red badge with yellow star">M≈© C·ªëi (L√≠nh B·∫Øc Vi·ªát)</option>
                                    <option value="wear vietnamese soft cap, boonie hat, green fabric, red star badge">M≈© Tai B√®o</option>
                                    <option value="wear vietnamese officer kepi hat, mixed red and green color, gold chin strap, red badge with gold star">M≈© Kepi (Sƒ© quan)</option>
                                    <option value="wear vietnamese police kepi hat, green color, red band, gold badge">M≈© Kepi (C√¥ng an)</option>
                                    <option value="wear vietnamese bamboo helmet, cloth covered">M≈© Nan</option>
                                </select>
                            </div>
                            <div class="section-gap">
                                <label class="text-label">C·∫•p b·∫≠c</label>
                                <select id="rank-select" class="pro-input save-input" data-key="rankSelect">
                                    <option value="">-- T·ª± ƒë·ªông --</option>
                                    <option value="no_rank_insignia">üö´ Kh√¥ng ƒëeo h√†m</option>
                                    <option value="plain red collar tabs, soldier rank">Chi·∫øn sƒ© (Tr∆°n)</option>
                                    <option value="red collar tabs with one yellow stripe">H·∫° sƒ© (1 g·∫°ch)</option>
                                    <option value="red collar tabs with three stars, officer rank">Th∆∞·ª£ng √∫y (3 sao)</option>
                                    <option value="red collar tabs with four stars, officer rank">ƒê·∫°i √∫y (4 sao)</option>
                                </select>
                             </div>
                            <div class="grid grid-cols-2 gap-2 mt-2">
                                <div class="flex items-center gap-2 bg-white/5 p-1.5 rounded-lg"><input id="check-sao-vang" type="checkbox" class="chk-pro save-input"><label class="text-[9px] text-yellow-400">Hu√¢n ch∆∞∆°ng Sao V√†ng</label></div>
                                <div class="flex items-center gap-2 bg-white/5 p-1.5 rounded-lg"><input id="check-khang-chien" type="checkbox" class="chk-pro save-input"><label class="text-[9px] text-slate-300">HC Kh√°ng Chi·∫øn</label></div>
                                <div class="flex items-center gap-2 bg-white/5 p-1.5 rounded-lg"><input id="check-chien-si" type="checkbox" class="chk-pro save-input"><label class="text-[9px] text-slate-300">Danh hi·ªáu Chi·∫øn sƒ©</label></div>
                                <div class="flex items-center gap-2 bg-white/5 p-1.5 rounded-lg"><input id="check-doan" type="checkbox" class="chk-pro save-input"><label class="text-[9px] text-cyan-400">Huy hi·ªáu ƒêo√†n</label></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- MODULE: LIGHTING (TAO ANH SANG - RESTORED FULL) -->
                <div class="module-group" id="module-cinematic">
                    <div id="toggle-cinematic" class="module-header">
                        <span class="text-[10px] font-bold text-pink-500 uppercase flex items-center gap-2">üéûÔ∏è LIGHTING & M√ÄU PHIM</span>
                        <svg class="w-3 h-3 text-pink-500" id="icon-cinematic" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                    <div id="content-cinematic" class="module-content">
                        <div class="module-inner">
                            <div class="mb-3">
                                <div class="flex justify-between text-[9px] text-pink-400 font-bold mb-1">
                                    <span>ƒê·ªò NHI·ªÑU (GRAIN)</span>
                                    <span id="grain-val">3%</span>
                                </div>
                                <input type="range" id="grain-slider" min="0" max="100" value="3" class="slider-pink">
                             </div>
                            <div class="section-gap">
                                <select id="color-grading" class="pro-input save-input">
                                     <option value="">-- M√†u g·ªëc (Standard) --</option>
                                     <option value="golden_hour_blinds">üåÖ Golden Hour + Blinds</option>
                                     <option value="moonlight_window">üåô Moonlight Window</option>
                                     <option value="streetlight_cozy">üí° Streetlight Cozy</option>
                                     <option value="neon_cyberpunk">üåÉ Neon Vibrant</option>
                                     <option value="soft_diffused">‚òÅÔ∏è Soft Diffused</option>
                                     <option value="kodak portra 400 style, natural skin tone, fine grain" selected>Kodak Portra 400</option>
                                     <option value="sepia tone, antique photo style">Sepia (X∆∞a c≈©)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- MODULE: EXPOSURE & QWEN (RESTORED) -->
                <div class="module-group" id="module-exposure">
                    <div id="toggle-exposure" class="module-header">
                        <span class="text-[10px] font-bold text-cyan-400 uppercase flex items-center gap-2">‚òÄÔ∏è X·ª¨ L√ù CH√ÅY S√ÅNG</span>
                        <svg class="w-3 h-3 text-cyan-400" id="icon-exposure" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                    <div id="content-exposure" class="module-content">
                        <div class="module-inner">
                             <div class="flex items-center gap-2 p-2 rounded-lg border border-cyan-500/20 bg-cyan-900/10 mb-2">
                                <input id="check-qwen-exposure" type="checkbox" class="chk-pro save-input">
                                <label for="check-qwen-exposure" class="cursor-pointer select-none flex-1">
                                    <span class="block text-[10px] font-bold text-cyan-300">K√çCH HO·∫†T QWEN EDIT</span>
                                    <span class="block text-[8px] text-cyan-500/70">X√≥a b√≥ng g·∫Øt / S·ª≠a ch√°y s√°ng</span>
                                </label>
                            </div>
                            <div class="flex items-center gap-2 pl-2">
                                <input id="check-remove-shadow" type="checkbox" class="chk-pro save-input" checked>
                                <label for="check-remove-shadow" class="text-[10px] text-slate-300">LoRA: Remove Shadow</label>
                            </div>
                             <div class="flex items-center gap-2 pl-2 mt-1">
                                <input id="check-soft-light" type="checkbox" class="chk-pro save-input" checked>
                                <label for="check-soft-light" class="text-[10px] text-slate-300">Prompt: Soft Light</label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- REFERENCE FACE UPLOAD (RESTORED) -->
                <div class="relative group p-2 rounded-lg bg-white/[0.02] border border-white/5 mb-2">
                     <div class="flex gap-2 items-center mb-2">
                         <div id="ref-img-preview" class="w-8 h-8 rounded bg-black/40 border border-white/10 flex-shrink-0 bg-cover bg-center" style="display:none;"></div>
                         <input type="file" id="ref-upload" accept="image/*" class="hidden">
                         <label for="ref-upload" class="flex-1 h-8 border border-dashed border-slate-700 rounded flex items-center justify-center cursor-pointer hover:bg-white/5 transition-colors">
                             <span id="ref-text" class="text-[10px] text-slate-500 font-medium">+ ·∫¢nh tham chi·∫øu (TƒÉng gi·ªëng)</span>
                         </label>
                         <button id="clear-ref" class="w-8 h-8 rounded bg-white/5 hover:bg-white/10 text-slate-400 flex items-center justify-center transition-colors" style="display:none;">x</button>
                     </div>
                     <div class="flex items-center gap-2 px-1">
                        <input id="check-reactor" type="checkbox" class="chk-pro save-input">
                        <label for="check-reactor" class="flex-1 cursor-pointer select-none">
                            <span class="block text-[10px] font-bold text-purple-400">K√≠ch ho·∫°t Face Swap (ReActor)</span>
                            <span class="block text-[8px] text-purple-500/70">Thay th·∫ø khu√¥n m·∫∑t thay v√¨ tr·ªôn</span>
                        </label>
                    </div>
                </div>

                <!-- MODULE: PROCESSING (RESTORED FULL) -->
                <div class="module-group" id="module-processing">
                    <div id="toggle-processing" class="module-header">
                        <span class="text-[10px] font-bold text-slate-200 uppercase flex items-center gap-2">üõ†Ô∏è X·ª¨ L√ù H√åNH ·∫¢NH</span>
                        <svg class="w-3 h-3 text-slate-500" id="icon-processing" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                    <div id="content-processing" class="module-content open">
                        <div class="module-inner pt-1">
                             <div class="mb-3">
                                <div class="flex justify-between text-[9px] text-indigo-300 font-bold mb-1">
                                    <span>TU√ÇN TH·ª¶ / S√ÅNG T·∫†O</span>
                                    <span id="creativity-val">45%</span>
                                </div>
                                <input type="range" id="creativity-slider" min="0" max="100" value="45" class="slider-flux">
                             </div>

                             <div class="grid grid-cols-2 gap-2 mb-3">
                                 <div class="flex items-center gap-2 bg-white/5 p-1.5 rounded"><input id="check-dehaze" type="checkbox" class="chk-pro save-input"><label class="text-[9px] text-slate-300">Kh·ª≠ s∆∞∆°ng m√π</label></div>
                                 <div class="flex items-center gap-2 bg-white/5 p-1.5 rounded"><input id="check-contrast-fix" type="checkbox" class="chk-pro save-input"><label class="text-[9px] text-slate-300">Kontext Contrast</label></div>
                                 <div class="flex items-center gap-2 bg-white/5 p-1.5 rounded"><input id="check-uniform-skin" type="checkbox" class="chk-pro save-input" checked><label class="text-[9px] text-slate-300">ƒê·ªÅu m√†u da</label></div>
                                 <div class="flex items-center gap-2 bg-white/5 p-1.5 rounded"><input id="check-vibrant" type="checkbox" class="chk-pro save-input" checked><label class="text-[9px] text-indigo-300 font-bold">LZP COLOR</label></div>
                             </div>

                             <div class="section-gap">
                                <label class="text-label">Upscale Model (4K)</label>
                                <select id="upscale-mode" class="pro-input save-input">
                                    <option value="supir_tiled" selected>üåü Tiled 4K (SUPIR)</option>
                                    <option value="invsr_sharp" class="text-green-400">üî™ InvSR Deblur (Ch·ªëng Rung)</option>
                                    <option value="pixel_perfect" class="text-yellow-400">üíé Pixel Perfect</option>
                                    <option value="ultrasharp">‚ö° 4x-UltraSharp</option>
                                    <option value="none">üö´ Kh√¥ng Upscale</option>
                                </select>
                             </div>

                             <div class="space-y-1.5 pt-1 border-t border-white/5">
                                 <div class="flex items-center gap-2"><input id="check-face" type="checkbox" class="chk-pro save-input" checked><label class="text-[10px] text-slate-300">Chi ti·∫øt m·∫∑t (Face Detail)</label></div>
                                 <div class="flex items-center gap-2 bg-indigo-500/10 p-1.5 rounded border border-indigo-500/20">
                                    <input id="check-background" type="checkbox" class="chk-pro save-input" checked>
                                    <label class="text-[10px] font-bold text-indigo-300">L√†m n√©t N·ªÅn & Hoa L√°</label>
                                 </div>
                             </div>
                        </div>
                    </div>
                </div>

                <!-- MODULE: ƒê·ªêI T∆Ø·ª¢NG & TRANG PH·ª§C (RESTORED - WAS MISSING) -->
                <div class="module-group" id="module-subject">
                    <div id="toggle-subject" class="module-header">
                        <span class="text-[10px] font-bold text-slate-200 uppercase flex items-center gap-2">üëî ƒê·ªêI T∆Ø·ª¢NG & TRANG PH·ª§C</span>
                        <svg class="w-3 h-3 text-slate-500" id="icon-subject" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                    <div id="content-subject" class="module-content">
                        <div class="module-inner">
                            <div class="grid grid-cols-3 gap-1.5 mb-2">
                                 <select id="gender-select" class="pro-input save-input" data-key="gender"><option value="">Gi·ªõi t√≠nh</option><option value="male">Nam</option><option value="female">N·ªØ</option><option value="male and female">Nam & N·ªØ</option></select>
                                 <input type="number" id="age-input" placeholder="Tu·ªïi" class="pro-input text-center save-input" data-key="age">
                                 <select id="damage-level" class="pro-input save-input" data-key="damageLevel"><option value="">ƒê·ªô h·ªèng</option><option value="fix slightly blurry" selected>Nh·∫π</option><option value="fix scratches, mold">V·ª´a</option><option value="fix torn, missing details">N·∫∑ng</option></select>
                            </div>
                            <select id="texture-mode" class="pro-input save-input mb-2" data-key="textureMode">
                                <option value="">-- ƒê·ªô ch√¢n th·ª±c (Texture) --</option>
                                <option value="true skin, natural pores, film grain, realistic skin:1.2, natural beauty:1.2" selected>üß¨ TRUE SKIN (DA TH·∫¨T)</option>
                                <option value="Canon EOS 5D Mark IV, 85mm lens, shallow depth of field, perfect lighting, raw photo, realistic skin texture">üì∏ Canon 5D (Studio Skin)</option>
                                <option value="smooth skin, ai beauty">M·ªãn m√†ng (AI Beauty)</option>
                            </select>
                            <div class="space-y-1.5">
                                <div class="flex items-center gap-2 p-1.5 rounded border border-blue-500/20 bg-blue-500/10">
                                    <input id="check-id-photo" type="checkbox" class="chk-pro save-input">
                                    <label for="check-id-photo" class="cursor-pointer select-none flex-1">
                                        <span class="block text-[10px] font-bold text-blue-300">CH·∫æ ƒê·ªò ·∫¢NH TH·∫∫ (ID PHOTO)</span>
                                    </label>
                                </div>
                                <select id="event-context" class="pro-input save-input" data-key="eventContext">
                                    <option value="">-- (AUTO) Ng·ªØ c·∫£nh th√¥ng minh --</option>
                                    <option value="original_enhanced">üõ°Ô∏è N·ªÅn G·ªëc + MAX CHI TI·∫æT</option>
                                    <option value="blue_bg">üü¶ N·ªÅn Xanh</option>
                                    <option value="white_bg">‚¨ú N·ªÅn Tr·∫Øng</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- MODULE: IDENTITY GUARD (RESTORED) -->
                <div class="module-group" id="module-identity">
                    <div id="toggle-identity" class="module-header">
                        <span class="text-[10px] font-bold text-slate-200 uppercase flex items-center gap-2">üß¨ KH√ìA N√âT (IDENTITY GUARD)</span>
                        <svg class="w-3 h-3 text-slate-500" id="icon-identity" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                    <div id="content-identity" class="module-content">
                        <div class="module-inner">
                            <div class="mb-3">
                                <div class="flex justify-between text-[9px] text-slate-400 font-bold mb-1">
                                    <span>LOCK STRENGTH</span>
                                    <span id="identity-weight-val">300%</span>
                                </div>
                                <input type="range" id="identity-weight-slider" min="100" max="400" step="10" value="300" class="save-input slider-red">
                            </div>

                            <div class="flex items-center gap-3 p-2 rounded-lg bg-red-500/10 border border-red-500/20 mb-2">
                                <input id="check-anti-flip" type="checkbox" class="chk-pro chk-red save-input" checked>
                                <label for="check-anti-flip" class="flex-1 cursor-pointer">
                                    <span class="block text-[10px] font-bold text-red-300">SMART ANTI-FLIP</span>
                                </label>
                            </div>
                             <div class="mb-2">
                                <div class="flex justify-between text-[9px] text-purple-300 font-bold mb-1">
                                    <span>CONTROLNET STRUCTURE</span>
                                    <span id="structure-val">80%</span>
                                </div>
                                <input type="range" id="structure-slider" min="0" max="100" value="80" class="slider-flux">
                             </div>
                            
                            <div class="mt-2 border-t border-white/5 pt-2 space-y-2">
                                <p class="text-[9px] font-bold text-slate-500 uppercase tracking-widest">B·∫¢O T·ªíN ƒê·∫∂C ƒêI·ªÇM</p>
                                <div class="grid grid-cols-2 gap-2">
                                    <div class="flex items-center gap-2"><input id="check-asian-identity" type="checkbox" class="chk-pro save-input" checked><label class="text-[9px] text-slate-300">Asian Identity</label></div>
                                    <div class="flex items-center gap-2"><input id="check-cross-eyed" type="checkbox" class="chk-pro chk-red save-input"><label class="text-[9px] text-slate-300">M·∫Øt L√©</label></div>
                                    <div class="flex items-center gap-2"><input id="check-ptosis" type="checkbox" class="chk-pro chk-red save-input"><label class="text-[9px] text-slate-300">M·∫Øt S·ª•p M√≠</label></div>
                                    <div class="flex items-center gap-2"><input id="check-closed-eyes" type="checkbox" class="chk-pro chk-red save-input"><label class="text-[9px] text-slate-300">M·∫Øt Nh·∫Øm</label></div>
                                    <div class="flex items-center gap-2"><input id="check-buck-teeth" type="checkbox" class="chk-pro chk-red save-input"><label class="text-[9px] text-slate-300">RƒÉng H√¥</label></div>
                                    <div class="flex items-center gap-2"><input id="check-black-teeth" type="checkbox" class="chk-pro chk-red save-input"><label class="text-[9px] text-slate-300">RƒÉng ƒêen</label></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- MODULE: PROMPT (RESTORED - WAS MISSING) -->
                <div class="module-group" id="module-prompt">
                    <div id="toggle-prompt" class="module-header">
                        <span class="text-[10px] font-bold text-slate-200 uppercase flex items-center gap-2">üìù PROMPT & API</span>
                        <svg class="w-3 h-3 text-slate-500" id="icon-prompt" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                    <div id="content-prompt" class="module-content">
                        <div class="module-inner">
                            <textarea id="prompt-main" rows="3" class="pro-input w-full p-2 resize-none text-[10px] mb-2" data-key="promptMainValue" placeholder="Prompt s·∫Ω t·ª± ƒë·ªông t·∫°o..."></textarea>
                            <input type="text" id="prompt-negative" placeholder="Negative Prompt..." class="pro-input w-full save-input mb-2" data-key="promptNegative">
                        </div>
                    </div>
                </div>

                <!-- MODULE: LOGO (RESTORED - WAS MISSING) -->
                <div class="module-group" id="module-logo">
                    <div id="toggle-logo" class="module-header">
                        <span class="text-[10px] font-bold text-slate-200 uppercase">¬©Ô∏è CH√àN LOGO B·∫¢N QUY·ªÄN</span>
                        <svg class="w-3 h-3 text-slate-500" id="icon-logo" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </div>
                    <div id="content-logo" class="module-content">
                        <div class="module-inner">
                            <div class="flex items-center gap-2 mb-2">
                                <input id="check-logo" type="checkbox" class="chk-pro save-input">
                                <label for="check-logo" class="flex-1 cursor-pointer select-none">
                                    <span class="block text-[10px] font-bold text-slate-300">K√≠ch ho·∫°t ƒë√≥ng d·∫•u Logo</span>
                                </label>
                            </div>
                            <input type="text" id="custom-logo-text" class="pro-input w-full text-center font-bold text-yellow-400" placeholder="Nh·∫≠p t√™n/SƒêT...">
                        </div>
                    </div>
                </div>

                <div class="h-8"></div>
            </div>
            
            <!-- Bottom Actions -->
            <div class="hidden lg:block p-4 glass-panel border-t border-white/5 z-20">
                <button id="process-image" class="w-full py-3.5 btn-primary-soft text-white font-bold text-xs tracking-widest rounded-xl flex justify-center items-center gap-2 hover:brightness-110 transition-all disabled:opacity-70 disabled:cursor-not-allowed">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                    T·∫†O ·∫¢NH (FLUX/QWEN)
                </button>
                <button id="reset-button" class="w-full mt-2 py-2 text-[10px] font-bold text-slate-500 hover:text-white uppercase tracking-widest transition-colors">L√ÄM M·ªöI</button>
            </div>
        </aside>

        <!-- MAIN WORKSPACE -->
        <main class="flex-1 flex flex-col relative overflow-hidden bg-background" id="main-workspace">
            <!-- Mobile Header -->
            <div class="lg:hidden h-14 glass-panel border-b border-white/5 flex items-center px-4 justify-between z-30 relative">
                <button id="toggle-sidebar-btn" class="p-2 rounded-lg bg-white/5 text-slate-300 active:bg-white/10">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 6h16M4 12h16M4 18h7" /></svg>
                </button>
                <div class="flex flex-col items-center">
                    <span class="text-xs font-bold text-white tracking-widest">PH·ª§C CH·∫æ ·∫¢NH</span>
                    <span id="mobile-status-text" class="text-[8px] text-slate-500 font-mono tracking-wider">CH·ªú ·∫¢NH...</span>
                </div>
                <button id="download-mobile" class="p-2 rounded-lg bg-indigo-500/10 text-indigo-400 border border-indigo-500/20 active:scale-95 disabled:opacity-30" disabled>
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                </button>
            </div>

            <!-- Desktop Toolbar -->
            <div class="absolute top-6 left-6 right-6 h-12 glass-panel rounded-xl flex items-center justify-between px-4 z-20 hidden lg:flex">
                <div class="flex items-center gap-4">
                     <div class="text-[10px] text-slate-400 font-mono flex items-center gap-2"><span class="w-1.5 h-1.5 rounded-full bg-indigo-500"></span>ZOOM: <span id="zoom-level" class="text-white font-bold">100%</span></div>
                     <div class="h-4 w-[1px] bg-white/10"></div>
                     <button id="toggle-magnifier" class="text-[10px] font-bold text-slate-300 hover:text-white flex items-center gap-2"><svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg> SOI DA</button>
                </div>
                <div class="flex items-center gap-3">
                    <button id="download-trigger" class="px-5 py-1.5 bg-white text-black text-[11px] font-bold rounded-lg shadow-lg hover:bg-slate-200 transition-all disabled:opacity-50 disabled:cursor-not-allowed" disabled>L∆ØU ·∫¢NH</button>
                </div>
            </div>

            <!-- Canvas -->
            <div class="flex-1 relative flex items-center justify-center overflow-hidden p-4 lg:p-0 pb-32 lg:pb-0">
                <div id="canvas-scale-container" class="relative transition-transform duration-300 ease-out will-change-transform">
                    <div id="scan-beam" class="scan-beam"></div>
                    <div id="comparison-view" class="relative hidden justify-center items-center animate-fade-in">
                         <div id="comp-inner" class="mobile-image-frame group cursor-ew-resize">
                              <img id="img-original" class="block max-h-[75vh] w-auto pointer-events-none select-none">
                              <div id="img-modified-wrapper" class="absolute top-0 left-0 h-full w-[50%] overflow-hidden border-r border-white/50 bg-black/10">
                                  <img id="img-modified" class="absolute top-0 left-0 max-h-[75vh] w-auto pointer-events-none select-none" style="max-width: none;">
                              </div>
                              <div class="comp-label before">G·ªêC</div>
                              <div class="comp-label after" style="display:none;">K·∫æT QU·∫¢</div>
                              <div id="slider-handle" class="absolute top-0 bottom-0 left-[50%] w-0.5 bg-white/50 z-20 pointer-events-none hidden">
                                  <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-8 h-8 bg-white/10 backdrop-blur-md border border-white rounded-full flex items-center justify-center shadow-[0_0_15px_rgba(0,0,0,0.5)]">
                                      <svg class="w-4 h-4 text-white drop-shadow-md" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" /></svg>
                                  </div>
                              </div>
                         </div>
                    </div>
                    <div id="placeholder-state" class="text-center p-10 animate-float">
                        <div class="w-24 h-24 bg-[#1e202e] rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-2xl border border-white/5 relative">
                             <div class="absolute inset-0 bg-indigo-500/10 blur-xl rounded-full"></div>
                             <svg class="w-10 h-10 text-indigo-400 relative z-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l-1.586-1.586a2 2 0 00-2.828 0L6 18H4a2 2 0 01-2-2V6a2 2 0 01-2-2V6a2 2 0 012-2h16a2 2 0 012 2v8a2 2 0 01-2 2h-2m-4-4l-3 3m0 0l-3-3m3 3V4"></path></svg>
                        </div>
                        <h3 class="text-lg font-bold text-white mb-2">PH·ª§C H·ªíI ·∫¢NH</h3>
                        <p class="text-xs text-slate-500 font-medium">K√©o th·∫£ ho·∫∑c Ch·ªçn ·∫£nh</p>
                    </div>
                </div>

                <!-- AI Terminal -->
                <div id="ai-terminal-overlay" class="absolute inset-0 z-50 bg-[#02040a]/90 backdrop-blur-md hidden flex flex-col items-center justify-center font-mono">
                    <div class="w-full max-w-sm p-6 rounded-2xl border border-white/10 bg-[#0f111a] shadow-2xl relative overflow-hidden">
                        <div class="flex items-center gap-3 mb-6 border-b border-white/5 pb-4">
                            <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
                            <span class="text-xs text-indigo-300 font-bold tracking-widest">ƒêANG X·ª¨ L√ù...</span>
                        </div>
                        <div id="terminal-content" class="text-[10px] text-slate-400 space-y-1 h-32 overflow-hidden opacity-80"></div>
                        <div class="mt-4 h-1 w-full bg-white/5 rounded-full overflow-hidden">
                            <div id="term-progress-bar" class="h-full bg-indigo-500 w-0 transition-all duration-300"></div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- === MOBILE DOCK === -->
    <div id="mobile-action-bar" class="lg:hidden fixed bottom-6 left-4 right-4 z-[90] transition-all duration-500 translate-y-32 opacity-0">
        <div class="glass-panel p-2 rounded-2xl shadow-[0_10px_40px_rgba(0,0,0,0.6)] flex gap-2 w-full max-w-md mx-auto ring-1 ring-white/10">
            <button id="mob-btn-upload" class="flex-1 py-3 bg-[#1e202e] active:bg-[#2a2d3d] rounded-xl text-slate-200 font-bold text-[10px] tracking-widest flex flex-col items-center justify-center gap-1 transition-all border border-white/5">
                <svg class="w-5 h-5 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4 4m0 0L8 8m4-4v12"></path></svg>
                <span>T·∫¢I ·∫¢NH</span>
            </button>
            <button id="mob-btn-scan" class="hidden flex-1 py-3 bg-indigo-600 active:bg-indigo-500 rounded-xl text-white font-bold text-[10px] tracking-widest flex flex-col items-center justify-center gap-1 shadow-lg shadow-indigo-500/30 transition-all">
                <svg class="w-5 h-5 animate-bounce" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                <span>AUTO SCAN</span>
            </button>
            <button id="mob-btn-run" class="hidden flex-1 py-3 bg-gradient-to-r from-emerald-500 to-teal-500 rounded-xl text-white font-bold text-[10px] tracking-widest flex flex-col items-center justify-center gap-1 shadow-lg shadow-emerald-500/30 active:scale-95 transition-all">
                 <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                <span>CH·∫†Y NGAY</span>
            </button>
            <button id="mob-btn-reset" class="w-14 bg-white/5 rounded-xl flex items-center justify-center text-slate-400 active:bg-red-500/20 active:text-red-400 transition-colors border border-white/5" title="Reset">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
            </button>
        </div>
    </div>

    <!-- === RECHARGE MODAL === -->
    <div id="recharge-modal" class="fixed inset-0 z-[110] bg-black/80 backdrop-blur-xl hidden flex items-end sm:items-center justify-center animate-fade-in p-0 sm:p-4">
        <div class="w-full sm:w-full max-w-[850px] bg-[#0f111a] sm:rounded-3xl rounded-t-3xl border-t sm:border border-white/10 shadow-2xl flex flex-col md:flex-row relative overflow-hidden h-[90vh] sm:h-auto">
            <button id="close-recharge" class="absolute top-4 right-4 z-50 p-2 bg-white/10 rounded-full text-slate-300 hover:text-white"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            
            <div class="w-full md:w-5/12 bg-white/[0.02] border-r border-white/5 p-6 flex flex-col">
                <h3 class="text-lg font-bold text-white mb-1">MUA CREDITS</h3>
                <p class="text-xs text-slate-500 mb-6">Ch·ªçn g√≥i ƒë·ªÉ hi·ªán m√£ QR thanh to√°n</p>

                <div class="space-y-3 flex-1 overflow-y-auto">
                    <div class="recharge-pkg-card group relative p-4 rounded-xl border border-white/5 bg-white/5 cursor-pointer hover:bg-white/10 transition-all" data-amount="100000" data-credits="80">
                        <div class="flex justify-between items-center">
                            <div><span class="block text-lg font-bold text-slate-200">100k</span><span class="text-[10px] text-slate-500 font-bold tracking-wider">C∆† B·∫¢N</span></div>
                            <div class="text-right"><span class="block text-lg font-bold text-yellow-400 font-mono">80 CR</span></div>
                        </div>
                        <div class="absolute inset-0 border-2 border-indigo-500 rounded-xl opacity-0 scale-95 transition-all group-hover:opacity-100 group-hover:scale-100 pointer-events-none pkg-border"></div>
                    </div>
                    <div class="recharge-pkg-card active relative p-4 rounded-xl border border-indigo-500/50 bg-indigo-500/10 cursor-pointer transition-all" data-amount="200000" data-credits="200">
                        <div class="absolute -top-2 -right-2 bg-indigo-500 text-white text-[9px] font-bold px-2 py-0.5 rounded shadow-lg">KHUY√äN D√ôNG</div>
                        <div class="flex justify-between items-center">
                            <div><span class="block text-xl font-bold text-white">200k</span><span class="text-[10px] text-indigo-300 font-bold tracking-wider">PH·ªî BI·∫æN</span></div>
                            <div class="text-right"><span class="block text-xl font-bold text-yellow-400 font-mono">200 CR</span><span class="text-[9px] text-green-400 font-bold">+20% Bonus</span></div>
                        </div>
                        <div class="absolute inset-0 border-2 border-indigo-500 rounded-xl opacity-100 scale-100 pointer-events-none pkg-border"></div>
                    </div>
                    <div class="recharge-pkg-card group relative p-4 rounded-xl border border-white/5 bg-white/5 cursor-pointer hover:bg-white/10 transition-all" data-amount="500000" data-credits="500">
                        <div class="flex justify-between items-center">
                            <div><span class="block text-lg font-bold text-slate-200">500k</span><span class="text-[10px] text-slate-500 font-bold tracking-wider">STUDIO</span></div>
                            <div class="text-right"><span class="block text-lg font-bold text-yellow-400 font-mono">500 CR</span></div>
                        </div>
                        <div class="absolute inset-0 border-2 border-blue-500 rounded-xl opacity-0 scale-95 transition-all group-hover:opacity-100 group-hover:scale-100 pointer-events-none pkg-border"></div>
                    </div>
                </div>
            </div>

            <div class="w-full md:w-7/12 p-8 bg-[#0a0a0f] flex flex-col items-center justify-center relative">
                 <div class="bg-white p-3 rounded-2xl shadow-2xl mb-6 relative group">
                    <img id="vietqr-image" src="" alt="QR Payment" class="w-48 h-48 object-contain rounded-xl">
                    <div class="absolute top-3 left-3 right-3 h-0.5 bg-red-500 shadow-[0_0_15px_red] animate-scan opacity-40 pointer-events-none"></div>
                </div>
                <div class="text-center space-y-2 mb-6">
                    <p class="text-[10px] text-slate-500 font-bold uppercase">N·ªòI DUNG CHUY·ªÇN KHO·∫¢N (AUTO)</p>
                    <div class="bg-white/5 px-4 py-2 rounded-lg border border-white/5 inline-block"><p id="qr-content-display" class="text-lg font-bold text-yellow-400 font-mono">...</p></div>
                </div>
                <div class="w-full max-w-xs border-t border-white/5 pt-6">
                    <label class="text-[10px] font-bold text-slate-400 uppercase mb-2 block text-center">NH·∫¨P M√É K√çCH HO·∫†T (SAU KHI CK)</label>
                    <div class="flex gap-2">
                        <input type="text" id="recharge-input" class="pro-input text-center font-mono uppercase text-indigo-300" placeholder="V35-XXXX-XXXX">
                        <button id="btn-submit-recharge" class="px-5 bg-white text-black rounded-lg text-xs font-bold shadow-lg hover:scale-105 transition-transform">K√çCH HO·∫†T</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JS Logic -->
    <script>
        const DEFAULT_ENCRYPTED_CONFIG = "LRFALDY3LTQ/IH1xZxg7PigidAVWQX1/ZyIlOw46MmdjfSAqYSUjW3QnGQd0ZAU1DngybTckJQEfP1hSNgspJzAbIgofNW4bMRIfBBoCbxkrNBtkF2dzaTUrMCUoKDEkEQ99MCouMCZnc2knOCw2FD44dAkXNycxMyZoanAqNTBxMC4hMSJSRTZ9Jiw4cDg="; 
        const ALLOWED_DOMAINS = []; 

        document.addEventListener('DOMContentLoaded', () => {
            const apiKey = ""; 

            const Sec = {
                key: "V35_SEC_V2", 
                dec(t){ try { if(!t) return null; return [...atob(t)].map((c,i) => String.fromCharCode(c.charCodeAt(0)^this.key.charCodeAt(i%this.key.length))).join("") } catch(e) { return null; } }
            };

            const UserSystem = {
                deviceId: null, credits: 0, ipAddress: null, 
                async init() {
                    try {
                        let storedId = localStorage.getItem('v35_unique_device_id');
                        if (!storedId) {
                            storedId = `ID-${Math.random().toString(36).substring(2, 8).toUpperCase()}`;
                            localStorage.setItem('v35_unique_device_id', storedId);
                        }
                        this.deviceId = storedId;
                    } catch (e) { this.deviceId = "GUEST-" + Math.floor(Math.random()*1000); }
                    
                    await this.fetchIP();
                    this.loadCredits();

                    try {
                        let configStr = localStorage.getItem("v35_user_settings");
                        if (!configStr && DEFAULT_ENCRYPTED_CONFIG) configStr = DEFAULT_ENCRYPTED_CONFIG;
                        if (configStr) {
                            const decryptConfig = (t) => { const k = "V35_SECURE_KEY_SALT"; try { let text = atob(t), res = ''; for(let i=0;i<text.length;i++) res += String.fromCharCode(text.charCodeAt(i)^k.charCodeAt(i%k.length)); return res; } catch(e){return null;} };
                            const jsonStr = decryptConfig(configStr);
                            if (jsonStr) { const c = JSON.parse(jsonStr); if(c && c.apiKey) { window.GEMINI_API_KEY = c.apiKey; window.API_BASE_URL = c.baseUrl || "https://generativelanguage.googleapis.com"; window.API_PROVIDER = c.provider || "google"; } }
                        }
                    } catch(e) {}

                    this.updateUI();
                    initRechargeSystem(this.deviceId);
                    updateMobileBtnState('upload');
                },
                async fetchIP() {
                    const disp = document.getElementById('gate-ip-display'), btn = document.getElementById('gate-submit'), status = document.getElementById('gate-status'), topIp = document.getElementById('top-bar-ip');
                    const enable = (ip) => {
                        if(disp) { disp.innerHTML = `<span class="text-slate-400 text-xs">${ip}</span> <span class="text-white mx-1">|</span> <span class="text-yellow-400 font-bold">${this.deviceId}</span>`; disp.classList.remove('shimmer-text'); }
                        if(btn) { btn.disabled = false; btn.classList.remove('opacity-50', 'cursor-not-allowed'); }
                        if(status) { status.textContent = `ƒê√£ nh·∫≠n di·ªán: ${this.deviceId}`; status.classList.add('text-green-500'); }
                        document.getElementById('gate-loading-spinner').style.display = 'none';
                    };
                    try {
                        const r = await fetch(`https://api.ipify.org?format=json`); const d = await r.json(); this.ipAddress = d.ip;
                        if(topIp) topIp.textContent = `IP: ${d.ip}`; enable(d.ip); return d.ip;
                    } catch(e) { this.ipAddress = "Offline Mode"; if(topIp) topIp.textContent = "Offline"; enable("Offline"); return null; }
                },
                loadCredits() { this.credits = parseInt(localStorage.getItem(`v35_credits_${this.deviceId}`) || 0); this.save(); },
                setCredits(a) { this.credits = a; this.save(); },
                addCredits(a) { this.credits += a; this.save(); },
                deductCredits(a) { if(this.credits>=a) { this.credits-=a; this.save(); return true; } return false; },
                save() { localStorage.setItem(`v35_credits_${this.deviceId}`, this.credits); this.updateUI(); },
                updateUI() { const el = document.getElementById('credit-count'); if(el) el.textContent = this.credits; }
            };

            const sidebar = document.getElementById('sidebar');
            const mobileBar = document.getElementById('mobile-action-bar');
            
            function openSidebar() { sidebar.classList.add('open'); mobileBar.classList.add('translate-y-32', 'opacity-0'); }
            function closeSidebar() { sidebar.classList.remove('open'); mobileBar.classList.remove('translate-y-32', 'opacity-0'); }
            
            document.getElementById('toggle-sidebar-btn').onclick = () => sidebar.classList.contains('open') ? closeSidebar() : openSidebar();
            document.getElementById('close-sidebar-mobile').onclick = closeSidebar;

            const toggleModule = (btnId, contentId, iconId) => { const btn = document.getElementById(btnId), content = document.getElementById(contentId), icon = document.getElementById(iconId); if(btn) btn.addEventListener('click', () => { content.classList.toggle('open'); if(icon) icon.style.transform = content.classList.contains('open') ? 'rotate(180deg)' : 'rotate(0deg)'; }); };
            ['processing','military','cinematic','exposure','identity','prompt','logo','subject'].forEach(id => toggleModule(`toggle-${id}`, `content-${id}`, `icon-${id}`));

            document.querySelectorAll('input[type="range"]').forEach(s => s.addEventListener('input', (e) => { 
                const idMap = {'creativity-slider': 'creativity-val', 'grain-slider': 'grain-val', 'identity-weight-slider': 'identity-weight-val', 'structure-slider': 'structure-val'};
                const label = document.getElementById(idMap[e.target.id]); 
                if(label) label.textContent = e.target.value + (e.target.max > 10 ? '%' : ''); 
            }));

            function initRechargeSystem(deviceId) {
                const qrImg = document.getElementById('vietqr-image'), disp = document.getElementById('qr-content-display');
                const updateQR = (amt) => { const c = `V35 ${deviceId}`; qrImg.src = `https://img.vietqr.io/image/mbbank-85543556868-compact.png?amount=${amt}&addInfo=${encodeURIComponent(c)}&accountName=HOANG%20QUANG%20CUONG`; if(disp) disp.textContent = c; };
                updateQR(200000); 
                document.querySelectorAll('.recharge-pkg-card').forEach(card => {
                    card.addEventListener('click', () => {
                        document.querySelectorAll('.recharge-pkg-card').forEach(c => { c.classList.remove('active', 'border-indigo-500/50', 'bg-indigo-500/10'); c.classList.add('border-white/5', 'bg-white/5'); c.querySelector('.pkg-border').classList.remove('opacity-100', 'scale-100'); });
                        card.classList.remove('border-white/5', 'bg-white/5'); card.classList.add('active', 'border-indigo-500/50', 'bg-indigo-500/10'); card.querySelector('.pkg-border').classList.add('opacity-100', 'scale-100');
                        updateQR(card.dataset.amount);
                    });
                });
            }

            document.getElementById('credit-display').onclick = () => document.getElementById('recharge-modal').classList.remove('hidden');
            document.getElementById('close-recharge').onclick = () => document.getElementById('recharge-modal').classList.add('hidden');
            document.getElementById('btn-submit-recharge').onclick = () => {
                const code = document.getElementById('recharge-input').value.trim();
                if(!code.startsWith('V35-')) return showToast("M√£ kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng", "error");
                const dec = Sec.dec(code.substring(4));
                if(!dec || !dec.includes('|')) return showToast("M√£ l·ªói", "error");
                const [amt, machine] = dec.split('|');
                if(machine !== UserSystem.deviceId) return showToast(`M√£ b·ªã kh√≥a cho m√°y: ${machine}`, "error");
                if(JSON.parse(localStorage.getItem('v35_used_codes')||'[]').includes(code)) return showToast("M√£ ƒë√£ s·ª≠ d·ª•ng", "error");
                UserSystem.addCredits(parseInt(amt));
                localStorage.setItem('v35_used_codes', JSON.stringify([...JSON.parse(localStorage.getItem('v35_used_codes')||'[]'), code]));
                showToast(`N·∫°p th√†nh c√¥ng +${amt} Credits`, "success");
                document.getElementById('recharge-modal').classList.add('hidden');
            };

            let state = { base64: null, restoredObj: null };
            const showToast = (msg, type) => {
                const t = document.createElement('div'); t.className = `px-4 py-3 rounded-xl border backdrop-blur-md shadow-lg text-xs font-bold flex items-center gap-2 animate-fade-in ${type==='error'?'bg-red-500/10 border-red-500/50 text-red-200':'bg-indigo-500/10 border-indigo-500/50 text-indigo-200'}`;
                t.innerHTML = `<span>${type==='error'?'‚ö†Ô∏è':'‚úÖ'}</span> ${msg}`;
                document.getElementById('toast-container').appendChild(t);
                setTimeout(() => t.remove(), 3000);
            };

            const updateMobileBtnState = (s) => {
                const u = document.getElementById('mob-btn-upload'), sc = document.getElementById('mob-btn-scan'), r = document.getElementById('mob-btn-run'), stat = document.getElementById('mobile-status-text');
                [u, sc, r].forEach(b => b.classList.add('hidden'));
                if(s === 'upload') { u.classList.remove('hidden'); stat.textContent = "CH·ªú T·∫¢I ·∫¢NH"; }
                else if(s === 'scan') { sc.classList.remove('hidden'); stat.textContent = "ƒê√É T·∫¢I > SCAN NGAY"; }
                else if(s === 'scanning') { sc.classList.remove('hidden'); sc.disabled=true; stat.textContent = "AI ƒêANG QU√âT..."; }
                else if(s === 'run') { r.classList.remove('hidden'); r.disabled=false; stat.textContent = "S·∫¥N S√ÄNG CH·∫†Y"; }
                else if(s === 'running') { r.classList.remove('hidden'); r.disabled=true; r.classList.add('opacity-50'); stat.textContent = "ƒêANG X·ª¨ L√ù..."; }
                else if(s === 'done') { r.classList.remove('hidden'); r.disabled=false; stat.textContent = "HO√ÄN T·∫§T"; }
            };

            document.getElementById('gate-submit').onclick = () => {
                const gate = document.getElementById('security-gate');
                gate.classList.add('opacity-0'); setTimeout(() => gate.style.display='none', 500);
            };
            UserSystem.init();

            const loadImg = (file) => {
                if(!file || !file.type.startsWith('image/')) return showToast("Ch·ªâ h·ªó tr·ª£ file ·∫£nh", "error");
                const reader = new FileReader();
                reader.onload = (e) => {
                    state.base64 = e.target.result;
                    document.getElementById('img-original').src = state.base64;
                    document.getElementById('comparison-view').classList.remove('hidden');
                    document.getElementById('comparison-view').classList.add('flex');
                    document.getElementById('placeholder-state').style.display = 'none';
                    document.getElementById('img-modified-wrapper').style.width = '0%';
                    document.querySelector('.comp-label.after').style.display = 'none';
                    document.getElementById('slider-handle').style.display = 'none';
                    updateMobileBtnState('scan');
                    showToast("ƒê√£ t·∫£i ·∫£nh", "success");
                };
                reader.readAsDataURL(file);
            };
            document.getElementById('image-upload').onchange = (e) => { if(e.target.files.length) loadImg(e.target.files[0]); };
            document.getElementById('mob-btn-upload').onclick = () => document.getElementById('image-upload').click();

            // Auto Pilot Logic
            document.getElementById('btn-auto-pilot').onclick = async () => {
                if(!state.base64) return showToast("Vui l√≤ng t·∫£i ·∫£nh tr∆∞·ªõc", "error");
                const btn = document.getElementById('btn-auto-pilot'); const oldText = btn.innerHTML;
                btn.innerHTML = "ƒêANG QU√âT AI..."; btn.disabled = true; updateMobileBtnState('scanning');
                
                try {
                    const { apiKey, apiBase } = { apiKey: window.GEMINI_API_KEY || "", apiBase: window.API_BASE_URL || "https://generativelanguage.googleapis.com" };
                    if (!apiKey) throw new Error("Ch∆∞a c√≥ API Key");

                    // Real Scan Logic similar to original file
                    const img = new Image(); img.src = state.base64; await new Promise(r => img.onload = r);
                    const cvs = document.createElement('canvas'); let w=img.width,h=img.height; if(w>1024){h*=1024/w;w=1024;} cvs.width=w; cvs.height=h; cvs.getContext('2d').drawImage(img,0,0,w,h);
                    const resized = cvs.toDataURL('image/jpeg', 0.8).split(',')[1];
                    
                    const pText = "Analyze image return JSON: { \"sceneContext\": \"wedding\"|\"funeral\"|\"casual\"|\"studio\"|\"outdoor\", \"lightingCondition\": \"rembrandt\"|\"golden_hour\"|\"neon\"|\"soft_diffused\", \"isMilitary\": boolean, \"gender\": \"male\"|\"female\", \"age\": number, \"damageType\": \"scratches\"|\"blur\"|\"none\", \"isOldPhoto\": boolean, \"isIDPhoto\": boolean }";
                    const resp = await fetch(`${apiBase}/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ contents: [{ parts: [{ text: pText }, { inlineData: { mimeType: "image/jpeg", data: resized } }] }] })
                    });
                    
                    const d = await resp.json();
                    let t = d.candidates?.[0]?.content?.parts?.[0]?.text;
                    if(t) {
                        const res = JSON.parse(t.replace(/```json|```/g, '').trim());
                        
                        // Apply to UI
                        if(res.isMilitary) { document.getElementById('module-military').querySelector('.module-content').classList.add('open'); showToast("Ph√°t hi·ªán Qu√¢n ph·ª•c", "success"); }
                        if(res.isIDPhoto) { document.getElementById('check-id-photo').checked = true; document.getElementById('module-subject').querySelector('.module-content').classList.add('open'); }
                        if(document.getElementById('gender-select')) document.getElementById('gender-select').value = res.gender || '';
                        if(document.getElementById('age-input')) document.getElementById('age-input').value = res.age || 30;
                        
                        if(window.innerWidth >= 1024) openSidebar();
                        updateMobileBtnState('run');
                        showToast("ƒê√£ qu√©t xong: " + (res.sceneContext || "Ch√¢n dung"), "success");
                    }
                } catch(e) { console.error(e); showToast("L·ªói Scan: " + e.message, "error"); updateMobileBtnState('scan'); }
                finally { btn.innerHTML = oldText; btn.disabled = false; }
            };
            document.getElementById('mob-btn-scan').onclick = () => document.getElementById('btn-auto-pilot').click();

            const runProcess = async () => {
                if(!state.base64) return;
                if(!UserSystem.deductCredits(20)) { showToast("Kh√¥ng ƒë·ªß Credits!", "error"); document.getElementById('recharge-modal').classList.remove('hidden'); return; }
                
                updateMobileBtnState('running'); closeSidebar();
                const term = document.getElementById('ai-terminal-overlay'); term.classList.remove('hidden'); term.classList.add('flex');
                document.getElementById('scan-beam').classList.add('active');
                
                try {
                    const key = window.GEMINI_API_KEY || "";
                    if(!key) throw new Error("Ch∆∞a c·∫•u h√¨nh API Key");
                    
                    let prompt = document.getElementById('prompt-main').value || "Restore this photo, high quality, 8k";
                    if(document.getElementById('check-anti-flip').checked) prompt += ", (do not flip:1.5)";
                    if(document.getElementById('check-asian-identity').checked) prompt += ", (vietnamese asian face:1.4)";
                    
                    const img = new Image(); img.src = state.base64; await new Promise(r => img.onload = r);
                    const cvs = document.createElement('canvas'); let w=img.width,h=img.height; if(w>1536){h*=1536/w;w=1536;} cvs.width=w; cvs.height=h; cvs.getContext('2d').drawImage(img,0,0,w,h);
                    const resized = cvs.toDataURL('image/jpeg', 0.9).split(',')[1];

                    const resp = await fetch(`${window.API_BASE_URL || 'https://generativelanguage.googleapis.com'}/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${key}`, {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: "image/jpeg", data: resized } }] }] })
                    });
                    
                    const data = await resp.json();
                    const resBase64 = data.candidates?.[0]?.content?.parts?.find(p=>p.inlineData)?.inlineData?.data;
                    if(!resBase64) throw new Error("Kh√¥ng c√≥ d·ªØ li·ªáu ·∫£nh tr·∫£ v·ªÅ");

                    const resImg = document.getElementById('img-modified');
                    resImg.src = `data:image/jpeg;base64,${resBase64}`;
                    resImg.onload = () => {
                        const orig = document.getElementById('img-original');
                        resImg.style.width = orig.clientWidth + 'px';
                        resImg.style.height = orig.clientHeight + 'px';
                        document.getElementById('img-modified-wrapper').style.width = '50%';
                        document.getElementById('slider-handle').style.left = '50%';
                        document.getElementById('slider-handle').style.display = 'flex';
                        document.querySelector('.comp-label.after').style.display = 'block';
                        document.getElementById('download-trigger').disabled = false;
                        document.getElementById('download-mobile').disabled = false;
                        updateMobileBtnState('done');
                        showToast("Ph·ª•c ch·∫ø th√†nh c√¥ng!", "success");
                    };
                } catch(e) { console.error(e); showToast(e.message, "error"); updateMobileBtnState('run'); }
                finally { term.classList.add('hidden'); term.classList.remove('flex'); document.getElementById('scan-beam').classList.remove('active'); }
            };

            document.getElementById('process-image').onclick = runProcess;
            document.getElementById('mob-btn-run').onclick = runProcess;

            const comp = document.getElementById('comp-inner'), wrap = document.getElementById('img-modified-wrapper'), hand = document.getElementById('slider-handle');
            let isDrag = false;
            const move = (x) => { const r = comp.getBoundingClientRect(); let p = ((x - r.left)/r.width)*100; p=Math.max(0,Math.min(100,p)); wrap.style.width = p+'%'; hand.style.left = p+'%'; };
            comp.addEventListener('mousedown', ()=>isDrag=true); window.addEventListener('mouseup', ()=>isDrag=false);
            comp.addEventListener('touchstart', ()=>isDrag=true); window.addEventListener('touchend', ()=>isDrag=false);
            comp.addEventListener('mousemove', (e)=>isDrag && move(e.clientX));
            comp.addEventListener('touchmove', (e)=>isDrag && move(e.touches[0].clientX));

            const dl = () => { const a = document.createElement('a'); a.download = `V35-Full-${Date.now()}.jpg`; a.href = document.getElementById('img-modified').src; a.click(); };
            document.getElementById('download-trigger').onclick = dl; document.getElementById('download-mobile').onclick = dl;
            const reset = () => confirm("L√†m m·ªõi?") && location.reload();
            document.getElementById('reset-button').onclick = reset; document.getElementById('mob-btn-reset').onclick = reset;
            
            setTimeout(() => mobileBar.classList.remove('translate-y-32', 'opacity-0'), 800);
        });
    </script>
</body>
</html>