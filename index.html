<!DOCTYPE html>
<html lang="vi" class="h-full antialiased text-gray-100">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>PH·ª§C H·ªíI ·∫¢NH - AI RESTORATION PRO (V36.60 + UI V41 UPGRADE)</title>
    
    <!-- FONTS: Apple Style Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800;900&family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- COPYRIGHT PROTECTION SCRIPT -->
    <script>
        (function() {
            document.addEventListener('contextmenu', function(e) { e.preventDefault(); return false; });
            document.onkeydown = function(e) {
                if (e.keyCode == 123) return false;
                if (e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) return false;
                if (e.ctrlKey && e.shiftKey && e.keyCode == 'C'.charCodeAt(0)) return false;
                if (e.ctrlKey && e.shiftKey && e.keyCode == 'J'.charCodeAt(0)) return false;
                if (e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) return false;
                if (e.ctrlKey && e.keyCode == 'S'.charCodeAt(0)) { e.preventDefault(); return false; }
            };
            console.log("%cD·ª™NG L·∫†I!", "color: red; font-size: 50px; font-weight: bold; text-shadow: 2px 2px #000;");
            console.log("%cƒê√¢y l√† ph·∫ßn m·ªÅm c√≥ b·∫£n quy·ªÅn.", "color: white; background: red; font-size: 16px; padding: 10px; border-radius: 5px;");
        })();
    </script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['"Plus Jakarta Sans"', '-apple-system', 'BlinkMacSystemFont', 'sans-serif'],
                        mono: ['"JetBrains Mono"', 'monospace'],
                    },
                    colors: {
                        ios: {
                            bg: '#000000',
                            card: '#1c1c1e',
                            input: '#2c2c2e',
                            border: 'rgba(255, 255, 255, 0.12)',
                            blue: '#0A84FF',
                            green: '#30D158',
                            orange: '#FF9F0A',
                            red: '#FF453A',
                            purple: '#BF5AF2',
                            teal: '#64D2FF',
                            yellow: '#FFD60A'
                        }
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'scan': 'scan 2s linear infinite', 
                        'scan-fast': 'scan 1.5s linear infinite',
                        'toast-in': 'toastIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)', 
                        'pulse-glow': 'pulseGlow 2s infinite',
                        'fade-out': 'fadeOut 0.5s ease-out forwards', 
                        'enter-up': 'enterUp 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards',
                        'ios-press': 'iosPress 0.2s ease-out',
                        'highlight-pulse': 'highlightPulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'blob': 'blob 10s infinite',
                        'typewriter': 'typewriter 0.5s steps(40, end)',
                        'shimmer-fast': 'shimmer 1.5s linear infinite',
                        'pop-in': 'popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards',
                        'text-cycle': 'textCycle 2s ease-in-out forwards', 
                        'spin-slow': 'spin 3s linear infinite',
                        'grid-move': 'gridMove 20s linear infinite',
                    },
                    keyframes: {
                        enterUp: { '0%': { opacity: '0', transform: 'translateY(30px) scale(0.95)' }, '100%': { opacity: '1', transform: 'translateY(0) scale(1)' } },
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } },
                        scan: { '0%': { top: '0%', opacity: '0' }, '10%': { opacity: '1', boxShadow: '0 0 15px #0A84FF' }, '90%': { opacity: '1' }, '100%': { top: '100%', opacity: '0' } },
                        toastIn: { '0%': { transform: 'translateX(20px)', opacity: '0' }, '100%': { transform: 'translateX(0)', opacity: '1' } },
                        pulseGlow: { '0%, 100%': { opacity: '1', boxShadow: '0 0 10px #0A84FF' }, '50%': { opacity: '0.8', boxShadow: '0 0 20px #0A84FF' } },
                        fadeOut: { '0%': { opacity: '1', visibility: 'visible' }, '100%': { opacity: '0', visibility: 'hidden' } },
                        iosPress: { '0%': { transform: 'scale(1)' }, '50%': { transform: 'scale(0.97)' }, '100%': { transform: 'scale(1)' } },
                        highlightPulse: { '0%, 100%': { borderColor: 'rgba(255, 214, 10, 0.5)', backgroundColor: 'rgba(255, 214, 10, 0.1)' }, '50%': { borderColor: 'rgba(255, 214, 10, 1)', backgroundColor: 'rgba(255, 214, 10, 0.2)' } },
                        blob: { '0%': { transform: 'translate(0px, 0px) scale(1)' }, '33%': { transform: 'translate(30px, -50px) scale(1.1)' }, '66%': { transform: 'translate(-20px, 20px) scale(0.9)' }, '100%': { transform: 'translate(0px, 0px) scale(1)' } },
                        shimmer: { '0%': { backgroundPosition: '200% center' }, '100%': { backgroundPosition: '-200% center' } },
                        popIn: { '0%': { opacity: '0', transform: 'scale(0.5)' }, '100%': { opacity: '1', transform: 'scale(1)' } },
                        textCycle: { 
                            '0%': { opacity: '0', transform: 'translateY(10px)' }, 
                            '10%': { opacity: '1', transform: 'translateY(0)' }, 
                            '80%': { opacity: '1', transform: 'translateY(0)' }, 
                            '100%': { opacity: '0', transform: 'translateY(-10px)' } 
                        },
                        gridMove: { '0%': { transform: 'translateY(0)' }, '100%': { transform: 'translateY(50px)' } }
                    }
                }
            }
        }
    </script>

    <style>
        /* iOS Base Reset */
        :root { --ease-ios: cubic-bezier(0.2, 0.8, 0.2, 1); }
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; -webkit-font-smoothing: antialiased; }
        body { 
            background-color: #000000;
            color: #f2f2f7;
            -webkit-user-select: none; user-select: none;
            position: fixed; inset: 0; width: 100vw; height: 100dvh;
        }
        input, textarea { -webkit-user-select: text; user-select: text; }

        /* Custom Scrollbar - iOS Style Refined */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: transparent; margin: 4px; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 10px; transition: background 0.3s; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.3); }

        /* Glass Components - Softer, smoother */
        .glass-panel { 
            background: rgba(20, 20, 22, 0.65); 
            backdrop-filter: blur(40px); 
            -webkit-backdrop-filter: blur(40px);
            border-right: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 10px 0 30px rgba(0,0,0,0.5);
        }
        
        .ios-card {
            background: rgba(44, 44, 46, 0.6);
            border-radius: 16px;
            overflow: hidden;
            transition: background 0.3s var(--ease-ios);
        }
        
        /* Form Inputs - Sleeker iOS Look */
        .pro-input { 
            background: rgba(0, 0, 0, 0.3); 
            border: 1px solid rgba(255, 255, 255, 0.06); 
            color: #fff; 
            transition: all 0.3s var(--ease-ios); 
            font-size: 11.5px; 
            font-weight: 500;
            border-radius: 10px; 
            padding: 10px 14px;
            box-shadow: inset 0 2px 6px rgba(0,0,0,0.15);
        }
        .pro-input:focus { 
            background: rgba(0, 0, 0, 0.5); 
            border-color: #0A84FF; 
            outline: none; 
            box-shadow: 0 0 0 3px rgba(10, 132, 255, 0.2), inset 0 2px 6px rgba(0,0,0,0.15); 
        }
        select.pro-input { padding-top: 10px; padding-bottom: 10px; }
        
        select { 
            -webkit-appearance: none; 
            background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E");
            background-position: right 0.75rem center;
            background-repeat: no-repeat;
            background-size: 1.2em 1.2em;
        }
        select option { background-color: #1c1c1e; color: #fff; padding: 12px; } 
        select optgroup { background-color: #000; color: #8E8E93; font-weight: 700; }

        /* Module Accordion - Fully Re-designed for iOS */
        .module-group { 
            background: rgba(30, 30, 32, 0.45); 
            border-radius: 18px; 
            margin-bottom: 16px; 
            overflow: hidden; 
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 6px 24px -6px rgba(0,0,0,0.3);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            transition: all 0.4s var(--ease-ios);
        }
        .module-group:hover {
            background: rgba(40, 40, 42, 0.55);
            border-color: rgba(255, 255, 255, 0.1);
        }
        .module-header { 
            background: transparent; 
            padding: 14px 18px; 
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
        }
        .module-header:active { background: rgba(255, 255, 255, 0.04); }
        .module-content { display: grid; grid-template-rows: 0fr; transition: grid-template-rows 0.4s var(--ease-ios), opacity 0.4s ease; opacity: 0; }
        .module-content.open { grid-template-rows: 1fr; opacity: 1; }
        .module-content.open .module-inner { 
            padding: 4px 18px 18px 18px; 
            border-top: 1px solid rgba(255,255,255,0.03); 
        }
        .module-inner { min-height: 0; overflow: hidden; }

        /* iOS Switch / Checkbox - Smoother */
        .chk-pro { appearance: none; width: 20px; height: 20px; border-radius: 6px; border: 1.5px solid rgba(142, 142, 147, 0.4); background: rgba(0,0,0,0.2); display: grid; place-content: center; cursor: pointer; transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); box-shadow: inset 0 2px 4px rgba(0,0,0,0.1); }
        .chk-pro::before { content: ""; width: 10px; height: 10px; transform: scale(0); background: #fff; border-radius: 3px; transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        .chk-pro:checked::before { transform: scale(1); }
        .chk-pro:checked { border-color: #0A84FF; background: #0A84FF; box-shadow: 0 0 10px rgba(10, 132, 255, 0.3); }
        
        .chk-gold:checked { border-color: #FFD60A; background: #FFD60A; box-shadow: 0 0 10px rgba(255, 214, 10, 0.3); }
        .chk-red:checked { border-color: #FF453A; background: #FF453A; box-shadow: 0 0 10px rgba(255, 69, 58, 0.3); }
        .chk-real:checked { border-color: #FF9F0A; background: #FF9F0A; }

        /* Sliders */
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%; background: #ffffff; cursor: pointer; margin-top: -8px; box-shadow: 0 2px 8px rgba(0,0,0,0.4); transition: transform 0.2s; }
        input[type=range]::-webkit-slider-thumb:active { transform: scale(1.15); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 5px; cursor: pointer; background: rgba(255,255,255,0.15); border-radius: 3px; box-shadow: inset 0 1px 2px rgba(0,0,0,0.2); }
        .slider-red::-webkit-slider-thumb { background: #FF453A; }
        .slider-flux::-webkit-slider-thumb { background: #BF5AF2; }
        .slider-cyan::-webkit-slider-thumb { background: #64D2FF; box-shadow: 0 0 10px rgba(100, 210, 255, 0.4); }

        /* Animations & Effects */
        .modal-fade-in { animation: modalFadeIn 0.4s var(--ease-ios); }
        @keyframes modalFadeIn { from { opacity: 0; transform: scale(0.95); filter: blur(15px); } to { opacity: 1; transform: scale(1); filter: blur(0); } }
        
        .shimmer-text { background: linear-gradient(90deg, #8E8E93 0%, #fff 50%, #8E8E93 100%); background-size: 200% auto; -webkit-background-clip: text; -webkit-text-fill-color: transparent; animation: shine 3s linear infinite; }
        @keyframes shine { to { background-position: 200% center; } }
        
        /* Mobile Specifics */
        @media (max-width: 1024px) {
            #sidebar { width: 100% !important; max-width: 100% !important; border-right: none; background: rgba(10, 10, 12, 0.85); backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px); }
        }
        
        /* Image Comparison Frame */
        .mobile-image-frame {
            border: 1px solid rgba(255, 255, 255, 0.15); 
            box-shadow: 0 20px 50px -12px rgba(0, 0, 0, 0.7);
            background: #000;
            border-radius: 16px;
            overflow: hidden;
            width: auto; height: auto;
            max-width: 95vw; max-height: 70vh;
            display: flex; align-items: center; justify-content: center;
            margin: 0 auto; position: relative;
        }
        #img-original, #img-modified { display: block; max-width: 100%; max-height: 70vh; object-fit: contain; width: auto; height: auto; }
        #img-modified-wrapper { position: absolute; top: 0; left: 0; height: 100%; width: 50%; overflow: hidden; border-right: 1px solid rgba(255, 255, 255, 0.8); }

        .comp-label { 
            position: absolute; bottom: 16px; padding: 6px 14px; 
            background: rgba(28, 28, 30, 0.6); color: white; 
            font-size: 11px; font-weight: 700; letter-spacing: 0.5px;
            border-radius: 20px; pointer-events: none; z-index: 25; 
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            border: 1px solid rgba(255,255,255,0.15); 
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .comp-label.before { right: 16px; } 
        .comp-label.after { left: 16px; } 

        /* Button Styles (CLEAN iOS STYLE) */
        .btn-iso-glass {
            background: rgba(255,255,255,0.06);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.1);
            color: rgba(255,255,255,0.9);
            border-radius: 16px;
            font-weight: 600;
            transition: all 0.3s var(--ease-ios);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .btn-iso-glass:hover { background: rgba(255,255,255,0.1); color: #fff; }
        .btn-iso-glass:active { transform: scale(0.96); background: rgba(255,255,255,0.08); }

        /* Security Gate iOS Style */
        .passcode-dot { width: 12px; height: 12px; border-radius: 50%; border: 1px solid #fff; margin: 0 8px; }
        .passcode-dot.filled { background: #fff; }

        /* Tag in HUD */
        .scan-tag { 
            display: inline-flex; align-items: center; 
            padding: 2px 6px; margin: 0 2px;
            color: #fff; font-size: 9px; font-weight: 600; font-family: monospace;
            opacity: 0; animation: pop-in 0.3s forwards;
            white-space: nowrap;
        }
        .scan-tag.highlight { color: #FFD60A; text-shadow: 0 0 5px rgba(255, 214, 10, 0.5); }

        /* Sequential Log Text (Corner) */
        .sequential-log-text {
            display: block;
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            font-weight: 700;
            color: #0A84FF;
            text-shadow: 0 0 10px rgba(10, 132, 255, 0.6);
            white-space: nowrap;
            background: rgba(0,0,0,0.5);
            padding: 4px 8px;
            border-radius: 4px;
            border-left: 2px solid #0A84FF;
            animation: text-cycle 0.8s ease-in-out forwards;
        }
        .sequential-log-text.highlight { 
            color: #FFD60A; 
            border-color: #FFD60A;
            text-shadow: 0 0 10px rgba(255, 214, 10, 0.6); 
        }
        .sequential-log-text::before { content: ">> "; opacity: 0.7; }

        /* Text Mask for HUD */
        .mask-linear-fade {
            mask-image: linear-gradient(to right, black 80%, transparent 100%);
            -webkit-mask-image: linear-gradient(to right, black 80%, transparent 100%);
        }

        /* Grid Background Effect */
        .cyber-grid-bg {
            background-image: 
                linear-gradient(rgba(10, 132, 255, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(10, 132, 255, 0.1) 1px, transparent 1px);
            background-size: 40px 40px;
            mask-image: radial-gradient(circle at center, black 40%, transparent 80%);
            -webkit-mask-image: radial-gradient(circle at center, black 40%, transparent 80%);
            animation: gridMove 20s linear infinite;
        }

        /* Modern HUD Loader (Ring) */
        @keyframes spinRing {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loader-ring {
            border: 3px solid rgba(10, 132, 255, 0.1);
            border-top: 3px solid #0A84FF;
            border-radius: 50%;
            width: 60px; height: 60px;
            animation: spinRing 1s linear infinite;
        }
        .loader-ring-inner {
            border: 3px solid rgba(255, 214, 10, 0.1);
            border-bottom: 3px solid #FFD60A;
            border-radius: 50%;
            width: 40px; height: 40px;
            animation: spinRing 1.5s linear infinite reverse;
        }
        
        /* Drop Zone Pulse */
        .drop-zone-pulse {
            box-shadow: 0 0 0 0 rgba(10, 132, 255, 0.7);
            animation: dropPulse 2s infinite;
        }
        @keyframes dropPulse {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(10, 132, 255, 0.7); }
            70% { transform: scale(1.02); box-shadow: 0 0 0 10px rgba(10, 132, 255, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(10, 132, 255, 0); }
        }

        /* History Items */
        .history-item {
            width: 48px; height: 48px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.1);
            background-size: cover; background-position: center;
            cursor: pointer; transition: all 0.2s var(--ease-ios);
            position: relative;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }
        .history-item:hover { transform: scale(1.1) translateY(-2px); border-color: #0A84FF; z-index: 10; box-shadow: 0 8px 15px rgba(10, 132, 255, 0.3); }
        .history-dl-btn {
            position: absolute; bottom: -4px; right: -4px;
            width: 18px; height: 18px;
            background: #0A84FF; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            color: white; font-size: 9px;
            border: 1.5px solid #1c1c1e;
            box-shadow: 0 2px 5px rgba(0,0,0,0.5);
            transition: all 0.2s var(--ease-ios);
            opacity: 0;
            transform: scale(0.8);
        }
        .history-item:hover .history-dl-btn { opacity: 1; transform: scale(1); }
    </style>
</head>

<body class="font-sans flex overflow-hidden select-none relative" oncontextmenu="return false;">
    
    <!-- BACKGROUND: Simple Deep Dark + CYBER GRID -->
    <div class="fixed inset-0 bg-black z-0">
        <div class="absolute top-[-20%] left-[-20%] w-[80vw] h-[80vw] bg-blue-900/10 rounded-full blur-[120px]"></div>
        <div class="absolute bottom-[-20%] right-[-20%] w-[80vw] h-[80vw] bg-purple-900/10 rounded-full blur-[120px]"></div>
        <!-- Subtle Grid for High Tech feel -->
        <div class="absolute inset-0 cyber-grid-bg opacity-20 pointer-events-none"></div>
    </div>

    <!-- SECURITY GATE -->
    <div id="security-gate" class="fixed inset-0 z-[9999] flex flex-col items-center justify-center bg-black transition-opacity duration-500">
        <div class="absolute inset-0 z-0">
            <div class="absolute top-[-10%] left-[-10%] w-[70vw] h-[70vw] bg-blue-600/20 rounded-full blur-[100px] animate-blob"></div>
            <div class="absolute bottom-[-10%] right-[-10%] w-[70vw] h-[70vw] bg-purple-600/20 rounded-full blur-[100px] animate-blob animation-delay-2000"></div>
            <div class="absolute inset-0 bg-black/40 backdrop-blur-3xl"></div>
        </div>
        <div class="relative z-10 w-full max-w-sm px-6 flex flex-col items-center justify-center h-full sm:h-auto sm:py-12">
            <div class="mb-10 flex flex-col items-center animate-enter-up">
                <div class="w-20 h-20 rounded-[28px] bg-gradient-to-br from-[#1c1c1e] to-[#2c2c2e] border border-white/10 flex items-center justify-center shadow-2xl shadow-purple-900/20 mb-6 relative group">
                    <div class="absolute inset-0 rounded-[28px] bg-white/5 blur-lg opacity-50"></div>
                    <svg class="w-8 h-8 text-white/90 drop-shadow-lg" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l-1.586-1.586a2 2 0 00-2.828 0L6 18H4a2 2 0 01-2-2V6a2 2 0 012-2h16a2 2 0 012 2v8a2 2 0 01-2 2h-2m-4-4l-3 3m0 0l-3-3m3 3V4"></path></svg>
                </div>
                <h1 class="text-3xl md:text-4xl font-bold text-white tracking-wide text-center drop-shadow-lg">PH·ª§C H·ªíI ·∫¢NH</h1>
                <p class="text-sm text-gray-400 mt-2 font-medium tracking-wide text-center">AI Professional System</p>
            </div>
            <div class="w-full bg-[#1c1c1e]/80 backdrop-blur-xl border border-white/10 rounded-[24px] p-1.5 shadow-2xl mb-6 animate-enter-up" style="animation-delay: 0.1s;">
                <div class="bg-black/50 rounded-[20px] p-5 flex items-center justify-between border border-white/5">
                    <div class="flex flex-col">
                        <span class="text-[10px] text-gray-500 font-bold uppercase tracking-wider mb-1">THI·∫æT B·ªä (DEVICE ID)</span>
                        <div class="flex items-center gap-2">
                            <span id="gate-ip-display" class="font-mono text-sm font-bold text-white tracking-wider shimmer-text">Connecting...</span>
                            <div id="gate-loading-spinner" class="w-3 h-3 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>
                        </div>
                    </div>
                </div>
            </div>
            <button id="gate-submit" class="w-full py-4 bg-white text-black rounded-[20px] text-[15px] font-bold tracking-wide transition-all active:scale-95 shadow-lg shadow-white/10 disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-100 mb-8 animate-enter-up flex items-center justify-center gap-2" style="animation-delay: 0.2s;" disabled>
                <span>V√ÄO PH·ª§C H·ªíI ·∫¢NH</span>
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
            </button>
            <p id="gate-status" class="text-[11px] text-gray-500 font-medium animate-pulse">ƒêang x√°c th·ª±c b·∫£o m·∫≠t...</p>
        </div>
        <div class="absolute bottom-8 text-[10px] text-gray-600 font-mono tracking-widest opacity-50">SECURE CONNECTION ‚Ä¢ V36.60 (V41 UI UPGRADE)</div>
    </div>
    
    <!-- SYSTEM NOTIFICATION AREA -->
    <div id="toast-container" class="fixed top-6 right-6 z-[100] flex flex-col gap-2 pointer-events-none w-auto max-w-sm items-end"></div>
    
    <!-- HUD LOADING OVERLAY -->
    <div id="scan-window-overlay" class="fixed inset-0 z-[100] flex flex-col items-center justify-center hidden bg-black/40 backdrop-blur-sm transition-all duration-500">
        <div class="relative w-[80vw] max-w-[300px] bg-[#1c1c1e]/90 backdrop-blur-2xl border border-white/10 rounded-[32px] p-6 shadow-2xl shadow-blue-500/20 ring-1 ring-white/5 flex flex-col items-center animate-enter-up">
            <div class="relative w-20 h-20 mb-4 flex items-center justify-center">
                 <div class="loader-ring absolute inset-0"></div>
                 <div class="loader-ring-inner absolute inset-0 m-auto"></div>
                 <div class="w-2 h-2 bg-white rounded-full animate-pulse shadow-[0_0_15px_white]"></div>
            </div>
            <div class="flex flex-col items-center gap-1 mb-4">
                <span id="scan-title" class="text-xs font-bold text-[#0A84FF] tracking-[2px] uppercase animate-pulse">ƒêANG X·ª¨ L√ù...</span>
                <span class="text-[9px] text-gray-500 font-mono">AI NEURAL NETWORK V36</span>
            </div>
            <div class="w-full h-[1px] bg-gradient-to-r from-transparent via-white/10 to-transparent mb-3"></div>
            <div id="scan-tags-container" class="flex flex-wrap justify-center gap-1 max-h-[60px] overflow-hidden mask-linear-fade w-full"></div>
        </div>
    </div>

    <!-- ELEGANT SUCCESS OVERLAY (NEW) -->
    <div id="elegant-success-overlay" class="fixed inset-0 z-[9999] flex items-center justify-center pointer-events-none opacity-0 transition-opacity duration-700">
        <div class="absolute inset-0 bg-black/50 backdrop-blur-md"></div>
        <div id="elegant-success-box" class="relative bg-gradient-to-b from-[#2c2c2e] to-[#1c1c1e] border border-yellow-500/30 rounded-[32px] p-10 flex flex-col items-center shadow-[0_10px_50px_rgba(0,0,0,0.8)] transform scale-95 transition-transform duration-700">
            <div class="w-20 h-20 rounded-full bg-white/5 border border-white/10 flex items-center justify-center mb-5 shadow-inner relative">
                <div class="absolute inset-0 bg-yellow-500/20 rounded-full animate-ping opacity-50"></div>
                <svg class="w-10 h-10 text-yellow-400 relative z-10" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
            </div>
            <h2 class="text-[18px] font-bold text-white tracking-[0.2em] uppercase mb-2 drop-shadow-md">Ho√†n T·∫•t</h2>
            <p class="text-[12px] text-gray-400 font-medium tracking-widest uppercase">·∫¢nh ƒë√£ x·ª≠ l√Ω xong</p>
        </div>
    </div>

    <div class="flex w-full h-full relative z-10" id="fullscreen-target">
        
        <!-- SIDEBAR -->
        <aside id="sidebar" class="fixed inset-y-0 left-0 z-[60] w-full sm:w-[380px] flex-shrink-0 glass-panel flex flex-col transition-transform duration-300 ease-out lg:static lg:translate-x-0 -translate-x-full shadow-2xl lg:shadow-none bg-[#000]/90 lg:bg-transparent">
            
            <!-- Sidebar Header -->
            <div class="h-14 px-5 flex items-center justify-between border-b border-white/10 bg-white/[0.02]">
                <div class="flex flex-col justify-center">
                    <h1 class="text-[16px] font-bold tracking-wide text-white uppercase drop-shadow-sm">PH·ª§C H·ªíI ·∫¢NH</h1>
                    <div class="flex items-center gap-2 mt-0.5 opacity-80">
                        <span id="sidebar-ip-display" class="text-[9px] font-mono text-[#0A84FF] font-bold tracking-tight">IP: LOADING...</span>
                        <span class="text-[9px] text-gray-600">|</span>
                        <span id="sidebar-id-display" class="text-[9px] font-mono text-[#FFD60A] font-bold tracking-tight">ID: ...</span>
                    </div>
                </div>
                
                <div class="flex items-center gap-3">
                    <div class="flex flex-col items-end mr-1 px-3 py-1.5 rounded-[10px] bg-white/5 border border-white/10 cursor-pointer hover:bg-white/10 transition-all shadow-sm" id="credit-display">
                        <span class="text-[8px] text-gray-400 font-bold uppercase tracking-wider">L∆Ø·ª¢T T·∫†O</span>
                        <span class="text-[14px] font-mono font-bold text-[#FFD60A] drop-shadow-sm leading-none mt-0.5" id="credit-count">---</span>
                    </div>
                    <button id="close-sidebar-mobile" class="lg:hidden p-2 rounded-full bg-[#2c2c2e] text-white hover:bg-[#3c3c3e] transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto p-4 scroll-smooth space-y-4 pb-24 lg:pb-4 custom-scrollbar">
                <!-- 1. MAIN UPLOAD AREA -->
                <div class="relative group mb-1">
                    <input type="file" id="image-upload" accept="image/*" class="hidden">
                    <label id="drop-zone" for="image-upload" class="flex flex-col items-center justify-center w-full h-32 border border-dashed border-gray-500/50 rounded-[20px] cursor-pointer bg-black/20 hover:bg-black/40 hover:border-[#0A84FF]/60 transition-all duration-300 group shadow-inner">
                        <div id="upload-placeholder" class="flex flex-col items-center pointer-events-none group-hover:scale-105 transition-transform duration-300">
                            <div class="w-12 h-12 rounded-full bg-[#0A84FF]/15 flex items-center justify-center mb-3 shadow-[0_0_15px_rgba(10,132,255,0.15)] group-hover:bg-[#0A84FF]/25 transition-colors">
                                <svg class="w-5 h-5 text-[#0A84FF]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l-1.586-1.586a2 2 0 00-2.828 0L6 18H4a2 2 0 01-2-2V6a2 2 0 012-2h16a2 2 0 012 2v8a2 2 0 01-2 2h-2m-4-4l-3 3m0 0l-3-3m3 3V4"></path></svg>
                            </div>
                            <span class="text-xs font-semibold text-gray-300 uppercase tracking-widest drop-shadow-md">T·∫£i ·∫£nh g·ªëc (K√©o th·∫£/Click)</span>
                        </div>
                    </label>
                </div>

                <!-- 2. AUTO-PILOT BUTTON -->
                <button id="btn-auto-pilot" class="w-full py-3.5 rounded-[20px] flex items-center justify-center gap-2 transition-all active:scale-[0.96] mb-3 bg-[#2c2c2e]/80 hover:bg-[#3c3c3e] border border-[#FFD60A]/40 shadow-[0_4px_15px_rgba(255,214,10,0.15)] group">
                    <svg class="w-4 h-4 text-[#FFD60A] group-hover:rotate-180 transition-transform duration-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                    <span class="text-[13px] font-bold text-[#FFD60A] tracking-wider">AUTO SCAN V36.50</span>
                </button>

                <!-- MODULES (EXISTING V36 MODULES) -->
                <!-- FLUX KONTEXT (LZP) -->
                <div class="module-group" id="kontext-module-container">
                    <div class="p-4 border-b border-white/5 bg-[#2c2c2e]/40 backdrop-blur-md">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex flex-col">
                                <span class="text-[12.5px] font-bold text-white tracking-wide drop-shadow-sm">üöÄ ENGINE X·ª¨ L√ù</span>
                                <span class="text-[10px] text-gray-400 font-medium mt-0.5">Core: Qwen-VL, Kontext, SUPIR, InvSR</span>
                            </div>
                             <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="mode-flux" class="sr-only peer" checked>
                                <div class="w-11 h-6 bg-black/40 border border-white/10 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-[#0A84FF] shadow-inner"></div>
                            </label>
                        </div>
                        <div id="workflow-container">
                            <label class="block text-[10px] font-bold text-gray-400 mb-2 uppercase tracking-widest ml-1">QUY TR√åNH (WORKFLOW)</label>
                            <select id="kontext-workflow" class="pro-input w-full py-3 cursor-pointer text-white appearance-none font-semibold text-[11.5px]">
                                <option value="qwen_edit_pro" class="text-cyan-300 font-bold" selected>‚ö° Qwen Edit Pro (Khuy√™n d√πng)</option>
                                <option value="replica_pro" class="text-yellow-400 font-bold">üß¨ Si√™u th·ª±c (Replica Pro)</option>
                                <option value="qwen_lightning" class="text-teal-300 font-bold">‚ö° Qwen V2.5-VL (Si√™u nhanh)</option>
                                <option value="old_photo_v1">üìú Kontext V1.0 Native</option>
                                <option value="invsr_deblur" class="text-green-400 font-bold">üî™ InvSR Deblur (·∫¢nh m·ªù)</option>
                                <option value="ancient_restore" class="text-purple-400 font-bold">üèØ Ph·ª•c ch·∫ø Tranh/T∆∞·ª£ng C·ªï</option>
                                <option value="wedding_kontext_v2" class="text-pink-400 font-bold">üë∞ Wedding Kontext V2</option>
                                <option value="default">‚ú® M·∫∑c ƒë·ªãnh (Kontext Base)</option>
                                <option value="realvis_v5" class="text-orange-400 font-bold">ü¶Å RealVisXL V5</option>
                                <option value="qwen_restore_full" class="text-blue-400 font-bold">‚ö° Qwen V2.5 Full Restore</option>
                                <option value="wedding_pro">üíç Wedding Pro + Upscale</option>
                                <option value="outdoor_mode">üèûÔ∏è Ph·ª•c h·ªìi Ngo·∫°i C·∫£nh</option>
                                <option value="product_mode">üõçÔ∏è ·∫¢nh S·∫£n Ph·∫©m (Ecommerce)</option>
                                <option value="white_bg">‚¨ú T√°ch N·ªÅn Tr·∫Øng</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- REPLICA MODE -->
                <div class="module-group">
                    <div class="p-4 flex items-center justify-between">
                         <div class="flex flex-col">
                            <span class="text-[12.5px] font-bold text-white tracking-wide drop-shadow-sm">üíé SAO Y G·ªêC</span>
                            <span class="text-[10px] text-gray-400 font-medium mt-0.5">KH√ìA G√ìC M·∫∂T - CH·ªêNG L·∫¨T H√åNH</span>
                        </div>
                         <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="mode-replica" class="sr-only peer">
                            <div class="w-10 h-[22px] bg-black/40 border border-white/10 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-[16px] after:w-[16px] after:transition-all peer-checked:bg-[#0A84FF] shadow-inner"></div>
                        </label>
                    </div>
                </div>

                <!-- MODULE: QU√ÇN S·ª¨ VI·ªÜT NAM -->
                <div class="module-group" id="module-military">
                    <button id="toggle-military" class="module-header w-full">
                        <div class="flex items-center gap-2">
                            <span class="text-[12px] font-bold text-white tracking-wider uppercase drop-shadow-sm">QU√ÇN S·ª¨ (PRO)</span>
                        </div>
                        <svg class="w-4 h-4 text-gray-400 transition-transform" id="icon-military" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="content-military" class="module-content">
                        <div class="module-inner space-y-3">
                             <div class="space-y-1.5">
                                <label class="text-[10px] uppercase text-gray-400 font-bold tracking-wider ml-1 block">Qu√¢n ch·ªßng</label>
                                <select id="mil-branch" class="pro-input w-full"><option value="">-- T·ª± ƒë·ªông / Kh√¥ng ch·ªçn --</option><option value="vietnamese army ground force, red collar tabs">üü• L·ª•c qu√¢n</option><option value="vietnamese air force, blue collar tabs">üü¶ Ph√≤ng Kh√¥ng - Kh√¥ng Qu√¢n</option><option value="vietnamese navy, navy blue uniform, white striped collar">‚öì H·∫£i qu√¢n</option><option value="vietnamese border guard, green collar tabs">üü© B·ªô ƒë·ªôi Bi√™n ph√≤ng</option><option value="vietnamese public security, green uniform, red collar tabs">üëÆ C√¥ng an Nh√¢n d√¢n</option><option value="vietnamese youth volunteer force, dark green uniform">‚≠ê Thanh ni√™n Xung phong</option></select>
                             </div>
                             <div class="space-y-1.5">
                                <label class="text-[10px] uppercase text-gray-400 font-bold tracking-wider ml-1 block">Qu√¢n ph·ª•c</label>
                                <select id="mil-uniform" class="pro-input w-full"><option value="">-- T·ª± ƒë·ªông / M·∫∑c ƒë·ªãnh --</option><option value="wearing tran thu shirt, padded cotton jacket, viet minh era">√Åo Tr·∫•n Th·ªß (Ch·ªëng Ph√°p)</option><option value="wearing to chau uniform, plain green fatigue, vietnam war era">Qu√¢n ph·ª•c T√¥ Ch√¢u (Ch·ªëng M·ªπ)</option><option value="wearing K82 uniform, formal military tunic">Qu√¢n ph·ª•c K82</option><option value="wearing K94 uniform, modern formal suit">Qu√¢n ph·ª•c K94/K03</option><option value="wearing camouflage special force uniform">ƒê·∫∑c c√¥ng (R·∫±n ri)</option></select>
                             </div>
                             <div class="space-y-1.5">
                                <label class="text-[10px] uppercase text-gray-400 font-bold tracking-wider ml-1 block">M≈© n√≥n</label>
                                <select id="hat-select" class="pro-input w-full" data-key="hatSelect"><option value="">-- Kh√¥ng x·ª≠ l√Ω M≈© --</option><option value="wear vietnamese pith helmet, hard pith helmet, dark green color, rounded shape, red badge with yellow star">M≈© C·ªëi</option><option value="wear vietnamese soft cap, boonie hat, green fabric, red star badge">M≈© Tai B√®o</option><option value="wear vietnamese officer kepi hat, mixed red and green color, gold chin strap, red badge with gold star">M≈© Kepi (Sƒ© quan)</option><option value="wear vietnamese police kepi hat, green color, red band, gold badge">M≈© Kepi (C√¥ng an)</option><option value="wear vietnamese bamboo helmet, cloth covered">M≈© Nan (B·ªçc v·∫£i)</option></select>
                             </div>
                             <div class="space-y-1.5">
                                <label class="text-[10px] uppercase text-gray-400 font-bold tracking-wider ml-1 block">C·∫•p b·∫≠c</label>
                                <select id="rank-select" class="pro-input w-full" data-key="rankSelect"><option value="">-- T·ª± ƒë·ªông / Kh√¥ng ch·ªçn --</option><option value="no_rank_insignia">üö´ KH√îNG ƒêEO H√ÄM</option><optgroup label="H·∫° sƒ© quan / Chi·∫øn sƒ©"><option value="plain red collar tabs, soldier rank">Chi·∫øn sƒ© (Tr∆°n)</option><option value="red collar tabs with one yellow stripe">H·∫° sƒ© (1 g·∫°ch)</option><option value="red collar tabs with two yellow stripes">Trung sƒ© (2 g·∫°ch)</option><option value="red collar tabs with three yellow stripes">Th∆∞·ª£ng sƒ© (3 g·∫°ch)</option></optgroup><optgroup label="Sƒ© quan (Sao + G·∫°ch)"><option value="red collar tabs with one star, officer rank">Thi·∫øu √∫y (1 sao)</option><option value="red collar tabs with two stars, officer rank">Trung √∫y (2 sao)</option><option value="red collar tabs with three stars, officer rank">Th∆∞·ª£ng √∫y (3 sao)</option><option value="red collar tabs with four stars, officer rank">ƒê·∫°i √∫y (4 sao)</option></optgroup></select>
                             </div>
                             
                             <div class="space-y-2 mt-4 pt-3 border-t border-white/5">
                                 <label class="text-[10.5px] font-bold text-white uppercase tracking-widest block drop-shadow-sm">‚≠ê CHUY√äN S√ÇU</label>
                                 <div class="grid grid-cols-2 gap-3">
                                     <div class="flex items-center gap-2.5"><input id="check-metal-shader" type="checkbox" class="chk-pro save-input"><label for="check-metal-shader" class="text-[11.5px] font-medium text-gray-200 cursor-pointer">Kim lo·∫°i (Huy hi·ªáu)</label></div>
                                     <div class="flex items-center gap-2.5"><input id="check-fabric-detail" type="checkbox" class="chk-pro save-input"><label for="check-fabric-detail" class="text-[11.5px] font-medium text-gray-200 cursor-pointer">Ch·∫•t v·∫£i (T√¥ Ch√¢u)</label></div>
                                 </div>
                             </div>

                             <div class="grid grid-cols-2 gap-3 mt-3">
                                <div class="flex items-center gap-2.5"><input id="check-sao-vang" type="checkbox" class="chk-pro save-input"><label for="check-sao-vang" class="text-[11.5px] font-medium text-gray-200 cursor-pointer">HC Sao V√†ng</label></div>
                                <div class="flex items-center gap-2.5"><input id="check-khang-chien" type="checkbox" class="chk-pro save-input"><label for="check-khang-chien" class="text-[11.5px] font-medium text-gray-200 cursor-pointer">HC Kh√°ng Chi·∫øn</label></div>
                                <div class="flex items-center gap-2.5"><input id="check-chien-si" type="checkbox" class="chk-pro save-input"><label for="check-chien-si" class="text-[11.5px] font-medium text-gray-200 cursor-pointer">Chi·∫øn sƒ©</label></div>
                                <div class="flex items-center gap-2.5"><input id="check-doan" type="checkbox" class="chk-pro save-input"><label for="check-doan" class="text-[11.5px] font-bold text-gray-200 cursor-pointer">Huy hi·ªáu ƒêo√†n</label></div>
                             </div>
                             <div class="flex items-center gap-3 p-3 rounded-xl border border-white/10 bg-black/20 mt-3 transition-colors hover:bg-black/40">
                                <input id="check-insignia-boost" type="checkbox" class="chk-pro save-input">
                                <label for="check-insignia-boost" class="cursor-pointer select-none flex-1">
                                    <span class="block text-[11px] font-bold text-gray-200 drop-shadow-sm mb-0.5">N√âT QU√ÇN H√ÄM/LOGO</span>
                                </label>
                            </div>
                             <div class="flex items-center gap-3 p-3 rounded-xl border border-white/10 bg-black/20 mt-2 transition-colors hover:bg-black/40">
                                <input id="block-rank" type="checkbox" class="chk-pro chk-red save-input">
                                <label for="block-rank" class="cursor-pointer select-none flex-1">
                                    <span class="block text-[11px] font-bold text-gray-200 drop-shadow-sm mb-0.5">CH·∫∂N V·∫º QU√ÇN H√ÄM</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- MODULE: TEXTURE & LIGHTING -->
                <div class="module-group" id="module-cinematic">
                    <button id="toggle-cinematic" class="module-header w-full">
                        <div class="flex items-center gap-2">
                            <span class="text-[12px] font-bold text-white tracking-wider uppercase drop-shadow-sm">üéûÔ∏è M√ÄU PHIM & S√ÅNG</span>
                        </div>
                        <svg class="w-4 h-4 text-gray-400 transition-transform" id="icon-cinematic" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="content-cinematic" class="module-content">
                        <div class="module-inner space-y-4">
                             <div>
                                <div class="flex justify-between text-[11px] text-gray-400 font-bold mb-3 tracking-wide">
                                    <span>NHI·ªÑU H·∫†T</span>
                                    <span id="grain-val" class="text-white bg-black/30 px-2 py-0.5 rounded-md border border-white/5">3%</span>
                                </div>
                                <input type="range" id="grain-slider" min="0" max="100" value="3" class="w-full slider-red">
                             </div>
                             <select id="color-grading" class="pro-input w-full py-3">
                                 <option value="">-- M√†u g·ªëc (Standard) --</option>
                                 <optgroup label="üé® Colorization">
                                    <option value="colorize_bw_old_photo">üåà T√¥ m√†u ·∫£nh ƒëen tr·∫Øng</option>
                                    <option value="restore_faded_color">üçÇ Ph·ª•c h·ªìi m√†u phai</option>
                                 </optgroup>
                                 <optgroup label="‚ú® TAO ANH SANG Presets">
                                     <option value="golden_hour_blinds">üåÖ Golden Hour + Blinds</option>
                                     <option value="moonlight_window">üåô Moonlight Window</option>
                                     <option value="streetlight_cozy">üí° Streetlight Cozy</option>
                                     <option value="neon_cyberpunk">üåÉ Neon Vibrant</option>
                                     <option value="soft_diffused">‚òÅÔ∏è Soft Diffused</option>
                                     <option value="dappled_shade">üå≥ Dappled Shade</option>
                                 </optgroup>
                                 <optgroup label="üéûÔ∏è M√†u Phim">
                                     <option value="kodak portra 400 style, natural skin tone, fine grain" selected>Kodak Portra</option>
                                     <option value="fujifilm pro 400h style, cool tone, soft green tint">Fujifilm</option>
                                     <option value="sepia tone, antique photo style">Sepia</option>
                                 </optgroup>
                             </select>
                        </div>
                    </div>
                </div>

                <!-- MODULE: EXPOSURE & RELIGHTING -->
                <div class="module-group" id="module-exposure">
                    <button id="toggle-exposure" class="module-header w-full">
                         <div class="flex items-center gap-2">
                            <span class="text-[12px] font-bold text-white tracking-wider uppercase drop-shadow-sm">‚òÄÔ∏è X·ª¨ L√ù CH√ÅY S√ÅNG</span>
                        </div>
                        <svg class="w-4 h-4 text-gray-400 transition-transform" id="icon-exposure" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="content-exposure" class="module-content">
                        <div class="module-inner space-y-4">
                             <div class="flex items-center justify-between p-3 rounded-xl bg-black/20 border border-white/10 transition-colors hover:bg-black/40">
                                <div class="flex flex-col">
                                    <span class="text-[11.5px] font-bold text-white mb-0.5">B·∫¨T QWEN EDIT</span>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="check-qwen-exposure" class="sr-only peer save-input">
                                    <div class="w-10 h-[22px] bg-black/40 border border-white/10 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-[16px] after:w-[16px] after:transition-all peer-checked:bg-[#0A84FF] shadow-inner"></div>
                                </label>
                            </div>
                            <div class="space-y-3 pl-3 border-l-[1.5px] border-white/5 ml-1.5">
                                <div class="flex items-center gap-3">
                                    <input id="check-remove-shadow" type="checkbox" class="chk-pro save-input" checked>
                                    <label for="check-remove-shadow" class="text-[11.5px] font-medium text-gray-300 cursor-pointer">X√≥a b√≥ng g·∫Øt</label>
                                </div>
                                 <div class="flex items-center gap-3">
                                    <input id="check-soft-light" type="checkbox" class="chk-pro save-input" checked>
                                    <label for="check-soft-light" class="text-[11.5px] font-medium text-gray-300 cursor-pointer">√Ånh s√°ng m·ªÅm</label>
                                </div>
                            </div>
                            <div class="border border-white/5 rounded-xl bg-black/20 p-3 shadow-inner">
                                <div class="flex justify-between text-[11px] text-gray-300 font-bold mb-3 tracking-wide">
                                    <span>C∆Ø·ªúNG ƒê·ªò</span>
                                    <span id="exposure-val" class="text-white bg-black/30 px-2 py-0.5 rounded-md border border-white/5">1.0</span>
                                </div>
                                <input type="range" id="exposure-slider" min="0.1" max="2.0" step="0.1" value="1.0" class="w-full slider-cyan">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- MODULE 1: X·ª¨ L√ù H√åNH ·∫¢NH -->
                <div class="module-group" id="module-processing">
                    <button id="toggle-processing" class="module-header w-full">
                        <div class="flex items-center gap-2">
                            <span class="text-[12px] font-bold text-gray-100 tracking-wider uppercase drop-shadow-sm">üõ†Ô∏è X·ª¨ L√ù ·∫¢NH</span>
                        </div>
                        <svg class="w-4 h-4 text-gray-400 transition-transform" id="icon-processing" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="content-processing" class="module-content">
                        <div class="module-inner space-y-4">
                             <div class="p-4 bg-black/20 rounded-xl border border-white/5 transition-colors hover:bg-black/30">
                                <div class="flex justify-between text-[11px] text-white font-bold mb-3 tracking-wide">
                                    <span>B√ÅM G·ªêC</span>
                                    <span>S√ÅNG T·∫†O</span>
                                </div>
                                <input type="range" id="creativity-slider" min="0" max="100" value="45" class="w-full slider-flux">
                                <div class="text-[10px] text-center text-gray-300 mt-2 font-mono font-bold bg-black/20 py-1 rounded-md border border-white/5" id="creativity-val">M·ª©c 45% (LZP Balanced)</div>
                             </div>

                             <div class="grid grid-cols-2 gap-3">
                                 <div class="flex items-center gap-2.5 p-2.5 rounded-xl bg-black/20 border border-white/5 hover:bg-black/40 transition-colors"><input id="check-dehaze" type="checkbox" class="chk-pro save-input"><label for="check-dehaze" class="text-[11.5px] font-medium text-gray-200 cursor-pointer">Kh·ª≠ s∆∞∆°ng m√π</label></div>
                                 <div class="flex items-center gap-2.5 p-2.5 rounded-xl bg-black/20 border border-white/5 hover:bg-black/40 transition-colors"><input id="check-contrast-fix" type="checkbox" class="chk-pro save-input"><label for="check-contrast-fix" class="text-[11.5px] font-bold text-gray-200 cursor-pointer">Contrast</label></div>
                                 <div class="flex items-center gap-2.5 p-2.5 rounded-xl bg-black/20 border border-white/5 hover:bg-black/40 transition-colors"><input id="check-uniform-skin" type="checkbox" class="chk-pro save-input" checked><label for="check-uniform-skin" class="text-[11.5px] font-medium text-gray-200 cursor-pointer">ƒê·ªÅu m√†u da</label></div>
                                 <div class="flex items-center gap-2.5 p-2.5 rounded-xl bg-black/20 border border-white/5 hover:bg-black/40 transition-colors"><input id="check-vibrant" type="checkbox" class="chk-pro save-input" checked><label for="check-vibrant" class="text-[11.5px] font-bold text-gray-200 cursor-pointer">LZP COLOR</label></div>
                             </div>
                             
                             <div class="space-y-1.5 mt-2">
                                <label class="text-[10px] uppercase text-gray-400 font-bold tracking-wider ml-1 block">Upscale (Ph√≥ng to)</label>
                                <select id="upscale-mode" class="pro-input w-full py-3 cursor-pointer">
                                    <option value="supir_tiled" selected>üåü Tiled 4K (N√©t nh·∫•t)</option>
                                    <option value="invsr_sharp" class="text-green-400 font-bold">üî™ InvSR (Ch·ªëng Rung/M·ªù)</option>
                                    <option value="pixel_perfect" class="text-yellow-400">üíé Pixel Perfect</option>
                                    <option value="ultrasharp">‚ö° 4x-UltraSharp</option>
                                    <option value="realesrgan">üíç RealESRGAN</option>
                                    <option value="none">üö´ Kh√¥ng Upscale</option>
                                </select>
                             </div>

                             <div class="space-y-3 pt-3 border-t border-white/5">
                                 <div class="flex items-center justify-between">
                                    <span class="text-[12px] font-medium text-gray-200">N√©t m·∫∑t</span>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="check-face" data-key="checkFace" class="sr-only peer save-input" checked>
                                        <div class="w-10 h-[22px] bg-black/40 border border-white/10 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-[16px] after:w-[16px] after:transition-all peer-checked:bg-[#0A84FF] shadow-inner"></div>
                                    </label>
                                 </div>
                                 <div class="flex items-center justify-between p-3 rounded-xl bg-black/20 border border-white/10 transition-colors hover:bg-black/30">
                                    <div class="flex flex-col">
                                        <span class="text-[11.5px] font-bold text-white mb-0.5">N√©t n·ªÅn/hoa l√°</span>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="check-background" class="sr-only peer save-input" checked>
                                        <div class="w-10 h-[22px] bg-black/40 border border-white/10 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-[16px] after:w-[16px] after:transition-all peer-checked:bg-[#0A84FF] shadow-inner"></div>
                                    </label>
                                 </div>
                                 <div class="flex items-center justify-between">
                                    <span class="text-[12px] font-medium text-gray-200">V·∫Ω l·∫°i t√≥c</span>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="check-hair" data-key="checkHair" class="sr-only peer save-input" checked>
                                        <div class="w-10 h-[22px] bg-black/40 border border-white/10 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-[16px] after:w-[16px] after:transition-all peer-checked:bg-[#0A84FF] shadow-inner"></div>
                                    </label>
                                 </div>
                                 <div class="flex items-center justify-between">
                                    <span class="text-[12px] font-medium text-gray-200">TƒÉng chi ti·∫øt v·∫£i/da</span>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="check-texture-boost" class="sr-only peer save-input" checked>
                                        <div class="w-10 h-[22px] bg-black/40 border border-white/10 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-[16px] after:w-[16px] after:transition-all peer-checked:bg-[#0A84FF] shadow-inner"></div>
                                    </label>
                                 </div>
                             </div>

                             <div class="mt-4 pt-3 border-t border-white/5 space-y-3">
                                <label class="text-[10.5px] font-bold text-white uppercase tracking-widest mb-1.5 block drop-shadow-sm">üöÄ N√ÇNG CAO (PRO)</label>
                                <div class="flex items-center gap-3 p-3 rounded-xl bg-black/20 border border-white/10 transition-colors hover:bg-black/30">
                                    <input id="check-group-mode" type="checkbox" class="chk-pro save-input">
                                    <label for="check-group-mode" class="flex-1 cursor-pointer select-none">
                                        <span class="block text-[11px] font-bold text-gray-200 drop-shadow-sm mb-0.5">·∫¢NH ƒê√ÅM ƒê√îNG</span>
                                    </label>
                                </div>
                                <div class="flex items-center gap-3 p-3 rounded-xl bg-black/20 border border-white/10 transition-colors hover:bg-black/30" id="container-blur-prepass">
                                    <input id="check-blur-prepass" type="checkbox" class="chk-pro save-input">
                                    <label for="check-blur-prepass" class="flex-1 cursor-pointer select-none">
                                        <span class="block text-[11px] font-bold text-gray-200 drop-shadow-sm mb-0.5">KH·ª¨ NHI·ªÑU S√ÇU</span>
                                    </label>
                                </div>
                                <div class="flex items-center gap-3 p-3 rounded-xl bg-black/20 border border-white/10 transition-colors hover:bg-black/30">
                                    <input id="check-extreme-mode" type="checkbox" class="chk-pro chk-red save-input">
                                    <label for="check-extreme-mode" class="flex-1 cursor-pointer select-none">
                                        <span class="block text-[11px] font-bold text-gray-200 drop-shadow-sm mb-0.5">‚ö° C∆Ø·ª†NG √âP PH·ª§C H·ªíI</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- MODULE 2: ƒê·ªêI T∆Ø·ª¢NG -->
                <div class="module-group" id="module-subject">
                    <button id="toggle-subject" class="module-header w-full">
                         <div class="flex items-center gap-2">
                            <span class="text-[12px] font-bold text-gray-100 tracking-wider uppercase drop-shadow-sm">üëî ƒê·ªêI T∆Ø·ª¢NG</span>
                        </div>
                        <svg class="w-4 h-4 text-gray-400 transition-transform" id="icon-subject" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="content-subject" class="module-content">
                        <div class="module-inner">
                            <div class="grid grid-cols-3 gap-2.5 mb-4">
                                 <select id="gender-select" class="pro-input py-3" data-key="gender"><option value="">Gi·ªõi t√≠nh</option><option value="male">Nam</option><option value="female">N·ªØ</option><option value="male and female">Nam & N·ªØ</option></select>
                                 <input type="number" id="age-input" placeholder="Tu·ªïi" class="pro-input py-3 text-center" data-key="age">
                                 <select id="damage-level" class="pro-input py-3" data-key="damageLevel"><option value="">ƒê·ªô h·ªèng</option><option value="fix slightly blurry" selected>Nh·∫π</option><option value="fix scratches, mold">V·ª´a</option><option value="fix torn, missing details">N·∫∑ng</option></select>
                            </div>
                            <div class="space-y-1.5 mb-4">
                                <label class="text-[10px] uppercase text-gray-400 font-bold tracking-wider ml-1 block">Da / Texture</label>
                                <select id="texture-mode" class="pro-input w-full py-3" data-key="textureMode">
                                    <option value="true skin, natural pores, film grain, realistic skin:1.2, natural beauty:1.2" selected>üß¨ TRUE SKIN (DA TH·∫¨T)</option>
                                    <option value="Canon EOS 5D Mark IV, 85mm lens, shallow depth of field, perfect lighting, raw photo, realistic skin texture">üì∏ Canon 5D + 85mm (Studio)</option>
                                    <option value="smooth skin, ai beauty">M·ªãn m√†ng (AI Beauty)</option>
                                    <option value="high detail, film grain">Chi ti·∫øt cao</option>
                                </select>
                            </div>
                            <div class="space-y-3.5">
                                <div class="flex items-center justify-between p-3 rounded-xl bg-black/20 border border-white/10 transition-colors hover:bg-black/30">
                                    <div class="flex flex-col">
                                        <span class="text-[11.5px] font-bold text-white mb-0.5">·∫¢NH TH·∫∫</span>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="check-id-photo" class="sr-only peer save-input">
                                        <div class="w-10 h-[22px] bg-black/40 border border-white/10 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-[16px] after:w-[16px] after:transition-all peer-checked:bg-[#0A84FF] shadow-inner"></div>
                                    </label>
                                </div>
                                <div class="flex items-center justify-between p-3 rounded-xl bg-black/20 border border-white/10 transition-colors hover:bg-black/30">
                                    <div class="flex flex-col">
                                        <span class="text-[11.5px] font-bold text-white mb-0.5">·∫¢NH TH·ªú</span>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="check-altar-mode" class="sr-only peer save-input">
                                        <div class="w-10 h-[22px] bg-black/40 border border-white/10 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-[16px] after:w-[16px] after:transition-all peer-checked:bg-[#0A84FF] shadow-inner"></div>
                                    </label>
                                </div>
                                <div class="space-y-1.5 pt-1">
                                    <label class="text-[10px] uppercase text-gray-400 font-bold tracking-wider ml-1 block">Ng·ªØ c·∫£nh n·ªÅn</label>
                                    <select id="event-context" class="pro-input w-full py-3 cursor-pointer" data-key="eventContext">
                                        <option value="">-- (AUTO) T·ª± ƒë·ªông --</option>
                                        <option value="original_enhanced" class="text-violet-400 font-bold">üõ°Ô∏è N·ªÅn G·ªëc (MAX CHI TI·∫æT)</option>
                                        <optgroup label="Thay N·ªÅn M√†u">
                                            <option value="blue_bg">üü¶ N·ªÅn Xanh</option>
                                            <option value="white_bg">‚¨ú N·ªÅn Tr·∫Øng</option>
                                        </optgroup>
                                        <optgroup label="Flux Style">
                                            <option value="outdoor_garden">üåø S√¢n V∆∞·ªùn</option>
                                            <option value="luxury_interior">üï∞Ô∏è N·ªôi Th·∫•t Sang Tr·ªçng</option>
                                        </optgroup>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- MODULE 3: KH√ìA N√âT (IDENTITY) -->
                <div class="module-group" id="module-identity">
                    <button id="toggle-identity" class="module-header w-full">
                         <div class="flex items-center gap-2">
                            <span class="text-[12px] font-bold text-gray-100 tracking-wider uppercase drop-shadow-sm">üß¨ KH√ìA N√âT</span>
                        </div>
                        <svg class="w-4 h-4 text-gray-400 transition-transform" id="icon-identity" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="content-identity" class="module-content">
                        <div class="module-inner">
                            <div class="mb-4 border border-white/5 rounded-xl p-3 bg-black/20 shadow-inner">
                                <div class="flex justify-between text-[11px] text-gray-400 font-bold mb-3 tracking-wide">
                                    <span>M·ª®C KH√ìA</span>
                                    <span id="identity-weight-val" class="text-white bg-black/30 px-2 py-0.5 rounded-md border border-white/5">300%</span>
                                </div>
                                <input type="range" id="identity-weight-slider" min="100" max="400" step="10" value="300" class="w-full slider-red save-input" data-key="identityWeight">
                            </div>
                            <div class="flex items-center justify-between p-3 mb-3 bg-black/20 border border-white/10 rounded-xl transition-colors hover:bg-black/40">
                                <div class="flex flex-col">
                                    <span class="text-[11.5px] font-bold text-white mb-0.5">üö´ CH·ªêNG L·∫¨T M·∫∂T</span>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="check-anti-flip" class="sr-only peer save-input" checked>
                                    <div class="w-10 h-[22px] bg-black/40 border border-white/10 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-[16px] after:w-[16px] after:transition-all peer-checked:bg-[#0A84FF] shadow-inner"></div>
                                </label>
                            </div>
                            <div class="flex items-center justify-between p-3 mb-3 bg-black/20 rounded-xl border border-white/5 transition-colors hover:bg-black/40">
                                <div class="flex flex-col">
                                    <span class="text-[11.5px] font-bold text-gray-200 mb-0.5">N√âT CH√ÇU √Å</span>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="check-asian-identity" data-key="checkAsianIdentity" class="sr-only peer save-input" checked>
                                    <div class="w-10 h-[22px] bg-black/40 border border-white/10 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-[16px] after:w-[16px] after:transition-all peer-checked:bg-[#0A84FF] shadow-inner"></div>
                                </label>
                            </div>
                            <div class="flex items-center gap-3 p-3 rounded-xl border border-white/10 bg-black/20 mb-3 transition-colors hover:bg-black/40">
                                <input id="check-dual-controlnet" type="checkbox" class="chk-pro save-input">
                                <label for="check-dual-controlnet" class="flex-1 cursor-pointer select-none">
                                    <span class="block text-[11px] font-bold text-gray-200 drop-shadow-sm mb-0.5">KH√ìA C·∫§U TR√öC K√âP</span>
                                </label>
                            </div>
                            <div class="grid grid-cols-2 gap-3 border-t border-white/5 pt-3 mb-3">
                                <div class="flex items-center gap-2.5"><input id="lock-eyes" type="checkbox" class="chk-pro save-input" data-key="lockEyes" checked><label for="lock-eyes" class="text-[11px] font-medium text-gray-200 cursor-pointer">Kh√≥a M·∫Øt</label></div>
                                <div class="flex items-center gap-2.5"><input id="lock-mouth" type="checkbox" class="chk-pro save-input" data-key="lockMouth" checked><label for="lock-mouth" class="text-[11px] font-medium text-gray-200 cursor-pointer">Kh√≥a Mi·ªáng</label></div>
                                <div class="flex items-center gap-2.5"><input id="lock-skin" type="checkbox" class="chk-pro save-input" data-key="lockSkin"><label for="lock-skin" class="text-[11px] font-medium text-gray-200 cursor-pointer">N·ªët ru·ªìi/Ch√†m</label></div>
                                <div class="flex items-center gap-2.5" id="container-imperfection"><input id="lock-imperfection" type="checkbox" class="chk-pro chk-gold save-input" data-key="lockImperfection"><label for="lock-imperfection" class="text-[11px] text-yellow-500 font-bold drop-shadow-sm cursor-pointer">Khuy·∫øt ƒêi·ªÉm</label></div>
                            </div>
                            
                            <div class="mt-3 border-t border-white/10 pt-3">
                                <label class="text-[10.5px] uppercase text-white font-bold tracking-widest mb-2.5 block drop-shadow-sm">üõ°Ô∏è B·∫¢O T·ªíN ƒê·∫∂C ƒêI·ªÇM</label>
                                <div class="grid grid-cols-2 gap-3">
                                    <div class="flex items-center gap-2.5"><input id="check-cross-eyed" type="checkbox" class="chk-pro save-input"><label for="check-cross-eyed" class="text-[11.5px] font-medium text-gray-200 cursor-pointer">M·∫Øt L√©</label></div>
                                    <div class="flex items-center gap-2.5"><input id="check-ptosis" type="checkbox" class="chk-pro save-input"><label for="check-ptosis" class="text-[11.5px] font-medium text-gray-200 cursor-pointer">M·∫Øt S·ª•p M√≠</label></div>
                                    <div class="flex items-center gap-2.5"><input id="check-closed-eyes" type="checkbox" class="chk-pro save-input"><label for="check-closed-eyes" class="text-[11.5px] font-medium text-gray-200 cursor-pointer">M·∫Øt Nh·∫Øm</label></div>
                                    <div class="flex items-center gap-2.5"><input id="check-monolid" type="checkbox" class="chk-pro save-input"><label for="check-monolid" class="text-[11.5px] font-medium text-gray-200 cursor-pointer">M·∫Øt M·ªôt M√≠</label></div>
                                    <div class="flex items-center gap-2.5"><input id="check-buck-teeth" type="checkbox" class="chk-pro save-input"><label for="check-buck-teeth" class="text-[11.5px] font-medium text-gray-200 cursor-pointer">RƒÉng H√¥</label></div>
                                    <div class="flex items-center gap-2.5"><input id="check-black-teeth" type="checkbox" class="chk-pro save-input"><label for="check-black-teeth" class="text-[11.5px] font-medium text-gray-200 cursor-pointer">RƒÉng ƒêen</label></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- MODULE 4: PROMPT -->
                <div class="module-group" id="module-prompt">
                    <button id="toggle-prompt" class="module-header w-full">
                         <div class="flex items-center gap-2">
                            <span class="text-[12px] font-bold text-gray-100 tracking-wider uppercase drop-shadow-sm">üìù PROMPT</span>
                        </div>
                        <svg class="w-4 h-4 text-gray-400 transition-transform" id="icon-prompt" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="content-prompt" class="module-content">
                        <div class="module-inner">
                            <textarea id="prompt-main" rows="3" class="pro-input w-full p-3.5 resize-none text-[11.5px] font-mono save-input mb-3 shadow-inner" data-key="promptMainValue" placeholder="H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông t·ªëi ∆∞u..."></textarea>
                            <input type="text" id="prompt-negative" placeholder="Lo·∫°i tr·ª´..." class="pro-input w-full py-3 save-input mb-1 shadow-inner" data-key="promptNegative">
                        </div>
                    </div>
                </div>

                <!-- MODULE 5: B·∫¢N QUY·ªÄN (LOGO) -->
                <div class="module-group" id="module-logo">
                    <button id="toggle-logo" class="module-header w-full">
                         <div class="flex items-center gap-2">
                            <span class="text-[12px] font-bold text-gray-100 tracking-wider uppercase drop-shadow-sm">¬©Ô∏è CH√àN LOGO</span>
                        </div>
                        <svg class="w-4 h-4 text-gray-400 transition-transform" id="icon-logo" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="content-logo" class="module-content">
                        <div class="module-inner">
                            <div class="flex items-center justify-between mb-4">
                                <div class="flex flex-col">
                                    <span class="text-[11.5px] font-bold text-gray-200 mb-0.5">B·∫≠t ƒë√≥ng d·∫•u Logo</span>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="check-logo" class="sr-only peer save-input">
                                    <div class="w-10 h-[22px] bg-black/40 border border-white/10 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-[16px] after:w-[16px] after:transition-all peer-checked:bg-[#0A84FF] shadow-inner"></div>
                                </label>
                            </div>
                            <input type="text" id="custom-logo-text" class="pro-input w-full py-3 bg-black/30 text-center font-bold text-yellow-400 placeholder-gray-600 shadow-inner mb-1 tracking-wider" placeholder="Nh·∫≠p t√™n ho·∫∑c SƒêT c·ªßa b·∫°n...">
                        </div>
                    </div>
                </div>

                <!-- MODULE: L·ªäCH S·ª¨ -->
                <div class="module-group" id="module-history">
                    <button id="toggle-history" class="module-header w-full">
                         <div class="flex items-center gap-2">
                            <span class="text-[12px] font-bold text-gray-400 tracking-wider uppercase drop-shadow-sm">üïí L·ªäCH S·ª¨</span>
                        </div>
                        <svg class="w-4 h-4 text-gray-400 transition-transform" id="icon-history" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="content-history" class="module-content">
                        <div class="module-inner">
                            <div id="history-container" class="flex gap-2.5 overflow-x-auto pb-3 custom-scrollbar min-h-[50px] pt-1">
                                <div class="text-[10px] text-gray-500 font-medium w-full text-center py-2">Ch∆∞a c√≥ ·∫£nh n√†o...</div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- Footer Actions -->
            <div class="p-4 bg-[rgba(20,20,22,0.85)] backdrop-blur-2xl border-t border-white/10 z-20 space-y-3">
                <!-- N√öT T·∫†O ·∫¢NH ƒê∆Ø·ª¢C L√ÄM L·∫†I SANG TR·ªåNG (DARK PREMIUM GLOW) -->
                <button id="process-image" class="w-full py-4 bg-[#1c1c1e] hover:bg-[#2c2c2e] text-white text-[13px] flex justify-center items-center gap-2 disabled:opacity-70 disabled:cursor-not-allowed border border-white/20 rounded-[20px] shadow-[0_4px_20px_rgba(0,0,0,0.5)] transition-all active:scale-[0.98] relative overflow-hidden group">
                    <svg class="w-5 h-5 text-gray-300 group-hover:text-yellow-400 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                    <span class="tracking-widest font-bold group-hover:text-yellow-400 transition-colors">T·∫†O ·∫¢NH NGAY</span>
                </button>
                <button id="reset-button" class="w-full py-3 btn-iso-glass text-[11.5px] tracking-wider text-gray-300 hover:text-white flex justify-center items-center gap-1.5">
                    L√ÄM M·ªöI T·∫§T C·∫¢
                </button>
            </div>
        </aside>

        <!-- WORKSPACE -->
        <main class="flex-1 flex flex-col relative overflow-hidden bg-black" id="main-workspace">
            <!-- MOBILE HEADER (Glass) -->
            <div class="lg:hidden h-14 glass-panel border-b border-white/5 flex items-center px-4 justify-between z-30 relative w-full">
                <button id="toggle-sidebar-btn" class="text-gray-400 p-2 rounded-lg active:bg-white/10"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg></button>
                <div class="flex flex-col items-center">
                     <span class="font-bold text-white text-[15px] tracking-wide drop-shadow-md">PH·ª§C H·ªíI ·∫¢NH</span>
                     <div class="flex items-center gap-2 opacity-60">
                        <span class="text-[9px] font-mono">V36.60 PRO</span>
                        <span class="text-[9px]">‚Ä¢</span>
                        <span id="mobile-status-text" class="text-[9px] font-mono tracking-widest">WAITING</span>
                     </div>
                </div>
                <div class="flex items-center justify-center h-8 px-3 rounded-full bg-white/10 border border-white/10 text-[#FFD60A] font-bold font-mono text-xs cursor-pointer active:scale-95 transition-transform" id="mobile-credit-display">
                    <span id="mobile-credit-count">-- ·∫¢NH</span>
                </div>
            </div>
            
            <div class="flex-1 relative flex flex-col items-center justify-center overflow-hidden pb-32 lg:pb-0">
                <div id="canvas-scale-container" class="relative transition-transform duration-500 ease-[cubic-bezier(0.19,1,0.22,1)] origin-center will-change-transform" style="transform: scale(1);">
                    <div id="scan-beam" class="absolute top-0 left-0 w-full h-[5px] bg-gradient-to-b from-[#0A84FF] to-transparent shadow-[0_0_40px_#0A84FF] opacity-0 z-50 pointer-events-none transition-opacity duration-300"></div>
                    <style>.active#scan-beam { opacity: 1; animation: scan-fast 1.5s linear infinite; }</style>

                    <div id="magic-dust" class="absolute inset-0 z-40 pointer-events-none hidden">
                         <div class="absolute inset-0 bg-blue-500/10 mix-blend-screen animate-pulse"></div>
                    </div>

                    <div id="comparison-view" class="relative max-w-[95vw] max-h-[80vh] flex justify-center items-center" style="display:none;">
                         <div id="comp-inner" class="relative shadow-2xl rounded-2xl overflow-hidden cursor-ew-resize group select-none mobile-image-frame">
                              <img id="img-original" class="block max-h-[75vh] w-auto pointer-events-none select-none">
                              <div id="img-modified-wrapper" class="absolute top-0 left-0 h-full w-[50%] overflow-hidden border-r border-white/50 bg-black/5">
                                  <img id="img-modified" class="absolute top-0 left-0 max-h-[75vh] w-auto pointer-events-none select-none" style="max-width: none;">
                              </div>
                              
                              <div class="comp-label before">TR∆Ø·ªöC</div>
                              <div class="comp-label after">SAU</div>

                              <div id="slider-handle" class="absolute top-0 bottom-0 left-[50%] w-0.5 bg-white/80 z-20 pointer-events-none shadow-[0_0_10px_rgba(0,0,0,0.5)]">
                                  <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-8 h-8 bg-white/20 backdrop-blur-md border border-white rounded-full flex items-center justify-center shadow-lg">
                                      <svg class="w-4 h-4 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" /></svg>
                                  </div>
                              </div>
                         </div>
                         
                         <div id="scan-log-overlay" class="absolute bottom-4 left-4 z-30 flex flex-col items-start pointer-events-none max-w-[200px] overflow-hidden">
                             <!-- Log lines will appear here dynamically -->
                         </div>
                    </div>

                    <div class="w-full flex justify-center mt-6">
                        <button id="desktop-btn-download" class="hidden bg-[#1c1c1e] backdrop-blur-xl hover:bg-[#2c2c2e] text-white px-8 py-3.5 rounded-[22px] font-bold border border-white/20 z-50 items-center gap-2 transition-transform active:scale-95 shadow-[0_4px_15px_rgba(0,0,0,0.5)]">
                            <svg class="w-5 h-5 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                            <span class="tracking-widest">L∆ØU ·∫¢NH V·ªÄ M√ÅY</span>
                        </button>
                    </div>

                    <canvas id="canvas-process" class="hidden"></canvas>
                    
                    <div id="placeholder-state" class="text-center p-12 md:p-24 border border-dashed border-gray-700/50 rounded-[40px] bg-gradient-to-br from-white/[0.03] to-white/[0.01] hover:bg-white/[0.05] transition-all duration-500 backdrop-blur-md cursor-pointer group drop-zone-pulse">
                        <div class="w-28 h-28 relative mx-auto mb-6 group-hover:scale-110 transition-transform duration-500">
                             <div class="absolute inset-0 bg-blue-500/20 rounded-full blur-xl animate-pulse"></div>
                             <div class="relative w-full h-full bg-[#1c1c1e] rounded-full flex items-center justify-center border border-white/10 shadow-2xl">
                                <svg class="w-12 h-12 text-[#0A84FF] animate-bounce" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l-1.586-1.586a2 2 0 00-2.828 0L6 18H4a2 2 0 01-2-2V6a2 2 0 012-2h16a2 2 0 012 2v8a2 2 0 01-2 2h-2m-4-4l-3 3m0 0l-3-3m3 3V4"></path></svg>
                             </div>
                        </div>
                        <h3 class="text-2xl font-bold text-white tracking-tight mb-2">Ch·∫°m ƒë·ªÉ t·∫£i ·∫£nh</h3>
                        <p class="text-xs text-gray-400 font-medium tracking-wide uppercase">AI Restoration V36.60</p>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- MOBILE GLASS DOCK -->
    <div id="mobile-action-bar" class="lg:hidden fixed bottom-6 left-4 right-4 z-[90] flex items-center justify-center pointer-events-none transition-all duration-500 translate-y-32 opacity-0">
        <div class="bg-[#1c1c1e]/90 backdrop-blur-xl border border-white/10 p-2 rounded-[24px] shadow-2xl flex gap-3 w-full max-w-sm pointer-events-auto ring-1 ring-white/5">
            <button id="mob-btn-upload" class="flex-1 py-4 bg-[#2c2c2e]/80 backdrop-blur-xl rounded-[22px] text-white font-bold text-[10px] flex flex-col items-center justify-center gap-1 active:scale-95 transition-all border border-white/10 shadow-[inset_0_1px_2px_rgba(255,255,255,0.15)]">
                <svg class="w-6 h-6 text-[#0A84FF]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4 4m0 0L8 8m4-4v12"></path></svg>
                <span>T·∫¢I ·∫¢NH</span>
            </button>
            <button id="mob-btn-scan" class="hidden flex-1 py-4 bg-[#0A84FF]/90 backdrop-blur-xl rounded-[22px] text-white font-bold text-[10px] flex flex-col items-center justify-center gap-1 shadow-[0_8px_20px_-4px_rgba(10,132,255,0.5),inset_0_1.5px_2px_rgba(255,255,255,0.4)] active:scale-95 transition-all border border-white/20">
                <svg class="w-6 h-6 animate-pulse drop-shadow-md" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                <span class="drop-shadow-md">SCAN</span>
            </button>
            <!-- L√ÄM L·∫†I N√öT CH·∫†Y TR√äN MOBILE G·ªåN G√ÄNG, SANG TR·ªåNG -->
            <button id="mob-btn-run" class="hidden flex-1 py-4 bg-[#1c1c1e] backdrop-blur-xl rounded-[22px] text-white font-bold text-[10px] flex flex-col items-center justify-center gap-1 shadow-[0_4px_15px_rgba(0,0,0,0.5)] active:scale-95 transition-all border border-white/20 tracking-wider">
                 <svg class="w-5 h-5 text-gray-300 drop-shadow-md" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                <span>T·∫†O NGAY</span>
            </button>
            
            <button id="mob-btn-download" class="hidden flex-1 py-4 bg-[#1c1c1e] backdrop-blur-xl rounded-[22px] text-white font-bold text-[10px] flex flex-col items-center justify-center gap-1 shadow-[0_4px_15px_rgba(0,0,0,0.5)] active:scale-95 transition-all border border-white/20">
                <svg class="w-5 h-5 text-gray-300 drop-shadow-md" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                <span class="tracking-widest">L∆ØU ·∫¢NH</span>
            </button>

            <button id="mob-btn-reset" class="w-16 flex flex-col items-center justify-center bg-white/5 backdrop-blur-xl text-gray-400 rounded-[22px] active:scale-95 transition-all border border-white/10 shadow-[inset_0_1px_1px_rgba(255,255,255,0.05)]">
                <svg class="w-6 h-6 mb-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
            </button>
        </div>
    </div>

    <!-- RECHARGE MODAL -->
    <div id="recharge-modal" class="fixed inset-0 z-[110] bg-black/80 backdrop-blur-2xl hidden flex items-center justify-center modal-fade-in p-4 overflow-y-auto">
        <div class="w-full max-w-[400px] bg-[#1c1c1e] border border-white/10 rounded-[32px] shadow-2xl flex flex-col relative overflow-hidden">
            <button id="close-recharge" class="absolute top-4 right-4 z-50 p-2 bg-[#2c2c2e]/80 backdrop-blur-md rounded-full text-gray-400 hover:text-white transition-all hover:scale-110 active:scale-95">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            
            <div class="p-6 pb-2">
                <span class="text-[10px] font-bold text-[#0A84FF] uppercase tracking-widest mb-1 block">STORE</span>
                <h3 class="text-2xl font-bold text-white tracking-tight">N·∫°p th√™m l∆∞·ª£t ch·∫°y</h3>
                <p class="text-[12px] text-gray-400 mt-1">1 L∆∞·ª£t t·∫°o = 1 L·∫ßn x·ª≠ l√Ω ·∫£nh ch·∫•t l∆∞·ª£ng cao.</p>
            </div>

            <div class="px-6 grid grid-cols-2 sm:grid-cols-3 gap-2 max-h-[40vh] overflow-y-auto custom-scrollbar">
                
                <div class="recharge-pkg-card group relative p-3 rounded-[16px] bg-[#2c2c2e] border border-white/5 hover:bg-[#3a3a3c] cursor-pointer transition-all active:scale-[0.98] flex flex-col items-center text-center justify-center h-24" data-amount="50000" data-credits="4">
                    <span class="block text-sm font-bold text-white">50k</span>
                    <span class="text-[9px] text-gray-500 uppercase font-bold mb-1">G√ìI NH·ªé</span>
                    <div class="bg-white/10 px-2 py-0.5 rounded-full">
                        <span class="text-[10px] font-bold text-[#FFD60A]">4 ·∫¢NH</span>
                    </div>
                    <div class="absolute inset-0 border border-[#FF453A] rounded-[16px] opacity-0 pkg-border transition-opacity"></div>
                </div>

                <div class="recharge-pkg-card group relative p-3 rounded-[16px] bg-[#2c2c2e] border border-white/5 hover:bg-[#3a3a3c] cursor-pointer transition-all active:scale-[0.98] flex flex-col items-center text-center justify-center h-24" data-amount="80000" data-credits="7">
                    <span class="block text-sm font-bold text-white">80k</span>
                    <span class="text-[9px] text-gray-500 uppercase font-bold mb-1">TI·∫æT KI·ªÜM</span>
                    <div class="bg-white/10 px-2 py-0.5 rounded-full">
                        <span class="text-[10px] font-bold text-[#FFD60A]">7 ·∫¢NH</span>
                    </div>
                    <div class="absolute inset-0 border border-[#FF453A] rounded-[16px] opacity-0 pkg-border transition-opacity"></div>
                </div>

                <div class="recharge-pkg-card group relative p-3 rounded-[16px] bg-[#2c2c2e] border border-white/5 hover:bg-[#3a3a3c] cursor-pointer transition-all active:scale-[0.98] flex flex-col items-center text-center justify-center h-24" data-amount="100000" data-credits="9">
                    <span class="block text-sm font-bold text-white">100k</span>
                    <span class="text-[9px] text-gray-500 uppercase font-bold mb-1">TI√äU CHU·∫®N</span>
                    <div class="bg-white/10 px-2 py-0.5 rounded-full">
                        <span class="text-[10px] font-bold text-[#FFD60A]">9 ·∫¢NH</span>
                    </div>
                    <div class="absolute inset-0 border border-[#FF453A] rounded-[16px] opacity-0 pkg-border transition-opacity"></div>
                </div>

                <div class="recharge-pkg-card group relative p-3 rounded-[16px] bg-[#2c2c2e] border border-white/5 hover:bg-[#3a3a3c] cursor-pointer transition-all active:scale-[0.98] flex flex-col items-center text-center justify-center h-24" data-amount="200000" data-credits="19">
                    <span class="block text-sm font-bold text-white">200k</span>
                    <span class="text-[9px] text-gray-500 uppercase font-bold mb-1">CAO C·∫§P</span>
                    <div class="bg-white/10 px-2 py-0.5 rounded-full">
                        <span class="text-[10px] font-bold text-[#FFD60A]">19 ·∫¢NH</span>
                    </div>
                    <div class="absolute inset-0 border border-[#FF453A] rounded-[16px] opacity-0 pkg-border transition-opacity"></div>
                </div>

                <div class="recharge-pkg-card group relative p-3 rounded-[16px] bg-[#2c2c2e] border border-white/5 hover:bg-[#3a3a3c] cursor-pointer transition-all active:scale-[0.98] flex flex-col items-center text-center justify-center h-24" data-amount="500000" data-credits="45">
                    <span class="block text-sm font-bold text-white">500k</span>
                    <span class="text-[9px] text-gray-500 uppercase font-bold mb-1">SI√äU VIP</span>
                    <div class="bg-white/10 px-2 py-0.5 rounded-full">
                        <span class="text-[10px] font-bold text-[#FFD60A]">45 ·∫¢NH</span>
                    </div>
                    <div class="absolute inset-0 border border-[#FF453A] rounded-[16px] opacity-0 pkg-border transition-opacity"></div>
                </div>

            </div>

            <div class="p-5 mt-2 bg-[#2c2c2e]/30 backdrop-blur-xl border-t border-white/5 relative overflow-hidden">
                <div class="absolute top-0 left-1/2 -translate-x-1/2 w-full h-1 bg-gradient-to-r from-transparent via-[#0A84FF]/50 to-transparent"></div>
                <div class="flex gap-5 items-center">
                    <div class="relative group flex-shrink-0 flex flex-col items-center">
                        <div class="p-1.5 bg-white rounded-[16px] shadow-lg shadow-black/50 mb-2">
                            <img id="vietqr-image" src="" alt="QR" class="w-[110px] h-[110px] object-contain rounded-xl">
                        </div>
                        <button id="btn-download-qr" class="text-[9px] font-bold text-[#0A84FF] hover:text-white bg-white/5 hover:bg-[#0A84FF] px-2.5 py-1.5 rounded-lg transition-colors flex items-center gap-1.5">
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                            L∆ØU ·∫¢NH QR
                        </button>
                    </div>

                    <div class="flex flex-col justify-center flex-1 min-w-0">
                        <div class="mb-3">
                            <span class="text-[9px] text-gray-400 font-medium uppercase tracking-widest mb-1.5 block ml-1">N·ªòI DUNG CK</span>
                            <div class="bg-[#1c1c1e] border border-white/10 rounded-xl px-3 py-2.5 relative overflow-hidden group cursor-pointer active:scale-95 transition-transform flex items-center justify-between shadow-inner" onclick="navigator.clipboard.writeText(document.getElementById('qr-content-display').innerText); showToast('ƒê√£ sao ch√©p n·ªôi dung!', 'success');">
                                <span id="qr-content-display" class="font-mono text-[13px] font-bold text-[#FFD60A] tracking-widest truncate block">LOADING...</span>
                                <svg class="w-4 h-4 text-gray-500 group-hover:text-white transition-colors flex-shrink-0 ml-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                            </div>
                        </div>
                        
                        <div class="flex items-start gap-1.5 mb-3 px-1">
                            <svg class="w-3.5 h-3.5 text-blue-400 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            <p class="text-[10.5px] text-gray-300 font-normal leading-relaxed">
                                M·ªü ·ª©ng d·ª•ng ng√¢n h√†ng, <span class="text-white font-medium">qu√©t m√£ QR</span> ƒë·ªÉ h·ªá th·ªëng t·ª± ƒë·ªông k√≠ch ho·∫°t.
                            </p>
                        </div>

                        <a href="https://zalo.me/0352803379" target="_blank" rel="noopener noreferrer" class="flex items-center justify-center gap-1.5 bg-[#0A84FF]/15 border border-[#0A84FF]/30 text-[#64D2FF] hover:bg-[#0A84FF] hover:text-white px-3 py-2 rounded-xl transition-all w-full active:scale-95 shadow-sm">
                            <svg class="w-4 h-4 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg>
                            <span class="text-[10.5px] font-bold tracking-widest">ZALO: 0352.803.379</span>
                        </a>
                    </div>
                </div>

                <div class="mt-4 relative group">
                    <div class="absolute -inset-0.5 bg-gradient-to-r from-[#0A84FF] to-[#BF5AF2] rounded-xl opacity-20 group-focus-within:opacity-70 transition duration-500 blur-[2px]"></div>
                    <div class="relative flex items-center bg-[#000] rounded-xl border border-white/10 p-1">
                        <div class="pl-3 pr-2 text-gray-500">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path></svg>
                        </div>
                        <input type="text" id="recharge-input" class="w-full bg-transparent text-white text-[13px] font-mono py-2.5 outline-none placeholder-gray-600 tracking-widest uppercase" placeholder="NH·∫¨P M√É K√çCH HO·∫†T...">
                        <button id="btn-submit-recharge" class="p-2 bg-[#30D158] hover:bg-[#28c04d] text-white rounded-lg flex items-center justify-center transition-all shadow-lg active:scale-90">
                            <span class="text-[10px] font-bold px-1">N·∫†P</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN SCRIPT -->
    <script>
        const DEFAULT_ENCRYPTED_CONFIG = "LRFALDY3LTQ/IH1xZxg7PigidAVWQX1/ZyIlOw46MmdjfSAqYSUjW3QnGQd0ZAU1DngybTckJQEfP1hSNgspJzAbIgofNW4bMRIfBBoCbxkrNBtkF2dzaTUrMCUoKDEkEQ99MCouMCZnc2knOCw2FD44dAkXNycxMyZoanAqNTBxMC4hMSJSRTZ9Jiw4cDg="; 
        const ALLOWED_DOMAINS = []; 

        document.addEventListener('DOMContentLoaded', () => {
            const apiKey = ""; 

            const getFormattedTime = () => {
                const now = new Date();
                const vnTime = new Date(now.toLocaleString("en-US", {timeZone: "Asia/Ho_Chi_Minh"}));
                const d = String(vnTime.getDate()).padStart(2, '0');
                const m = String(vnTime.getMonth() + 1).padStart(2, '0');
                const y = vnTime.getFullYear();
                const h = String(vnTime.getHours()).padStart(2, '0');
                const min = String(vnTime.getMinutes()).padStart(2, '0');
                const s = String(vnTime.getSeconds()).padStart(2, '0');
                return `${d}-${m}-${y}_${h}h${min}m${s}s`;
            };

            const Sec = {
                key: "V35_SEC_V2", 
                dec(t){
                    try {
                        if(!t) return null;
                        return [...atob(t)].map((c,i) => String.fromCharCode(c.charCodeAt(0)^this.key.charCodeAt(i%this.key.length))).join("")
                    } catch(e) { return null; }
                }
            };

            const UserSystem = {
                deviceId: null,
                credits: 0,
                ipAddress: null, 
                history: [], 
                
                async init() {
                    try {
                        let storedId = localStorage.getItem('v35_unique_device_id');
                        if (!storedId) {
                            const randomPart = Math.random().toString(36).substring(2, 8).toUpperCase();
                            storedId = `ID-${randomPart}`;
                            localStorage.setItem('v35_unique_device_id', storedId);
                        }
                        this.deviceId = storedId;
                    } catch (e) {
                        this.deviceId = "GUEST-" + Math.floor(Math.random()*1000);
                    }
                    
                    await this.fetchIP();
                    this.loadCredits();
                    this.loadHistory(); 

                    try {
                        const currentHost = window.location.hostname;
                        if (ALLOWED_DOMAINS.length > 0) {
                            const isLocal = currentHost === "" || currentHost === "localhost" || currentHost === "127.0.0.1";
                            if (!isLocal && !ALLOWED_DOMAINS.includes(currentHost)) {
                                console.error("DOMAIN NOT ALLOWED: " + currentHost);
                                showToast("‚õî T√äN MI·ªÄN KH√îNG H·ª¢P L·ªÜ! Vui l√≤ng li√™n h·ªá Admin.", "error");
                                document.body.innerHTML = `<div style="display:flex;justify-content:center;align-items:center;height:100vh;background:#000;color:red;font-family:monospace;text-align:center;"><h1>‚õî ACCESS DENIED<br>DOMAIN: ${currentHost}</h1></div>`;
                                return;
                            }
                        }

                        let configStr = localStorage.getItem("v35_user_settings");
                        if (!configStr && DEFAULT_ENCRYPTED_CONFIG) {
                            configStr = DEFAULT_ENCRYPTED_CONFIG;
                        }

                        if (configStr) {
                            const decryptConfig = (t) => {
                                const k = "V35_SECURE_KEY_SALT";
                                try {
                                    if(!t) return null;
                                    let text = atob(t);
                                    let result = '';
                                    for(let i = 0; i < text.length; i++) {
                                        result += String.fromCharCode(text.charCodeAt(i) ^ k.charCodeAt(i % k.length));
                                    }
                                    return result;
                                } catch(e) { return null; }
                            };

                            const jsonStr = decryptConfig(configStr);
                            if (jsonStr) {
                                const config = JSON.parse(jsonStr);
                                if (config && config.apiKey) {
                                    window.GEMINI_API_KEY = config.apiKey || "";
                                    window.API_PROVIDER = config.provider || "google";
                                    window.API_BASE_URL = config.baseUrl || "https://generativelanguage.googleapis.com";
                                }
                            }
                        }
                    } catch(e) { console.error("Config Load Error", e); }

                    this.updateUI();
                    initRechargeSystem(this.deviceId);
                    updateMobileBtnState('upload');
                },

                async fetchIP() {
                    const gateIpDisplay = document.getElementById('gate-ip-display');
                    const gateLoader = document.getElementById('gate-loading-spinner');
                    const gateBtn = document.getElementById('gate-submit');
                    const gateStatus = document.getElementById('gate-status');
                    
                    const sidebarIpDisplay = document.getElementById('sidebar-ip-display');
                    const sidebarIdDisplay = document.getElementById('sidebar-id-display');

                    const updateSidebar = (ip) => {
                        if (sidebarIpDisplay) sidebarIpDisplay.textContent = `IP: ${ip}`;
                        if (sidebarIdDisplay) sidebarIdDisplay.textContent = `ID: ${this.deviceId}`;
                    };

                    const enableGate = (ip) => {
                        if (gateIpDisplay) {
                            gateIpDisplay.innerHTML = `<span class="text-gray-400 text-xs">${ip}</span> <span class="text-white mx-1">|</span> <span class="text-[#FFD60A] font-bold">${this.deviceId}</span>`; 
                            gateIpDisplay.classList.remove('shimmer-text');
                            if(gateLoader) gateLoader.style.display = 'none';
                            if(gateBtn) {
                                gateBtn.disabled = false;
                                gateBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                                gateStatus.textContent = `ƒê√£ nh·∫≠n di·ªán: ${this.deviceId}`;
                                gateStatus.classList.add('text-green-500');
                            }
                        }
                        updateSidebar(ip);
                    };

                    try {
                        const response = await fetch(`https://api.ipify.org?format=json&t=${Date.now()}`);
                        const data = await response.json();
                        this.ipAddress = data.ip;
                        enableGate(data.ip);
                        return data.ip;
                    } catch (e) {
                        this.ipAddress = "Offline Mode"; 
                        enableGate("Offline Mode");
                        return null;
                    }
                },

                loadCredits() {
                    const key = `v35_credits_${this.deviceId}`;
                    const savedCredits = localStorage.getItem(key);
                    if (savedCredits === null) {
                        this.credits = 0; 
                        this.save();
                    } else {
                        this.credits = parseInt(savedCredits);
                    }
                },
                
                loadHistory() {
                    const h = localStorage.getItem('v37_history');
                    if(h) this.history = JSON.parse(h);
                    this.renderHistory();
                },
                
                addHistory(imgData) {
                    this.history.unshift(imgData);
                    if(this.history.length > 10) this.history.pop();
                    
                    try {
                        localStorage.setItem('v37_history', JSON.stringify(this.history));
                    } catch(e) {
                        while(this.history.length > 2) { 
                            this.history.pop(); 
                        }
                        try { localStorage.setItem('v37_history', JSON.stringify(this.history)); } catch(err) {}
                    }
                    
                    this.renderHistory();
                },
                
                renderHistory() {
                    const container = document.getElementById('history-container');
                    if(!container) return;
                    if(this.history.length === 0) {
                        container.innerHTML = '<div class="text-[10px] text-gray-600 w-full text-center py-2">Ch∆∞a c√≥ ·∫£nh n√†o...</div>';
                        return;
                    }
                    container.innerHTML = '';
                    this.history.forEach(src => {
                        const d = document.createElement('div');
                        d.className = 'history-item flex-shrink-0 relative group';
                        d.style.backgroundImage = `url(${src})`;
                        d.onclick = () => {
                             const imgModified = document.getElementById('img-modified');
                             imgModified.src = src;
                             showToast("ƒê√£ t·∫£i l·∫°i t·ª´ l·ªãch s·ª≠", "success");
                        };
                        
                        const dlBtn = document.createElement('div');
                        dlBtn.className = 'history-dl-btn';
                        dlBtn.innerHTML = '<svg width="8" height="8" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M12 5v14M5 12l7 7 7-7"/></svg>';
                        dlBtn.onclick = (e) => {
                            e.stopPropagation();
                            const link = document.createElement('a');
                            link.href = src;
                            link.download = `V36-History_${getFormattedTime()}.jpg`;
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                            showToast("ƒê√£ l∆∞u ·∫£nh v·ªÅ m√°y!", "success");
                        };
                        
                        d.appendChild(dlBtn);
                        container.appendChild(d);
                    });
                },

                setCredits(amount) {
                    this.credits = amount;
                    this.save();
                },

                addCredits(amount) {
                    this.credits += amount;
                    this.save();
                },

                deductCredits(amount) {
                    if (this.credits >= amount) {
                        this.credits -= amount;
                        this.save();
                        return true;
                    }
                    return false;
                },

                save() {
                    try {
                        const key = `v35_credits_${this.deviceId}`;
                        localStorage.setItem(key, this.credits);
                    } catch(e) {}
                    this.updateUI();
                },

                updateUI() {
                    const el = document.getElementById('credit-count');
                    const mobEl = document.getElementById('mobile-credit-count');
                    // N√ÇNG C·∫§P: ƒê·ªîI TEXT TH√ÄNH C√íN X ·∫¢NH
                    if (el) el.textContent = "C√íN " + this.credits + " ·∫¢NH";
                    if (mobEl) mobEl.textContent = "C√íN " + this.credits + " ·∫¢NH";
                }
            };

            const sidebar = document.getElementById('sidebar');
            const mobileBar = document.getElementById('mobile-action-bar');

            function openSidebar() {
                if(sidebar) sidebar.classList.remove('-translate-x-full');
                if(mobileBar) mobileBar.classList.add('translate-y-32', 'opacity-0'); 
            }

            function closeSidebar() {
                if(sidebar) sidebar.classList.add('-translate-x-full');
                if(mobileBar) mobileBar.classList.remove('translate-y-32', 'opacity-0'); 
            }
            
            const mobCredit = document.getElementById('mobile-credit-display');
            if(mobCredit) {
                mobCredit.onclick = () => document.getElementById('recharge-modal').classList.remove('hidden');
            }

            function initRechargeSystem(deviceId) {
                const pkgCards = document.querySelectorAll('.recharge-pkg-card');
                const qrImage = document.getElementById('vietqr-image');
                const contentDisplay = document.getElementById('qr-content-display');
                const btnDownloadQr = document.getElementById('btn-download-qr'); 

                if(!qrImage) return;

                const bankId = 'mbbank';
                const accNo = '85543556868';
                const accName = 'HOANG QUANG CUONG';
                const template = 'compact'; 

                const updateQR = (amount) => {
                    const content = `V36 ${deviceId}`; 
                    const url = `https://img.vietqr.io/image/${bankId}-${accNo}-${template}.png?amount=${amount}&addInfo=${encodeURIComponent(content)}&accountName=${encodeURIComponent(accName)}`;
                    qrImage.src = url;
                    if(contentDisplay) contentDisplay.textContent = content;
                };

                if (btnDownloadQr) {
                    btnDownloadQr.onclick = () => {
                        if (qrImage.src) {
                            const link = document.createElement('a');
                            link.href = qrImage.src;
                            link.download = `V36-QR-Nap-Tien_${getFormattedTime()}.png`;
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                            showToast("ƒê√£ l∆∞u QR v·ªÅ m√°y!", "success");
                        }
                    };
                }

                updateQR(100000);

                pkgCards.forEach(card => {
                    card.addEventListener('click', () => {
                        pkgCards.forEach(c => {
                            c.classList.remove('active', 'border-red-500', 'bg-red-500/10');
                            c.classList.add('border-white/5', 'bg-[#2c2c2e]');
                            c.querySelector('.pkg-border').classList.remove('opacity-100');
                        });
                        
                        card.classList.remove('border-white/5', 'bg-[#2c2c2e]');
                        card.classList.add('active', 'border-red-500', 'bg-red-500/10');
                        card.querySelector('.pkg-border').classList.add('opacity-100');

                        const amount = card.dataset.amount;
                        updateQR(amount);
                    });
                });
            }

            const updateMobileBtnState = (state) => {
                const upload = document.getElementById('mob-btn-upload');
                const scan = document.getElementById('mob-btn-scan');
                const run = document.getElementById('mob-btn-run');
                const download = document.getElementById('mob-btn-download'); 
                const deskDownload = document.getElementById('desktop-btn-download'); 
                const status = document.getElementById('mobile-status-text');
                
                if(upload) upload.classList.add('hidden');
                if(scan) scan.classList.add('hidden');
                if(run) run.classList.add('hidden');
                if(download) download.classList.add('hidden'); 
                if(deskDownload) { 
                    deskDownload.className = "hidden bg-[#1c1c1e] backdrop-blur-xl hover:bg-[#2c2c2e] text-white px-8 py-3.5 rounded-[22px] font-bold border border-white/20 z-50 items-center gap-2 transition-transform active:scale-95 shadow-[0_4px_15px_rgba(0,0,0,0.5)]";
                }
                
                if (state === 'upload') {
                    if(upload) upload.classList.remove('hidden');
                    if(status) { status.textContent = "WAITING"; status.className = "text-[9px] text-gray-500 font-mono tracking-widest"; }
                } else if (state === 'scan') {
                    if(scan) {
                        scan.classList.remove('hidden');
                        scan.disabled = false;
                        scan.innerHTML = `<svg class="w-6 h-6 animate-pulse drop-shadow-md" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg><span class="drop-shadow-md">SCAN</span>`;
                    }
                    if(status) {
                        status.textContent = "LOADED";
                        status.className = "text-[9px] font-mono tracking-widest text-blue-400 font-bold";
                    }
                } else if (state === 'scanning') {
                    if(scan) {
                        scan.classList.remove('hidden');
                        scan.disabled = true;
                        scan.innerHTML = `<svg class="w-5 h-5 animate-spin drop-shadow-md" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> SCANNING...`;
                    }
                    if(status) status.textContent = "ANALYZING...";
                } else if (state === 'run') {
                    if(run) {
                        run.classList.remove('hidden');
                        run.disabled = false;
                        // N√ÇNG C·∫§P GIAO DI·ªÜN MOBILE CH·∫†Y G·ªåN G√ÄNG SANG TR·ªåNG
                        run.innerHTML = `<svg class="w-5 h-5 text-gray-300 drop-shadow-md" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg><span class="tracking-widest">T·∫†O NGAY</span>`;
                    }
                    if(status) {
                        status.textContent = "READY";
                        status.className = "text-[9px] font-mono tracking-widest text-green-400 font-bold";
                    }
                } else if (state === 'running') {
                    if(run) {
                        run.classList.remove('hidden');
                        run.disabled = true;
                        run.innerHTML = `<svg class="w-5 h-5 text-gray-400 animate-spin drop-shadow-md" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span class="tracking-widest">ƒêANG T·∫†O...</span>`;
                    }
                    if(status) {
                        status.textContent = "RESTORING...";
                        status.className = "text-[9px] font-mono tracking-widest text-orange-400 font-bold animate-pulse";
                    }
                } else if (state === 'done') {
                    if(run) {
                        run.classList.remove('hidden');
                        run.disabled = false;
                        run.innerHTML = `<svg class="w-5 h-5 text-gray-300 drop-shadow-md" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg><span class="tracking-widest">CH·∫†Y L·∫†I</span>`;
                    }
                    if(download) { 
                        download.classList.remove('hidden');
                    }
                    if(deskDownload) { 
                        deskDownload.className = "max-md:hidden md:flex bg-[#1c1c1e] backdrop-blur-xl hover:bg-[#2c2c2e] text-white px-8 py-3.5 rounded-[22px] font-bold border border-white/20 z-50 items-center gap-2 transition-transform active:scale-95 shadow-[0_4px_15px_rgba(0,0,0,0.5)]";
                    }
                    if(status) {
                        status.textContent = "COMPLETED";
                        status.className = "text-[9px] font-mono tracking-widest text-green-400 font-bold";
                    }
                }
            }

            UserSystem.init();

            const creditDisplay = document.getElementById('credit-display');
            if (creditDisplay) {
                creditDisplay.onclick = () => document.getElementById('recharge-modal').classList.remove('hidden');
            }

            let state = { base64: null, refBase64: null, restoredObj: null, originalImg: null, zoom: 1, rotation: 0, defaultPrompt: "Restore this photo, remove scratches, high quality, 8k", isLoupeActive: false, isReplicaMode: false, isFluxMode: true, currentSliderVal: 50, isComparing: false, aspectRatioType: null, userSettings: { username: '', apiKey: '', provider: 'google', baseUrl: 'https://generativelanguage.googleapis.com' } };
            const showToast = (message, type = 'info') => {
                const container = document.getElementById('toast-container'); if(!container) return;
                const toast = document.createElement('div');
                const colors = type === 'error' ? 'bg-red-500 text-white shadow-red-500/20' : type === 'success' ? 'bg-green-500 text-white shadow-green-500/20' : 'bg-[#1c1c1e] text-white border border-white/10';
                toast.className = `flex items-center gap-3 px-4 py-3 rounded-xl backdrop-blur-md shadow-xl animate-toast-in ${colors} text-xs font-semibold`;
                toast.innerHTML = `<span>${message}</span>`;
                container.appendChild(toast);
                setTimeout(() => { toast.classList.add('animate-fade-out'); setTimeout(() => toast.remove(), 500); }, 3000);
            };
            
            function showScanWindow() {
                const win = document.getElementById('scan-window-overlay');
                if(win) win.classList.remove('hidden');
            }
            
            function hideScanWindow() {
                const win = document.getElementById('scan-window-overlay');
                if(win) win.classList.add('hidden');
            }
            
            function updateScanTags(messages) {
                const container = document.getElementById('scan-tags-container');
                if(!container) return;
                
                container.innerHTML = '';
                
                messages.forEach((msg) => {
                    const tag = document.createElement('span');
                    tag.className = 'scan-tag';
                    if (msg.includes('AUTO:') || msg.includes('PH√ÅT HI·ªÜN:') || msg.includes('WORKFLOW:')) {
                        tag.classList.add('highlight');
                    }
                    tag.innerText = msg;
                    container.appendChild(tag);
                });
            }

            function playSequentialLog(messages) {
                const container = document.getElementById('scan-log-overlay');
                if (!container) return;

                container.innerHTML = ''; 

                let delay = 0;
                messages.forEach((msg) => {
                    setTimeout(() => {
                        container.innerHTML = '';
                        
                        const line = document.createElement('span');
                        line.className = 'sequential-log-text';
                        
                        let cleanMsg = msg;
                        if (msg.includes('AUTO:') || msg.includes('PH√ÅT HI·ªÜN:') || msg.includes('WORKFLOW:')) {
                             line.classList.add('highlight');
                             cleanMsg = msg.replace('AUTO: ', '').replace('PH√ÅT HI·ªÜN: ', '').replace('WORKFLOW: ', '');
                        } else {
                             cleanMsg = msg.replace('FIX: ', '');
                        }
                        
                        line.innerText = cleanMsg;
                        container.appendChild(line);
                        
                    }, delay);
                    
                    delay += 250; 
                });
                
                setTimeout(() => {
                    container.innerHTML = '';
                }, delay + 1000);
            }
            
            function getActiveSettings() {
                const settings = [];
                
                if(document.getElementById('mode-flux')?.checked) settings.push("FLUX ENGINE: ON");
                if(document.getElementById('mode-replica')?.checked) settings.push("REPLICA MODE");
                if(document.getElementById('check-face')?.checked) settings.push("FACE DETAIL");
                if(document.getElementById('check-hair')?.checked) settings.push("HAIR DRAWING");
                if(document.getElementById('check-background')?.checked) settings.push("BG SHARPEN");
                
                const upscale = document.getElementById('upscale-mode');
                if(upscale && upscale.value !== 'none') {
                    const text = upscale.options[upscale.selectedIndex].text;
                    let simpleName = text.split('(')[0].trim().replace(/^[^\w\s]+/, ''); 
                    settings.push(`UPSCALE: ${simpleName}`);
                }
                
                const workflow = document.getElementById('kontext-workflow');
                if(workflow && workflow.value !== 'default') {
                    let simpleName = workflow.options[workflow.selectedIndex].text.split('(')[0].trim().replace(/^[^\w\s]+/, '');
                    settings.push(`WORKFLOW: ${simpleName}`);
                }
                
                if(document.getElementById('check-logo')?.checked) settings.push("WATERMARK: ON");

                return settings;
            }


            const gateScreen = document.getElementById('security-gate'), gateSubmit = document.getElementById('gate-submit'), gateStatus = document.getElementById('gate-status');
            gateSubmit.addEventListener('click', async () => {
                if(!UserSystem.ipAddress) { UserSystem.ipAddress = "Offline Mode"; }
                gateStatus.textContent = `Verifying ID: ${UserSystem.deviceId}...`; 
                gateStatus.className = "text-[11px] text-[#0A84FF] font-bold animate-pulse flex items-center gap-2 justify-center"; 
                gateSubmit.disabled = true; 
                gateSubmit.classList.add('opacity-70');
                
                setTimeout(() => { 
                    gateStatus.textContent = "Access Granted"; 
                    gateStatus.className = "text-[11px] text-green-500 font-bold flex items-center gap-2 justify-center"; 
                    setTimeout(() => { 
                        gateScreen.classList.add('animate-fade-out'); 
                        setTimeout(() => { gateScreen.style.display = 'none'; }, 500); 
                    }, 500); 
                }, 1000);
            });
            
            const getApiConfig = () => {
                const key = window.GEMINI_API_KEY || window.COMET_API_KEY || "";
                const base = window.API_BASE_URL || "https://generativelanguage.googleapis.com";
                const isComet = window.API_PROVIDER === 'comet';
                return { key, base, isComet };
            };
            
            const resizeImage = (base64Str, maxWidth = 1536) => {
                return new Promise((resolve, reject) => { const img = new Image(); img.src = base64Str; img.onload = () => { let width = img.width; let height = img.height; if (width > maxWidth || height > maxWidth) { if (width > height) { height *= maxWidth / width; width = maxWidth; } else { width *= maxWidth / height; height = maxWidth; } } else { resolve(base64Str); return; } const canvas = document.createElement('canvas'); canvas.width = width; canvas.height = height; const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, width, height); resolve(canvas.toDataURL('image/jpeg', 0.9)); }; img.onerror = (err) => reject(new Error("L·ªói t·∫£i ·∫£nh ƒë·ªÉ Scan")); });
            };

            const toggleModule = (btnId, contentId, iconId) => { const btn = document.getElementById(btnId), content = document.getElementById(contentId), icon = document.getElementById(iconId); if(btn) btn.addEventListener('click', () => { if(content) content.classList.toggle('open'); if(icon && content) icon.style.transform = content.classList.contains('open') ? 'rotate(180deg)' : 'rotate(0deg)'; }); };
            ['processing','subject','identity','prompt','logo','military','cinematic','exposure','history'].forEach(id => toggleModule(`toggle-${id}`, `content-${id}`, `icon-${id}`));

            const toggleSidebarBtn = document.getElementById('toggle-sidebar-btn');
            if(toggleSidebarBtn) toggleSidebarBtn.onclick = openSidebar;
            
            const closeSidebarMobileBtn = document.getElementById('close-sidebar-mobile');
            if(closeSidebarMobileBtn) closeSidebarMobileBtn.onclick = closeSidebar;

            const downloadImage = () => {
                if (!state.restoredObj) return showToast("Ch∆∞a c√≥ ·∫£nh k·∫øt qu·∫£!", "error");
                const link = document.createElement('a');
                link.download = `V36-Restored_${getFormattedTime()}.jpg`;
                link.href = document.getElementById('img-modified').src;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };
            
            const mobBtnDownload = document.getElementById('mob-btn-download');
            if(mobBtnDownload) mobBtnDownload.onclick = downloadImage;

            const deskBtnDownload = document.getElementById('desktop-btn-download');
            if(deskBtnDownload) deskBtnDownload.onclick = downloadImage;

            const resetApp = () => {
                if(confirm("L√†m m·ªõi to√†n b·ªô?")) location.reload();
            };
            
            const btnResetSidebar = document.getElementById('reset-button');
            if(btnResetSidebar) btnResetSidebar.onclick = resetApp;
            
            const btnResetMobile = document.getElementById('mob-btn-reset');
            if(btnResetMobile) btnResetMobile.onclick = resetApp;

            const runImageProcessing = async () => {
                if(!state.base64) return showToast("Vui l√≤ng t·∫£i ·∫£nh!", "error");
                
                if (!UserSystem.deductCredits(1)) { 
                    showToast("T√†i kho·∫£n kh√¥ng ƒë·ªß ·∫¢nh t·∫°o! Vui l√≤ng n·∫°p.", "error"); 
                    document.getElementById('recharge-modal').classList.remove('hidden'); 
                    return; 
                }
                
                updateMobileBtnState('running');
                if(processBtn) {
                    processBtn.disabled = true; 
                    // CH·ªàNH TEXT L√öC CH·∫†Y ƒê·ªÇ SANG TR·ªåNG H∆†N
                    processBtn.innerHTML = `<span class="animate-pulse tracking-widest text-gray-400 font-bold">ƒêANG T·∫†O ·∫¢NH...</span>`; 
                }
                
                showScanWindow();
                document.getElementById('scan-title').innerText = "ƒêANG X·ª¨ L√ù ·∫¢NH...";
                const activeSettings = getActiveSettings();
                updateScanTags(activeSettings);
                
                document.getElementById('scan-beam').classList.add('active');
                
                const magicDust = document.getElementById('magic-dust');
                if(magicDust) magicDust.classList.remove('hidden');

                closeSidebar();

                const { key: keyToUse, base: apiBase, isComet } = getApiConfig();
                try {
                    const resizedBase64 = await resizeImage(state.base64);
                    let finalPrompt = document.getElementById('prompt-main').value;
                    if(!finalPrompt) finalPrompt = "Restore this photo, remove scratches, high quality, 8k";
                    
                    const antiFlip = document.getElementById('check-anti-flip')?.checked;
                    if (antiFlip) {
                        finalPrompt += ", (maintain original composition:1.5), (do not flip:1.5), (preserve composition:1.4)";
                    }
                    
                    const replicaMode = document.getElementById('mode-replica')?.checked;
                    if (replicaMode) {
                        finalPrompt += ", (exact facial features:1.5), (same face structure:1.5)";
                    }
                    finalPrompt += ", (maintain original composition:1.5), (do not flip:1.5), (do not crop:1.4), (preserve original aspect ratio:1.4)";
                    
                    const isAltarMode = document.getElementById('check-altar-mode')?.checked;
                    if (isAltarMode) {
                        finalPrompt += ", (formal portrait:1.4), (symmetrical face:1.3), (solemn expression), (perfectly centered), (white background:0.5)";
                    }

                    const isIDPhoto = document.getElementById('check-id-photo')?.checked;
                    if (isIDPhoto) {
                        finalPrompt += ", (passport photo:1.5), (studio lighting:1.3), (neutral background:1.4), (look at camera), (high quality headshot)";
                    }
                    
                    const isAsianIdentity = document.getElementById('check-asian-identity')?.checked;
                    if(isAsianIdentity) {
                        finalPrompt += ", (vietnamese facial structure:1.6), (southeast asian features), (warm skin tone), (slight high cheekbones:1.2), (authentic vietnamese eyes shape)";
                    }

                    const workflowSelect = document.getElementById('kontext-workflow');
                    if (workflowSelect) {
                        if (workflowSelect.value === 'qwen_edit_pro') {
                            finalPrompt = "Instruction: " + finalPrompt; 
                            finalPrompt += ". Describe key features of the input image, then explain how the user's text instruction should alter the image while maintaining consistency.";
                        } else if (workflowSelect.value === 'qwen_lightning') {
                             finalPrompt += ", (Qwen-Image-Edit-2511:1.2), (Lightning-4steps-V1.0-fp32:1.0)";
                             finalPrompt += ", (Instruction: High-resolution photo reconstruction:1.5)";
                        } else if (workflowSelect.value === 'old_photo_v1') {
                             finalPrompt += ", (Kontext_ËÄÅÁÖßÁâá‰øÆÂ§çlora_v1.safetensors:1.0), (ReferenceLatent:1.2)";
                        }
                    }

                    const upscaleMode = document.getElementById('upscale-mode');
                    if (upscaleMode && upscaleMode.value === 'invsr_sharp') {
                        finalPrompt += ", (sharp focus:1.4), (remove motion blur:1.3), (InvSR deblurring:1.2)";
                    } else if (upscaleMode && upscaleMode.value === 'realesrgan') {
                        finalPrompt += ", (RealESRGAN x4 Plus:1.4), (smooth restoration:1.3)";
                    }

                    const colorGrade = document.getElementById('color-grading');
                    if (colorGrade && colorGrade.value.includes('golden_hour')) {
                         finalPrompt += ", (Golden hour sunlight filtered through window blinds:1.3), (striped light patterns:1.2)";
                    } else if (colorGrade && colorGrade.value.includes('moonlight')) {
                         finalPrompt += ", (Moonlight through window panes:1.3), (bluish soft grid shadows:1.2), (mysterious night mood)";
                    } else if (colorGrade && colorGrade.value.includes('colorize_bw_old_photo')) {
                         finalPrompt += ", (colorize:1.5), (vibrant colors), (natural skin tones:1.4), (realistic clothes colors)";
                    }

                    const isInsigniaBoost = document.getElementById('check-insignia-boost')?.checked || false;
                    const isBlockRank = document.getElementById('block-rank')?.checked || false;
                    const isMetalShader = document.getElementById('check-metal-shader')?.checked || false;
                    const isFabricDetail = document.getElementById('check-fabric-detail')?.checked || false;

                    const hatVal = document.getElementById('hat-select')?.value || "";
                    if(hatVal.includes("pith helmet")) {
                        finalPrompt += ", (green vietnamese pith helmet:1.6), (hard shell texture:1.3), (round shape), (red circular badge with raised yellow star:1.5), (worn leather chin strap:1.2)";
                    } else if (hatVal.includes("kepi hat")) {
                         finalPrompt += ", (structured officer kepi hat:1.5), (stiff visor), (gold band details), (raised metal star insignia)";
                    }

                    const uniformVal = document.getElementById('mil-uniform')?.value || "";
                    if(uniformVal.includes("to chau")) {
                        finalPrompt += ", (to chau military uniform:1.5), (faded green fabric), (buttoned chest pockets), (loose fitting trousers), (simple collar)";
                    } else if (uniformVal.includes("tran thu")) {
                         finalPrompt += ", (padded cotton jacket:1.5), (diamond quilted texture:1.4), (thick warm fabric), (collarless or simple collar)";
                    }

                    if (isInsigniaBoost) finalPrompt += `, (hyper detailed military insignia:1.7), (macro photography of medals), (sharp defined star shape), (distinct collar tabs)`;
                    
                    if (isMetalShader) {
                         finalPrompt += ", (metallic texture rendering:1.4), (shiny gold surface:1.3), (reflective metal:1.2), (embossed 3d details), (oxidized vintage metal)";
                    }
                    
                    if (isFabricDetail) {
                         finalPrompt += ", (high thread count fabric:1.3), (visible weave texture), (natural fabric folds), (canvas material texture:1.2), (clothing seam details)";
                    }

                    if (isBlockRank) finalPrompt += `, (plain collar:1.5), (no rank insignia:1.5), (smooth collar fabric)`;

                    const isQwenExposure = document.getElementById('check-qwen-exposure')?.checked || false;
                    const exposureStrength = parseFloat(document.getElementById('exposure-slider')?.value || 1.0);
                    if (isQwenExposure) {
                         const isRemoveShadow = document.getElementById('check-remove-shadow')?.checked;
                         if (isRemoveShadow) {
                            finalPrompt += `, (remove harsh light and shadow:${(1.5 * exposureStrength).toFixed(1)}), (neutralize exposure:${(1.4 * exposureStrength).toFixed(1)})`;
                        }
                    }

                    finalPrompt += ", (best quality, 8k, hyper detailed)";

                    const parts = [{ text: finalPrompt }, { inlineData: { mimeType: "image/jpeg", data: resizedBase64.split(',')[1] } }];
                    const headers = { 'Content-Type': 'application/json' }; if (isComet) headers['Authorization'] = `Bearer ${keyToUse}`;
                    const response = await fetch(`${apiBase}/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${keyToUse}`, { method: 'POST', headers: headers, body: JSON.stringify({ contents: [{ parts: parts }], generationConfig: { responseModalities: ["TEXT", "IMAGE"] } }) });
                    
                    if (!response.ok) {
                        const err = await response.json();
                        throw new Error(err.error?.message || "L·ªói k·∫øt n·ªëi API (" + response.status + ")");
                    }

                    const data = await response.json();
                    let base64Img = null;
                    if (data.candidates && data.candidates[0].content && data.candidates[0].content.parts) {
                        for (const part of data.candidates[0].content.parts) { if (part.inlineData && part.inlineData.data) { base64Img = part.inlineData.data; break; } }
                    }
                    if(base64Img) {
                        const finalImgSrc = `data:image/jpeg;base64,${base64Img}`;
                        const restoredImg = new Image();
                        restoredImg.onload = () => {
                            try {
                                state.restoredObj = restoredImg;
                                
                                const imgOriginal = document.getElementById('img-original');
                                const imgModified = document.getElementById('img-modified');
                                
                                imgModified.src = finalImgSrc;
                                
                                if(imgOriginal) {
                                    const w = imgOriginal.clientWidth;
                                    const h = imgOriginal.clientHeight;
                                    imgModified.style.width = w + 'px';
                                    imgModified.style.height = h + 'px';
                                    imgModified.style.maxWidth = 'none'; 
                                }

                                document.getElementById('comparison-view').style.display = 'flex';
                                document.getElementById('placeholder-state').style.display = 'none';
                                
                                document.getElementById('img-modified-wrapper').style.width = '50%';
                                document.getElementById('slider-handle').style.left = '50%';
                                document.getElementById('slider-handle').style.display = 'flex'; 
                                document.querySelector('.comp-label.after').style.display = 'block';
                                
                                UserSystem.addHistory(finalImgSrc);

                                updateMobileBtnState('done');
                                
                                // G·ªåI HI·ªÜU ·ª®NG TH√îNG B√ÅO HO√ÄN T·∫§T ƒê·∫∏P M·∫ÆT
                                const successOverlay = document.getElementById('elegant-success-overlay');
                                const successBox = document.getElementById('elegant-success-box');
                                if(successOverlay && successBox) {
                                    successOverlay.classList.remove('opacity-0', 'pointer-events-none');
                                    successBox.classList.remove('scale-95');
                                    successBox.classList.add('scale-100');
                                    
                                    setTimeout(() => {
                                        successOverlay.classList.add('opacity-0', 'pointer-events-none');
                                        successBox.classList.remove('scale-100');
                                        successBox.classList.add('scale-95');
                                    }, 2500);
                                }
                                
                            } catch (err) {
                                console.error("L·ªói giao di·ªán sau khi t·∫°o ·∫£nh:", err);
                                updateMobileBtnState('done'); 
                            }
                        };
                        restoredImg.src = finalImgSrc;
                    } else { throw new Error("Kh√¥ng t·∫°o ƒë∆∞·ª£c ·∫£nh (Kh√¥ng c√≥ d·ªØ li·ªáu tr·∫£ v·ªÅ)."); }
                } catch(e) { console.error(e); showToast("L·ªói: " + e.message, "error"); updateMobileBtnState('run'); }
                finally { 
                    if(processBtn) {
                        processBtn.disabled = false; 
                        // TR·∫¢ V·ªÄ GIAO DI·ªÜN SANG TR·ªåNG BAN ƒê·∫¶U
                        processBtn.innerHTML = `<svg class="w-5 h-5 text-gray-300 group-hover:text-yellow-400 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg><span class="tracking-widest font-bold group-hover:text-yellow-400 transition-colors">T·∫†O ·∫¢NH NGAY</span>`;
                    }
                    hideScanWindow();
                    
                    document.getElementById('scan-beam').classList.remove('active'); 
                    if(magicDust) magicDust.classList.add('hidden');
                }
            };

            const btnAutoPilot = document.getElementById('btn-auto-pilot'), processBtn = document.getElementById('process-image');
            
            if(btnAutoPilot) btnAutoPilot.addEventListener('click', async () => {
                if(!state.base64) return showToast("Vui l√≤ng t·∫£i ·∫£nh tr∆∞·ªõc!", "error");
                
                btnAutoPilot.disabled = true;
                
                btnAutoPilot.className = "w-full py-3.5 rounded-[20px] flex items-center justify-center gap-2 transition-all mb-3 bg-[#FF453A]/15 border border-[#FF453A]/60 shadow-[0_0_20px_rgba(255,69,58,0.3)]";
                btnAutoPilot.innerHTML = `<span class="animate-pulse text-[#FF453A] font-extrabold tracking-widest drop-shadow-[0_0_8px_rgba(255,69,58,0.8)]">ƒêANG AUTO SCAN...</span>`;
                
                document.getElementById('scan-log-overlay').innerHTML = ''; 
                
                updateMobileBtnState('scanning');
                const { key: keyToUse, base: apiBase, isComet } = getApiConfig();
                if (!keyToUse) { 
                    showToast("Ch∆∞a c√≥ API Key!", "error"); 
                    btnAutoPilot.disabled = false; 
                    btnAutoPilot.className = "w-full py-3.5 rounded-[20px] flex items-center justify-center gap-2 transition-all active:scale-[0.96] mb-3 bg-[#2c2c2e]/80 hover:bg-[#3c3c3e] border border-[#FFD60A]/40 shadow-[0_4px_15px_rgba(255,214,10,0.15)] group";
                    btnAutoPilot.innerHTML = `<svg class="w-4 h-4 text-[#FFD60A] group-hover:rotate-180 transition-transform duration-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg><span class="text-[13px] font-bold text-[#FFD60A] tracking-wider">AUTO SCAN V36.50</span>`;
                    updateMobileBtnState('scan'); 
                    return; 
                }

                try {
                    const resizedBase64 = await resizeImage(state.base64);
                    const controller = new AbortController(); const timeoutId = setTimeout(() => controller.abort(), 40000);
                    
                    const promptText = "Analyze this image for photo restoration. Return ONLY JSON: { \"sceneContext\": \"wedding\"|\"funeral\"|\"casual\"|\"studio\"|\"outdoor\"|\"product\"|\"painting\"|\"ancient_portrait\"|\"nature\", \"materialType\": \"paper_photo\"|\"canvas\"|\"newspaper\"|\"silk\"|\"digital\", \"specificDamage\": \"scratches\"|\"mold_spots\"|\"water_stain\"|\"tear\"|\"severe_decay\"|\"none\", \"colorCast\": \"sepia\"|\"cyan\"|\"red\"|\"yellow\"|\"none\", \"estimatedEra\": \"french_colonial\"|\"vietnam_war\"|\"subsidy_period\"|\"modern\"|\"unknown\", \"faceSize\": \"portrait_closeup\"|\"medium_shot\"|\"group_small_faces\", \"lightingCondition\": \"rembrandt\"|\"golden_hour\"|\"neon\"|\"soft_diffused\"|\"flat\"|\"overexposed\"|\"harsh_sun\"|\"moonlight\"|\"streetlight\", \"backgroundType\": \"plain\"|\"complex_outdoor\"|\"complex_indoor\", \"hairCondition\": \"blurry_mess\"|\"sharp\"|\"normal\", \"skinTexture\": \"waxy\"|\"detailed\"|\"grainy\", \"fabricDetail\": \"lost\"|\"visible\", \"hasJewelry\": boolean, \"isNature\": boolean, \"isMilitary\": boolean, \"militaryUniformType\": \"army_ground\"|\"air_force\"|\"navy\"|\"border_guard\"|\"public_security\"|\"youth_volunteer\"|\"unknown\", \"militaryHatType\": \"pith_helmet\"|\"soft_cap\"|\"kepi_officer\"|\"kepi_police\"|\"bamboo_helmet\"|\"none\", \"hasGoldStarMedal\": boolean, \"hasResistanceMedal\": boolean, \"hasYouthBadge\": boolean, \"isBlackAndWhite\": boolean, \"isAltarPortrait\": boolean, \"gender\": \"male\"|\"female\"|\"mixed\", \"age\": number, \"damageType\": \"scratches\"|\"faded\"|\"sepia\"|\"severe_damage\"|\"none\"|\"blur\", \"isOldPhoto\": boolean, \"isIDPhoto\": boolean, \"isHazy\": boolean, \"hasStrabismus\": boolean, \"hasDroopyEyelids\": boolean, \"hasClosedEyes\": boolean, \"hasMonolids\": boolean, \"hasBuckTeeth\": boolean, \"hasBlackenedTeeth\": boolean, \"isGroupPhoto\": boolean, \"groupDemographics\": \"mixed_ages_genders\"|\"mostly_elders\"|\"mostly_children\"|\"mostly_young_adults\"|\"single_person\"|\"unknown\" }";
                    
                    const headers = { 'Content-Type': 'application/json' }; if (isComet) headers['Authorization'] = `Bearer ${keyToUse}`;
                    const response = await fetch(`${apiBase}/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${keyToUse}`, { method: 'POST', headers: headers, signal: controller.signal, body: JSON.stringify({ contents: [{ parts: [{ text: promptText }, { inlineData: { mimeType: "image/jpeg", data: resizedBase64.split(',')[1] } }] }] }) });
                    clearTimeout(timeoutId);
                    
                    if (!response.ok) {
                        const err = await response.json();
                        throw new Error(err.error?.message || "L·ªói Scan (" + response.status + ")");
                    }

                    const data = await response.json();
                    let text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    if(text) {
                        text = text.replace(/```json/g, '').replace(/```/g, '').trim();
                        const result = JSON.parse(text);
                        const autoReport = [];

                        const setChecked = (id, val) => { const el = document.getElementById(id); if(el) el.checked = val; };

                        if(document.getElementById('gender-select')) {
                            let genderVal = result.gender === 'male' ? 'male' : (result.gender === 'female' ? 'female' : '');
                            if (result.gender === 'mixed' || result.isGroupPhoto) genderVal = 'male and female';
                            document.getElementById('gender-select').value = genderVal;
                            if(genderVal) autoReport.push(`PH√ÅT HI·ªÜN: GI·ªöI T√çNH ${genderVal === 'male' ? 'NAM' : (genderVal === 'female' ? 'N·ªÆ' : 'H·ªñN H·ª¢P')}`);
                        }
                        if(document.getElementById('age-input') && !result.isGroupPhoto) {
                            document.getElementById('age-input').value = result.age || 30;
                            autoReport.push(`PH√ÅT HI·ªÜN: ƒê·ªò TU·ªîI ${result.age || 30}`);
                        }
                        if(result.isIDPhoto) { 
                            setChecked('check-id-photo', true); 
                            autoReport.push("CH·∫æ ƒê·ªò: ·∫¢NH TH·∫∫");
                        }
                        
                        if(result.isAltarPortrait) {
                            setChecked('check-altar-mode', true);
                            autoReport.push("PH√ÅT HI·ªÜN: ·∫¢NH TH·ªú");
                        }
                        
                        if(result.isMilitary) { 
                            autoReport.push("PH√ÅT HI·ªÜN: QU√ÇN PH·ª§C");
                            setChecked('check-insignia-boost', true);
                            
                            setChecked('check-metal-shader', true);
                            setChecked('check-fabric-detail', true);
                            autoReport.push("AUTO: PRO METAL/FABRIC");

                            if(result.militaryUniformType === 'public_security') {
                                document.getElementById('mil-branch').value = "vietnamese public security, green uniform, red collar tabs";
                                autoReport.push("AUTO: C√îNG AN");
                            } else if (result.militaryUniformType === 'navy') {
                                document.getElementById('mil-branch').value = "vietnamese navy, navy blue uniform, white striped collar";
                                autoReport.push("AUTO: H·∫¢I QU√ÇN");
                            } else if (result.militaryUniformType === 'army_ground') {
                                document.getElementById('mil-branch').value = "vietnamese army ground force, red collar tabs";
                                autoReport.push("AUTO: L·ª§C QU√ÇN");
                            }

                            if(result.militaryHatType === 'pith_helmet') {
                                document.getElementById('hat-select').value = "wear vietnamese pith helmet, hard pith helmet, dark green color, rounded shape, red badge v·ªõi yellow star";
                                autoReport.push("AUTO: M≈® C·ªêI");
                            } else if (result.militaryHatType === 'soft_cap') {
                                document.getElementById('hat-select').value = "wear vietnamese soft cap, boonie hat, green fabric, red star badge";
                                autoReport.push("AUTO: M≈® TAI B√àO");
                            } else if (result.militaryHatType === 'kepi_police') {
                                document.getElementById('hat-select').value = "wear vietnamese police kepi hat, green color, red band, gold badge";
                                autoReport.push("AUTO: M≈® KEPI CA");
                            } else if (result.militaryHatType === 'kepi_officer') {
                                document.getElementById('hat-select').value = "wear vietnamese officer kepi hat, mixed red and green color, gold chin strap, red badge v·ªõi gold star";
                                autoReport.push("AUTO: M≈® KEPI SQ");
                            }

                            if(result.hasGoldStarMedal) { setChecked('check-sao-vang', true); autoReport.push("AUTO: SAO V√ÄNG"); }
                            if(result.hasResistanceMedal) { setChecked('check-khang-chien', true); autoReport.push("AUTO: HC KH√ÅNG CHI·∫æN"); }
                            if(result.hasYouthBadge) { setChecked('check-doan', true); autoReport.push("AUTO: HUY HI·ªÜU ƒêO√ÄN"); }
                        }

                        if(result.isGroupPhoto) {
                            setChecked('check-group-mode', true);
                            autoReport.push("CH·∫æ ƒê·ªò: ·∫¢NH ƒê√ÅM ƒê√îNG");
                        }

                        let identityFeaturesFound = false;
                        if(result.hasStrabismus) { setChecked('check-cross-eyed', true); identityFeaturesFound = true; autoReport.push("KH√ìA N√âT: M·∫ÆT L√â"); }
                        if(result.hasDroopyEyelids) { setChecked('check-ptosis', true); identityFeaturesFound = true; autoReport.push("KH√ìA N√âT: M·∫ÆT S·ª§P M√ç"); }
                        if(result.hasClosedEyes) { setChecked('check-closed-eyes', true); identityFeaturesFound = true; autoReport.push("KH√ìA N√âT: M·∫ÆT NH·∫ÆM"); }
                        if(result.hasMonolids) { setChecked('check-monolid', true); identityFeaturesFound = true; autoReport.push("KH√ìA N√âT: M·∫ÆT M·ªòT M√ç"); }
                        if(result.hasBuckTeeth) { setChecked('check-buck-teeth', true); identityFeaturesFound = true; autoReport.push("KH√ìA N√âT: RƒÇNG H√î"); }
                        if(result.hasBlackenedTeeth) { setChecked('check-black-teeth', true); identityFeaturesFound = true; autoReport.push("KH√ìA N√âT: RƒÇNG ƒêEN"); }
                        
                        if (!state.isReplicaMode) { 
                            const modeReplica = document.getElementById('mode-replica');
                            if(modeReplica) modeReplica.click(); 
                            autoReport.push("K√çCH HO·∫†T: CH·∫æ ƒê·ªò SI√äU TH·ª∞C");
                        }
                        
                        let smartPrompt = `Restore this ${result.sceneContext} photo. (high resolution:1.5), (masterpiece:1.4), (detailed background:1.3). `;
                        smartPrompt += "(hyper-realistic skin texture:1.6), (detailed skin pores:1.5), (rosy undertone:1.3), (natural beauty:1.2). ";
                        if(result.isMilitary) smartPrompt += ", (Vietnamese military uniform:1.5), (historic details:1.4)";
                        
                        if(result.materialType === 'canvas') {
                             smartPrompt += ", (remove canvas texture:1.4), (smooth surface:1.2)";
                             autoReport.push("FIX: V√ÇN V·∫¢I CANVAS");
                        } else if (result.materialType === 'newspaper') {
                             smartPrompt += ", (remove halftone pattern:1.3), (denoise:1.4)";
                             autoReport.push("FIX: ·∫¢NH B√ÅO C≈®");
                        }

                        if(result.specificDamage === 'mold_spots') {
                            smartPrompt += ", (remove mold spots:1.5), (clean fungal growth:1.4)";
                            autoReport.push("AUTO CLEAN: N·∫§M M·ªêC");
                        } else if (result.specificDamage === 'water_stain') {
                            smartPrompt += ", (remove water stains:1.4), (fix discoloration:1.3)";
                            autoReport.push("AUTO CLEAN: ·ªê N∆Ø·ªöC");
                        } else if (result.specificDamage === 'tear') {
                            smartPrompt += ", (inpainting torn edges:1.5), (fill missing parts:1.4)";
                            autoReport.push("AUTO FILL: V·∫æT R√ÅCH");
                        }

                        if(!result.isBlackAndWhite && result.colorCast !== 'none') {
                            smartPrompt += `, (remove ${result.colorCast} color cast:1.4), (white balance:1.3), (natural colors)`;
                            autoReport.push(`FIX: √ÅM M√ÄU (${result.colorCast.toUpperCase()})`);
                        }

                        if(result.faceSize === 'portrait_closeup') {
                            smartPrompt += ", (extremely detailed eyes:1.4), (individual eyelashes:1.3)";
                        } else if (result.faceSize === 'group_small_faces' || result.isGroupPhoto) {
                            smartPrompt += ", (clear facial features:1.5), (avoid distorted faces:1.4), (preserve distinct individual facial features:1.6), (avoid uniform AI faces:1.5)";
                            if (result.groupDemographics === 'mixed_ages_genders') {
                                smartPrompt += ", (diverse group of people:1.4), (maintain distinct age differences between children, adults, and elders:1.6), (accurate mixed gender representation:1.4), (multi-generational portrait:1.3)";
                                autoReport.push("PROMPT: B·∫¢O TO√ÄN ƒêA D·∫†NG ƒê·ªò TU·ªîI/GI·ªöI T√çNH");
                            }
                        }

                        if(result.estimatedEra === 'french_colonial' && !result.isMilitary) {
                            smartPrompt += ", (1940s vietnamese clothing style:1.2)";
                        } else if (result.estimatedEra === 'subsidy_period' && !result.isMilitary) {
                             smartPrompt += ", (1980s vietnamese fashion:1.2)";
                        }

                        if (result.hairCondition === 'blurry_mess' || result.faceSize === 'portrait_closeup') {
                            smartPrompt += ", (LZP Hair:1.4), (detailed hair strands:1.5), (remove hair blur)";
                            setChecked('check-hair', true);
                            autoReport.push("AUTO: V·∫º L·∫†I T√ìC (LZP)");
                        }

                        if (result.skinTexture === 'waxy' || result.fabricDetail === 'lost') {
                            smartPrompt += ", (detailed skin pores:1.4), (realistic fabric texture:1.3), (micro details:1.3)";
                            setChecked('check-texture-boost', true);
                            autoReport.push("AUTO: TƒÇNG CHI TI·∫æT");
                        }

                        if (result.hasJewelry) {
                            smartPrompt += ", (detailed jewelry:1.4), (sparkling gold/silver:1.2)";
                            autoReport.push("AUTO: L√ÄM N√âT TRANG S·ª®C");
                        }
                        
                        const promptMain = document.getElementById('prompt-main');
                        if(promptMain) promptMain.value = smartPrompt;
                        
                        const workflowSelect = document.getElementById('kontext-workflow');
                        const moduleContainer = document.getElementById('kontext-module-container');
                        const lightingSelect = document.getElementById('color-grading');
                        const upscaleSelect = document.getElementById('upscale-mode');

                        if (workflowSelect && moduleContainer) {
                            let newWorkflow = 'qwen_edit_pro'; 
                            let toastMsg = "QWEN EDIT PRO"; 

                            if (lightingSelect) {
                                if (result.isBlackAndWhite && result.isOldPhoto) {
                                    lightingSelect.value = 'colorize_bw_old_photo';
                                    autoReport.push("AUTO: T√î M√ÄU ·∫¢NH C≈®");
                                }
                                else if (result.lightingCondition === 'golden_hour') { lightingSelect.value = 'golden_hour_blinds'; autoReport.push("LIGHTING: GOLDEN HOUR"); } 
                                else if (result.lightingCondition === 'moonlight') { lightingSelect.value = 'moonlight_window'; autoReport.push("LIGHTING: MOONLIGHT"); } 
                                else if (result.lightingCondition === 'neon') { lightingSelect.value = 'neon_cyberpunk'; autoReport.push("LIGHTING: NEON"); }
                            }

                            if ((result.damageType === 'blur' || result.isHazy) && upscaleSelect) {
                                upscaleSelect.value = 'invsr_sharp'; 
                                autoReport.push("UPSCALE: INVSR CH·ªêNG RUNG");
                            }

                            if(result.sceneContext === 'wedding') { newWorkflow = 'wedding_kontext_v2'; toastMsg = "WORKFLOW: ·∫¢NH C∆Ø·ªöI"; }
                            else if(result.sceneContext === 'ancient_portrait') { newWorkflow = 'ancient_restore'; toastMsg = "WORKFLOW: TRANH/T∆Ø·ª¢NG"; }
                            else if(result.sceneContext === 'outdoor' || result.sceneContext === 'nature' || result.isNature === true || result.backgroundType === 'complex_outdoor') { 
                                newWorkflow = 'outdoor_mode'; 
                                toastMsg = "WORKFLOW: NGO·∫†I C·∫¢NH"; 
                            }
                            else if (result.isIDPhoto) {
                                if (!result.isOldPhoto && result.damageType === 'none') { newWorkflow = 'white_bg'; toastMsg = "WORKFLOW: T√ÅCH N·ªÄN"; } 
                                else { newWorkflow = 'qwen_edit_pro'; toastMsg = "WORKFLOW: PH·ª§C H·ªíI ·∫¢NH TH·∫∫"; }
                            }
                            else if(result.sceneContext === 'product' && !result.isOldPhoto) { newWorkflow = 'product_mode'; toastMsg = "WORKFLOW: S·∫¢N PH·∫®M"; }

                            if(newWorkflow !== 'default') {
                                workflowSelect.value = newWorkflow;
                                autoReport.push(toastMsg);
                                moduleContainer.classList.add('ring-1', 'ring-[#0A84FF]');
                                setTimeout(() => { moduleContainer.classList.remove('ring-1', 'ring-[#0A84FF]'); }, 3000);
                            }
                        }

                        if (window.innerWidth >= 1024) { openSidebar(); } 
                        
                        playSequentialLog(autoReport); 
                        
                        updateMobileBtnState('run');
                        
                        if (document.getElementById('prompt-main').value !== "") {
                            btnAutoPilot.className = "w-full py-3.5 rounded-[20px] flex items-center justify-center gap-2 transition-all mb-3 bg-[#30D158]/15 border border-[#30D158]/50 shadow-[0_0_15px_rgba(48,209,88,0.2)]";
                            btnAutoPilot.innerHTML = `<svg class="w-5 h-5 text-[#30D158]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg><span class="text-[#30D158] font-bold tracking-wider drop-shadow-sm">ƒê√É SCAN XONG ‚úì</span>`;
                        }
                    }
                } catch(e) { 
                    console.error(e); 
                    showToast("L·ªói Smart Scan: " + e.message, "error"); 
                    updateMobileBtnState('scan'); 
                    btnAutoPilot.disabled = false;
                    btnAutoPilot.className = "w-full py-3.5 rounded-[20px] flex items-center justify-center gap-2 transition-all active:scale-[0.96] mb-3 bg-[#2c2c2e]/80 hover:bg-[#3c3c3e] border border-[#FFD60A]/40 shadow-[0_4px_15px_rgba(255,214,10,0.15)] group";
                    btnAutoPilot.innerHTML = `<svg class="w-4 h-4 text-[#FFD60A] group-hover:rotate-180 transition-transform duration-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg><span class="text-[13px] font-bold text-[#FFD60A] tracking-wider">AUTO SCAN V36.50</span>`;
                } 
            });

            if(processBtn) processBtn.addEventListener('click', runImageProcessing);
            
            const mobRunBtn = document.getElementById('mob-btn-run');
            if(mobRunBtn) {
                mobRunBtn.onclick = runImageProcessing;
            }

            const loadImg = (file) => { 
                if (!file || !file.type.startsWith('image/')) return showToast("Ch·ªâ h·ªó tr·ª£ file ·∫£nh!", "error"); 
                const reader = new FileReader(); 
                reader.onload = (e) => { 
                    const img = new Image(); 
                    img.onload = () => { 
                        state.base64 = e.target.result; state.originalImg = img; state.restoredObj = null; 
                        const ar = img.width / img.height; 
                        if(ar > 1.1) state.aspectRatioType = 'landscape'; 
                        else if(ar < 0.9) state.aspectRatioType = 'portrait'; 
                        else state.aspectRatioType = 'square'; 
                        
                        document.getElementById('img-original').src = state.base64; 
                        document.getElementById('comparison-view').style.display = 'flex'; 
                        document.getElementById('placeholder-state').style.display = 'none'; 
                        document.getElementById('img-modified-wrapper').style.width = '0%'; 
                        document.getElementById('slider-handle').style.left = '0%'; 
                        document.getElementById('slider-handle').style.display = 'none'; 
                        document.querySelector('.comp-label.after').style.display = 'none'; 
                        document.getElementById('scan-log-overlay').innerHTML = ''; 
                        
                        const btnAuto = document.getElementById('btn-auto-pilot');
                        if(btnAuto) {
                            btnAuto.disabled = false;
                            btnAuto.className = "w-full py-3.5 rounded-[20px] flex items-center justify-center gap-2 transition-all active:scale-[0.96] mb-3 bg-[#2c2c2e]/80 hover:bg-[#3c3c3e] border border-[#FFD60A]/40 shadow-[0_4px_15px_rgba(255,214,10,0.15)] group";
                            btnAuto.innerHTML = `<svg class="w-4 h-4 text-[#FFD60A] group-hover:rotate-180 transition-transform duration-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg><span class="text-[13px] font-bold text-[#FFD60A] tracking-wider">AUTO SCAN V36.50</span>`;
                        }

                        showToast(`ƒê√£ t·∫£i ·∫£nh: ${img.width}x${img.height}`, "success"); 
                        updateMobileBtnState('scan'); 
                    }; 
                    img.src = e.target.result; 
                }; 
                reader.readAsDataURL(file); 
            };
            const fileInput = document.getElementById('image-upload'); if(fileInput) fileInput.addEventListener('change', (e) => { if (e.target.files.length > 0) { loadImg(e.target.files[0]); e.target.value = ''; } });
            
            const mobBtnUpload = document.getElementById('mob-btn-upload'), mobBtnScan = document.getElementById('mob-btn-scan'), mobBar = document.getElementById('mobile-action-bar');
            if(mobBar) setTimeout(() => mobBar.classList.remove('translate-y-32', 'opacity-0'), 1000);
            if(mobBtnUpload) mobBtnUpload.onclick = () => document.getElementById('image-upload').click();
            if(mobBtnScan) mobBtnScan.onclick = () => document.getElementById('btn-auto-pilot').click();
            
            const placeholderEl = document.getElementById('placeholder-state');
            if(placeholderEl) {
                placeholderEl.addEventListener('click', () => {
                    document.getElementById('image-upload').click();
                });
            }
            
            const redeemBtn = document.getElementById('btn-submit-recharge');
            const redeemInput = document.getElementById('recharge-input');

            if(redeemBtn) redeemBtn.addEventListener('click', () => { 
                const code = redeemInput.value.trim(); 
                if(!code) return showToast("Vui l√≤ng nh·∫≠p m√£!", "error"); 
                
                const usedCodes = JSON.parse(localStorage.getItem('v35_used_codes') || '[]');
                if (usedCodes.includes(code)) return showToast("M√£ n√†y ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng!", "error");

                if (!code.startsWith('V36-')) return showToast("M√£ kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng V36-...", "error");

                const token = code.substring(4);
                const decrypted = Sec.dec(token);

                if (!decrypted) return showToast("M√£ kh√¥ng h·ª£p l·ªá ho·∫∑c b·ªã l·ªói!", "error");

                const parts = decrypted.split('|');
                if (parts.length < 3) return showToast("D·ªØ li·ªáu m√£ b·ªã h·ªèng!", "error");

                const amount = parseInt(parts[0]);
                const targetMachine = parts[1];

                if (targetMachine !== UserSystem.deviceId) {
                    console.log(`Mismatch: Code for ${targetMachine}, Current is ${UserSystem.deviceId}`);
                    return showToast(`M√£ n√†y b·ªã kh√≥a cho m√°y: ${targetMachine}. B·∫°n kh√¥ng th·ªÉ d√πng!`, "error");
                }

                if (isNaN(amount)) return showToast("L·ªói gi√° tr·ªã!", "error");

                UserSystem.addCredits(amount);
                
                usedCodes.push(code);
                localStorage.setItem('v35_used_codes', JSON.stringify(usedCodes));

                const msg = amount > 0 ? `N·∫°p th√†nh c√¥ng +${amount} ·∫¢NH!` : `ƒê√£ tr·ª´ ${Math.abs(amount)} ·∫¢NH!`;
                showToast(msg, amount > 0 ? "success" : "warning");
                
                document.getElementById('recharge-modal').classList.add('hidden'); 
                redeemInput.value = ''; 
            });
            
            const closeRechargeBtn = document.getElementById('close-recharge');
            if (closeRechargeBtn) closeRechargeBtn.onclick = () => document.getElementById('recharge-modal').classList.add('hidden');
            
            const sliders = document.querySelectorAll('input[type="range"]');
            sliders.forEach(s => s.addEventListener('input', (e) => { const label = document.getElementById(e.target.id.replace('slider', 'val') || e.target.id.replace('weight-slider', 'weight-val')); if(label) label.textContent = e.target.value + (e.target.max > 10 ? '%' : ''); }));
            
            const compContainer = document.getElementById('comp-inner'), imgModWrapper = document.getElementById('img-modified-wrapper'), sliderHandle = document.getElementById('slider-handle');
            if(compContainer) { let isDragging = false; const updateSlider = (percent) => { if(!imgModWrapper || !sliderHandle) return; percent = Math.max(0, Math.min(100, percent)); imgModWrapper.style.width = percent + '%'; sliderHandle.style.left = percent + '%'; }; compContainer.addEventListener('mousedown', () => isDragging = true); compContainer.addEventListener('touchstart', () => isDragging = true); window.addEventListener('mouseup', () => isDragging = false); window.addEventListener('touchend', () => isDragging = false); compContainer.addEventListener('mousemove', (e) => { if(isDragging) { const rect = compContainer.getBoundingClientRect(); updateSlider(((e.clientX - rect.left)/rect.width)*100); } }); compContainer.addEventListener('touchmove', (e) => { if(isDragging) { const rect = compContainer.getBoundingClientRect(); updateSlider(((e.touches[0].clientX - rect.left)/rect.width)*100); } }); }
        });
    </script>
</body>
</html>