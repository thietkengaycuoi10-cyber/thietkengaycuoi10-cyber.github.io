<!DOCTYPE html>
<html lang="vi" class="h-full antialiased">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ZALO: 0352803379 - STUDIO V35.80 (DUAL STORAGE SAFE)</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;700&family=Playfair+Display:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- COPYRIGHT PROTECTION SCRIPT -->
    <script>
        // H·ªÜ TH·ªêNG B·∫¢O V·ªÜ B·∫¢N QUY·ªÄN - ANTI-THEFT SYSTEM
        (function() {
            // 1. Ch·∫∑n chu·ªôt ph·∫£i
            document.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                return false;
            });

            // 2. Ch·∫∑n c√°c ph√≠m t·∫Øt xem code
            document.onkeydown = function(e) {
                if (e.keyCode == 123) return false; // F12
                if (e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) return false; // Ctrl+Shift+I
                if (e.ctrlKey && e.shiftKey && e.keyCode == 'C'.charCodeAt(0)) return false; // Ctrl+Shift+C
                if (e.ctrlKey && e.shiftKey && e.keyCode == 'J'.charCodeAt(0)) return false; // Ctrl+Shift+J
                if (e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) return false; // Ctrl+U
                if (e.ctrlKey && e.keyCode == 'S'.charCodeAt(0)) { // Ctrl+S
                    e.preventDefault();
                    alert("H·ªá th·ªëng ƒë∆∞·ª£c b·∫£o v·ªá b·∫£n quy·ªÅn. Kh√¥ng th·ªÉ l∆∞u trang.");
                    return false;
                }
            };

            console.log("%cD·ª™NG L·∫†I!", "color: red; font-size: 50px; font-weight: bold; text-shadow: 2px 2px #000;");
            console.log("%cƒê√¢y l√† ph·∫ßn m·ªÅm c√≥ b·∫£n quy·ªÅn c·ªßa ZALO: 0352803379.", "color: white; background: red; font-size: 16px; padding: 10px; border-radius: 5px;");
        })();
    </script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['"Plus Jakarta Sans"', 'sans-serif'],
                        body: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                        serif: ['"Playfair Display"', 'serif']
                    },
                    colors: {
                        glass: {
                            100: 'rgba(255, 255, 255, 0.05)',
                            200: 'rgba(255, 255, 255, 0.1)',
                            300: 'rgba(255, 255, 255, 0.15)',
                            border: 'rgba(255, 255, 255, 0.1)',
                        },
                        pro: {
                            500: '#3b82f6', // Pro Blue
                            600: '#2563eb',
                            gold: '#f59e0b', // Replica Gold
                            cine: '#ec4899', // Cinematic Pink
                            smart: '#10b981', // Smart Green
                            flux: '#8b5cf6', // Flux Purple
                            danger: '#f43f5e', // Danger Red
                            cyan: '#06b6d4', // Qwen Cyan
                            real: '#f97316', // RealVis Orange
                            ancient: '#8b4513', // Ancient Brown
                        }
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'blob': 'blob 7s infinite',
                        'scan': 'scan 2s linear infinite',
                        'toast-in': 'toastIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)', 
                        'pulse-glow': 'pulseGlow 2s infinite',
                        'flux-pulse': 'fluxPulse 3s infinite',
                        'real-pulse': 'realPulse 3s infinite',
                        'fade-out': 'fadeOut 0.5s ease-out forwards',
                        'fade-in': 'fadeIn 0.3s ease-out forwards',
                        'enter-up': 'enterUp 0.6s cubic-bezier(0.22, 1, 0.36, 1) forwards',
                    },
                    keyframes: {
                        enterUp: {
                            '0%': { opacity: '0', transform: 'translateY(20px) scale(0.95)' },
                            '100%': { opacity: '1', transform: 'translateY(0) scale(1)' },
                        },
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        },
                        blob: {
                            '0%': { transform: 'translate(0px, 0px) scale(1)' },
                            '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
                            '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
                            '100%': { transform: 'translate(0px, 0px) scale(1)' },
                        },
                        scan: {
                            '0%': { top: '0%', opacity: '0' },
                            '10%': { opacity: '1' },
                            '90%': { opacity: '1' },
                            '100%': { top: '100%', opacity: '0' },
                        },
                        toastIn: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'translateY(5px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        pulseGlow: {
                            '0%, 100%': { opacity: '1', boxShadow: '0 0 10px #10b981' },
                            '50%': { opacity: '0.8', boxShadow: '0 0 20px #10b981' },
                        },
                        fluxPulse: {
                            '0%, 100%': { boxShadow: '0 0 5px #8b5cf6' },
                            '50%': { boxShadow: '0 0 15px #8b5cf6' },
                        },
                        realPulse: {
                            '0%, 100%': { boxShadow: '0 0 5px #f97316' },
                            '50%': { boxShadow: '0 0 15px #f97316' },
                        },
                        fadeOut: {
                            '0%': { opacity: '1', visibility: 'visible' },
                            '100%': { opacity: '0', visibility: 'hidden' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* THEME STYLES - PRO MASTER */
        :root { --ease-spring: cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        
        body { 
            background-color: #050505; 
            background-image: radial-gradient(circle at top right, #0f172a, #050505);
            color: #e2e8f0;
            -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none;
        }
        input, textarea { -webkit-user-select: text; -moz-user-select: text; -ms-user-select: text; user-select: text; }

        /* Background blobs */
        .bg-blob { position: absolute; border-radius: 50%; filter: blur(100px); opacity: 0.15; z-index: 0; animation: blob 15s infinite; }
        .blob-1 { top: -10%; left: -10%; width: 500px; height: 500px; background: #8b5cf6; } 
        .blob-2 { bottom: -10%; right: -10%; width: 500px; height: 500px; background: #3b82f6; animation-delay: 2s; }
        
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 20px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.2); }

        .glass-panel { background: rgba(10, 11, 15, 0.95); backdrop-filter: blur(20px); border-right: 1px solid rgba(255, 255, 255, 0.08); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5); }
        .pro-input { background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.08); color: #cbd5e1; transition: all 0.2s; font-size: 11px; border-radius: 6px; padding-left: 10px; }
        .pro-input:focus { background: rgba(255, 255, 255, 0.06); border-color: #8b5cf6; outline: none; }
        select { color-scheme: dark; } select option { background-color: #0f172a; color: #e2e8f0; padding: 12px; } select optgroup { background-color: #020617; color: #94a3b8; font-weight: 700; }

        .module-group { border: 1px solid rgba(255, 255, 255, 0.05); background: rgba(255, 255, 255, 0.01); border-radius: 8px; margin-bottom: 6px; overflow: hidden; }
        .module-header { background: rgba(255, 255, 255, 0.02); transition: background 0.2s; padding: 10px 12px; }
        .module-header:hover { background: rgba(255, 255, 255, 0.04); }
        .module-content { display: grid; grid-template-rows: 0fr; transition: grid-template-rows 0.3s ease, opacity 0.3s ease; opacity: 0; }
        .module-content.open { grid-template-rows: 1fr; opacity: 1; }
        .module-content.open .module-inner { padding: 10px 12px; }
        .module-inner { min-height: 0; overflow: hidden; }
        
        .chk-pro { appearance: none; width: 14px; height: 14px; border-radius: 3px; border: 1px solid rgba(148, 163, 184, 0.4); background: transparent; display: grid; place-content: center; cursor: pointer; transition: all 0.2s; }
        .chk-pro::before { content: ""; width: 8px; height: 8px; transform: scale(0); background: #e2e8f0; border-radius: 2px; transition: transform 0.2s; }
        .chk-pro:checked::before { transform: scale(1); }
        .chk-pro:checked { border-color: #8b5cf6; background: #8b5cf6; }
        .chk-gold:checked { border-color: #f59e0b; background: #f59e0b; }
        .chk-red:checked { border-color: #ef4444; background: #ef4444; }
        .chk-real:checked { border-color: #f97316; background: #f97316; }

        .slider-red::-webkit-slider-thumb { background: #e2e8f0; }
        .slider-blue::-webkit-slider-thumb { background: #3b82f6; }
        .slider-gold::-webkit-slider-thumb { background: #f59e0b; box-shadow: 0 0 10px #f59e0b; }
        .slider-pink::-webkit-slider-thumb { background: #ec4899; box-shadow: 0 0 10px #ec4899; }
        .slider-green::-webkit-slider-thumb { background: #10b981; box-shadow: 0 0 10px #10b981; }
        .slider-flux::-webkit-slider-thumb { background: #8b5cf6; box-shadow: 0 0 10px #8b5cf6; }
        .slider-cyan::-webkit-slider-thumb { background: #06b6d4; box-shadow: 0 0 10px #06b6d4; }
        .slider-real::-webkit-slider-thumb { background: #f97316; box-shadow: 0 0 10px #f97316; }

        .btn-primary-modern { background: #3b82f6; border: 1px solid rgba(255,255,255,0.1); transition: all 0.2s ease; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .btn-primary-modern:hover { background: #2563eb; transform: translateY(-1px); }
        .btn-gold-modern { background: linear-gradient(135deg, #b45309 0%, #f59e0b 100%); border: 1px solid rgba(255,215,0,0.3); color: white; box-shadow: 0 0 15px rgba(245, 158, 11, 0.3); }
        .btn-gold-modern:hover { transform: translateY(-1px); box-shadow: 0 0 25px rgba(245, 158, 11, 0.5); }
        .btn-smart-modern { background: linear-gradient(135deg, #059669 0%, #10b981 100%); border: 1px solid rgba(16, 185, 129, 0.3); color: white; box-shadow: 0 0 15px rgba(16, 185, 129, 0.3); }
        .btn-smart-modern:hover { transform: translateY(-1px); box-shadow: 0 0 25px rgba(16, 185, 129, 0.5); }
        .btn-flux-modern { background: linear-gradient(135deg, #6d28d9 0%, #8b5cf6 100%); border: 1px solid rgba(139, 92, 246, 0.3); color: white; box-shadow: 0 0 15px rgba(139, 92, 246, 0.3); }
        .btn-flux-modern:hover { transform: translateY(-1px); box-shadow: 0 0 25px rgba(139, 92, 246, 0.5); }
        .btn-real-modern { background: linear-gradient(135deg, #c2410c 0%, #f97316 100%); border: 1px solid rgba(249, 115, 22, 0.3); color: white; box-shadow: 0 0 15px rgba(249, 115, 22, 0.3); }
        .btn-real-modern:hover { transform: translateY(-1px); box-shadow: 0 0 25px rgba(249, 115, 22, 0.5); }
        .btn-ancient-modern { background: linear-gradient(135deg, #6b21a8 0%, #a855f7 100%); border: 1px solid rgba(168, 85, 247, 0.3); color: white; box-shadow: 0 0 15px rgba(168, 85, 247, 0.3); }
        .btn-ancient-modern:hover { transform: translateY(-1px); box-shadow: 0 0 25px rgba(168, 85, 247, 0.5); }

        .modal-fade-in { animation: modalFadeIn 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes modalFadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        
        /* SECURITY GATE STYLES (UPDATED FOR IP LOGIN) */
        .gate-backdrop {
            position: fixed; inset: 0; z-index: 9999;
            background: rgba(5, 5, 8, 0.85); /* Fallback */
            display: flex; align-items: center; justify-content: center;
            transition: opacity 0.5s ease;
        }
        
        .shimmer-text {
            background: linear-gradient(90deg, #fff 0%, #a78bfa 50%, #fff 100%);
            background-size: 200% auto;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: shine 3s linear infinite;
        }
        @keyframes shine { to { background-position: 200% center; } }
    </style>
</head>

<body class="text-slate-300 font-sans h-screen flex overflow-hidden select-none relative" oncontextmenu="return false;">
    
    <!-- SECURITY GATE (REDESIGNED: SOFTER & PROFESSIONAL) -->
    <div id="security-gate" class="fixed inset-0 z-[9999] flex items-center justify-center bg-[#050505]/90 backdrop-blur-3xl transition-opacity duration-500">
        <!-- Ambient Background Glow (Subtle) -->
        <div class="absolute inset-0 overflow-hidden pointer-events-none">
            <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[600px] h-[600px] bg-violet-600/10 rounded-full blur-[120px] animate-pulse"></div>
            <div class="absolute bottom-0 right-0 w-[400px] h-[400px] bg-blue-600/10 rounded-full blur-[100px]"></div>
        </div>
        
        <!-- Main Card Container -->
        <div class="relative z-10 w-full max-w-[400px] bg-white/[0.02] border border-white/5 rounded-3xl p-8 shadow-2xl animate-enter-up flex flex-col items-center">
            
            <!-- ADMIN KEY BUTTON (Discrete Top Right) -->
            <button id="gate-admin-key" class="absolute top-4 right-4 text-slate-600 hover:text-white transition-colors p-2 z-50 rounded-full hover:bg-white/5" title="ƒêƒÉng nh·∫≠p Admin">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path></svg>
            </button>

            <!-- Logo / Brand Section -->
            <div class="flex flex-col items-center mb-8">
                <div class="w-16 h-16 rounded-2xl bg-gradient-to-tr from-violet-600 to-blue-600 p-[1px] mb-4 shadow-lg shadow-violet-500/20 rotate-3 hover:rotate-0 transition-transform duration-500 cursor-pointer group">
                     <div class="w-full h-full rounded-2xl bg-[#0a0a0f] flex items-center justify-center relative overflow-hidden group-hover:bg-opacity-80 transition-all">
                         <div class="absolute inset-0 bg-violet-500/20 animate-pulse"></div>
                         <svg class="w-8 h-8 text-white relative z-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                     </div>
                </div>
                
                <!-- EDITED: TITLE GATE -->
                <h1 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-white via-slate-200 to-slate-400 tracking-tight mb-1">PH·ª§C CH·∫æ ·∫¢NH</h1>
                <div class="flex items-center gap-2 opacity-70">
                    <div class="h-[1px] w-8 bg-gradient-to-r from-transparent to-violet-500"></div>
                    <p class="text-[10px] text-violet-300 font-mono tracking-[0.3em] uppercase">Professional AI</p>
                    <div class="h-[1px] w-8 bg-gradient-to-l from-transparent to-violet-500"></div>
                </div>
            </div>
            
            <!-- IP & Login Section -->
            <div class="w-full space-y-4">
                <!-- IP Display Box -->
                <div class="relative group w-full">
                    <div class="absolute -inset-0.5 bg-gradient-to-r from-violet-600 to-blue-600 rounded-2xl blur opacity-10 group-hover:opacity-30 transition duration-500"></div>
                    <div class="relative bg-black/40 border border-white/10 rounded-2xl p-4 flex flex-col items-center justify-center transition-all group-hover:border-white/20">
                        <span class="text-[9px] text-slate-500 uppercase tracking-widest font-bold mb-1.5">THI·∫æT B·ªä TRUY C·∫¨P</span>
                        <div class="flex items-center gap-2 h-8">
                            <!-- IP Display with Shimmer Effect -->
                            <span id="gate-ip-display" class="font-mono text-sm font-bold text-white tracking-wider shimmer-text">ƒêang k·∫øt n·ªëi...</span>
                            <div id="gate-loading-spinner" class="w-3 h-3 border-2 border-white/20 border-t-white rounded-full animate-spin"></div>
                        </div>
                    </div>
                </div>

                <!-- Submit Button - EDITED: TEXT and BACKGROUND -->
                <button id="gate-submit" class="w-full py-3.5 bg-gradient-to-r from-indigo-100 to-violet-100 text-slate-900 hover:to-white rounded-xl text-xs font-bold tracking-[0.15em] transition-all active:scale-[0.98] shadow-[0_0_20px_rgba(255,255,255,0.1)] flex items-center justify-center gap-2 group disabled:opacity-50 disabled:cursor-not-allowed overflow-hidden relative" disabled>
                    <span class="relative z-10">V√ÄO PH·ª§C CH·∫æ ·∫¢NH</span>
                    <svg class="w-3.5 h-3.5 relative z-10 group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                </button>
            </div>
            
            <!-- Status Text -->
            <div class="mt-6 h-4 flex items-center justify-center">
                <p id="gate-status" class="text-[10px] text-slate-500 transition-colors animate-pulse">ƒêang qu√©t th√¥ng tin thi·∫øt b·ªã...</p>
            </div>

            <!-- Footer Info -->
            <div class="absolute bottom-4 left-0 right-0 text-center opacity-30 pointer-events-none">
                <p class="text-[8px] font-mono">SECURE GATEWAY ‚Ä¢ IP VERIFICATION</p>
            </div>
        </div>
    </div>

    <div class="bg-blob blob-1"></div><div class="bg-blob blob-2"></div>
    <div id="toast-container" class="fixed top-6 right-6 z-[100] flex flex-col gap-3 pointer-events-none"></div>
    
    <div class="flex w-full h-full relative z-10 backdrop-blur-[1px]" id="fullscreen-target">
        <!-- Sidebar and Main Content (Same as before) -->

<aside id="sidebar" class="w-[360px] flex-shrink-0 glass-panel mobile-sidebar-bg flex flex-col transition-transform duration-500 ease-[cubic-bezier(0.33,1,0.68,1)] absolute z-50 h-full lg:relative lg:translate-x-0 -translate-x-full">
            <div class="h-14 px-4 flex items-center justify-between border-b border-white/5 bg-white/[0.02]">
                <div class="flex flex-col">
                    <!-- EDITED: SIDEBAR TITLE -->
                    <h1 class="text-xs font-bold tracking-widest text-violet-500">PH·ª§C CH·∫æ ·∫¢NH</h1>
                    <div class="flex items-center gap-2">
                        <!-- EDITED: REPLACE ZALO WITH IP -->
                        <span id="top-bar-ip" class="text-[9px] text-slate-400 font-mono">IP: Loading...</span>
                        <span class="w-1 h-1 rounded-full bg-violet-500"></span>
                        <span class="text-[9px] text-violet-400 font-bold">V35.80 (SAFE STORAGE)</span>
                    </div>
                </div>
                
                <div class="flex items-center gap-3">
                    <div class="flex flex-col items-end mr-1" id="credit-display">
                        <span class="text-[8px] text-slate-400 font-bold uppercase tracking-wider">CREDITS</span>
                        <span class="text-xs font-mono font-bold text-yellow-400 shadow-[0_0_10px_rgba(250,204,21,0.3)]" id="credit-count">---</span>
                    </div>
                    <!-- REMOVED ADMIN BUTTON AS REQUESTED -->
                    <button id="close-sidebar-mobile" class="lg:hidden text-slate-400 p-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 18L18 6M6 6l12 12"></path></svg></button>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto p-4 scroll-smooth custom-scrollbar space-y-2">
                <!-- 1. MAIN UPLOAD -->
                <div class="relative group">
                    <input type="file" id="image-upload" accept="image/*" style="position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0;">
                    <label id="drop-zone" for="image-upload" class="flex flex-col items-center justify-center w-full h-28 border border-dashed border-violet-500/50 rounded-lg cursor-pointer bg-white/[0.02] hover:bg-violet-900/[0.1] hover:border-violet-500 transition-all duration-200">
                        <div id="upload-placeholder" class="flex flex-col items-center pointer-events-none">
                            <svg class="w-5 h-5 text-violet-500 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l-1.586-1.586a2 2 0 00-2.828 0L6 18H4a2 2 0 01-2-2V6a2 2 0 01-2-2V6a2 2 0 012-2h16a2 2 0 012 2v8a2 2 0 01-2 2h-2m-4-4l-3 3m0 0l-3-3m3 3V4"></path></svg>
                            <span class="text-[10px] font-bold text-slate-400 uppercase">T·∫£i ·∫£nh g·ªëc (K√©o th·∫£ ho·∫∑c B·∫•m v√†o)</span>
                        </div>
                    </label>
                </div>

                <!-- 2. AUTO-PILOT BUTTON -->
                <button id="btn-auto-pilot" class="w-full py-2.5 mb-3 btn-flux-modern text-white rounded-lg flex items-center justify-center gap-2 transition-all disabled:opacity-50 disabled:cursor-not-allowed shadow-[0_0_15px_rgba(139,92,246,0.2)]">
                    <svg class="w-4 h-4 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
                    <span class="text-[10px] font-bold tracking-widest">AUTO SCAN V35.60 (AUTO-SIZE)</span>
                </button>

                <!-- FLUX KONTEXT (LZP) -->
                <div class="relative group p-2 rounded-lg border border-violet-500/30 bg-violet-500/5 mb-3 animate-flux-pulse" id="kontext-module-container">
                    <div class="flex items-center gap-2 mb-2">
                         <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="mode-flux" class="sr-only peer" checked>
                            <div class="w-9 h-5 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-violet-500"></div>
                        </label>
                        <div class="flex-1">
                            <span class="block text-[10px] font-bold text-violet-400 tracking-wide">üöÄ FLUX / REALVIS ENGINE</span>
                            <span class="block text-[9px] text-violet-500/70">Core: Kontext, SUPIR, ReActor, UltraSharp</span>
                        </div>
                    </div>
                    
                    <!-- WORKFLOW SELECTOR -->
                    <div class="pl-11 pr-1 border-t border-violet-500/20 pt-2" id="workflow-container">
                        <label class="block text-[9px] font-bold text-violet-300 mb-1">CH·ªåN QUY TR√åNH (WORKFLOW PRESETS)</label>
                        <select id="kontext-workflow" class="pro-input w-full py-1.5 cursor-pointer bg-violet-900/20 border-violet-500/30 text-violet-200 transition-all duration-500">
                            <option value="replica_pro" class="text-yellow-400 font-bold">üß¨ SI√äU TH·ª∞C (REPLICA PRO) - KH√ìA C·∫§U TR√öC S√ÇU</option>
                            <option value="default">‚ú® M·∫∑c ƒë·ªãnh (Kontext Base + OldPhoto-2)</option>
                            <option value="ancient_restore" class="text-purple-400 font-bold">üèØ Ph·ª•c ch·∫ø Tranh/T∆∞·ª£ng C·ªï (ReActor + ControlNet)</option>
                            <option value="realvis_v5" class="text-orange-400 font-bold">ü¶Å RealVisXL V5 (Ph·ª•c h·ªìi c·∫•u tr√∫c s√¢u)</option>
                            <option value="qwen_restore_full" class="text-cyan-400 font-bold">‚ö° Qwen V2.5 Full Restore (Prompt G·ªëc JSON)</option>
                            <option value="qwen_lightning">‚ö° Qwen V2.5-VL (Lightning Fast)</option>
                            <option value="wedding_kontext_v2" class="text-pink-400 font-bold">üë∞ Wedding Kontext V2 (Full JSON)</option>
                            <option value="wedding_pro">üíç Wedding Pro + Upscale (·∫¢nh C∆∞·ªõi - C∆° b·∫£n)</option>
                            <option value="old_photo_v1">üìú Kontext V1.0 Native (Ref-Latent Boost)</option>
                            <option value="outdoor_mode">üèûÔ∏è Ph·ª•c h·ªìi Ngo·∫°i C·∫£nh (IC-Light + PowerPaint)</option>
                            <option value="product_mode">üõçÔ∏è ·∫¢nh S·∫£n Ph·∫©m / Th∆∞∆°ng M·∫°i (Ecommerce)</option>
                            <option value="white_bg">‚¨ú T√°ch N·ªÅn Tr·∫Øng (BiRefNet + RMBG-2.0)</option>
                        </select>
                         <div class="text-[8px] text-violet-400/60 mt-1 italic" id="workflow-desc">S·ª≠ d·ª•ng OldPhoto-2.safetensors (0.87)</div>
                    </div>
                </div>

                <!-- REPLICA MODE -->
                <div class="relative group p-2 rounded-lg border border-yellow-500/30 bg-yellow-500/5 mb-3">
                    <div class="flex items-center gap-2">
                         <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="mode-replica" class="sr-only peer">
                            <div class="w-9 h-5 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-yellow-500"></div>
                        </label>
                        <div class="flex-1">
                            <span class="block text-[10px] font-bold text-yellow-500 tracking-wide">üíé CH·∫æ ƒê·ªò SAO Y B·∫¢N CH√çNH (ALIGN LOCK)</span>
                            <span class="block text-[9px] text-yellow-600/70">KH√ìA G√ìC M·∫∂T - CH·ªêNG B·ªä L·∫¨T H√åNH</span>
                        </div>
                    </div>
                </div>

                <!-- MODULE: QU√ÇN S·ª¨ VI·ªÜT NAM -->
                <div class="module-group border-yellow-500/30" id="module-military">
                    <button id="toggle-military" class="w-full flex justify-between items-center module-header bg-yellow-500/10 hover:bg-yellow-500/20">
                        <span class="text-[10px] font-bold text-yellow-500 tracking-wide uppercase flex items-center gap-2">üáªüá≥ QU√ÇN S·ª¨ & K·ª∂ V·∫¨T (FULL UPGRADE)</span>
                        <svg class="w-3 h-3 text-yellow-500 toggle-icon" id="icon-military" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="content-military" class="module-content">
                        <div class="module-inner space-y-2">
                             <div class="space-y-1">
                                <label class="section-label text-yellow-600/80">Qu√¢n ch·ªßng / L·ª±c l∆∞·ª£ng</label>
                                <select id="mil-branch" class="pro-input w-full py-1.5 save-input">
                                    <option value="">-- T·ª± ƒë·ªông / Kh√¥ng ch·ªçn --</option>
                                    <option value="vietnamese army ground force, red collar tabs">üü• L·ª•c qu√¢n (H√†m ƒê·ªè)</option>
                                    <option value="vietnamese air force, blue collar tabs">üü¶ Ph√≤ng Kh√¥ng - Kh√¥ng Qu√¢n (H√†m Xanh Tr·ªùi)</option>
                                    <option value="vietnamese navy, navy blue uniform, white striped collar">‚öì H·∫£i qu√¢n (√Åo y·∫øm/H√†m T√≠m than)</option>
                                    <option value="vietnamese border guard, green collar tabs">üü© B·ªô ƒë·ªôi Bi√™n ph√≤ng (H√†m Xanh l√°)</option>
                                    <option value="vietnamese public security, green uniform, red collar tabs">üëÆ C√¥ng an Nh√¢n d√¢n (C·∫£nh ph·ª•c)</option>
                                    <option value="vietnamese youth volunteer force, dark green uniform">‚≠ê Thanh ni√™n Xung phong</option>
                                </select>
                             </div>
                             <div class="space-y-1">
                                <label class="section-label text-yellow-600/80">Qu√¢n ph·ª•c / Th·ªùi k·ª≥</label>
                                <select id="mil-uniform" class="pro-input w-full py-1.5 save-input">
                                    <option value="">-- T·ª± ƒë·ªông / M·∫∑c ƒë·ªãnh --</option>
                                    <option value="wearing tran thu shirt, padded cotton jacket, viet minh era">√Åo Tr·∫•n Th·ªß (Ch·ªëng Ph√°p)</option>
                                    <option value="wearing to chau uniform, plain green fatigue, vietnam war era">Qu√¢n ph·ª•c T√¥ Ch√¢u (Ch·ªëng M·ªπ)</option>
                                    <option value="wearing K82 uniform, formal military tunic">Qu√¢n ph·ª•c K82 (Bao c·∫•p/Bi√™n gi·ªõi)</option>
                                    <option value="wearing K94 uniform, modern formal suit">Qu√¢n ph·ª•c K94/K03 (Hi·ªán ƒë·∫°i)</option>
                                    <option value="wearing camouflage special force uniform">ƒê·∫∑c c√¥ng (R·∫±n ri/Ng·ª•y trang)</option>
                                </select>
                             </div>
                             <div class="space-y-1">
                                <label class="section-label text-yellow-600/80">M≈© & N√≥n (Ch√≠nh x√°c)</label>
                                <select id="hat-select" class="pro-input w-full py-1.5 save-input" data-key="hatSelect">
                                    <option value="">-- Kh√¥ng x·ª≠ l√Ω M≈© --</option>
                                    <option value="wear vietnamese pith helmet, hard pith helmet, dark green color, rounded shape, red badge with yellow star">M≈© C·ªëi (L√≠nh B·∫Øc Vi·ªát) - C·ª©ng & Tr√≤n</option>
                                    <option value="wear vietnamese soft cap, boonie hat, green fabric, red star badge">M≈© Tai B√®o (M·ªÅm)</option>
                                    <option value="wear vietnamese officer kepi hat, mixed red and green color, gold chin strap, red badge with gold star">M≈© Kepi (Sƒ© quan - Sao n·ªïi)</option>
                                    <option value="wear vietnamese police kepi hat, green color, red band, gold badge">M≈© Kepi (C√¥ng an)</option>
                                    <option value="wear vietnamese bamboo helmet, cloth covered">M≈© Nan (B·ªçc v·∫£i)</option>
                                </select>
                             </div>
                             <div class="space-y-1">
                                <label class="section-label text-yellow-600/80">C·∫•p b·∫≠c / Qu√¢n h√†m</label>
                                <select id="rank-select" class="pro-input w-full py-1.5 save-input" data-key="rankSelect">
                                    <option value="">-- T·ª± ƒë·ªông / Kh√¥ng ch·ªçn --</option>
                                    <option value="no_rank_insignia">üö´ KH√îNG ƒêEO H√ÄM (√ÅO TR∆†N)</option>
                                    <optgroup label="H·∫° sƒ© quan / Chi·∫øn sƒ©">
                                        <option value="plain red collar tabs, soldier rank">Chi·∫øn sƒ© (H√†m tr∆°n/Binh nh√¨-nh·∫•t)</option>
                                        <option value="red collar tabs with one yellow stripe">H·∫° sƒ© (1 g·∫°ch)</option>
                                        <option value="red collar tabs with two yellow stripes">Trung sƒ© (2 g·∫°ch)</option>
                                        <option value="red collar tabs with three yellow stripes">Th∆∞·ª£ng sƒ© (3 g·∫°ch)</option>
                                    </optgroup>
                                    <optgroup label="Sƒ© quan (Sao + G·∫°ch)">
                                        <option value="red collar tabs with one star, officer rank">Thi·∫øu √∫y (1 sao)</option>
                                        <option value="red collar tabs with two stars, officer rank">Trung √∫y (2 sao)</option>
                                        <option value="red collar tabs with three stars, officer rank">Th∆∞·ª£ng √∫y (3 sao)</option>
                                        <option value="red collar tabs with four stars, officer rank">ƒê·∫°i √∫y (4 sao)</option>
                                    </optgroup>
                                </select>
                             </div>
                             <div class="space-y-1">
                                <label class="section-label text-yellow-600/80">Hu√¢n / Huy Ch∆∞∆°ng</label>
                                <div class="grid grid-cols-2 gap-1.5">
                                    <div class="flex items-center gap-2"><input id="check-sao-vang" type="checkbox" class="chk-pro save-input"><label for="check-sao-vang" class="text-[9px] text-yellow-400">Hu√¢n ch∆∞∆°ng Sao V√†ng</label></div>
                                    <div class="flex items-center gap-2"><input id="check-khang-chien" type="checkbox" class="chk-pro save-input"><label for="check-khang-chien" class="text-[9px] text-slate-300">HC Kh√°ng Chi·∫øn</label></div>
                                    <div class="flex items-center gap-2"><input id="check-chien-si" type="checkbox" class="chk-pro save-input"><label for="check-chien-si" class="text-[9px] text-slate-300">Danh hi·ªáu Chi·∫øn sƒ©</label></div>
                                    <div class="flex items-center gap-2"><input id="check-doan" type="checkbox" class="chk-pro save-input"><label for="check-doan" class="text-[9px] text-cyan-400">Huy hi·ªáu ƒêo√†n</label></div>
                                </div>
                             </div>
                             <div class="flex items-center gap-2 p-1.5 rounded border border-yellow-500/20 bg-yellow-500/10 mt-1">
                                <input id="check-insignia-boost" type="checkbox" class="chk-pro save-input">
                                <label for="check-insignia-boost" class="cursor-pointer select-none flex-1">
                                    <span class="block text-[10px] font-bold text-yellow-300">TƒÇNG N√âT QU√ÇN H√ÄM & LOGO</span>
                                    <span class="block text-[8px] text-yellow-500/70">X·ª≠ l√Ω ri√™ng vi·ªÅn Sao M≈© & Chi ti·∫øt kim lo·∫°i</span>
                                </label>
                            </div>
                             <div class="flex items-center gap-2 p-1.5 rounded border border-red-500/20 bg-red-500/10 mt-1">
                                <input id="block-rank" type="checkbox" class="chk-pro chk-red save-input">
                                <label for="block-rank" class="cursor-pointer select-none flex-1">
                                    <span class="block text-[10px] font-bold text-red-300">CH·∫∂N V·∫º QU√ÇN H√ÄM (GI·ªÆ C·ªî √ÅO TR∆†N)</span>
                                    <span class="block text-[8px] text-red-500/70">Tick v√†o n·∫øu ·∫£nh g·ªëc kh√¥ng c√≥ ve/h√†m m√† AI c·ª© v·∫Ω th√™m</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- MODULE: TEXTURE & LIGHTING -->
                <div class="module-group border-pink-500/30" id="module-cinematic">
                    <button id="toggle-cinematic" class="w-full flex justify-between items-center module-header bg-pink-500/10 hover:bg-pink-500/20">
                        <span class="text-[10px] font-bold text-pink-500 tracking-wide uppercase flex items-center gap-2">üéûÔ∏è LIGHTING & M√ÄU PHIM</span>
                        <svg class="w-3 h-3 text-pink-500 toggle-icon" id="icon-cinematic" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="content-cinematic" class="module-content open" style="grid-template-rows: 1fr; opacity: 1;">
                        <div class="module-inner space-y-3">
                             <div>
                                <div class="flex justify-between text-[10px] text-pink-400 font-bold mb-1">
                                    <span>ƒê·ªò NHI·ªÑU H·∫†T (FLUX GRAIN)</span>
                                    <span id="grain-val">3% (Kontext Default)</span>
                                </div>
                                <input type="range" id="grain-slider" min="0" max="100" value="3" class="slider-pink w-full h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                             </div>
                             <select id="color-grading" class="pro-input w-full py-1.5 save-input">
                                 <option value="">-- M√†u g·ªëc (Standard) --</option>
                                 <optgroup label="‚ú® Kontext Lighting (T·ª´ JSON)">
                                     <option value="rembrandt_lighting">üé¨ Rembrandt (ƒêi·ªán ·∫£nh/K·ªãch t√≠nh)</option>
                                     <option value="golden_hour_backlight">üåÖ Golden Hour (N·∫Øng chi·ªÅu ng∆∞·ª£c s√°ng)</option>
                                     <option value="soft_diffused_light">‚òÅÔ∏è Soft Diffused (√Ånh s√°ng m·ªÅm)</option>
                                     <option value="neon_cyberpunk">üåÉ Neon Lights (Hi·ªán ƒë·∫°i/T∆∞∆°ng ph·∫£n)</option>
                                 </optgroup>
                                 <optgroup label="üéûÔ∏è M√†u Phim C·ªï ƒêi·ªÉn">
                                     <option value="kodak gold 200 style, warm tone, vintage film look">Kodak Gold (·∫§m √°p)</option>
                                     <option value="kodak portra 400 style, natural skin tone, fine grain" selected>Kodak Portra (Chu·∫©n JSON)</option>
                                     <option value="fujifilm pro 400h style, cool tone, soft green tint">Fujifilm (Trong tr·∫ªo)</option>
                                     <option value="sepia tone, antique photo style">Sepia (M√†u x∆∞a c≈©)</option>
                                 </optgroup>
                             </select>
                        </div>
                    </div>
                </div>

                <!-- MODULE: EXPOSURE & RELIGHTING -->
                <div class="module-group border-cyan-500/30" id="module-exposure">
                    <button id="toggle-exposure" class="w-full flex justify-between items-center module-header bg-cyan-500/10 hover:bg-cyan-500/20">
                        <span class="text-[10px] font-bold text-cyan-400 tracking-wide uppercase flex items-center gap-2">‚òÄÔ∏è X·ª¨ L√ù CH√ÅY S√ÅNG (QWEN EDIT)</span>
                        <svg class="w-3 h-3 text-cyan-400 toggle-icon" id="icon-exposure" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="content-exposure" class="module-content">
                        <div class="module-inner space-y-2">
                             <div class="flex items-center gap-2 p-1.5 rounded border border-cyan-500/20 bg-cyan-500/10">
                                <input id="check-qwen-exposure" type="checkbox" class="chk-pro save-input">
                                <label for="check-qwen-exposure" class="cursor-pointer select-none flex-1">
                                    <span class="block text-[10px] font-bold text-cyan-300">K√çCH HO·∫†T QWEN EDIT (V2511)</span>
                                    <span class="block text-[8px] text-cyan-500/70">Core: Qwen-Image-Edit + LoRA ÁßªÈô§ÂÖâÂΩ±</span>
                                </label>
                            </div>
                            <div class="space-y-1.5 pl-2 border-l border-cyan-500/10 ml-1">
                                <div class="flex items-center gap-2">
                                    <input id="check-remove-shadow" type="checkbox" class="chk-pro save-input" checked>
                                    <label for="check-remove-shadow" class="text-[10px] text-slate-300 cursor-pointer">LoRA: ÁßªÈô§ÂÖâÂΩ± (X√≥a b√≥ng g·∫Øt)</label>
                                </div>
                                 <div class="flex items-center gap-2">
                                    <input id="check-soft-light" type="checkbox" class="chk-pro save-input" checked>
                                    <label for="check-soft-light" class="text-[10px] text-slate-300 cursor-pointer">Prompt: Soft Light (√Ånh s√°ng m·ªÅm)</label>
                                </div>
                            </div>
                            <div class="border border-white/10 rounded bg-black/20 p-2">
                                <div class="flex justify-between text-[10px] text-cyan-400 font-bold mb-1">
                                    <span>C∆Ø·ªúNG ƒê·ªò X·ª¨ L√ù (STRENGTH)</span>
                                    <span id="exposure-val" class="text-slate-200">1.0</span>
                                </div>
                                <input type="range" id="exposure-slider" min="0.1" max="2.0" step="0.1" value="1.0" class="slider-cyan w-full h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- REFERENCE FACE UPLOAD -->
                <div class="relative group p-2 rounded-lg bg-white/[0.02] border border-white/5 mb-3">
                     <div class="flex gap-2 items-center mb-2">
                         <div id="ref-img-preview" class="w-8 h-8 rounded bg-black/40 border border-white/10 flex-shrink-0 bg-cover bg-center" style="display:none;"></div>
                         <input type="file" id="ref-upload" accept="image/*" class="hidden">
                         <label for="ref-upload" class="flex-1 h-8 border border-dashed border-slate-700 rounded flex items-center justify-center cursor-pointer hover:bg-white/5 transition-colors">
                             <span id="ref-text" class="text-[10px] text-slate-500 font-medium">+ ·∫¢nh tham chi·∫øu (TƒÉng gi·ªëng)</span>
                         </label>
                         <button id="clear-ref" class="w-8 h-8 rounded bg-white/5 hover:bg-white/10 text-slate-400 flex items-center justify-center transition-colors" style="display:none;">
                             <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                         </button>
                     </div>
                     <div class="flex items-center gap-2 px-1">
                        <input id="check-reactor" type="checkbox" class="chk-pro save-input">
                        <label for="check-reactor" class="flex-1 cursor-pointer select-none">
                            <span class="block text-[10px] font-bold text-purple-400">K√≠ch ho·∫°t Face Swap (ReActor)</span>
                            <span class="block text-[8px] text-purple-500/70">Thay th·∫ø khu√¥n m·∫∑t thay v√¨ tr·ªôn (InsightFace)</span>
                        </label>
                    </div>
                </div>

                <!-- MODULE 1: X·ª¨ L√ù H√åNH ·∫¢NH -->
                <div class="module-group" id="module-processing">
                    <button id="toggle-processing" class="w-full flex justify-between items-center module-header">
                        <span class="text-[10px] font-bold text-slate-200 tracking-wide uppercase flex items-center gap-2">üõ†Ô∏è X·ª¨ L√ù H√åNH ·∫¢NH (LZP DETAIL)</span>
                        <svg class="w-3 h-3 text-slate-600 toggle-icon" id="icon-processing" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="content-processing" class="module-content open" style="grid-template-rows: 1fr; opacity: 1;">
                        <div class="module-inner space-y-3">
                             <div class="border border-violet-500/30 rounded bg-violet-900/10 p-2 mb-2" id="creativity-container">
                                <div class="flex justify-between text-[10px] text-violet-300 font-bold mb-1">
                                    <span>TU√ÇN TH·ª¶ G·ªêC</span>
                                    <span>CHI TI·∫æT FLUX</span>
                                </div>
                                <input type="range" id="creativity-slider" min="0" max="100" value="45" class="slider-flux w-full h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                                <div class="text-[9px] text-center text-violet-400 mt-1" id="creativity-val">M·ª©c 45% (LZP Balanced)</div>
                             </div>

                             <div class="grid-compact">
                                 <div class="flex items-center gap-2 p-1.5 rounded border border-white/5 bg-white/[0.02]" id="container-dehaze"><input id="check-dehaze" type="checkbox" class="chk-pro save-input"><label for="check-dehaze" class="cursor-pointer text-[10px] text-slate-300">Kh·ª≠ s∆∞∆°ng m√π</label></div>
                                 <div class="flex items-center gap-2 p-1.5 rounded border border-white/5 bg-white/[0.02]" id="container-contrast-fix"><input id="check-contrast-fix" type="checkbox" class="chk-pro save-input"><label for="check-contrast-fix" class="cursor-pointer text-[10px] font-bold text-violet-300">Kontext Contrast (Match)</label></div>
                                 <div class="flex items-center gap-2 p-1.5 rounded border border-white/5 bg-white/[0.02]"><input id="check-uniform-skin" type="checkbox" class="chk-pro save-input" checked><label for="check-uniform-skin" class="cursor-pointer text-[10px] text-slate-300">ƒê·ªÅu m√†u da</label></div>
                                 <div class="flex items-center gap-2 p-1.5 rounded border border-white/5 bg-white/[0.02]"><input id="check-vibrant" type="checkbox" class="chk-pro save-input" checked><label for="check-vibrant" class="cursor-pointer text-[10px] font-bold text-violet-400">LZP COLOR</label></div>
                             </div>
                             
                             <div class="space-y-1">
                                <label class="section-label text-slate-500">Ch·∫ø ƒë·ªô Ph√≥ng to (Upscale)</label>
                                <select id="upscale-mode" class="pro-input w-full py-1.5 save-input cursor-pointer">
                                    <option value="supir" selected>üåü SUPIR v0F (Ch·∫•t l∆∞·ª£ng cao nh·∫•t - Ch·∫≠m)</option>
                                    <option value="pixel_perfect" class="text-yellow-400">üíé Pixel Perfect (Gi·ªØ nguy√™n h·∫°t da)</option>
                                    <option value="ultrasharp">‚ö° 4x-UltraSharp (T·ªëc ƒë·ªô nhanh - S·∫Øc n√©t)</option>
                                    <option value="realesrgan">üíç RealESRGAN (·∫¢nh c∆∞·ªõi/M·ªãn da)</option>
                                    <option value="none">üö´ Kh√¥ng Upscale (Nhanh nh·∫•t)</option>
                                </select>
                             </div>

                             <div class="space-y-1.5 pt-1 border-t border-white/5">
                                 <div class="flex items-center gap-2"><input id="check-face" type="checkbox" class="chk-pro save-input" data-key="checkFace" checked><label for="check-face" class="text-[10px] text-slate-300 cursor-pointer">Chi ti·∫øt m·∫∑t (Face Detail)</label></div>
                                 
                                 <div class="flex items-center gap-2 p-1.5 rounded bg-violet-500/10 border border-violet-500/20">
                                    <input id="check-background" type="checkbox" class="chk-pro save-input" checked>
                                    <label for="check-background" class="cursor-pointer select-none flex-1">
                                        <span class="block text-[10px] font-bold text-violet-300">L√†m n√©t N·ªÅn & Hoa L√°</span>
                                        <span class="block text-[8px] text-violet-400/70">Ch·∫ø ƒë·ªô: Botanical Detail (Baby.json)</span>
                                    </label>
                                 </div>

                                 <div class="flex items-center gap-2"><input id="check-hair" type="checkbox" class="chk-pro save-input" data-key="checkHair" checked><label for="check-hair" class="text-[10px] text-slate-300 cursor-pointer">V·∫Ω l·∫°i t·ª´ng s·ª£i t√≥c (LZP Hair)</label></div>
                             </div>

                             <div class="mt-2 border-t border-blue-500/20 pt-2 space-y-1.5">
                                <label class="section-label text-blue-400/80 mb-2">üöÄ V35.25 ADVANCED</label>
                                <div class="flex items-center gap-2 p-1.5 rounded border border-blue-500/20 bg-blue-500/10">
                                    <input id="check-group-mode" type="checkbox" class="chk-pro save-input">
                                    <label for="check-group-mode" class="cursor-pointer select-none flex-1">
                                        <span class="block text-[10px] font-bold text-blue-300">GROUP PHOTO PRO (ƒê√°m ƒë√¥ng)</span>
                                        <span class="block text-[8px] text-blue-500/70">Core: GroundingDINO + SAM (Ph√¢n ƒëo·∫°n)</span>
                                    </label>
                                 </div>
                                <div class="flex items-center gap-2 p-1.5 rounded border border-orange-500/20 bg-orange-500/10 animate-real-pulse" id="container-blur-prepass">
                                    <input id="check-blur-prepass" type="checkbox" class="chk-pro chk-real save-input">
                                    <label for="check-blur-prepass" class="cursor-pointer select-none flex-1">
                                        <span class="block text-[10px] font-bold text-orange-400">KH·ª¨ NHI·ªÑU S√ÇU (BLUR INPUT)</span>
                                        <span class="block text-[8px] text-orange-500/70">L√†m m·ªù ·∫£nh g·ªëc tr∆∞·ªõc x·ª≠ l√Ω (Fix nhi·ªÖu h·∫°t/R·ªó)</span>
                                    </label>
                                </div>
                                <div class="flex items-center gap-2 p-1.5 rounded border border-red-500/20 bg-red-500/10 animate-pulse-glow">
                                    <input id="check-extreme-mode" type="checkbox" class="chk-pro chk-red save-input">
                                    <label for="check-extreme-mode" class="cursor-pointer select-none flex-1">
                                        <span class="block text-[10px] font-bold text-red-400">‚ö° C∆Ø·ª†NG √âP PH·ª§C H·ªíI (Extreme Recovery)</span>
                                        <span class="block text-[8px] text-red-500/70">D√πng cho ·∫£nh qu√° n√°t/m·ªù m√† ch·∫ø ƒë·ªô th∆∞·ªùng b√≥ tay</span>
                                    </label>
                                </div>
                             </div>
                        </div>
                    </div>
                </div>

                <!-- MODULE 2: ƒê·ªêI T∆Ø·ª¢NG & TRANG PH·ª§C -->
                <div class="module-group" id="module-subject">
                    <button id="toggle-subject" class="w-full flex justify-between items-center module-header">
                        <span class="text-[10px] font-bold text-slate-200 tracking-wide uppercase flex items-center gap-2">üëî ƒê·ªêI T∆Ø·ª¢NG & TRANG PH·ª§C</span>
                        <svg class="w-3 h-3 text-slate-600 toggle-icon" id="icon-subject" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="content-subject" class="module-content">
                        <div class="module-inner">
                            <div class="grid grid-cols-3 gap-1.5 mb-2">
                                 <select id="gender-select" class="pro-input py-1.5 save-input" data-key="gender"><option value="">Gi·ªõi t√≠nh</option><option value="male">Nam</option><option value="female">N·ªØ</option><option value="male and female">Nam & N·ªØ</option></select>
                                 <input type="number" id="age-input" placeholder="Tu·ªïi" class="pro-input py-1.5 save-input text-center" data-key="age">
                                 <select id="damage-level" class="pro-input py-1.5 save-input cursor-pointer" data-key="damageLevel"><option value="">ƒê·ªô h·ªèng</option><option value="fix slightly blurry" selected>Nh·∫π</option><option value="fix scratches, mold">V·ª´a</option><option value="fix torn, missing details">N·∫∑ng</option></select>
                            </div>
                            <select id="texture-mode" class="pro-input w-full py-1.5 save-input cursor-pointer mb-2" data-key="textureMode">
                                <option value="">-- ƒê·ªô ch√¢n th·ª±c (Texture) --</option>
                                <option value="true skin, natural pores, film grain, realistic skin:1.2, natural beauty:1.2" selected>üß¨ TRUE SKIN (DA TH·∫¨T - L·ªñ CH√ÇN L√îNG)</option>
                                <option value="Canon EOS 5D Mark IV, 85mm lens, shallow depth of field, perfect lighting, raw photo, realistic skin texture">üì∏ Canon 5D + 85mm Lens (Studio Skin)</option>
                                <option value="smooth skin, ai beauty">M·ªãn m√†ng (AI Beauty)</option>
                                <option value="high detail, film grain">Chi ti·∫øt cao (Film Grain)</option>
                            </select>
                            <div class="space-y-1.5">
                                <div class="flex items-center gap-2 p-1.5 rounded border border-blue-500/20 bg-blue-500/10">
                                    <input id="check-id-photo" type="checkbox" class="chk-pro save-input">
                                    <label for="check-id-photo" class="cursor-pointer select-none flex-1">
                                        <span class="block text-[10px] font-bold text-blue-300">CH·∫ø ƒê·ªò ·∫¢NH TH·∫∫ (ID PHOTO)</span>
                                        <span class="block text-[8px] text-blue-500/70">Ph√¥ng xanh/tr·∫Øng chu·∫©n (chuan.txt)</span>
                                    </label>
                                </div>
                                <select id="event-context" class="pro-input w-full py-1.5 cursor-pointer save-input" data-key="eventContext">
                                    <option value="">-- (AUTO) Ng·ªØ c·∫£nh th√¥ng minh --</option>
                                    <option value="original_enhanced" class="text-violet-400 font-bold">üõ°Ô∏è N·ªÅn G·ªëc + MAX CHI TI·∫æT (LZP BOOST)</option>
                                    <optgroup label="Thay N·ªÅn M√†u">
                                        <option value="blue_bg">üü¶ N·ªÅn Xanh (Blue)</option>
                                        <option value="white_bg">‚¨ú N·ªÅn Tr·∫Øng (White)</option>
                                    </optgroup>
                                     <optgroup label="Flux Style (Theo JSON)">
                                        <option value="outdoor_garden">üåø S√¢n V∆∞·ªùn / Hoa L√° (Chu·∫©n JSON)</option>
                                        <option value="luxury_interior">üï∞Ô∏è N·ªôi Th·∫•t Sang Tr·ªçng</option>
                                    </optgroup>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- MODULE 3: KH√ìA N√âT (IDENTITY) -->
                <div class="module-group" id="module-identity">
                    <button id="toggle-identity" class="w-full flex justify-between items-center module-header">
                        <span class="text-[10px] font-bold text-slate-200 tracking-wide uppercase flex items-center gap-2">üß¨ KH√ìA N√âT (IDENTITY GUARD)</span>
                        <svg class="w-3 h-3 text-slate-600 toggle-icon" id="icon-identity" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="content-identity" class="module-content">
                        <div class="module-inner">
                            <div class="border border-white/10 rounded bg-black/20 p-2 mb-2" id="identity-slider-container">
                                <div class="flex justify-between text-[10px] text-slate-400 font-bold mb-1">
                                    <span>M·ª©c ƒë·ªô kh√≥a</span>
                                    <span id="identity-weight-val" class="text-slate-200">300%</span>
                                </div>
                                <input type="range" id="identity-weight-slider" min="100" max="400" step="10" value="300" class="slider-red save-input" data-key="identityWeight">
                            </div>
                            <div class="flex items-start gap-2 p-1.5 rounded bg-red-500/10 border border-red-500/20 mb-2">
                                <input id="check-anti-flip" type="checkbox" class="chk-pro chk-red save-input mt-0.5" checked>
                                <label for="check-anti-flip" class="flex-1 cursor-pointer select-none">
                                    <span class="block text-[10px] font-bold text-red-300">üö´ CH·ªêNG L·∫¨T H√åNH (SMART ANTI-FLIP)</span>
                                    <span class="block text-[9px] text-red-400/70">T·ª± ƒë·ªông nh·∫≠n di·ªán T·ª∑ l·ªá ·∫£nh & G√≥c m·∫∑t</span>
                                </label>
                            </div>
                             <div class="border border-purple-500/30 rounded bg-purple-900/10 p-2 mb-2" id="structure-container" style="display:none;">
                                <div class="flex justify-between text-[10px] text-purple-300 font-bold mb-1">
                                    <span>KH√ìA C·∫§U TR√öC (CONTROLNET)</span>
                                    <span id="structure-val">M·∫°nh (0.8)</span>
                                </div>
                                <input type="range" id="structure-slider" min="0" max="100" value="80" class="slider-flux w-full h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                             </div>
                            <div class="flex items-start gap-2 p-1.5 rounded bg-white/[0.02] border border-white/5 mb-2">
                                <input id="check-asian-identity" type="checkbox" class="chk-pro save-input mt-0.5" data-key="checkAsianIdentity" checked>
                                <label for="check-asian-identity" class="flex-1 cursor-pointer select-none">
                                    <span class="block text-[10px] font-bold text-slate-200">GI·ªÆ N√âT √Å ƒê√îNG (Asian Identity)</span>
                                    <span class="block text-[9px] text-slate-500">Ch·ªëng "T√¢y h√≥a", gi·ªØ ƒë·∫∑c ƒëi·ªÉm ng∆∞·ªùi Vi·ªát</span>
                                </label>
                            </div>
                            <div class="flex items-center gap-2 p-1.5 rounded border border-purple-500/20 bg-purple-500/10 mb-2">
                                <input id="check-dual-controlnet" type="checkbox" class="chk-pro save-input">
                                <label for="check-dual-controlnet" class="cursor-pointer select-none flex-1">
                                    <span class="block text-[10px] font-bold text-purple-300">KH√ìA C·∫§U TR√öC K√âP (DUAL CONTROLNET)</span>
                                    <span class="block text-[8px] text-purple-500/70">K·∫øt h·ª£p Depth + LineArt (D√πng cho tranh/t∆∞·ª£ng c·ªï)</span>
                                </label>
                            </div>
                            <div class="grid-compact border-t border-white/5 pt-2 mb-2">
                                <div class="flex items-center gap-2"><input id="lock-eyes" type="checkbox" class="chk-pro save-input" data-key="lockEyes" checked><label for="lock-eyes" class="text-[10px] text-slate-300">Kh√≥a M·∫Øt</label></div>
                                <div class="flex items-center gap-2"><input id="lock-mouth" type="checkbox" class="chk-pro save-input" data-key="lockMouth" checked><label for="lock-mouth" class="text-[10px] text-slate-300">Kh√≥a Mi·ªáng</label></div>
                                <div class="flex items-center gap-2"><input id="lock-skin" type="checkbox" class="chk-pro save-input" data-key="lockSkin"><label for="lock-skin" class="text-[10px] text-slate-300">N·ªët ru·ªìi/Ch√†m</label></div>
                                <div class="flex items-center gap-2" id="container-imperfection"><input id="lock-imperfection" type="checkbox" class="chk-pro chk-gold save-input" data-key="lockImperfection"><label for="lock-imperfection" class="text-[10px] text-yellow-500 font-bold">Gi·ªØ Khuy·∫øt ƒêi·ªÉm</label></div>
                            </div>
                            <div class="mt-2 border-t border-red-500/20 pt-2">
                                <label class="section-label text-red-400/80 mb-2">üõ°Ô∏è B·∫¢O T·ªíN ƒê·∫∂C ƒêI·ªÇM (CH·ªêNG AI S·ª¨A)</label>
                                <div class="space-y-1.5">
                                    <div class="flex items-center gap-2"><input id="check-cross-eyed" type="checkbox" class="chk-pro chk-red save-input"><label for="check-cross-eyed" class="text-[10px] text-slate-300 cursor-pointer">M·∫Øt L√© / L√°c (Cross-eyed)</label></div>
                                    <div class="flex items-center gap-2" id="container-ptosis">
                                        <input id="check-ptosis" type="checkbox" class="chk-pro chk-red save-input">
                                        <label for="check-ptosis" class="text-[10px] text-slate-300 cursor-pointer">M·∫Øt S·ª•p M√≠ (Droopy/Ptosis)</label>
                                    </div>
                                    <div class="flex items-center gap-2" id="container-closed-eyes">
                                        <input id="check-closed-eyes" type="checkbox" class="chk-pro chk-red save-input">
                                        <label for="check-closed-eyes" class="text-[10px] text-slate-300 cursor-pointer">M·∫Øt Nh·∫Øm / Ng·ªß (Closed Eyes)</label>
                                    </div>
                                    <div class="flex items-center gap-2"><input id="check-monolid" type="checkbox" class="chk-pro chk-red save-input"><label for="check-monolid" class="text-[10px] text-slate-300 cursor-pointer">M·∫Øt M·ªôt M√≠ (Monolid)</label></div>
                                    <div class="flex items-center gap-2"><input id="check-buck-teeth" type="checkbox" class="chk-pro chk-red save-input"><label for="check-buck-teeth" class="text-[10px] text-slate-300 cursor-pointer">RƒÉng H√¥ (Buck Teeth)</label></div>
                                    <div class="flex items-center gap-2"><input id="check-black-teeth" type="checkbox" class="chk-pro chk-red save-input"><label for="check-black-teeth" class="text-[10px] text-slate-300 cursor-pointer">RƒÉng ƒêen Truy·ªÅn Th·ªëng</label></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- MODULE 4: PROMPT & API -->
                <div class="module-group" id="module-prompt">
                    <button id="toggle-prompt" class="w-full flex justify-between items-center module-header">
                        <span class="text-[10px] font-bold text-slate-200 tracking-wide uppercase flex items-center gap-2">üìù PROMPT & API</span>
                        <svg class="w-3 h-3 text-slate-600 toggle-icon" id="icon-prompt" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="content-prompt" class="module-content">
                        <div class="module-inner">
                            <textarea id="prompt-main" rows="3" class="pro-input w-full p-2 resize-none text-[10px] font-mono save-input mb-2" data-key="promptMainValue" placeholder="H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông t·ªëi ∆∞u theo chu·∫©n Flux..."></textarea>
                            <input type="text" id="prompt-negative" placeholder="Lo·∫°i tr·ª´..." class="pro-input w-full py-1.5 save-input mb-2" data-key="promptNegative">
                            <input type="password" id="user-api-key" placeholder="API Key ri√™ng (N·∫øu c·∫ßn)" class="pro-input w-full py-1.5 save-input" data-key="userApiKey">
                        </div>
                    </div>
                </div>

                <!-- MODULE 5: B·∫¢N QUY·ªÄN (LOGO) -->
                <div class="module-group" id="module-logo">
                    <button id="toggle-logo" class="w-full flex justify-between items-center module-header">
                        <span class="text-[10px] font-bold text-slate-200 uppercase">¬©Ô∏è CH√àN LOGO B·∫¢N QUY·ªÄN</span>
                        <svg class="w-3 h-3 text-slate-600 toggle-icon" id="icon-logo" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="content-logo" class="module-content">
                        <div class="module-inner">
                            <div class="flex items-center gap-2 mb-2">
                                <input id="check-logo" type="checkbox" class="chk-pro save-input">
                                <label for="check-logo" class="flex-1 cursor-pointer select-none">
                                    <span class="block text-[10px] font-bold text-slate-300">K√≠ch ho·∫°t ƒë√≥ng d·∫•u Logo</span>
                                    <span class="block text-[9px] text-slate-500">D·∫°ng l∆∞·ªõi m·ªù 10% ph·ªß ·∫£nh</span>
                                </label>
                            </div>
                            <input type="text" id="custom-logo-text" class="pro-input w-full py-2 bg-black/20 border-white/10 text-center font-bold text-yellow-400 placeholder-slate-600" placeholder="Nh·∫≠p t√™n ho·∫∑c SƒêT c·ªßa b·∫°n...">
                        </div>
                    </div>
                </div>

            </div>

            <!-- Footer Actions -->
            <div class="p-4 glass-panel border-t-0 space-y-2 z-20">
                <button id="process-image" class="w-full py-3 btn-flux-modern text-white font-bold text-xs tracking-widest flex justify-center items-center gap-2 disabled:opacity-70 disabled:cursor-not-allowed">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                    T·∫†O ·∫¢NH (FLUX KONTEXT)
                </button>
                <button id="reset-button" class="w-full py-2 bg-white/5 hover:bg-white/10 text-slate-400 text-[10px] font-bold tracking-widest rounded transition-colors border border-white/5">L√ÄM M·ªöI</button>
            </div>
        </aside>

        <!-- WORKSPACE -->
        <main class="flex-1 flex flex-col relative overflow-hidden" id="main-workspace">
            <!-- MOBILE HEADER -->
            <div class="lg:hidden h-14 glass-panel border-b border-white/5 flex items-center px-4 justify-between z-30 relative bg-[#0a0a0f]/90 backdrop-blur-xl">
                <button id="toggle-sidebar-btn" class="text-slate-400 p-2 border border-white/10 rounded-lg hover:bg-white/5"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg></button>
                <div class="flex flex-col items-center">
                     <!-- UPDATED: MOBILE HEADER TITLE -->
                     <span class="font-bold text-violet-500 text-xs tracking-wider">PHOTO RESTORATION</span>
                     <span class="text-[8px] text-slate-500 font-mono tracking-widest" id="mobile-status-text">WAITING FOR IMAGE</span>
                </div>
                <button id="download-mobile" class="text-blue-400 p-2 bg-blue-500/10 rounded-lg border border-blue-500/20 disabled:opacity-30 transition-all active:scale-95" disabled>
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                </button>
            </div>
            
            <!-- SMART MOBILE ACTION BAR (REDESIGNED PROFESSIONAL DOCK) -->
            <div id="mobile-action-bar" class="lg:hidden fixed bottom-6 left-4 right-4 z-40 flex items-center justify-center pointer-events-none transition-all duration-500 translate-y-24 opacity-0">
                <div class="bg-[#0f1016]/90 backdrop-blur-2xl border border-white/10 p-2 rounded-2xl shadow-[0_8px_32px_rgba(0,0,0,0.6)] flex gap-3 w-full max-w-sm pointer-events-auto ring-1 ring-white/5">
                    
                    <!-- 1. UPLOAD BUTTON -->
                    <button id="mob-btn-upload" class="flex-1 py-3.5 bg-slate-800/50 hover:bg-slate-700/50 border border-white/10 rounded-xl text-slate-200 font-bold text-[10px] tracking-widest flex flex-col items-center justify-center gap-1 active:scale-95 transition-all shadow-inner group">
                        <svg class="w-5 h-5 text-blue-400 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                        <span>T·∫¢I ·∫¢NH</span>
                    </button>

                    <!-- 2. SCAN BUTTON -->
                    <button id="mob-btn-scan" class="hidden flex-1 py-3.5 bg-gradient-to-b from-violet-600 to-violet-700 hover:from-violet-500 hover:to-violet-600 border border-violet-500/30 rounded-xl text-white font-bold text-[10px] tracking-widest flex flex-col items-center justify-center gap-1 shadow-[0_0_15px_rgba(124,58,237,0.3)] animate-pulse active:scale-95 transition-all">
                        <svg class="w-5 h-5 animate-bounce" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                        <span>AUTO SCAN</span>
                    </button>

                    <!-- 3. GENERATE BUTTON -->
                    <button id="mob-btn-run" class="hidden flex-1 py-3.5 bg-gradient-to-b from-emerald-500 to-teal-600 hover:from-emerald-400 hover:to-teal-500 border border-emerald-500/30 rounded-xl text-white font-bold text-[10px] tracking-widest flex flex-col items-center justify-center gap-1 shadow-[0_0_15px_rgba(16,185,129,0.3)] active:scale-95 transition-all">
                         <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                        <span>CH·∫†Y NGAY</span>
                    </button>

                    <!-- Reset Small Btn -->
                    <button id="mob-btn-reset" class="w-12 flex flex-col items-center justify-center bg-white/5 hover:bg-red-500/20 text-slate-400 hover:text-red-400 rounded-xl border border-white/10 active:scale-95 transition-all" title="L√†m m·ªõi">
                        <svg class="w-5 h-5 mb-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                        <span class="text-[8px] font-bold">RESET</span>
                    </button>
                </div>
            </div>

            <div class="absolute top-6 left-6 right-6 h-12 glass-panel rounded-lg flex items-center justify-between px-4 z-20 shadow-lg hidden sm:flex border border-white/5">
                <div class="flex items-center gap-3">
                     <div class="text-[10px] text-slate-400 font-mono flex items-center gap-2"><span class="w-1.5 h-1.5 rounded-full bg-violet-500"></span>ZOOM: <span id="zoom-level" class="text-white font-bold">100%</span></div>
                     <button id="rotate-btn" class="p-1.5 hover:bg-white/10 rounded text-slate-400 hover:text-white transition"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg></button>
                </div>
                <div class="flex items-center gap-3">
                     <div class="hidden lg:flex items-center gap-1.5 mr-2 px-2 py-1 rounded border border-white/5 bg-white/5">
                        <span class="text-[9px] font-bold text-slate-400">TIP:</span>
                        <span class="text-[9px] text-slate-300">Gi·ªØ ph√≠m SPACE ƒë·ªÉ xem ·∫£nh g·ªëc</span>
                    </div>
                    <button id="toggle-magnifier" class="flex items-center gap-2 px-3 py-1.5 rounded bg-white/5 border border-white/10 hover:bg-white/10 text-slate-300 text-[10px] font-bold transition-colors">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"></path></svg>
                        <span>SOI DA</span>
                    </button>
                    <div class="flex bg-black/20 rounded p-0.5 gap-0.5 border border-white/5">
                        <button id="zoom-out" class="p-1.5 hover:bg-white/10 rounded text-slate-400"><svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path></svg></button>
                        <button id="zoom-reset" class="px-2 hover:bg-white/10 rounded text-slate-400 text-[10px] font-bold">FIT</button>
                        <button id="zoom-in" class="p-1.5 hover:bg-white/10 rounded text-slate-400"><svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg></button>
                    </div>
                    <button id="download-trigger" class="flex items-center gap-2 bg-blue-600 hover:bg-blue-500 text-white px-5 py-2 rounded text-xs font-bold transition-all opacity-50 cursor-not-allowed shadow-lg" disabled><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg><span>L∆ØU ·∫¢NH</span></button>
                </div>
            </div>
            
            <div class="flex-1 relative flex items-center justify-center overflow-hidden perspective-1000">
                <div id="canvas-scale-container" class="relative transition-transform duration-500 ease-[cubic-bezier(0.19,1,0.22,1)] origin-center will-change-transform" style="transform: scale(1);">
                    <div id="scan-beam" class="scan-beam"></div>
                    
                    <div id="comparison-view" class="relative max-w-[95vw] max-h-[80vh] flex justify-center items-center" style="display:none;">
                         <div id="comp-inner" class="relative shadow-2xl rounded overflow-hidden cursor-ew-resize group select-none border border-white/10 bg-black">
                              <img id="img-original" class="block max-h-[75vh] w-auto pointer-events-none select-none">
                              <div id="img-modified-wrapper" class="absolute top-0 left-0 h-full w-[50%] overflow-hidden border-r border-white/50 bg-black/5">
                                  <img id="img-modified" class="absolute top-0 left-0 max-h-[75vh] w-auto pointer-events-none select-none" style="max-width: none;">
                              </div>
                              <div id="logo-overlay" class="logo-overlay"></div>
                              <div id="magnifier" class="magnifier"></div>
                              <div id="slider-handle" class="absolute top-0 bottom-0 left-[50%] w-0.5 bg-white/80 z-20 pointer-events-none shadow-[0_0_10px_rgba(0,0,0,0.5)]">
                                  <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-6 h-6 bg-white/20 backdrop-blur-md border border-white rounded-full flex items-center justify-center shadow-lg">
                                      <svg class="w-3 h-3 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" /></svg>
                                  </div>
                              </div>
                              <div class="absolute bottom-4 left-1/2 -translate-x-1/2 text-[9px] bg-black/50 backdrop-blur text-white px-2 py-1 rounded-full pointer-events-none opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                                  Gi·ªØ ƒë·ªÉ xem g·ªëc / Hold to compare
                              </div>
                         </div>
                    </div>

                    <canvas id="canvas-process" class="hidden"></canvas>

                    <div id="ai-terminal-overlay" class="absolute inset-0 z-50 bg-[#000]/90 backdrop-blur-md hidden flex flex-col items-center justify-center font-mono">
                        <div class="w-full max-w-md p-6 rounded-xl border border-white/10 bg-white/5 shadow-2xl relative overflow-hidden">
                            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-violet-500 to-transparent animate-scan opacity-70"></div>
                            <div class="flex items-center gap-3 mb-6 border-b border-white/5 pb-4"><div class="w-2 h-2 rounded-full bg-slate-500"></div><div class="w-2 h-2 rounded-full bg-slate-500"></div><span class="ml-auto text-[10px] text-violet-400 font-bold tracking-widest">FLUX/KONTEXT ENGINE ACTIVATED...</span></div>
                            <div id="terminal-content" class="text-xs text-slate-300 space-y-2 h-32 overflow-hidden scroll-smooth"></div>
                            <div class="mt-4 border-t border-white/5 pt-3"><div class="w-full bg-white/5 h-1 rounded-full overflow-hidden"><div id="term-progress-bar" class="h-full bg-violet-500 w-0 transition-all duration-300"></div></div></div>
                        </div>
                    </div>
                    
                    <div id="placeholder-state" class="text-center px-6 py-10 md:p-24 border border-dashed border-violet-500/50 rounded-2xl bg-white/[0.01] hover:bg-white/[0.02] transition-all duration-500 animate-float backdrop-blur-sm w-[85%] max-w-lg md:w-auto mx-auto flex flex-col items-center justify-center mb-16 md:mb-0 cursor-pointer">
                        <div class="w-20 h-20 bg-gradient-to-tr from-slate-800 to-slate-700 rounded-full flex items-center justify-center mx-auto mb-6 shadow-inner border border-white/5"><svg class="w-10 h-10 text-violet-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l-1.586-1.586a2 2 0 00-2.828 0L6 18H4a2 2 0 01-2-2V6a2 2 0 01-2-2V6a2 2 0 012-2h16a2 2 0 012 2v8a2 2 0 01-2 2h-2m-4-4l-3 3m0 0l-3-3m3 3V4"></path></svg></div>
                        <!-- EDITED: CHANGE TEXT HERE -->
                        <h3 class="text-2xl font-bold text-violet-500 tracking-tight mb-2">PH·ª§C H·ªíI ·∫¢NH</h3>
                        <p class="text-xs text-slate-500 font-medium uppercase tracking-widest">K√©o th·∫£ ho·∫∑c D√°n ·∫£nh v√†o ƒë√¢y</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- NEW: RECHARGE MODAL -->
    <div id="recharge-modal" class="fixed inset-0 z-[110] bg-black/90 backdrop-blur-md hidden flex items-center justify-center modal-fade-in">
        <div class="w-[350px] bg-[#0a0a0f] border border-red-500/30 rounded-2xl shadow-[0_0_50px_rgba(239,68,68,0.2)] p-6 text-center relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-1 bg-red-500"></div>
            <div class="w-16 h-16 bg-red-500/10 rounded-full flex items-center justify-center mx-auto mb-4 border border-red-500/20">
                <svg class="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
            </div>
            <h3 class="text-xl font-bold text-white mb-2 uppercase">H·∫æT CREDIT S·ª¨ D·ª§NG!</h3>
            <p class="text-xs text-slate-400 mb-6">B·∫°n ƒë√£ d√πng h·∫øt l∆∞·ª£t t·∫°o ·∫£nh mi·ªÖn ph√≠. M·ªói l·∫ßn t·∫°o ·∫£nh t·ªën <span class="text-red-400 font-bold">20 Credit</span>.</p>
            
            <!-- B·∫¢NG GI√Å QUY ƒê·ªîI (M·ªöI TH√äM V√ÄO ƒê√ÇY) -->
            <div class="grid grid-cols-3 gap-2 mb-4">
                <div class="flex flex-col items-center justify-center p-2 rounded-lg bg-white/5 border border-white/10 hover:bg-white/10 transition-colors cursor-default">
                    <span class="text-xs font-bold text-slate-300">100K</span>
                    <span class="text-[10px] font-mono font-bold text-yellow-500">= 80 CR</span>
                </div>
                <div class="flex flex-col items-center justify-center p-2 rounded-lg bg-violet-600/20 border border-violet-500/50 relative overflow-hidden cursor-default shadow-[0_0_10px_rgba(139,92,246,0.2)]">
                    <div class="absolute top-0 right-0 bg-red-500 text-[6px] font-bold px-1.5 text-white rounded-bl">HOT</div>
                    <span class="text-xs font-bold text-violet-300">200K</span>
                    <span class="text-[10px] font-mono font-bold text-yellow-400">= 200 CR</span>
                </div>
                <div class="flex flex-col items-center justify-center p-2 rounded-lg bg-blue-600/20 border border-blue-500/50 cursor-default hover:bg-blue-600/30 transition-colors">
                    <span class="text-xs font-bold text-blue-300">500K</span>
                    <span class="text-[10px] font-mono font-bold text-yellow-400">= 500 CR</span>
                </div>
            </div>

            <div class="bg-white/5 rounded-lg p-4 mb-4 border border-white/10">
                <p class="text-[10px] font-bold text-slate-500 uppercase mb-1">TH√îNG TIN CHUY·ªÇN KHO·∫¢N</p>
                <p class="text-sm font-mono font-bold text-yellow-400 tracking-wider mb-2 break-all">MB BANK - HOANG QUANG CUONG - 85543556868</p>
                
                <div class="mt-3 pt-3 border-t border-white/10 text-left">
                    <label class="text-[9px] font-bold text-slate-400 uppercase mb-1 block">CH·ªåN G√ìI ƒê√É CHUY·ªÇN KHO·∫¢N</label>
                    <div class="flex gap-2 mb-2">
                        <button class="pkg-select-btn flex-1 py-1.5 rounded border border-white/10 bg-white/5 hover:bg-blue-600 hover:text-white text-[9px] font-bold transition-all text-slate-300" data-amount="100k">100K</button>
                        <button class="pkg-select-btn flex-1 py-1.5 rounded border border-white/10 bg-white/5 hover:bg-blue-600 hover:text-white text-[9px] font-bold transition-all text-slate-300" data-amount="200k">200K</button>
                        <button class="pkg-select-btn flex-1 py-1.5 rounded border border-white/10 bg-white/5 hover:bg-blue-600 hover:text-white text-[9px] font-bold transition-all text-slate-300" data-amount="500k">500K</button>
                    </div>

                    <label class="text-[9px] font-bold text-slate-400 uppercase mb-1 block">N·ªòI DUNG NH·∫ÆN ZALO (T·ª∞ ƒê·ªòNG)</label>
                    <div class="relative group">
                        <textarea id="zalo-msg-content" class="pro-input w-full p-2 h-16 resize-none text-[10px] bg-black/20 border-blue-500/30 text-blue-200" placeholder="Ch·ªçn g√≥i ƒë·ªÉ t·∫°o n·ªôi dung t·ª± ƒë·ªông..." readonly></textarea>
                        <a id="btn-send-zalo" href="https://zalo.me/0352803379" target="_blank" class="absolute bottom-2 right-2 px-3 py-1 bg-blue-600 hover:bg-blue-500 text-white text-[9px] font-bold rounded flex items-center gap-1 transition-all shadow-lg hover:shadow-blue-500/50">
                            G·ª¨I ZALO <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                        </a>
                    </div>
                    <p class="text-[8px] text-slate-500 mt-1 italic text-center">*Click g·ª≠i ƒë·ªÉ m·ªü Zalo chat v·ªõi Admin</p>
                </div>
            </div>

            <!-- NEW: REDEEM CODE INPUT -->
            <div class="mb-4">
                <div class="flex gap-2">
                    <input type="text" id="recharge-input" class="pro-input w-full py-2.5 text-center font-mono uppercase text-violet-300 border-violet-500/30 bg-violet-500/10" placeholder="NH·∫¨P M√É N·∫†P (V35-...)">
                </div>
                <button id="btn-submit-recharge" class="w-full mt-2 py-2.5 bg-gradient-to-r from-violet-600 to-blue-600 hover:from-violet-500 hover:to-blue-500 text-white rounded-lg text-xs font-bold transition-all shadow-lg flex items-center justify-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                    N·∫†P NGAY
                </button>
            </div>
            
            <button id="close-recharge" class="w-full py-2.5 bg-white/10 hover:bg-white/20 text-white rounded-lg text-xs font-bold transition-colors">ƒê√ìNG L·∫†I</button>
        </div>
    </div>

    <!-- NEW: ADMIN MODAL WITH API CONFIG & LICENSE GENERATOR -->
    <div id="admin-modal" class="fixed inset-0 z-[10002] bg-black/90 backdrop-blur-md hidden flex items-center justify-center modal-fade-in overflow-y-auto">
        <div class="w-[450px] glass-panel rounded-xl border border-white/10 shadow-2xl p-6 relative my-10">
            <button id="close-admin" class="absolute top-4 right-4 text-slate-400 hover:text-white"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            
            <!-- ADMIN LOGIN STATE -->
            <div id="admin-login-view">
                <div class="mb-6 text-center">
                    <h2 class="text-lg font-bold text-slate-200 tracking-widest mb-1">QU·∫¢N TR·ªä H·ªÜ TH·ªêNG</h2>
                    <p class="text-[10px] text-slate-500">Vui l√≤ng ƒëƒÉng nh·∫≠p quy·ªÅn Admin ƒë·ªÉ c·∫•u h√¨nh API</p>
                </div>
                <div class="space-y-4">
                    <input type="password" id="admin-password" class="pro-input w-full py-3 text-center tracking-widest" placeholder="Nh·∫≠p m·∫≠t kh·∫©u qu·∫£n tr·ªã">
                    <button id="btn-admin-login" class="w-full py-3 bg-violet-600 hover:bg-violet-500 text-white rounded text-xs font-bold transition-colors shadow-lg">ƒêƒÇNG NH·∫¨P ADMIN</button>
                </div>
            </div>

            <!-- ADMIN DASHBOARD STATE -->
            <div id="admin-dashboard-view" class="hidden">
                 <div class="flex justify-between items-center mb-6 border-b border-white/5 pb-4">
                    <!-- UPDATED: ADMIN DASHBOARD TITLE -->
                    <h2 class="text-sm font-bold text-green-400 tracking-widest">DASHBOARD ADMIN</h2>
                    <span class="text-[9px] bg-green-500/20 text-green-400 px-2 py-1 rounded">ADMIN ACCESS GRANTED</span>
                </div>
                
                <div class="space-y-4">
                    <!-- Credits Management -->
                    <div class="bg-white/5 p-3 rounded border border-white/10 flex justify-between items-center">
                        <div>
                            <label class="text-[9px] font-bold text-slate-500 uppercase block mb-1">S·ªê D∆Ø HI·ªÜN T·∫†I</label>
                            <div class="text-xl font-mono font-bold text-yellow-400" id="admin-current-credits">0</div>
                        </div>
                        <div class="flex flex-col gap-1">
                             <button class="add-credit-btn px-3 py-1.5 bg-green-600 hover:bg-green-500 text-white text-[9px] font-bold rounded" data-amount="100">+100 CR</button>
                             <button class="add-credit-btn px-3 py-1.5 bg-blue-600 hover:bg-blue-500 text-white text-[9px] font-bold rounded" data-amount="500">+500 CR</button>
                             <button class="add-credit-btn px-3 py-1.5 bg-red-600 hover:bg-red-500 text-white text-[9px] font-bold rounded" data-amount="-20">-20 CR (Test)</button>
                        </div>
                    </div>
                    
                    <div class="bg-white/5 p-3 rounded border border-white/10">
                        <label class="text-[9px] font-bold text-slate-500 uppercase block mb-1">DEVICE ID (M√°y hi·ªán t·∫°i)</label>
                        <div class="text-[10px] font-mono text-violet-300 break-all" id="admin-device-id">---</div>
                    </div>

                    <!-- NEW: LICENSE GENERATOR SECTION -->
                    <div class="pt-4 mt-2 border-t border-white/5">
                        <h3 class="text-xs font-bold text-yellow-500 tracking-widest mb-3 uppercase flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path></svg>
                            üõ† C√îNG C·ª§ T·∫†O M√É K√çCH HO·∫†T (V2 - CH·ªêNG SPAM)
                        </h3>
                        
                        <div class="space-y-3 bg-white/5 p-3 rounded-lg border border-white/10">
                            <div>
                                <label class="text-[9px] font-bold text-slate-400 uppercase mb-1 block">M√£ Kh√°ch H√†ng (T·ª´ Email)</label>
                                <div class="flex gap-2">
                                    <input type="text" id="gen-customer-email" class="pro-input w-full py-2" placeholder="Nh·∫≠p Email kh√°ch h√†ng...">
                                    <input type="text" id="gen-customer-hash" class="pro-input w-24 py-2 font-mono text-center text-slate-500" readonly placeholder="HASH ID">
                                </div>
                            </div>

                            <div>
                                <label class="text-[9px] font-bold text-slate-400 uppercase mb-1 block">G√≥i Credits</label>
                                <div class="grid grid-cols-3 gap-2">
                                    <button class="gen-pkg-btn py-1.5 rounded border border-white/10 bg-white/5 hover:bg-violet-500 hover:text-white text-[9px] font-bold transition-all text-slate-300" data-val="100">100 CR</button>
                                    <button class="gen-pkg-btn py-1.5 rounded border border-white/10 bg-white/5 hover:bg-violet-500 hover:text-white text-[9px] font-bold transition-all text-slate-300" data-val="200">200 CR</button>
                                    <button class="gen-pkg-btn py-1.5 rounded border border-white/10 bg-white/5 hover:bg-violet-500 hover:text-white text-[9px] font-bold transition-all text-slate-300" data-val="500">500 CR</button>
                                </div>
                                <input type="hidden" id="gen-selected-credit" value="">
                            </div>

                            <button id="btn-generate-key" class="w-full py-2 bg-yellow-600 hover:bg-yellow-500 text-white rounded text-xs font-bold transition-colors shadow-lg flex items-center justify-center gap-2">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                                T·∫†O M√É (GENERATE)
                            </button>

                            <div id="gen-result-container" class="hidden animate-fade-in mt-2 pt-2 border-t border-white/10">
                                <label class="text-[9px] font-bold text-green-400 uppercase mb-1 block">M√£ K√≠ch Ho·∫°t (Click ƒë·ªÉ copy)</label>
                                <div class="relative group">
                                    <input type="text" id="gen-result-key" class="pro-input w-full py-2.5 font-mono text-center text-yellow-400 font-bold border-yellow-500/30 bg-yellow-500/10 cursor-pointer text-xs tracking-wider" readonly>
                                    <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none opacity-50">
                                        <svg class="w-4 h-4 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"></path></svg>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- API CONFIGURATION SECTION -->
                    <div class="pt-4 mt-2 border-t border-white/5">
                        <h3 class="text-xs font-bold text-violet-400 tracking-widest mb-3 uppercase">C·∫§U H√åNH API & T√ÄI KHO·∫¢N</h3>
                        
                        <div class="space-y-3">
                            <div>
                                <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">IP Thi·∫øt B·ªã</label>
                                <input type="text" id="display-ip-address" class="pro-input w-full py-2 bg-white/5 border-violet-500/20 text-violet-300 font-mono tracking-widest text-center" readonly value="ƒêang qu√©t IP...">
                            </div>

                            <div>
                                <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">T√™n ng∆∞·ªùi d√πng (T√πy ch·ªçn)</label>
                                <!-- UPDATED: PLACEHOLDER -->
                                <input type="text" id="modal-username" class="pro-input w-full py-2" placeholder="V√≠ d·ª•: Admin User">
                            </div>

                            <div>
                                <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Nh√† cung c·∫•p (Provider)</label>
                                <div class="grid grid-cols-2 gap-2 mb-2">
                                    <button class="py-2 rounded border border-white/10 bg-white/5 hover:bg-white/10 text-[10px] font-bold transition-all text-slate-300" id="btn-provider-google">GOOGLE (Default)</button>
                                    <button class="py-2 rounded border border-violet-500/30 bg-violet-500/10 hover:bg-violet-500/20 text-[10px] font-bold transition-all text-violet-300 shadow-[0_0_10px_rgba(139,92,246,0.1)]" id="btn-provider-comet">COMET API (Proxy)</button>
                                </div>
                            </div>

                            <div>
                                <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">API Key (L∆∞u v√†o tr√¨nh duy·ªát)</label>
                                <input type="password" id="modal-api-key" class="pro-input w-full py-2 text-center tracking-widest font-mono text-violet-300" placeholder="sk-...">
                                <div class="flex justify-end mt-1"><button id="toggle-show-key" class="text-[9px] text-slate-500 hover:text-slate-300">Hi·ªán/·∫®n</button></div>
                            </div>

                            <div id="base-url-section" class="hidden">
                                <label class="text-[10px] font-bold text-slate-400 uppercase mb-1 block">Base URL (Endpoint)</label>
                                <input type="text" id="modal-base-url" class="pro-input w-full py-2 font-mono text-[10px]" value="https://generativelanguage.googleapis.com">
                                <p class="text-[9px] text-slate-500 mt-1 italic" id="url-hint">M·∫∑c ƒë·ªãnh: https://generativelanguage.googleapis.com</p>
                            </div>

                            <div class="pt-2 flex flex-col gap-2">
                                <button id="btn-save-login" class="w-full py-2 bg-violet-600 hover:bg-violet-500 text-white rounded text-xs font-bold transition-colors shadow-lg">L∆ØU C·∫§U H√åNH</button>
                                <button id="btn-logout" class="w-full py-2 bg-red-500/10 hover:bg-red-500/20 text-red-400 border border-red-500/20 rounded text-xs font-bold transition-colors hidden">ƒêƒÇNG XU·∫§T / RESET</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const apiKey = ""; 

            // === H·ªÜ TH·ªêNG M√É H√ìA B·∫¢O M·∫¨T ===
            const SimpleSec = {
                _key: "V35_SECURE_KEY_SALT", 
                encrypt: function(text) {
                    if(!text) return '';
                    try {
                        let result = '';
                        for(let i = 0; i < text.length; i++) {
                            result += String.fromCharCode(text.charCodeAt(i) ^ this._key.charCodeAt(i % this._key.length));
                        }
                        return btoa(result);
                    } catch(e) { return text; }
                },
                decrypt: function(encoded) {
                    if(!encoded) return '';
                    try {
                        let text = atob(encoded);
                        let result = '';
                        for(let i = 0; i < text.length; i++) {
                            result += String.fromCharCode(text.charCodeAt(i) ^ this._key.charCodeAt(i % this._key.length));
                        }
                        return result;
                    } catch(e) { return encoded; }
                }
            };

            // === COOKIE HELPERS (BACKUP STORAGE) ===
            const CookieMgr = {
                set: (name, value, days = 365) => {
                    const d = new Date();
                    d.setTime(d.getTime() + (days * 24 * 60 * 60 * 1000));
                    let expires = "expires=" + d.toUTCString();
                    document.cookie = name + "=" + value + ";" + expires + ";path=/";
                },
                get: (name) => {
                    let nameEQ = name + "=";
                    let ca = document.cookie.split(';');
                    for(let i = 0; i < ca.length; i++) {
                        let c = ca[i];
                        while (c.charAt(0) == ' ') c = c.substring(1, c.length);
                        if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length, c.length);
                    }
                    return null;
                }
            };
            
            // === USER & CREDIT SYSTEM (DUAL STORAGE: LS + COOKIE + MASTER BACKUP) ===
            const UserSystem = {
                deviceId: null,
                credits: 0,
                ipAddress: null, 
                
                async init() {
                    let storedId = null;
                    let backupData = null;

                    // 0. Th·ª≠ t·∫£i d·ªØ li·ªáu Backup t·ªïng h·ª£p (Master Backup)
                    try {
                        const backupRaw = localStorage.getItem('v35_store_backup');
                        if(backupRaw) {
                            backupData = JSON.parse(backupRaw);
                            console.log("Found Master Backup:", backupData);
                        }
                    } catch(e){}

                    // 1. Try LocalStorage
                    try {
                        storedId = localStorage.getItem('v35_unique_device_id');
                    } catch (e) { console.warn("LS denied"); }

                    // 2. Try Cookie if no LS (FALLBACK)
                    if (!storedId) {
                        storedId = CookieMgr.get('v35_unique_device_id');
                    }

                    // 3. Kh√¥i ph·ª•c t·ª´ Backup n·∫øu m·∫•t c·∫£ LS v√† Cookie (Quan tr·ªçng ƒë·ªÉ kh√¥ng m·∫•t Credit khi F5/M·ªü l·∫°i)
                    if (!storedId && backupData && backupData.id) {
                        storedId = backupData.id;
                        console.log("Restored ID from Master Backup:", storedId);
                    }

                    // 4. Generate New n·∫øu ho√†n to√†n kh√¥ng t√¨m th·∫•y g√¨ (Ng∆∞·ªùi d√πng m·ªõi)
                    if (!storedId) {
                        const randomPart = Math.random().toString(36).substring(2, 8).toUpperCase();
                        storedId = `ID-${randomPart}`;
                    }
                    
                    // 5. Save back to both (try/catch for safety)
                    this.deviceId = storedId;
                    
                    try { localStorage.setItem('v35_unique_device_id', storedId); } catch(e) {}
                    CookieMgr.set('v35_unique_device_id', storedId);
                    
                    this.loadCredits(backupData); // Truy·ªÅn backupData v√†o ƒë·ªÉ kh√¥i ph·ª•c Credit
                    this.updateUI();
                    await this.fetchIP();
                    this.updateUI();

                    // T·ª± ƒë·ªông l∆∞u khi ƒë√≥ng tab
                    window.addEventListener('beforeunload', () => {
                        this.save();
                    });
                },

                async fetchIP() {
                    try {
                        const response = await fetch(`https://api.ipify.org?format=json&t=${Date.now()}`);
                        const data = await response.json();
                        this.ipAddress = data.ip;
                        
                        const gateIpDisplay = document.getElementById('gate-ip-display');
                        const gateLoader = document.getElementById('gate-loading-spinner');
                        const adminIpDisplay = document.getElementById('display-ip-address');
                        const gateBtn = document.getElementById('gate-submit');
                        const gateStatus = document.getElementById('gate-status');
                        const topBarIp = document.getElementById('top-bar-ip');
                        if (topBarIp) topBarIp.textContent = `IP: ${data.ip}`;

                        const zaloMsg = document.getElementById('zalo-msg-content');
                        if (zaloMsg) {
                            zaloMsg.dataset.ipInfo = `IP: ${data.ip} - M√°y: ${this.deviceId}`;
                        }

                        if (gateIpDisplay) {
                            gateIpDisplay.innerHTML = `<span class="text-slate-400 text-xs">${data.ip}</span> <span class="text-white mx-1">|</span> <span class="text-yellow-400 font-bold">${this.deviceId}</span>`; 
                            gateIpDisplay.classList.remove('shimmer-text');
                            if(gateLoader) gateLoader.style.display = 'none';
                            if(gateBtn) {
                                gateBtn.disabled = false;
                                gateBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                                gateStatus.textContent = `ƒê√£ nh·∫≠n di·ªán thi·∫øt b·ªã: ${this.deviceId}`;
                                gateStatus.classList.add('text-green-500');
                            }
                        }
                        if(adminIpDisplay) adminIpDisplay.value = `${data.ip} (Device: ${this.deviceId})`;
                        return data.ip;
                    } catch (e) {
                        console.error("IP Fetch Error", e);
                        this.ipAddress = "Offline";
                        const gateIpDisplay = document.getElementById('gate-ip-display');
                        if (gateIpDisplay) gateIpDisplay.textContent = `Offline | ${this.deviceId}`;
                        const topBarIp = document.getElementById('top-bar-ip');
                        if (topBarIp) topBarIp.textContent = `IP: Offline`;
                        return null;
                    }
                },

                loadCredits(backupData) {
                    const key = `v35_credits_${this.deviceId}`;
                    let savedCredits = null;
                    
                    // 1. Try LocalStorage
                    try { savedCredits = localStorage.getItem(key); } catch(e){}
                    
                    // 2. Fallback to Cookie
                    if (savedCredits === null) {
                        savedCredits = CookieMgr.get(key);
                    }

                    // 3. Fallback to Master Backup (C·ª©u c√°nh cu·ªëi c√πng)
                    if (savedCredits === null && backupData && backupData.credits !== undefined) {
                        savedCredits = backupData.credits;
                        console.log("Restored Credits from Master Backup:", savedCredits);
                    }
                    
                    if (savedCredits === null) {
                        this.credits = 20; 
                        this.save();
                        console.log(`New Device ${this.deviceId} initialized with 20 credits`);
                    } else {
                        this.credits = parseInt(savedCredits);
                    }
                    
                    // ƒê·ªìng b·ªô l·∫°i m·ªçi n∆°i ngay l·∫≠p t·ª©c
                    this.save();
                },

                setCredits(amount) {
                    this.credits = amount;
                    this.save();
                },

                addCredits(amount) {
                    this.credits += amount;
                    this.save();
                },

                deductCredits(amount) {
                    if (this.credits >= amount) {
                        this.credits -= amount;
                        this.save();
                        return true;
                    }
                    return false;
                },

                save() {
                    const key = `v35_credits_${this.deviceId}`;
                    try {
                        // 1. Save to LocalStorage (Standard)
                        localStorage.setItem(key, this.credits);
                        localStorage.setItem('v35_unique_device_id', this.deviceId);

                        // 2. Save to Cookie (Backup)
                        CookieMgr.set(key, this.credits); // Backup to cookie
                        CookieMgr.set('v35_unique_device_id', this.deviceId);

                        // 3. Save to Master Backup (Robust Persistence)
                        // ƒê√¢y l√† file JSON ch·ª©a to√†n b·ªô tr·∫°ng th√°i quan tr·ªçng
                        const backupObj = {
                            id: this.deviceId,
                            credits: this.credits,
                            lastSaved: Date.now()
                        };
                        localStorage.setItem('v35_store_backup', JSON.stringify(backupObj));

                    } catch(e) {}
                    this.updateUI();
                },

                updateUI() {
                    const el = document.getElementById('credit-count');
                    if (el) el.textContent = this.credits;
                    const adminCredit = document.getElementById('admin-current-credits');
                    if (adminCredit) adminCredit.textContent = this.credits;
                    const adminDevId = document.getElementById('admin-device-id');
                    if(adminDevId) adminDevId.textContent = `${this.ipAddress || '...'} | ${this.deviceId}`;
                }
            };

            UserSystem.init();

            let state = { 
                base64: null, 
                refBase64: null, 
                restoredObj: null, 
                originalImg: null, 
                zoom: 1, 
                rotation: 0, 
                defaultPrompt: "Restore this photo, remove scratches, high quality, 8k",
                isLoupeActive: false,
                isReplicaMode: false,
                isFluxMode: true,
                currentSliderVal: 50,
                isComparing: false,
                aspectRatioType: null, // 'portrait', 'landscape', 'square'
                userSettings: {
                    username: '',
                    apiKey: '',
                    provider: 'google', // 'google' | 'comet' | 'custom'
                    baseUrl: 'https://generativelanguage.googleapis.com'
                }
            };

            const showToast = (message, type = 'info') => {
                const container = document.getElementById('toast-container');
                if(!container) return;
                const toast = document.createElement('div');
                const colors = type === 'error' ? 'bg-red-900/90 border-red-500/30 text-red-100' : 
                               type === 'warning' ? 'bg-yellow-900/90 border-yellow-500/30 text-yellow-100' :
                               type === 'smart' ? 'bg-emerald-900/90 border-emerald-500/30 text-emerald-100' :
                               type === 'flux' ? 'bg-violet-900/90 border-violet-500/30 text-violet-100' :
                               type === 'cyan' ? 'bg-cyan-900/90 border-cyan-500/30 text-cyan-100' :
                               type === 'real' ? 'bg-orange-900/90 border-orange-500/30 text-orange-100' :
                               type === 'ancient' ? 'bg-purple-900/90 border-purple-500/30 text-purple-100' :
                               'bg-slate-800/90 border-slate-600/30 text-white';
                toast.className = `flex items-center gap-4 px-5 py-4 rounded-xl border backdrop-blur-md shadow-2xl animate-toast-in ${colors}`;
                toast.innerHTML = `<span class="text-xs font-bold tracking-wide">${message}</span>`;
                container.appendChild(toast);
                setTimeout(() => {
                    toast.classList.add('animate-fade-out');
                    setTimeout(() => toast.remove(), 500);
                }, 3000);
            };

            // === LOCK SCREEN LOGIC ===
            const gateScreen = document.getElementById('security-gate');
            const gateSubmit = document.getElementById('gate-submit');
            const gateStatus = document.getElementById('gate-status');
            const gateAdminKey = document.getElementById('gate-admin-key');
            
            try {
                // LOAD M√É H√ìA
                const savedSettings = localStorage.getItem('v35_user_settings');
                if(savedSettings) {
                    // Th·ª≠ gi·∫£i m√£, n·∫øu kh√¥ng ƒë∆∞·ª£c (do b·∫£n c≈©) th√¨ parse th∆∞·ªùng
                    try {
                        const decrypted = SimpleSec.decrypt(savedSettings);
                        // N·∫øu gi·∫£i m√£ ra chu·ªói JSON h·ª£p l·ªá
                        if(decrypted && decrypted.startsWith('{')) {
                            state.userSettings = JSON.parse(decrypted);
                        } else {
                            // B·∫£n c≈© ch∆∞a m√£ h√≥a
                            state.userSettings = JSON.parse(savedSettings);
                        }
                    } catch(e) {
                         state.userSettings = JSON.parse(savedSettings);
                    }
                }
            } catch(e) {}

            async function loginByIP() {
                if(!UserSystem.ipAddress) return showToast("Ch∆∞a t√¨m th·∫•y IP, vui l√≤ng ƒë·ª£i...", "error");
                
                gateStatus.textContent = `ƒêang x√°c th·ª±c IP: ${UserSystem.ipAddress}...`;
                gateStatus.className = "mt-6 text-[10px] text-blue-400 font-bold animate-pulse";
                gateSubmit.disabled = true;
                gateSubmit.classList.add('opacity-70');

                setTimeout(() => {
                    gateStatus.textContent = "ƒêƒÉng nh·∫≠p th√†nh c√¥ng!";
                    gateStatus.className = "mt-6 text-[10px] text-green-400 font-bold";
                    
                    updateLoginUI();

                    setTimeout(() => {
                        gateScreen.classList.add('animate-fade-out');
                        setTimeout(() => { gateScreen.style.display = 'none'; }, 500);
                        showToast(`IP ƒê√£ X√°c Th·ª±c: ${UserSystem.ipAddress}`, "smart");
                    }, 500);
                }, 1500);
            }

            gateSubmit.addEventListener('click', loginByIP);
            
            if(gateAdminKey) gateAdminKey.addEventListener('click', (e) => {
                e.stopPropagation();
                adminModal.classList.remove('hidden');
                adminLoginView.classList.remove('hidden');
                adminDashView.classList.add('hidden');
                adminPassInput.value = '';
                adminPassInput.focus();
            });

            // === ADMIN MODAL LOGIC ===
            const btnOpenAdmin = document.getElementById('btn-login-modal');
            const adminModal = document.getElementById('admin-modal');
            const closeAdminBtn = document.getElementById('close-admin');
            const btnAdminLogin = document.getElementById('btn-admin-login');
            const adminPassInput = document.getElementById('admin-password');
            const adminLoginView = document.getElementById('admin-login-view');
            const adminDashView = document.getElementById('admin-dashboard-view');
            const btnSaveLogin = document.getElementById('btn-save-login');
            const btnLogout = document.getElementById('btn-logout');
            
            const modalUser = document.getElementById('modal-username');
            const modalKey = document.getElementById('modal-api-key');
            const modalBaseUrl = document.getElementById('modal-base-url');
            const btnProvGoogle = document.getElementById('btn-provider-google');
            const btnProvComet = document.getElementById('btn-provider-comet');
            const baseUrlSection = document.getElementById('base-url-section');
            const loginDot = document.getElementById('login-status-dot');
            const urlHint = document.getElementById('url-hint');
            const displayIp = document.getElementById('display-ip-address');

            function updateLoginUI() {
                if(state.userSettings.apiKey) {
                    if(loginDot) {
                        loginDot.classList.remove('bg-slate-600');
                        loginDot.classList.add('bg-green-500', 'shadow-[0_0_8px_#22c55e]');
                    }
                    if(btnLogout) btnLogout.classList.remove('hidden');
                    if(btnOpenAdmin) btnOpenAdmin.title = `Admin: ${state.userSettings.provider.toUpperCase()}`;
                } else {
                    if(loginDot) {
                        loginDot.classList.remove('bg-green-500', 'shadow-[0_0_8px_#22c55e]');
                        loginDot.classList.add('bg-slate-600');
                    }
                    if(btnLogout) btnLogout.classList.add('hidden');
                    if(btnOpenAdmin) btnOpenAdmin.title = "Admin / C·∫•u h√¨nh";
                }
            }
            if(state.userSettings.apiKey) updateLoginUI();

            if(btnOpenAdmin) btnOpenAdmin.addEventListener('click', () => {
                adminModal.classList.remove('hidden');
                adminLoginView.classList.remove('hidden');
                adminDashView.classList.add('hidden');
                adminPassInput.value = '';
                adminPassInput.focus();
            });

            if(closeAdminBtn) closeAdminBtn.addEventListener('click', () => adminModal.classList.add('hidden'));

            if(btnAdminLogin) btnAdminLogin.onclick = () => {
                const pass = adminPassInput.value.trim();
                // B·∫¢O M·∫¨T: SO S√ÅNH HASH (BASE64) THAY V√å TEXT THU·∫¶N
                // "ccdnacyme@1985" -> "Y2NkbmFjeW1lQDE5ODU="
                if(btoa(pass) === "Y2NkbmFjeW1lQDE5ODU=") {
                    showToast("ƒêƒÉng nh·∫≠p Admin th√†nh c√¥ng!", "success");
                    adminLoginView.classList.add('hidden');
                    adminDashView.classList.remove('hidden');
                    UserSystem.updateUI();
                    
                    modalUser.value = state.userSettings.username || '';
                    modalKey.value = state.userSettings.apiKey || '';
                    modalBaseUrl.value = state.userSettings.baseUrl || 'https://generativelanguage.googleapis.com';
                    
                    if(UserSystem.ipAddress) {
                        displayIp.value = UserSystem.ipAddress;
                    }
                    setProviderUI(state.userSettings.provider);

                } else {
                    showToast("M·∫≠t kh·∫©u kh√¥ng ƒë√∫ng!", "error");
                    adminPassInput.classList.add('border-red-500', 'text-red-500');
                    setTimeout(() => adminPassInput.classList.remove('border-red-500', 'text-red-500'), 2000);
                }
            };

            function setProviderUI(provider) {
                if(provider === 'comet') {
                    btnProvComet.classList.add('bg-violet-500', 'text-white', 'border-transparent');
                    btnProvComet.classList.remove('bg-violet-500/10', 'text-violet-300');
                    btnProvGoogle.classList.remove('bg-blue-500', 'text-white');
                    btnProvGoogle.classList.add('bg-white/5', 'text-slate-300');
                    baseUrlSection.classList.remove('hidden');
                    if(modalBaseUrl.value === 'https://generativelanguage.googleapis.com') {
                        modalBaseUrl.value = 'https://api.cometapi.com'; 
                    }
                    urlHint.textContent = "Endpoint CometAPI (VD: https://api.cometapi.com)";
                } else {
                    btnProvGoogle.classList.add('bg-blue-500', 'text-white');
                    btnProvGoogle.classList.remove('bg-white/5', 'text-slate-300');
                    btnProvComet.classList.remove('bg-violet-500', 'text-white');
                    btnProvComet.classList.add('bg-violet-500/10', 'text-violet-300');
                    baseUrlSection.classList.add('hidden');
                    modalBaseUrl.value = 'https://generativelanguage.googleapis.com';
                }
            }

            if(btnProvGoogle) btnProvGoogle.addEventListener('click', () => { state.userSettings.provider = 'google'; setProviderUI('google'); });
            if(btnProvComet) btnProvComet.addEventListener('click', () => { state.userSettings.provider = 'comet'; setProviderUI('comet'); });

            if(btnSaveLogin) btnSaveLogin.addEventListener('click', () => {
                state.userSettings.username = modalUser.value.trim();
                state.userSettings.apiKey = modalKey.value.trim();
                state.userSettings.baseUrl = modalBaseUrl.value.trim().replace(/\/$/, '');
                
                // L∆ØU C√ì M√É H√ìA
                try { 
                    const dataStr = JSON.stringify(state.userSettings);
                    const encrypted = SimpleSec.encrypt(dataStr);
                    localStorage.setItem('v35_user_settings', encrypted); 
                } catch(e){}

                updateLoginUI();
                showToast(`ƒê√£ l∆∞u c·∫•u h√¨nh (M√£ h√≥a): ${state.userSettings.provider.toUpperCase()}`, "success");
            });

            if(btnLogout) btnLogout.addEventListener('click', () => {
                state.userSettings = { username: '', apiKey: '', provider: 'google', baseUrl: 'https://generativelanguage.googleapis.com' };
                try { localStorage.removeItem('v35_user_settings'); } catch(e){}
                modalUser.value = ''; modalKey.value = '';
                
                gateScreen.style.display = 'flex';
                gateScreen.classList.remove('animate-fade-out');
                gateSubmit.disabled = true; // Wait for IP again
                gateSubmit.classList.add('opacity-70');
                gateStatus.textContent = "H·ªá th·ªëng t·ª± ƒë·ªông qu√©t l·∫°i IP...";
                gateStatus.className = "mt-6 text-[10px] text-slate-500 h-4 transition-colors";

                setProviderUI('google');
                updateLoginUI();
                adminModal.classList.add('hidden');
                UserSystem.fetchIP(); // Refetch IP
                showToast("ƒê√£ ƒëƒÉng xu·∫•t & Kh√≥a m√†n h√¨nh!", "info");
            });

            document.getElementById('toggle-show-key').addEventListener('click', (e) => {
                e.preventDefault();
                modalKey.type = modalKey.type === 'password' ? 'text' : 'password';
            });
            
            // === NEW: LICENSE KEY GENERATOR LOGIC ===
            const pkgBtns = document.querySelectorAll('.gen-pkg-btn');
            const selectedCreditInput = document.getElementById('gen-selected-credit');
            const btnGenerate = document.getElementById('btn-generate-key');
            const inputEmail = document.getElementById('gen-customer-email');
            const inputHash = document.getElementById('gen-customer-hash');
            const resultContainer = document.getElementById('gen-result-container');
            const resultKey = document.getElementById('gen-result-key');

            // Auto-Hash Email to Customer ID
            if(inputEmail && inputHash) {
                inputEmail.addEventListener('input', (e) => {
                    const val = e.target.value.trim();
                    if(val) {
                        // Create a simple hash from email
                        let hash = 0;
                        for (let i = 0; i < val.length; i++) {
                            const char = val.charCodeAt(i);
                            hash = ((hash << 5) - hash) + char;
                            hash = hash & hash; // Convert to 32bit integer
                        }
                        const hexHash = Math.abs(hash).toString(16).toUpperCase().substring(0, 8);
                        inputHash.value = hexHash;
                    } else {
                        inputHash.value = "HASH ID";
                    }
                });
            }

            // Package Selection
            pkgBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    pkgBtns.forEach(b => {
                        b.classList.remove('bg-violet-500', 'text-white', 'border-violet-500');
                        b.classList.add('bg-white/5', 'text-slate-300', 'border-white/10');
                    });
                    btn.classList.remove('bg-white/5', 'text-slate-300', 'border-white/10');
                    btn.classList.add('bg-violet-500', 'text-white', 'border-violet-500');
                    selectedCreditInput.value = btn.dataset.val;
                });
            });

            // Generate Key
            if(btnGenerate) {
                btnGenerate.addEventListener('click', () => {
                    const email = inputEmail.value.trim();
                    const hash = inputHash.value;
                    let credits = selectedCreditInput.value;
                    
                    if(!email) return showToast("Vui l√≤ng nh·∫≠p Email kh√°ch h√†ng!", "error");
                    if(!credits) { credits = "100"; } // Default

                    const rand = Math.random().toString(36).substring(2, 6).toUpperCase();
                    const timestamp = Date.now().toString(36).substring(4, 8).toUpperCase();
                    
                    // Format: V35-{CREDITS}-{HASH}-{RANDOM}-{TIME}
                    const key = `V35-${credits}-${hash}-${rand}-${timestamp}`;
                    
                    resultKey.value = key;
                    resultContainer.classList.remove('hidden');
                    showToast(`ƒê√£ t·∫°o m√£ ${credits} Credits th√†nh c√¥ng!`, "success");
                });
            }

            // Copy Key
            if(resultKey) {
                resultKey.addEventListener('click', () => {
                    // Use execCommand for iframe compatibility
                    const textArea = document.createElement("textarea");
                    textArea.value = resultKey.value;
                    textArea.style.position = "fixed"; // Prevent scrolling
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    
                    try {
                        document.execCommand('copy');
                        showToast("ƒê√£ copy M√£ K√≠ch Ho·∫°t!", "success");
                    } catch (err) {
                        console.error('Fallback copy failed', err);
                        showToast("L·ªói copy: " + err, "error");
                    }
                    
                    document.body.removeChild(textArea);
                    resultKey.select();
                });
            }
            
            // Helper to get effective API Key and URL
            const getApiConfig = () => {
                const manualKey = document.getElementById('user-api-key')?.value.trim();
                const key = manualKey || state.userSettings.apiKey || apiKey;
                const base = state.userSettings.baseUrl || "https://generativelanguage.googleapis.com";
                const isComet = state.userSettings.provider === 'comet';
                return { key, base, isComet };
            };
            
            const resizeImage = (base64Str, maxWidth = 1536) => {
                return new Promise((resolve) => {
                    const img = new Image();
                    img.src = base64Str;
                    img.onload = () => {
                        let width = img.width;
                        let height = img.height;
                        if (width > maxWidth || height > maxWidth) {
                            if (width > height) { height *= maxWidth / width; width = maxWidth; } 
                            else { width *= maxWidth / height; height = maxWidth; }
                        } else { resolve(base64Str); return; }
                        const canvas = document.createElement('canvas'); canvas.width = width; canvas.height = height;
                        const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', 0.9));
                    };
                });
            };

            const fluxToggle = document.getElementById('mode-flux');
            const workflowSelect = document.getElementById('kontext-workflow');
            const workflowDesc = document.getElementById('workflow-desc');
            const kontextContainer = document.getElementById('kontext-module-container');
            const replicaToggle = document.getElementById('mode-replica');
            const processBtn = document.getElementById('process-image');
            const creativitySlider = document.getElementById('creativity-slider');
            const creativityVal = document.getElementById('creativity-val');
            const idSlider = document.getElementById('identity-weight-slider');
            const idVal = document.getElementById('identity-weight-val');
            const textureMode = document.getElementById('texture-mode');
            const promptMain = document.getElementById('prompt-main');
            const compContainer = document.getElementById('comp-inner');
            const imgModWrapper = document.getElementById('img-modified-wrapper');
            const sliderHandle = document.getElementById('slider-handle');
            const magnifier = document.getElementById('magnifier');
            const toggleMagnifierBtn = document.getElementById('toggle-magnifier');
            const logoCheck = document.getElementById('check-logo');
            const logoOverlay = document.getElementById('logo-overlay');
            const btnAutoPilot = document.getElementById('btn-auto-pilot');
            const downloadTrigger = document.getElementById('download-trigger');
            const btnMobDown = document.getElementById('download-mobile');
            const btnReset = document.getElementById('reset-button');
            const grainSlider = document.getElementById('grain-slider');
            const grainVal = document.getElementById('grain-val');
            const colorGrading = document.getElementById('color-grading');
            const exposureSlider = document.getElementById('exposure-slider');
            const exposureVal = document.getElementById('exposure-val');
            const upscaleSelect = document.getElementById('upscale-mode');
            const structureSlider = document.getElementById('structure-slider');
            const structureVal = document.getElementById('structure-val');
            const structureContainer = document.getElementById('structure-container');
            
            const rechargeModal = document.getElementById('recharge-modal');
            const closeRechargeBtn = document.getElementById('close-recharge');
            const addCreditBtns = document.querySelectorAll('.add-credit-btn');

            if(closeRechargeBtn) closeRechargeBtn.onclick = () => rechargeModal.classList.add('hidden');
            
            addCreditBtns.forEach(btn => {
                btn.onclick = (e) => {
                    const amount = parseInt(e.target.dataset.amount);
                    UserSystem.addCredits(amount);
                    showToast(`ƒê√£ thay ƒë·ªïi s·ªë d∆∞: ${amount > 0 ? '+' : ''}${amount} CR`, "success");
                };
            });

            // === REDEEM CODE LOGIC ===
            const redeemBtn = document.getElementById('btn-submit-recharge');
            const redeemInput = document.getElementById('recharge-input');
            
            if(redeemBtn && redeemInput) {
                redeemBtn.addEventListener('click', () => {
                     const code = redeemInput.value.trim();
                     if(!code) return showToast("Vui l√≤ng nh·∫≠p m√£!", "error");
                     
                     // Check format V35-CREDIT-HASH-RAND-TIME
                     const parts = code.split('-');
                     if(parts.length !== 5 || parts[0] !== 'V35') return showToast("M√£ kh√¥ng h·ª£p l·ªá!", "error");
                     
                     // Check if used (simulated)
                     const usedCodes = JSON.parse(localStorage.getItem('v35_used_codes') || '[]');
                     if(usedCodes.includes(code)) return showToast("M√£ n√†y ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng!", "error");
                     
                     const credits = parseInt(parts[1]);
                     if(isNaN(credits)) return showToast("L·ªói ƒë·ªãnh d·∫°ng t√≠n d·ª•ng!", "error");
                     
                     UserSystem.addCredits(credits);
                     usedCodes.push(code);
                     localStorage.setItem('v35_used_codes', JSON.stringify(usedCodes));
                     
                     showToast(`N·∫°p th√†nh c√¥ng +${credits} Credits!`, "success");
                     rechargeModal.classList.add('hidden');
                     redeemInput.value = '';
                });
            }

            // === ZALO AUTO MESSAGE LOGIC (UPDATED WITH AUTO IP) ===
            const btnSendZalo = document.getElementById('btn-send-zalo');
            const zaloMsgContent = document.getElementById('zalo-msg-content');
            const pkgSelectBtns = document.querySelectorAll('.pkg-select-btn');

            // Function to update message with IP and amount
            const updateZaloMsg = (amount) => {
                if(!zaloMsgContent) return;
                // L·∫•y th√¥ng tin IP/ID ƒë√£ l∆∞u ho·∫∑c l·∫•y tr·ª±c ti·∫øp
                const ipInfo = zaloMsgContent.dataset.ipInfo || `IP: ${UserSystem.ipAddress} - ID: ${UserSystem.deviceId}`;
                zaloMsgContent.value = `ƒê√£ CK ${amount}. ${ipInfo}. Xin m√£ k√≠ch ho·∫°t Studio V35.`;
            };

            // Event listeners for package buttons
            pkgSelectBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    // Visual updates for buttons
                    pkgSelectBtns.forEach(b => {
                        b.classList.remove('bg-blue-600', 'text-white', 'border-blue-500');
                        b.classList.add('bg-white/5', 'text-slate-300', 'border-white/10');
                    });
                    btn.classList.remove('bg-white/5', 'text-slate-300', 'border-white/10');
                    btn.classList.add('bg-blue-600', 'text-white', 'border-blue-500');
                    
                    // Update content
                    updateZaloMsg(btn.dataset.amount);
                });
            });

            if(btnSendZalo && zaloMsgContent) {
                btnSendZalo.addEventListener('click', (e) => {
                    // Copy content to clipboard before opening link
                    const msg = zaloMsgContent.value.trim();
                    if(msg) {
                        // Use execCommand for iframe compatibility
                        const textArea = document.createElement("textarea");
                        textArea.value = msg;
                        textArea.style.position = "fixed"; // Prevent scrolling
                        document.body.appendChild(textArea);
                        textArea.focus();
                        textArea.select();
                        
                        try {
                            document.execCommand('copy');
                            showToast("ƒê√£ copy n·ªôi dung! H√£y d√°n v√†o Zalo.", "success");
                        } catch (err) {
                            console.error('Fallback copy failed', err);
                            // Don't block the link opening if copy fails, just log it
                        }
                        
                        document.body.removeChild(textArea);
                    } else {
                        showToast("Vui l√≤ng ch·ªçn g√≥i chuy·ªÉn kho·∫£n tr∆∞·ªõc!", "warning");
                        e.preventDefault(); // Prevent opening link if empty
                    }
                    // Link continues to open in new tab
                });
            }

            if(fluxToggle) {
                fluxToggle.addEventListener('change', (e) => {
                    state.isFluxMode = e.target.checked;
                    if(state.isFluxMode) {
                        showToast("üöÄ FLUX / REALVIS ENGINE: ƒê√É K√çCH HO·∫†T", "flux");
                        document.getElementById('creativity-slider')?.classList.add('slider-flux');
                        if(processBtn) {
                            processBtn.classList.remove('btn-primary-modern');
                            processBtn.classList.add('btn-flux-modern');
                            processBtn.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg> T·∫†O ·∫¢NH (FLUX KONTEXT V2)`;
                        }
                        if(colorGrading) colorGrading.value = "kodak portra 400 style, natural skin tone, fine grain";
                        document.getElementById('workflow-container').style.display = 'block';
                    } else {
                        showToast("ƒê√£ t·∫Øt AI Engine.");
                        document.getElementById('creativity-slider')?.classList.remove('slider-flux');
                        if(processBtn) {
                            processBtn.classList.remove('btn-flux-modern');
                            processBtn.classList.add('btn-primary-modern');
                            processBtn.innerHTML = "T·∫†O ·∫¢NH (ENTER)";
                        }
                        document.getElementById('workflow-container').style.display = 'none';
                    }
                });
            }

            if(workflowSelect) {
                workflowSelect.addEventListener('change', (e) => {
                    const val = e.target.value;
                    const desc = document.getElementById('workflow-desc');
                    const btn = document.getElementById('process-image');
                    const container = document.getElementById('kontext-module-container');

                    // Reset Classes
                    container.classList.remove('flux-active', 'real-active', 'ancient-active', 'replica-active');
                    btn.classList.remove('btn-flux-modern', 'btn-real-modern', 'btn-ancient-modern', 'btn-gold-modern');
                    
                    if (val === 'replica_pro') {
                        desc.textContent = "üß¨ ControlNet Canny + Depth + Reference (Kh√≥a c·∫•u tr√∫c tuy·ªát ƒë·ªëi)";
                        showToast("üß¨ ƒê√£ ch·ªçn: SI√äU TH·ª∞C (REPLICA PRO) - D√πng cho ·∫£nh c·ª±c m·ªù", "warning");
                        container.classList.add('replica-active');
                        btn.classList.add('btn-gold-modern');
                        btn.innerHTML = "T·∫†O ·∫¢NH (REPLICA PRO)";
                        
                        document.getElementById('check-blur-prepass').checked = true; 
                        document.getElementById('creativity-slider').value = 15;
                        document.getElementById('creativity-val').textContent = "M·ª©c 15% (Kh√≥a c·ª©ng)";
                        if(structureContainer) structureContainer.style.display = 'block';
                        document.getElementById('mode-replica').checked = true;
                    } else if(val === 'old_photo_v1') {
                        desc.textContent = "üìú Ref-Latent + FluxGuidance (2.5) + Kontext LoRA";
                        showToast("ƒê√£ ch·ªçn: Kontext V1.0 Native (Chuy√™n ph·ª•c h·ªìi c·∫•u tr√∫c)", "flux");
                        container.classList.add('flux-active');
                        btn.classList.add('btn-flux-modern');
                        btn.innerHTML = "T·∫†O ·∫¢NH (KONTEXT V1)";
                        if(structureContainer) structureContainer.style.display = 'none';
                    } else if (val === 'realvis_v5') {
                        desc.textContent = "ü¶Å RealVisXL V5.0 + ControlNet Union Promax + DepthAnything V2";
                        showToast("ü¶Å ƒê√£ ch·ªçn: RealVisXL V5 (Si√™u Th·ª±c - Ph·ª•c h·ªìi c·∫•u tr√∫c s√¢u)", "real");
                        container.classList.add('real-active');
                        btn.classList.add('btn-real-modern');
                        btn.innerHTML = "T·∫†O ·∫¢NH (REALVIS V5)";
                        if(structureContainer) structureContainer.style.display = 'none';
                    } else if (val === 'ancient_restore') {
                        desc.textContent = "üèØ ReActor Face Swap + Dual ControlNet (Depth + LineArt) + 4x-UltraSharp";
                        showToast("üèØ ƒê√£ ch·ªçn: Ph·ª•c ch·∫ø Tranh/T∆∞·ª£ng C·ªï (Face Swap & Dual ControlNet)", "ancient");
                        container.classList.add('ancient-active');
                        btn.classList.add('btn-ancient-modern');
                        btn.innerHTML = "T·∫†O ·∫¢NH (ANCIENT RESTORE)";
                        
                        document.getElementById('check-reactor').checked = true;
                        document.getElementById('check-dual-controlnet').checked = true;
                        if(upscaleSelect) upscaleSelect.value = "ultrasharp";
                        if(structureContainer) structureContainer.style.display = 'none';
                    } else if (val === 'wedding_pro') {
                        desc.textContent = "üíç S·ª≠ d·ª•ng Kontext_ÊëÑÂΩ±Á≤æ‰øÆlora_v1.safetensors (0.8) + RealESRGAN";
                        showToast("ƒê√£ ch·ªçn: Wedding Pro + Upscale (·∫¢nh C∆∞·ªõi)", "flux");
                        btn.classList.add('btn-flux-modern');
                        if(structureContainer) structureContainer.style.display = 'none';
                    } else if (val === 'wedding_kontext_v2') {
                         desc.textContent = "üë∞ Full JSON: FluxGuidance (3.5) + Refine Characters + Transparency";
                         showToast("üë∞ ƒê√£ ch·ªçn: Wedding Kontext V2 (Full JSON) - Trong tr·∫ªo & Chi ti·∫øt", "flux");
                         btn.classList.add('btn-flux-modern');
                         if(structureContainer) structureContainer.style.display = 'none';
                    } else if (val === 'qwen_restore_full') {
                         desc.textContent = "‚ö° Qwen V2.5-VL: Full Instruction Prompt (Chi ti·∫øt t·ªëi ƒëa)";
                         showToast("‚ö° ƒê√£ ch·ªçn: Qwen V2.5 Full Restore (Prompt G·ªëc t·ª´ JSON)", "cyan");
                         btn.classList.add('btn-flux-modern');
                         if(structureContainer) structureContainer.style.display = 'none';
                    } else if (val === 'outdoor_mode') {
                        desc.textContent = "üèûÔ∏è IC-Light + PowerPaint + Florence2 (Ngo·∫°i c·∫£nh)";
                        showToast("ƒê√£ ch·ªçn: Ch·∫ø ƒë·ªô Ph·ª•c h·ªìi Ngo·∫°i C·∫£nh Chuy√™n S√¢u", "smart");
                        btn.classList.add('btn-flux-modern');
                        if(structureContainer) structureContainer.style.display = 'none';
                    } else if (val === 'product_mode') {
                        desc.textContent = "üõçÔ∏è BiRefNet + IC-Light + ZenProduct LoRA (Ecommerce)";
                        showToast("ƒê√£ ch·ªçn: Ch·∫ø ƒë·ªô ·∫¢nh S·∫£n Ph·∫©m / Th∆∞∆°ng M·∫°i", "smart");
                        btn.classList.add('btn-flux-modern');
                        if(structureContainer) structureContainer.style.display = 'none';
                    } else if (val === 'white_bg') {
                        desc.textContent = "‚¨ú RMBG-2.0 + BiRefNetUltra (T√°ch n·ªÅn)";
                        showToast("ƒê√£ ch·ªçn: T√°ch N·ªÅn Tr·∫Øng (Studio)", "warning");
                        btn.classList.add('btn-flux-modern');
                        if(structureContainer) structureContainer.style.display = 'none';
                    } else if (val === 'qwen_lightning') {
                        desc.textContent = "‚ö° Qwen V2.5-VL (V2511 Lightning) - M√¥ h√¨nh GGUF+Lora m·ªõi nh·∫•t";
                        showToast("‚ö° ƒê√£ ch·ªçn: Qwen V2.5-VL (Lightning Fast)", "cyan");
                        btn.classList.add('btn-flux-modern');
                        if(structureContainer) structureContainer.style.display = 'none';
                    } else {
                        desc.textContent = "‚ú® S·ª≠ d·ª•ng OldPhoto-2.safetensors (0.87)";
                        showToast("ƒê√£ ch·ªçn: M·∫∑c ƒë·ªãnh (Standard)", "flux");
                        btn.classList.add('btn-flux-modern');
                        btn.innerHTML = "T·∫†O ·∫¢NH (FLUX KONTEXT)";
                        if(structureContainer) structureContainer.style.display = 'none';
                    }
                });
            }

            if(replicaToggle) {
                replicaToggle.addEventListener('change', (e) => {
                    state.isReplicaMode = e.target.checked;
                    if(state.isReplicaMode) {
                        showToast("üíé ƒê√É B·∫¨T CH·∫æ ƒê·ªò: SAO Y B·∫¢N CH√çNH (V33)", "warning");
                        if(processBtn) {
                            processBtn.classList.remove('btn-flux-modern', 'btn-real-modern', 'btn-ancient-modern');
                            processBtn.classList.add('btn-gold-modern');
                            processBtn.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path></svg> T·∫†O ·∫¢NH (REPLICA)`;
                        }
                        document.getElementById('module-identity')?.classList.add('open', 'replica-active');
                        if(creativitySlider) { creativitySlider.value = 10; creativitySlider.disabled = true; }
                        if(creativityVal) creativityVal.textContent = "M·ª©c 10% (T·ªëi ƒëa tu√¢n th·ªß g·ªëc)";
                        if(idSlider) idSlider.value = 400; 
                        if(idVal) idVal.textContent = "400% (Kh√≥a c·ª©ng)";
                        document.getElementById('check-asian-identity').checked = true;
                    } else {
                        showToast("ƒê√£ v·ªÅ ch·∫ø ƒë·ªô Studio");
                        if(state.isFluxMode) {
                            const wf = document.getElementById('kontext-workflow').value;
                            if (wf === 'realvis_v5') {
                                processBtn.classList.add('btn-real-modern');
                                processBtn.classList.remove('btn-gold-modern');
                                processBtn.innerHTML = "T·∫†O ·∫¢NH (REALVIS V5)";
                            } else if (wf === 'ancient_restore') {
                                processBtn.classList.add('btn-ancient-modern');
                                processBtn.classList.remove('btn-gold-modern');
                                processBtn.innerHTML = "T·∫†O ·∫¢NH (ANCIENT RESTORE)";
                            } else if (wf === 'replica_pro') {
                                processBtn.classList.add('btn-gold-modern');
                                processBtn.innerHTML = "T·∫†O ·∫¢NH (REPLICA PRO)";
                            } else {
                                processBtn.classList.add('btn-flux-modern');
                                processBtn.classList.remove('btn-gold-modern');
                                processBtn.innerHTML = "T·∫†O ·∫¢NH (FLUX KONTEXT)";
                            }
                        } else {
                            processBtn.classList.add('btn-primary-modern');
                            processBtn.innerHTML = "T·∫†O ·∫¢NH (ENTER)";
                        }
                        document.getElementById('module-identity')?.classList.remove('replica-active');
                        if(creativitySlider) { creativitySlider.value = 45; creativitySlider.disabled = false; }
                        if(creativityVal) creativityVal.textContent = "M·ª©c 45% (LZP Balanced)";
                        if(idSlider) idSlider.value = 300;
                        if(idVal) idVal.textContent = "300%";
                    }
                });
            }

            const toggleModule = (btnId, contentId, iconId) => {
                const btn = document.getElementById(btnId), content = document.getElementById(contentId), icon = document.getElementById(iconId);
                if(btn) btn.addEventListener('click', () => {
                    if(content) content.classList.toggle('open');
                    if(icon && content) icon.style.transform = content.classList.contains('open') ? 'rotate(180deg)' : 'rotate(0deg)';
                });
            };

            toggleModule('toggle-processing', 'content-processing', 'icon-processing');
            toggleModule('toggle-subject', 'content-subject', 'icon-subject');
            toggleModule('toggle-identity', 'content-identity', 'icon-identity');
            toggleModule('toggle-prompt', 'content-prompt', 'icon-prompt');
            toggleModule('toggle-logo', 'content-logo', 'icon-logo');
            toggleModule('toggle-military', 'content-military', 'icon-military');
            toggleModule('toggle-cinematic', 'content-cinematic', 'icon-cinematic');
            toggleModule('toggle-exposure', 'content-exposure', 'icon-exposure');

            let isDragging = false;
            const syncViewerSize = () => {
                const imgOrg = document.getElementById('img-original');
                const imgMod = document.getElementById('img-modified');
                if (imgOrg && imgMod && state.restoredObj) {
                    const width = imgOrg.offsetWidth;
                    const height = imgOrg.offsetHeight;
                    if(width > 0 && height > 0) {
                        imgMod.style.width = width + "px";
                        imgMod.style.height = height + "px";
                        imgMod.style.maxWidth = "none"; 
                    }
                }
            };
            window.addEventListener('resize', () => { requestAnimationFrame(syncViewerSize); });

            const updateSlider = (percent) => {
                if(!imgModWrapper || !sliderHandle) return;
                percent = Math.max(0, Math.min(100, percent));
                state.currentSliderVal = percent;
                imgModWrapper.style.width = percent + '%';
                sliderHandle.style.left = percent + '%';
            };

            const handleMove = (e) => {
                if(state.isLoupeActive || state.isComparing) return;
                if(!isDragging || !compContainer) return;
                const rect = compContainer.getBoundingClientRect();
                const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
                let percent = (x / rect.width) * 100;
                updateSlider(percent);
            };

            const startCompare = () => {
                if(!state.restoredObj) return;
                state.isComparing = true;
                if(imgModWrapper) imgModWrapper.style.display = 'none';
                if(sliderHandle) sliderHandle.style.opacity = '0';
            };
            
            const endCompare = () => {
                if(!state.restoredObj) return;
                state.isComparing = false;
                if(imgModWrapper) imgModWrapper.style.display = 'block';
                if(sliderHandle) sliderHandle.style.opacity = '1';
            };

            document.addEventListener('keydown', (e) => { if(e.code === 'Space' && state.restoredObj && document.activeElement.tagName !== 'INPUT' && document.activeElement.tagName !== 'TEXTAREA') { e.preventDefault(); startCompare(); } });
            document.addEventListener('keyup', (e) => { if(e.code === 'Space') endCompare(); });

            if(compContainer) {
                compContainer.addEventListener('mousedown', () => { if(!state.isLoupeActive) isDragging = true; });
                compContainer.addEventListener('touchstart', () => { if(!state.isLoupeActive) isDragging = true; });
                window.addEventListener('mouseup', () => isDragging = false);
                window.addEventListener('touchend', () => isDragging = false);
                window.addEventListener('mousemove', handleMove);
                window.addEventListener('touchmove', handleMove);

                if(toggleMagnifierBtn) {
                    toggleMagnifierBtn.addEventListener('click', () => {
                        state.isLoupeActive = !state.isLoupeActive;
                        if(state.isLoupeActive) {
                            toggleMagnifierBtn.classList.add('bg-white', 'text-black', 'border-transparent');
                            toggleMagnifierBtn.classList.remove('text-slate-300', 'bg-white/5');
                            compContainer.style.cursor = 'none';
                            showToast("ƒê√£ b·∫≠t K√≠nh L√∫p", "success");
                        } else {
                            toggleMagnifierBtn.classList.remove('bg-white', 'text-black', 'border-transparent');
                            toggleMagnifierBtn.classList.add('text-slate-300', 'bg-white/5');
                            if(magnifier) magnifier.style.display = 'none';
                            compContainer.style.cursor = 'ew-resize';
                        }
                    });
                }

                compContainer.addEventListener('mousemove', (e) => {
                    if(!state.isLoupeActive || !state.restoredObj || !magnifier) return;
                    const rect = compContainer.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    if (x < 0 || y < 0 || x > rect.width || y > rect.height) { magnifier.style.display = 'none'; return; }
                    magnifier.style.display = 'block';
                    magnifier.style.left = x + 'px';
                    magnifier.style.top = y + 'px';
                    const zoom = 3; 
                    magnifier.style.backgroundSize = `${rect.width * zoom}px ${rect.height * zoom}px`;
                    magnifier.style.backgroundPosition = `-${x * zoom - 100}px -${y * zoom - 100}px`;
                });
                compContainer.addEventListener('mouseleave', () => { if(magnifier) magnifier.style.display = 'none'; });
            }

            if(logoCheck && logoOverlay) {
                logoCheck.addEventListener('change', (e) => {
                    if(e.target.checked) logoOverlay.classList.add('active');
                    else logoOverlay.classList.remove('active');
                });
            }

            // === UPDATED: CLICK PLACEHOLDER TO TRIGGER UPLOAD ON MOBILE ===
            const placeholder = document.getElementById('placeholder-state');
            if(placeholder) {
                placeholder.addEventListener('click', () => {
                    const uploadInput = document.getElementById('image-upload');
                    if(uploadInput) uploadInput.click();
                });
            }

            if(btnAutoPilot) {
                btnAutoPilot.addEventListener('click', async () => {
                    if(!state.base64) return showToast("Vui l√≤ng t·∫£i ·∫£nh tr∆∞·ªõc!", "error");
                    const originalText = btnAutoPilot.innerHTML;
                    btnAutoPilot.disabled = true;
                    btnAutoPilot.innerHTML = `<span class="animate-pulse">AUTO-SCAN V35.60 (AUTO-SIZE)...</span>`;
                    
                    const { key: keyToUse, base: apiBase, isComet } = getApiConfig();

                    try {
                        const resizedBase64 = await resizeImage(state.base64);
                        const headers = { 'Content-Type': 'application/json' };
                        if (isComet) headers['Authorization'] = `Bearer ${keyToUse}`;

                        const response = await fetch(`${apiBase}/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${keyToUse}`, {
                            method: 'POST',
                            headers: headers,
                            body: JSON.stringify({
                                contents: [{
                                    parts: [
                                        { text: "Analyze this image for restoration. DETECT VIETNAMESE MILITARY DETAILS SPECIFICALLY. Return ONLY JSON: { \"sceneContext\": \"wedding\"|\"funeral\"|\"casual\"|\"studio\"|\"outdoor\"|\"product\"|\"painting\"|\"ancient_portrait\", \"lightingCondition\": \"rembrandt\"|\"golden_hour\"|\"neon\"|\"soft_diffused\"|\"flat\"|\"overexposed\"|\"harsh_sun\", \"backgroundType\": \"plain\"|\"complex_outdoor\"|\"complex_indoor\", \"faceAngle\": \"front\"|\"side_left\"|\"side_right\"|\"tilted_up\"|\"tilted_down\", \"jawStructure\": \"defined\"|\"soft\"|\"round\"|\"square\", \"noseAngle\": \"straight\"|\"tilted\", \"mouthAngle\": \"straight\"|\"tilted\", \"eyeSymmetry\": \"even\"|\"uneven\", \"hasAsymmetry\": boolean, \"isNature\": boolean, \"isMilitary\": boolean, \"isGroupPhoto\": boolean, \"hasVisibleRankInsignia\": boolean, \"rankColor\": \"red\"|\"green\"|\"blue\"|\"none\", \"specificHat\": \"pith_helmet\"|\"soft_cap\"|\"kepi\"|\"bamboo_helmet\"|\"none\", \"gender\": \"male\"|\"female\", \"age\": number, \"damageType\": \"scratches\"|\"faded\"|\"sepia\"|\"severe_damage\"|\"none\", \"isOldPhoto\": boolean, \"isLowContrast\": boolean, \"isNoisy\": boolean, \"hasStrabismus\": boolean, \"hasDroopyEyelids\": boolean, \"hasClosedEyes\": boolean, \"hasDistinctiveImperfections\": boolean, \"hasMonolids\": boolean, \"hasBuckTeeth\": boolean, \"hasBlackenedTeeth\": boolean, \"needsBackgroundRestoration\": boolean, \"militaryBranch\": \"army\"|\"air_force\"|\"navy\"|\"border_guard\"|\"police\"|\"youth_volunteer\"|\"unknown\", \"uniformEra\": \"tran_thu\"|\"to_chau\"|\"k82\"|\"k94\"|\"camouflage\"|\"unknown\", \"rankLevel\": \"soldier\"|\"officer\"|\"unknown\", \"hasMedalSaoVang\": boolean, \"hasMedalKhangChien\": boolean, \"hasBadgeDoan\": boolean, \"isIDPhoto\": boolean, \"isHazy\": boolean }" },
                                        { inlineData: { mimeType: "image/jpeg", data: resizedBase64.split(',')[1] } }
                                    ]
                                }]
                            })
                        });
                        const data = await response.json();
                        let text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                        if(text) {
                            text = text.replace(/```json/g, '').replace(/```/g, '').trim();
                            const result = JSON.parse(text);
                            
                            const genderSelect = document.getElementById('gender-select');
                            if(genderSelect) {
                                if(result.gender === 'male') genderSelect.value = 'male';
                                else if(result.gender === 'female') genderSelect.value = 'female';
                            }
                            const ageInput = document.getElementById('age-input');
                            if(ageInput) ageInput.value = result.age || 30;

                            if (result.isMilitary) {
                                const milContent = document.getElementById('content-military');
                                const insigEl = document.getElementById('check-insignia-boost');
                                if(milContent) milContent.classList.add('open');
                                if(insigEl) insigEl.checked = true;
                                
                                const branchSelect = document.getElementById('mil-branch');
                                const uniformSelect = document.getElementById('mil-uniform');
                                const hatSelect = document.getElementById('hat-select');
                                const rankSelect = document.getElementById('rank-select');

                                showToast("üáªüá≥ AUTO SCAN: ƒê√£ ph√°t hi·ªán ·∫¢nh Qu√¢n ƒê·ªôi", "warning");
                                document.getElementById('module-military').classList.add('military-highlight');
                                setTimeout(() => document.getElementById('module-military').classList.remove('military-highlight'), 3000);

                                if(branchSelect) {
                                    if(result.militaryBranch === 'air_force') branchSelect.value = "vietnamese air force, blue collar tabs";
                                    else if(result.militaryBranch === 'navy') branchSelect.value = "vietnamese navy, navy blue uniform, white striped collar";
                                    else if(result.militaryBranch === 'border_guard') branchSelect.value = "vietnamese border guard, green collar tabs";
                                    else if(result.militaryBranch === 'police') branchSelect.value = "vietnamese public security, green uniform, red collar tabs";
                                    else if(result.militaryBranch === 'youth_volunteer') branchSelect.value = "vietnamese youth volunteer force, dark green uniform";
                                    else branchSelect.value = "vietnamese army ground force, red collar tabs"; 
                                }

                                if(uniformSelect) {
                                    if(result.uniformEra === 'tran_thu') uniformSelect.value = "wearing tran thu shirt, padded cotton jacket, viet minh era";
                                    else if(result.uniformEra === 'to_chau') uniformSelect.value = "wearing to chau uniform, plain green fatigue, vietnam war era";
                                    else if(result.uniformEra === 'k82') uniformSelect.value = "wearing K82 uniform, formal military tunic";
                                    else if(result.uniformEra === 'camouflage') uniformSelect.value = "wearing camouflage special force uniform";
                                }

                                if(hatSelect) {
                                    if(result.specificHat === 'pith_helmet') hatSelect.value = "wear vietnamese pith helmet, hard pith helmet, dark green color, rounded shape, red badge with yellow star";
                                    else if(result.specificHat === 'soft_cap') hatSelect.value = "wear vietnamese soft cap, boonie hat, green fabric, red star badge";
                                    else if(result.specificHat === 'kepi') hatSelect.value = "wear vietnamese officer kepi hat, mixed red and green color, gold chin strap, red badge with gold star";
                                    else if(result.specificHat === 'bamboo_helmet') hatSelect.value = "wear vietnamese bamboo helmet, cloth covered";
                                }

                                if(rankSelect) {
                                    if(result.rankLevel === 'soldier') rankSelect.value = "plain red collar tabs, soldier rank";
                                    else if(result.rankLevel === 'officer') rankSelect.value = "red collar tabs with one star, officer rank";
                                    else if(!result.hasVisibleRankInsignia) rankSelect.value = "no_rank_insignia";
                                }

                                if(result.hasMedalSaoVang) document.getElementById('check-sao-vang').checked = true;
                                if(result.hasMedalKhangChien) document.getElementById('check-khang-chien').checked = true;
                                if(result.hasBadgeDoan) document.getElementById('check-doan').checked = true;
                            }

                            const colorGrading = document.getElementById('color-grading');
                            if(colorGrading && result.lightingCondition) {
                                if(result.lightingCondition === 'rembrandt') { colorGrading.value = "rembrandt_lighting"; }
                                else if(result.lightingCondition === 'golden_hour') { colorGrading.value = "golden_hour_backlight"; }
                                else if(result.lightingCondition === 'neon') { colorGrading.value = "neon_cyberpunk"; }
                                else if(result.lightingCondition === 'overexposed' || result.lightingCondition === 'harsh_sun') {
                                    document.getElementById('content-exposure').classList.add('open');
                                    document.getElementById('check-qwen-exposure').checked = true;
                                    showToast("‚òÄÔ∏è Ph√°t hi·ªán CH√ÅY S√ÅNG: Auto k√≠ch ho·∫°t Qwen Edit", "cyan");
                                }
                            }

                            if(result.isGroupPhoto) {
                                const groupEl = document.getElementById('check-group-mode');
                                if(groupEl) { groupEl.checked = true; showToast("üë• Auto b·∫≠t: Group Photo Pro (GroundingDINO)", "warning"); }
                            }

                            if (result.isIDPhoto) {
                                document.getElementById('check-id-photo').checked = true;
                                showToast("üì∏ Auto b·∫≠t: Ch·∫ø ƒë·ªô ·∫¢nh th·∫ª (ID Photo)", "blue");
                            }

                            if (result.isHazy) {
                                document.getElementById('check-dehaze').checked = true;
                                showToast("üå´Ô∏è Ph√°t hi·ªán S∆∞∆°ng m√π: Auto b·∫≠t Kh·ª≠ s∆∞∆°ng", "info");
                                document.getElementById('container-dehaze')?.classList.add('contrast-highlight');
                            }

                            const dmgSelect = document.getElementById('damage-level');
                            if (dmgSelect) {
                                if (result.damageType === 'severe_damage') dmgSelect.value = "fix torn, missing details";
                                else if (result.damageType === 'scratches') dmgSelect.value = "fix scratches, mold";
                                else dmgSelect.value = "fix slightly blurry";
                            }

                            const workflowSelect = document.getElementById('kontext-workflow');
                            const workflowDesc = document.getElementById('workflow-desc');
                            
                            if(workflowSelect) workflowSelect.value = 'default';
                            
                            if (result.sceneContext === 'ancient_portrait' || result.sceneContext === 'painting') {
                                if(workflowSelect) {
                                    workflowSelect.value = "ancient_restore";
                                    if(workflowDesc) workflowDesc.textContent = "üèØ Auto: ReActor + Dual ControlNet + 4x-UltraSharp";
                                    showToast("üèØ Auto Detect: Tranh C·ªï / T∆∞·ª£ng -> K√≠ch ho·∫°t Ancient Restore Mode", "ancient");
                                    document.getElementById('check-reactor').checked = true;
                                    document.getElementById('check-dual-controlnet').checked = true;
                                    document.getElementById('kontext-module-container').classList.add('workflow-highlight');
                                    setTimeout(() => document.getElementById('kontext-module-container').classList.remove('workflow-highlight'), 3000);
                                }
                            }
                            else if (result.sceneContext === 'wedding') {
                                if(workflowSelect) {
                                    workflowSelect.value = "wedding_kontext_v2"; 
                                    if(workflowDesc) workflowDesc.textContent = "üë∞ Auto: Wedding Kontext Full JSON (Trong tr·∫ªo)";
                                    showToast("üë∞ Auto Detect: ·∫¢nh C∆∞·ªõi -> K√≠ch ho·∫°t Wedding Kontext V2 (Full JSON)", "smart");
                                    document.getElementById('kontext-module-container').classList.add('workflow-highlight');
                                    setTimeout(() => document.getElementById('kontext-module-container').classList.remove('workflow-highlight'), 3000);
                                }
                            } 
                            else if (result.sceneContext === 'product' || (result.backgroundType === 'plain' && !result.isOldPhoto && !result.isMilitary)) {
                                if(workflowSelect) {
                                    if(result.sceneContext === 'product') {
                                        workflowSelect.value = "product_mode";
                                        if(workflowDesc) workflowDesc.textContent = "üõçÔ∏è Auto: BiRefNet + IC-Light + ZenProduct LoRA";
                                        showToast("üõçÔ∏è Auto Detect: ·∫¢nh S·∫£n Ph·∫©m (N·ªÅn Tr∆°n) -> K√≠ch ho·∫°t E-commerce Mode", "smart");
                                    } else {
                                        workflowSelect.value = "white_bg"; 
                                        if(workflowDesc) workflowDesc.textContent = "‚¨ú Auto: RMBG-2.0 + BiRefNetUltra (N·ªÅn Tr∆°n)";
                                        showToast("‚¨ú Auto Detect: N·ªÅn Tr∆°n (Studio) -> K√≠ch ho·∫°t T√°ch N·ªÅn/Clean Mode", "smart");
                                    }
                                    document.getElementById('kontext-module-container').classList.add('workflow-highlight');
                                    setTimeout(() => document.getElementById('kontext-module-container').classList.remove('workflow-highlight'), 3000);
                                }
                            }
                            else if (result.sceneContext === 'outdoor' || result.backgroundType === 'complex_outdoor' || result.isNature) {
                                 if(workflowSelect) {
                                    workflowSelect.value = "outdoor_mode";
                                    if(workflowDesc) workflowDesc.textContent = "üèûÔ∏è Auto: IC-Light + PowerPaint + Florence2";
                                    showToast("üèûÔ∏è Auto Detect: N·ªÅn Ngo√†i C·∫£nh (Ph·ª©c t·∫°p) -> K√≠ch ho·∫°t Outdoor Mode", "smart");
                                    document.getElementById('kontext-module-container').classList.add('workflow-highlight');
                                    setTimeout(() => document.getElementById('kontext-module-container').classList.remove('workflow-highlight'), 3000);
                                }
                            }
                            else if (result.isOldPhoto || result.damageType === 'scratches' || result.damageType === 'severe_damage' || result.damageType === 'faded' || result.damageType === 'sepia' || result.isNoisy) {
                                if(workflowSelect) {
                                    if (result.damageType === 'severe_damage' || result.isNoisy) {
                                        workflowSelect.value = "replica_pro";
                                        if(workflowDesc) workflowDesc.textContent = "üß¨ Auto: Replica Pro - Kh√≥a c·∫•u tr√∫c c·ª±c ƒëoan cho ·∫£nh m·ªù";
                                        showToast("üß¨ Auto Detect: ·∫¢nh r·∫•t m·ªù -> K√≠ch ho·∫°t REPLICA PRO", "warning");
                                    } else {
                                        workflowSelect.value = "old_photo_v1";
                                        if(workflowDesc) workflowDesc.textContent = "üìú Auto: Kontext V1.0 Native (Ref-Latent Boost)";
                                        showToast("üìú Auto Detect: ·∫¢nh c≈© th∆∞·ªùng -> K√≠ch ho·∫°t Kontext V1.0 Native", "warning");
                                    }
                                    document.getElementById('kontext-module-container').classList.add('workflow-highlight');
                                    setTimeout(() => document.getElementById('kontext-module-container').classList.remove('workflow-highlight'), 3000);
                                }
                            }

                            if (result.isNoisy || result.damageType === 'severe_damage') {
                                const blurCheck = document.getElementById('check-blur-prepass');
                                if (blurCheck) {
                                    blurCheck.checked = true;
                                    showToast("üíß Ph√°t hi·ªán Nhi·ªÖu h·∫°t/Noise: Auto b·∫≠t Kh·ª≠ Nhi·ªÖu S√¢u (Blur Input)", "real");
                                    const blurContainer = document.getElementById('container-blur-prepass');
                                    if(blurContainer) {
                                        blurContainer.classList.add('real-pulse');
                                        setTimeout(() => blurContainer.classList.remove('real-pulse'), 3000);
                                    }
                                }
                            }

                            if(result.isLowContrast || result.damageType === 'faded' || result.damageType === 'sepia') {
                                const contrastCheck = document.getElementById('check-contrast-fix');
                                if(contrastCheck) {
                                    contrastCheck.checked = true;
                                    showToast("üåì Ph√°t hi·ªán ·∫£nh m·ªù/nh·∫°t: Auto b·∫≠t Kontext Contrast (1.3)", "flux");
                                    const contrastContainer = document.getElementById('container-contrast-fix');
                                    if(contrastContainer) {
                                        contrastContainer.classList.add('contrast-highlight');
                                        setTimeout(() => contrastContainer.classList.remove('contrast-highlight'), 3000);
                                    }
                                }
                            }

                            if(result.hasStrabismus) document.getElementById('check-cross-eyed').checked = true;
                            
                            if(result.hasDroopyEyelids) {
                                const ptosisCheck = document.getElementById('check-ptosis');
                                if(ptosisCheck) {
                                    ptosisCheck.checked = true;
                                    showToast("üëÅÔ∏è Ph√°t hi·ªán S·ª•p M√≠ (Ptosis): ƒê√£ b·∫≠t ch·∫ø ƒë·ªô gi·ªØ m√≠ s·ª•p", "warning");
                                    document.getElementById('container-ptosis')?.classList.add('identity-highlight');
                                }
                            }
                            if(result.hasClosedEyes) {
                                const closedCheck = document.getElementById('check-closed-eyes');
                                if(closedCheck) {
                                    closedCheck.checked = true;
                                    showToast("üí§ Ph√°t hi·ªán M·∫Øt Nh·∫Øm/Ng·ªß: ƒê√£ b·∫≠t ch·∫ø ƒë·ªô gi·ªØ m·∫Øt nh·∫Øm", "warning");
                                    document.getElementById('container-closed-eyes')?.classList.add('identity-highlight');
                                }
                            }

                            if(result.hasDistinctiveImperfections) {
                                const imperfCheck = document.getElementById('lock-imperfection');
                                if(imperfCheck) {
                                    imperfCheck.checked = true;
                                    showToast("üß¨ Ph√°t hi·ªán ƒë·∫∑c ƒëi·ªÉm ri√™ng (n·ªët ru·ªìi/s·∫πo): Auto b·∫≠t Gi·ªØ Khuy·∫øt ƒêi·ªÉm", "warning");
                                    const imperfContainer = document.getElementById('container-imperfection');
                                    if(imperfContainer) {
                                        imperfContainer.classList.add('identity-highlight');
                                        setTimeout(() => imperfContainer.classList.remove('identity-highlight'), 3000);
                                    }
                                }
                            }

                            if (!state.isReplicaMode) {
                                document.getElementById('mode-replica').click();
                                showToast("üíé Auto Scan: ƒê√£ k√≠ch ho·∫°t Ch·∫ø ƒë·ªô Sao Y B·∫£n Ch√≠nh (Replica)", "warning");
                            }
                            
                            let smartPrompt = `Restore this ${result.sceneContext} photo. (high resolution:1.5), (masterpiece:1.4), (detailed background:1.3). `;
                            smartPrompt += "(hyper-realistic skin texture:1.6), (detailed skin pores:1.5), (rosy undertone:1.3), (natural beauty:1.2). ";
                            
                            let negPromptAdd = "";
                            if (result.faceAngle === 'side_left' || result.faceAngle === 'side_right' || result.faceAngle === 'tilted_up' || result.faceAngle === 'tilted_down') {
                                smartPrompt += "(side profile:1.5), (looking away:1.2), (tilted head:1.3). ";
                                if(result.faceAngle === 'side_left') smartPrompt += "(looking left:1.5), ";
                                if(result.faceAngle === 'side_right') smartPrompt += "(looking right:1.5), ";
                                negPromptAdd = ", (front view:1.5), (looking at camera:1.5), (symmetry:1.4)";
                                showToast(`üìê Ph√°t hi·ªán G√ìC NGHI√äNG (${result.faceAngle}): ƒê√£ kh√≥a g√≥c m·∫∑t!`, "warning");
                            }

                            if (result.hasAsymmetry || result.eyeSymmetry === 'uneven') {
                                smartPrompt += "(natural facial asymmetry:1.3), (preserve irregular features:1.3). ";
                                negPromptAdd += ", (perfect symmetry:1.5), (mirror face:1.4), (beautified symmetry:1.4)";
                                showToast("üß¨ Ph√°t hi·ªán m·∫∑t l·ªách t·ª± nhi√™n: ƒê√£ kh√≥a c·∫•u tr√∫c g·ªëc!", "danger");
                            }

                            if (result.noseAngle === 'tilted' || result.faceAngle.includes('side')) smartPrompt += "(preserve nose angle:1.4), (tilted nose:1.2). ";
                            if (result.mouthAngle === 'tilted') smartPrompt += "(preserve mouth angle:1.3). ";
                            if (result.jawStructure) smartPrompt += `(preserve ${result.jawStructure} jawline:1.3). `;
                            if (result.isNature || result.sceneContext === 'outdoor') smartPrompt += "(high detailed background:1.4), (sharp background textures:1.4). ";
                            if (state.isFluxMode) smartPrompt += "(flux generation style:1.5), (controlnet union style:1.2), (high fidelity:1.5), (kontext lighting:1.4). ";

                            if(promptMain) promptMain.value = smartPrompt;
                            
                            const negInput = document.getElementById('prompt-negative');
                            if(negInput && negPromptAdd) {
                                let currentNeg = negInput.value;
                                if (!currentNeg.includes("front view")) negInput.value = currentNeg + negPromptAdd;
                            }

                            document.getElementById('content-prompt').classList.add('open');
                            btnAutoPilot.classList.remove('btn-smart-modern');
                            btnAutoPilot.classList.add('bg-violet-600');
                        }
                    } catch(e) { console.error(e); showToast("L·ªói Smart Scan: " + e.message, "error"); } 
                    finally { btnAutoPilot.disabled = false; btnAutoPilot.innerHTML = originalText; }
                });
            }

            const loadImg = (file) => {
                if (!file || !file.type.startsWith('image/')) return showToast("Ch·ªâ h·ªó tr·ª£ file ·∫£nh!", "error");
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        state.base64 = e.target.result;
                        state.originalImg = img; state.restoredObj = null; 
                        
                        const ar = img.width / img.height;
                        if(ar > 1.1) state.aspectRatioType = 'landscape';
                        else if(ar < 0.9) state.aspectRatioType = 'portrait';
                        else state.aspectRatioType = 'square';
                        
                        document.getElementById('img-original').src = state.base64;
                        document.getElementById('comparison-view').style.display = 'flex';
                        document.getElementById('placeholder-state').style.display = 'none';
                        downloadTrigger.disabled = true;
                        if(btnMobDown) btnMobDown.disabled = true;
                        imgModWrapper.style.width = '0%'; sliderHandle.style.left = '0%';
                        showToast(`ƒê√£ t·∫£i ·∫£nh: ${img.width}x${img.height} (${state.aspectRatioType.toUpperCase()})`, "success");

                        // === MOBILE SMART BAR UPDATE ===
                        // T·ª± ƒë·ªông chuy·ªÉn n√∫t T·∫£i ·∫£nh -> Auto Scan ngay khi ·∫£nh l√™n h√¨nh
                        const mUpload = document.getElementById('mob-btn-upload');
                        const mScan = document.getElementById('mob-btn-scan');
                        const mStatus = document.getElementById('mobile-status-text');
                        
                        if(mUpload && mScan) {
                            mUpload.classList.add('hidden');
                            mScan.classList.remove('hidden');
                            mStatus.textContent = "·∫¢NH ƒê√É S·∫¥N S√ÄNG - B·∫§M SCAN";
                            mStatus.classList.remove('text-violet-400');
                            mStatus.classList.add('text-violet-400', 'font-bold', 'animate-pulse');
                        }
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            };

            const fileInput = document.getElementById('image-upload');
            if(fileInput) fileInput.addEventListener('change', (e) => { if (e.target.files.length > 0) { loadImg(e.target.files[0]); e.target.value = ''; } });
            
            const dropZone = document.getElementById('drop-zone');
            if(dropZone && fileInput) {
                dropZone.addEventListener('click', (e) => { if(e.target !== fileInput) {} });
                ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                    dropZone.addEventListener(eventName, (e) => { e.preventDefault(); e.stopPropagation(); }, false);
                    document.body.addEventListener(eventName, (e) => { e.preventDefault(); e.stopPropagation(); }, false);
                });
                ['dragenter', 'dragover'].forEach(eventName => { dropZone.addEventListener(eventName, () => dropZone.classList.add('bg-violet-900/20', 'border-violet-400'), false); });
                ['dragleave', 'drop'].forEach(eventName => { dropZone.addEventListener(eventName, () => dropZone.classList.remove('bg-violet-900/20', 'border-violet-400'), false); });
                dropZone.addEventListener('drop', (e) => { const dt = e.dataTransfer; const files = dt.files; if (files.length > 0) loadImg(files[0]); }, false);
            }

            const loadRefImg = (file) => {
                 if (!file || !file.type.startsWith('image/')) return showToast("Ch·ªâ h·ªó tr·ª£ file ·∫£nh!", "error");
                 const reader = new FileReader();
                 reader.onload = (e) => {
                     state.refBase64 = e.target.result;
                     const preview = document.getElementById('ref-img-preview');
                     preview.style.backgroundImage = `url('${state.refBase64}')`;
                     preview.style.display = 'block';
                     document.getElementById('ref-text').textContent = "ƒê√£ nh·∫≠n";
                     document.getElementById('clear-ref').style.display = 'flex';
                     showToast("ƒê√£ t·∫£i ·∫£nh tham chi·∫øu!", "success");
                 };
                 reader.readAsDataURL(file);
            };
            const refUpload = document.getElementById('ref-upload');
            if(refUpload) refUpload.addEventListener('change', (e) => { if(e.target.files.length > 0) loadRefImg(e.target.files[0]); });
            const clearRef = document.getElementById('clear-ref');
            if(clearRef) clearRef.addEventListener('click', () => {
                state.refBase64 = null;
                document.getElementById('ref-img-preview').style.display = 'none';
                document.getElementById('ref-text').textContent = "+ Th√™m ·∫£nh r√µ n√©t";
                clearRef.style.display = 'none';
                if(refUpload) refUpload.value = "";
            });

            const zoomInBtn = document.getElementById('zoom-in');
            if(zoomInBtn) zoomInBtn.onclick = () => { if(state.zoom < 3) state.zoom += 0.1; document.getElementById('canvas-scale-container').style.transform = `scale(${state.zoom}) rotate(${state.rotation}deg)`; document.getElementById('zoom-level').textContent = Math.round(state.zoom * 100) + '%'; };
            const zoomOutBtn = document.getElementById('zoom-out');
            if(zoomOutBtn) zoomOutBtn.onclick = () => { if(state.zoom > 0.2) state.zoom -= 0.1; document.getElementById('canvas-scale-container').style.transform = `scale(${state.zoom}) rotate(${state.rotation}deg)`; document.getElementById('zoom-level').textContent = Math.round(state.zoom * 100) + '%'; };
            const zoomResetBtn = document.getElementById('zoom-reset');
            if(zoomResetBtn) zoomResetBtn.onclick = () => { state.zoom = 1; state.rotation = 0; document.getElementById('canvas-scale-container').style.transform = `scale(${state.zoom}) rotate(${state.rotation}deg)`; document.getElementById('zoom-level').textContent = Math.round(state.zoom * 100) + '%'; };
            const rotateBtn = document.getElementById('rotate-btn');
            if(rotateBtn) rotateBtn.onclick = () => { state.rotation = (state.rotation + 90) % 360; document.getElementById('canvas-scale-container').style.transform = `scale(${state.zoom}) rotate(${state.rotation}deg)`; };
            
            const sidebar = document.getElementById('sidebar');
            const toggleSidebar = document.getElementById('toggle-sidebar-btn');
            if(toggleSidebar) toggleSidebar.onclick = () => sidebar.classList.remove('-translate-x-full');
            const closeSidebar = document.getElementById('close-sidebar-mobile');
            if(closeSidebar) closeSidebar.onclick = () => sidebar.classList.add('-translate-x-full');
            
            function drawLogo(ctx, width, height) {
                if (logoCheck && logoCheck.checked) {
                    // UPDATED: DEFAULT LOGO TEXT
                    const customText = document.getElementById('custom-logo-text').value.trim() || "PHOTO RESTORATION";
                    
                    ctx.filter = 'none'; ctx.save(); ctx.translate(width / 2, height / 2); ctx.rotate(-45 * Math.PI / 180);
                    const fontSize = Math.max(20, width / 25); ctx.font = "900 " + fontSize + "px 'Playfair Display', serif"; 
                    ctx.fillStyle = "rgba(255, 255, 255, 0.15)"; ctx.textAlign = "center"; ctx.textBaseline = "middle";
                    const stepX = fontSize * 11; const stepY = fontSize * 5.5;  
                    const limit = (Math.sqrt(width*width + height*height)) / 2 + fontSize * 5; 
                    for (let y = -limit; y < limit; y += stepY) {
                        const offsetX = (Math.round(y / stepY) % 2 === 0) ? 0 : (stepX / 2);
                        for (let x = -limit - stepX; x < limit + stepX; x += stepX) { ctx.fillText(customText, x + offsetX, y); }
                    }
                    ctx.restore();
                }
            }

            if(processBtn) {
                processBtn.addEventListener('click', async () => {
                    if(!state.base64) return showToast("Vui l√≤ng t·∫£i ·∫£nh!", "error");
                    if (!UserSystem.deductCredits(20)) {
                        rechargeModal.classList.remove('hidden');
                        return; 
                    }
                    
                    processBtn.disabled = true;
                    processBtn.innerHTML = "FLUX/KONTEXT PROCESSING...";
                    document.getElementById('ai-terminal-overlay').classList.remove('hidden');
                    document.getElementById('scan-beam').classList.add('active');
                    
                    const isAsian = document.getElementById('check-asian-identity')?.checked || false;
                    const isImperfection = document.getElementById('lock-imperfection')?.checked || false;
                    const isUniformSkin = document.getElementById('check-uniform-skin')?.checked || false;
                    const eventContext = document.getElementById('event-context')?.value || '';
                    const isDehaze = document.getElementById('check-dehaze')?.checked || false;
                    const isContrastFix = document.getElementById('check-contrast-fix')?.checked || false;
                    
                    const milBranch = document.getElementById('mil-branch')?.value || '';
                    const milUniform = document.getElementById('mil-uniform')?.value || '';
                    const hatVal = document.getElementById('hat-select')?.value || '';
                    const rankVal = document.getElementById('rank-select')?.value || ''; 
                    const isInsigniaBoost = document.getElementById('check-insignia-boost')?.checked || false;
                    const isSaoVang = document.getElementById('check-sao-vang')?.checked || false;
                    const isKhangChien = document.getElementById('check-khang-chien')?.checked || false;
                    const isChienSi = document.getElementById('check-chien-si')?.checked || false;
                    const isDoan = document.getElementById('check-doan')?.checked || false;
                    
                    const isBlockRank = document.getElementById('block-rank')?.checked || false;

                    const grainLevel = parseInt(grainSlider?.value) || 0;
                    const colorGrade = colorGrading?.value || '';
                    const isGroupMode = document.getElementById('check-group-mode')?.checked || false;
                    const isTextureBoost = document.getElementById('check-texture-boost')?.checked || false;
                    const isCrossEyed = document.getElementById('check-cross-eyed')?.checked || false;
                    
                    const isPtosis = document.getElementById('check-ptosis')?.checked || false;
                    const isClosedEyes = document.getElementById('check-closed-eyes')?.checked || false;

                    const isMonolid = document.getElementById('check-monolid')?.checked || false;
                    const isBuckTeeth = document.getElementById('check-buck-teeth')?.checked || false;
                    const isBlackTeeth = document.getElementById('check-black-teeth')?.checked || false;
                    
                    const isQwenExposure = document.getElementById('check-qwen-exposure')?.checked || false;
                    const isRemoveShadow = document.getElementById('check-remove-shadow')?.checked || false;
                    const isSoftLight = document.getElementById('check-soft-light')?.checked || false;
                    const exposureStrength = parseFloat(document.getElementById('exposure-slider')?.value || 1.0);
                    
                    const textureModeVal = document.getElementById('texture-mode')?.value || '';
                    const isIDPhoto = document.getElementById('check-id-photo')?.checked || false;
                    const isBlurPrepass = document.getElementById('check-blur-prepass')?.checked || false;
                    const workflowVal = document.getElementById('kontext-workflow')?.value || 'default';
                    const isReActor = document.getElementById('check-reactor')?.checked || false;
                    const isDualControlNet = document.getElementById('check-dual-controlnet')?.checked || false;
                    const upscaleMode = document.getElementById('upscale-mode')?.value || 'supir';
                    const isAntiFlip = document.getElementById('check-anti-flip')?.checked || false;

                    let finalPrompt = promptMain?.value || state.defaultPrompt;
                    let negPrompt = document.getElementById('prompt-negative')?.value || "blur, noise, low quality"; 

                    negPrompt += ", Negative(hands), text, error, cropped, (worst quality:1.2), (low quality:1.2), normal quality, (jpeg artifacts:1.3), signature, watermark, username, blurry, artist name, monochrome, sketch, censorship, censor, (copyright:1.2), extra legs, (forehead mark), (depth of field), (emotionless), (penis), noises, dusts, scratches, multicolor, patches, extra hands, wrong adam apple, dark skin, painting, earring, scratches, stains, old photo damages, bad quality, blurry, (beard:2), (facial hair:2)";

                    const restorePrompt = "Restore old photos, colorize, reconstruct missing parts, repair damage, remove noise, adjust brightness and contrast, adjust color balance, sharpen facial features, restore details, enlarge to high resolution";
                    
                    if (state.isFluxMode) {
                        showToast("üöÄ K√≠ch ho·∫°t AI Engine V35.65...", "flux");
                        finalPrompt += `, ${restorePrompt}`;
                        
                        if(workflowVal === 'realvis_v5') {
                            showToast("ü¶Å ƒêang ch·∫°y: RealVisXL V5 (Si√™u th·ª±c)...", "real");
                            finalPrompt += ", (RealVisXL V5.0 style:1.5), (photorealistic:1.6), (8k uhd:1.4), (high quality:1.5)";
                            finalPrompt += ", (ControlNet Union Promax:1.2), (DepthAnything V2 based structure:1.4)";
                            finalPrompt += ", (sharp focus:1.4), (highly detailed:1.3), (professional photography:1.4), (bright natural ambient light:1.3)";
                            if(isBlurPrepass) {
                                finalPrompt += ", (pre-blur denoising:1.3), (smooth skin texture:1.4), (remove grain:1.5)";
                                showToast("üíß ƒê√£ k√≠ch ho·∫°t: Kh·ª≠ nhi·ªÖu s√¢u (Smart Blur)", "real");
                            }
                        } else if (workflowVal === 'replica_pro') {
                            showToast("üß¨ K√≠ch ho·∫°t REPLICA PRO: Kh√≥a c·∫•u tr√∫c s√¢u...", "warning");
                            finalPrompt += ", (ControlNet Canny Hard:1.2), (ControlNet Depth V2:1.2), (ReferenceLatent:1.3)";
                            finalPrompt += ", (maintain facial structure:1.6), (preserve eye shape:1.5), (preserve mouth shape:1.5)";
                            finalPrompt += ", (hyper-detailed skin texture:1.6), (no beautification:1.4), (raw photo:1.5)";
                            finalPrompt += ", (keep imperfections:1.3), (natural look:1.5)";
                            negPrompt += ", (beautified:1.5), (makeup:1.2), (smooth skin:1.5), (plastic:1.6), (doll:1.6)";
                        } else {
                            finalPrompt += ", (Repair old photos:1.4), (restore to high fidelity photography:1.4), (keep people's appearance and features unchanged:1.5), (recolor and repair damaged areas:1.3)";
                            finalPrompt += ", (flux generation style:1.5), (lzp old photo style:1.5), (high fidelity:1.5), (photorealistic:1.6)";
                            
                            if(workflowVal === 'old_photo_v1') {
                                 finalPrompt += ", (Kontext_ËÄÅÁÖßÁâá‰øÆÂ§çlora_v1.safetensors:1.0)";
                                 finalPrompt += ", (ReferenceLatent:1.2), (FluxGuidance:2.5)"; 
                                 showToast("üìú √Åp d·ª•ng Workflow: Kontext V1.0 Native", "warning");
                            } else if (workflowVal === 'ancient_restore') {
                                 finalPrompt += ", (Ancient Restoration LoRA:1.0), (Qing Dynasty style:1.2), (traditional painting restoration:1.3)";
                                 finalPrompt += ", (Flux.1-dev-ControlNet-Union-Pro:1.2)";
                                 showToast("üèØ √Åp d·ª•ng Workflow: Ancient Restore (Tranh C·ªï)", "ancient");
                            } else if (workflowVal === 'wedding_pro') {
                                 finalPrompt += ", (Kontext_ÊëÑÂΩ±Á≤æ‰øÆlora_v1.safetensors:0.8)";
                                 finalPrompt += ", (RealESRGAN_x4 upscale simulation:1.4), (wedding photography style:1.3)";
                                 showToast("üíç √Åp d·ª•ng Workflow: Wedding Pro + RealESRGAN", "smart");
                            } else if (workflowVal === 'wedding_kontext_v2') {
                                 finalPrompt += ", (Kontext_ÊëÑÂΩ±Á≤æ‰øÆlora_v1.safetensors:0.8), (FluxGuidance:3.5)";
                                 finalPrompt += ", (Refine characters:1.4), (adjust color tone:1.3), (transparent and clear image:1.3)";
                                 finalPrompt += ", (RealESRGAN_x4 upscale:1.0)";
                                 showToast("üë∞ √Åp d·ª•ng Workflow: Wedding Kontext V2 (Full JSON)", "flux");
                            } else if (workflowVal === 'outdoor_mode') {
                                 finalPrompt += ", (IC-Light:1.0), (PowerPaint:1.0), (Florence2 Captioning:1.2)";
                                 showToast("üèûÔ∏è √Åp d·ª•ng Workflow: Ph·ª•c h·ªìi Ngo·∫°i C·∫£nh Chuy√™n S√¢u", "smart");
                            } else if (workflowVal === 'product_mode') {
                                 finalPrompt += ", (ZenProduct LoRA:0.6), (BiRefNet Segmentation:1.0)";
                                 showToast("üõçÔ∏è √Åp d·ª•ng Workflow: ·∫¢nh S·∫£n Ph·∫©m (Ecommerce)", "smart");
                            } else if (workflowVal === 'white_bg') {
                                 finalPrompt += ", (RMBG-2.0:1.0), (remove background:1.5), (pure white background:1.5)";
                                 showToast("‚¨ú √Åp d·ª•ng Workflow: T√°ch n·ªÅn tr·∫Øng", "warning");
                            } else if (workflowVal === 'qwen_lightning') {
                                 finalPrompt += ", (Qwen-Image-Edit-2511:1.2), (Lightning-4steps-V1.0-fp32:1.0)";
                                 finalPrompt += ", (Instruction: High-resolution photo reconstruction:1.5)";
                                 finalPrompt += ", (Detailed facial preservation, zero identity drift:1.4)";
                                 finalPrompt += ", (Remove dust, scratches, and grain:1.3), (Full colorization with lifelike subsurface scattering:1.3)";
                                 finalPrompt += ", (Repair torn edges and artifacts:1.3), (neutral white balance:1.2)";
                                 showToast("‚ö° √Åp d·ª•ng Workflow: Qwen V2.5-VL (V2511) - Newest", "cyan");
                            } else if (workflowVal === 'qwen_restore_full') {
                                 finalPrompt += ", (Qwen-Image-Edit-2511:1.2), (Lightning-4steps-V1.0-fp32:1.0)";
                                 finalPrompt += ", (Instruction: High-resolution photo reconstruction. Detailed facial preservation, zero identity drift. Remove dust, scratches, and grain. Full colorization with lifelike subsurface scattering on skin. Naturalistic lighting, professional color grading. Repair torn edges and artifacts. 4K, highly detailed, sharp focus, neutral white balance, professional photography, realistic textures, volumetric lighting:1.5)";
                                 showToast("‚ö° √Åp d·ª•ng Workflow: Qwen V2.5 Full Restore (Prompt G·ªëc)", "cyan");
                            } else {
                                 finalPrompt += ", (oldphoto-2.safetensors:0.87), (vintage photo restoration:1.2)";
                            }
                        }

                        if(upscaleMode === 'supir') {
                             showToast("üåü ƒêang Upscale b·∫±ng SUPIR v0F (High Fidelity)...", "flux");
                             finalPrompt += ", (SUPIR-v0F_fp16 style:1.4), (RestoreDPMPP2MSampler:1.2)";
                        } else if (upscaleMode === 'ultrasharp') {
                             showToast("‚ö° ƒêang Upscale b·∫±ng 4x-UltraSharp (T·ªëc ƒë·ªô)...", "flux");
                             finalPrompt += ", (4x-UltraSharp Upscale:1.5), (sharp details:1.5)";
                        } else if (upscaleMode === 'realesrgan') {
                             showToast("üíç ƒêang Upscale b·∫±ng RealESRGAN...", "smart");
                             finalPrompt += ", (RealESRGAN x4 Plus:1.4), (smooth restoration:1.3)";
                        } else if (upscaleMode === 'pixel_perfect') {
                             showToast("üíé ƒêang ch·∫°y Pixel Perfect: Gi·ªØ nguy√™n h·∫°t...", "warning");
                             finalPrompt += ", (preserve original pixels:1.4), (no smoothing:1.4), (sharp grain:1.3)";
                        }

                        if (textureModeVal.includes('Canon')) {
                            finalPrompt += `, (${textureModeVal}:1.4), (perfect retouched complexion:1.3), (glowing healthy skin:1.2)`;
                        } else {
                            finalPrompt += ", (hyper-realistic skin texture:1.6), (detailed pores:1.5), (subsurface scattering:1.4)";
                        }
                        
                        if (isTextureBoost) finalPrompt += ", (visible fabric weave:1.5), (intricate clothing details:1.6), (detailed leather texture:1.5), (detailed textures:1.5)";
                        
                        if (isGroupMode) {
                            finalPrompt += ", (group photo:1.5), (all faces sharp:1.4), (individual face detail:1.3), (high resolution faces:1.5)";
                            showToast("üë• K√≠ch ho·∫°t GroundingDINO cho ·∫£nh t·∫≠p th·ªÉ", "warning");
                        }

                        if(colorGrade.includes('rembrandt')) finalPrompt += ", (Rembrandt lighting:1.5), (45 degree key light:1.4), (triangle of light on cheek:1.3), (dramatic contrast:1.4)";
                        else if(colorGrade.includes('golden_hour')) finalPrompt += ", (Golden hour backlighting:1.6), (warm tones:1.5), (soft rim light:1.5), (lens flare:1.2)";
                        else if(colorGrade.includes('soft_diffused')) finalPrompt += ", (Soft diffused light:1.5), (even tones:1.4), (no harsh shadows:1.4)";
                        else if(colorGrade.includes('neon')) finalPrompt += ", (Neon cinematic lighting:1.6), (pink and blue reflections:1.4), (cyberpunk atmosphere:1.3)";

                        if(!(isCrossEyed || isPtosis || isClosedEyes || isMonolid || isBuckTeeth || isBlackTeeth || isImperfection)) {
                            negPrompt += ", (waxy skin:1.6), (plastic skin:1.6), (airbrushed:1.6), (doll face:1.5), (cartoon:1.5), (3d render:1.5), (disfigured:1.5), (bad art:1.5)";
                        } else {
                            negPrompt += ", (waxy skin:1.6), (plastic skin:1.6)";
                        }
                        finalPrompt += ", (individual hair strands:1.5), (volumetric hair:1.4)";
                        
                        if(isDualControlNet) {
                             finalPrompt += ", (ControlNet Union Depth:1.0), (ControlNet Union LineArt:1.0), (structure preservation:1.5)";
                             showToast("üß± K√≠ch ho·∫°t Dual ControlNet (Depth + LineArt)", "ancient");
                        } else {
                             finalPrompt += ", (controlnet union style:1.2)";
                        }
                    }

                    if (isQwenExposure) {
                        showToast("‚òÄÔ∏è K√≠ch ho·∫°t Qwen Edit (V2509) - X·ª≠ l√Ω ch√°y s√°ng", "cyan");
                        finalPrompt += `, (Qwen Image Edit V2509 style:1.2)`;
                        if (isRemoveShadow) {
                            finalPrompt += `, (remove harsh light and shadow:${(1.5 * exposureStrength).toFixed(1)}), (neutralize exposure:${(1.4 * exposureStrength).toFixed(1)})`;
                            negPrompt += ", (overexposed:1.5), (blown out highlights:1.5), (harsh shadows:1.5)";
                        }
                        if (isSoftLight) {
                            finalPrompt += `, (soft diffused lighting:${(1.5 * exposureStrength).toFixed(1)}), (relight image:${(1.4 * exposureStrength).toFixed(1)})`;
                        }
                    }

                    if (eventContext) finalPrompt += `, (${eventContext}:1.6)`;
                    
                    if (isIDPhoto) {
                        finalPrompt += ", (ID photo:1.8), (passport photo:1.8), (clean blue background:1.5), (even lighting:1.5), (looking straight at camera:1.6), (formal attire:1.4)";
                    }

                    if(grainLevel > 0) finalPrompt += `, (film grain:${(grainLevel/50).toFixed(1)}), (analog photography:1.2)`;
                    if(colorGrade && !colorGrade.includes('_')) finalPrompt += `, ${colorGrade}`;

                    if (state.refBase64) {
                        finalPrompt = "The first image is the target old photo. The second image is a REFERENCE FACE. Restore using reference features. " + finalPrompt;
                        
                        if(isReActor) {
                            finalPrompt += ", (ReActor Face Swap:1.0), (InsightFace Swap:1.0), (codeformer face restore:1.0)";
                            showToast("üé≠ ƒêang th·ª±c hi·ªán Face Swap (ReActor)...", "ancient");
                        } else {
                            finalPrompt += `, (use reference face features:2.0), (ReferenceLatent:1.0)`;
                        }
                    }

                    if (isAsian) finalPrompt += ", (vietnamese nationality:1.4), (asian facial features:1.4), (dark brown eyes:1.2), (warm yellow skin tone:1.2)";
                    if(isDehaze) finalPrompt += ", (dehaze:1.8), (clear atmosphere:1.5)";
                    
                    if(isContrastFix) {
                        finalPrompt += ", (match original color tone:1.3), (consistent color grading:1.3), (KJNodes ColorMatch style:1.2)";
                        finalPrompt += ", (high contrast:1.3), (tonal range adjustment:1.2), (rich blacks:1.3)";
                        if(document.getElementById('check-vibrant')?.checked) finalPrompt += ", (saturation boost:1.03)";
                    }

                    const shouldAddRank = !isBlockRank && rankVal !== 'no_rank_insignia';

                    if (milBranch) finalPrompt += `, (${milBranch}:1.6)`;
                    if (milUniform) finalPrompt += `, (${milUniform}:1.5)`;
                    if (hatVal) finalPrompt += `, (${hatVal}:2.5)`;
                    
                    if (shouldAddRank && rankVal) {
                        finalPrompt += `, (${rankVal}:2.5), (sharp collar tab details:1.6)`;
                    } else if (isBlockRank || rankVal === 'no_rank_insignia') {
                        finalPrompt += `, (plain collar:1.5), (no rank insignia:1.5)`;
                        negPrompt += `, collar tabs, rank insignia, shoulder marks, epaulettes, red badge`;
                    }

                    if (isInsigniaBoost && shouldAddRank) finalPrompt += `, (detailed military insignia:1.6), (shiny gold star badge:1.6), (collar rank details:1.5)`;
                    
                    if (isSaoVang) finalPrompt += `, (wearing golden star medal on left chest:2.0)`;
                    if (isKhangChien) finalPrompt += `, (wearing vietnamese resistance war medals:1.5)`;
                    if (isChienSi) finalPrompt += `, (wearing soldier of glory badge:1.5)`;
                    if (isDoan) finalPrompt += `, (wearing ho chi minh communist youth union badge:1.5)`;

                    if(isCrossEyed) finalPrompt += ", (strabismus:2.0), (cross-eyed:2.0)";
                    
                    if(isPtosis) finalPrompt += ", (droopy eyelids:1.8), (ptosis:1.8), (heavy eyelids:1.6)";
                    if(isClosedEyes) { 
                        finalPrompt += ", (closed eyes:1.6), (sleeping:1.4), (eyes shut:1.5)";
                        negPrompt += ", (wide open eyes:1.5), (staring eyes:1.5), (surprised look:1.4), (looking at camera:1.4)";
                    }

                    if(isMonolid) finalPrompt += ", (monolid eyes:1.8), (single eyelid:1.8)";
                    if(isBuckTeeth) finalPrompt += ", (buck teeth:1.8), (protruding upper teeth:1.8)";
                    if(isBlackTeeth) { finalPrompt += ", (traditional blackened teeth:2.0), (lacquered black teeth:1.8)"; negPrompt += ", (perfect white teeth:2.0), (bleached teeth:2.0)"; }
                    
                    if(isAntiFlip) {
                         finalPrompt += ", (exact orientation:1.6), (preserve left right orientation:1.5), (no mirroring:1.5)";
                         
                         if (state.aspectRatioType === 'portrait') {
                             finalPrompt += ", (vertical orientation:1.5), (portrait mode:1.5), (tall aspect ratio:1.4)";
                             negPrompt += ", (horizontal orientation:2.0), (landscape mode:2.0), (wide aspect ratio:2.0)";
                             showToast("üìè Kh√≥a chi·ªÅu: D·ªåC (Portrait) - NgƒÉn l·∫≠t ngang", "warning");
                         } else if (state.aspectRatioType === 'landscape') {
                             finalPrompt += ", (horizontal orientation:1.5), (landscape mode:1.5), (wide aspect ratio:1.4)";
                             negPrompt += ", (vertical orientation:2.0), (portrait mode:2.0), (tall aspect ratio:2.0)";
                             showToast("üìè Kh√≥a chi·ªÅu: NGANG (Landscape) - NgƒÉn l·∫≠t d·ªçc", "warning");
                         } else {
                             finalPrompt += ", (square aspect ratio:1.5)";
                         }

                         negPrompt += ", (flipped:2.0), (mirrored:2.0), (horizontal flip:2.0), (inverted orientation:2.0)";
                    }

                    if (document.getElementById('check-vibrant')?.checked) finalPrompt += ", (rich colors:1.4), (vibrant fabric:1.4)";

                    finalPrompt += ", (tiled upscaling style:1.2), (no seams:1.4)";

                    const termContent = document.getElementById('terminal-content');
                    const steps = ["LOADING AI ENGINE...", "ANALYZING IMAGE STRUCTURE...", "RESTORING DETAILS...", "APPLYING COLOR MATCH...", "FINALIZING..."];
                    let stepIdx = 0;
                    const termInterval = setInterval(() => {
                        if(stepIdx < steps.length) {
                            if(termContent) termContent.innerHTML += `<div class='text-violet-300'>${steps[stepIdx]}</div>`;
                            const pBar = document.getElementById('term-progress-bar');
                            if(pBar) pBar.style.width = ((stepIdx+1)*20) + "%";
                            stepIdx++;
                        }
                    }, 800);

                    const { key: keyToUse, base: apiBase, isComet } = getApiConfig();

                    try {
                        const resizedBase64 = await resizeImage(state.base64);
                        const parts = [
                            { text: `${finalPrompt}. Negative prompt: ${negPrompt}. (deblur:1.5), (sharpen:1.5), (unblur:1.5)` },
                            { inlineData: { mimeType: "image/jpeg", data: resizedBase64.split(',')[1] } }
                        ];
                        if (state.refBase64) parts.push({ inlineData: { mimeType: "image/jpeg", data: state.refBase64.split(',')[1] } });

                        const headers = { 'Content-Type': 'application/json' };
                        if (isComet) headers['Authorization'] = `Bearer ${keyToUse}`;

                        const response = await fetch(`${apiBase}/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${keyToUse}`, {
                            method: 'POST',
                            headers: headers,
                            body: JSON.stringify({ contents: [{ parts: parts }], generationConfig: { responseModalities: ["TEXT", "IMAGE"] } })
                        });

                        const data = await response.json();
                        if (data.error) throw new Error(data.error.message || "L·ªói k·∫øt n·ªëi ƒë·∫øn server AI.");
                        
                        let base64Img = null;
                        if (data.candidates && data.candidates[0].content && data.candidates[0].content.parts) {
                            for (const part of data.candidates[0].content.parts) {
                                if (part.inlineData && part.inlineData.data) { base64Img = part.inlineData.data; break; }
                            }
                        }

                        if(base64Img) {
                            const finalImgSrc = `data:image/jpeg;base64,${base64Img}`;
                            const restoredImg = new Image();
                            restoredImg.onload = () => {
                                state.restoredObj = restoredImg;
                                const imgMod = document.getElementById('img-modified');
                                if(imgMod) imgMod.src = finalImgSrc;
                                if(magnifier) magnifier.style.backgroundImage = `url('${finalImgSrc}')`;
                                setTimeout(() => { syncViewerSize(); updateSlider(50); }, 100);
                                if(downloadTrigger) { downloadTrigger.disabled = false; downloadTrigger.classList.remove('opacity-50', 'cursor-not-allowed'); }
                                if(btnMobDown) btnMobDown.disabled = false;
                                if (window.innerWidth < 1024) document.getElementById('sidebar')?.classList.add('-translate-x-full');
                                showToast("Ph·ª•c ch·∫ø th√†nh c√¥ng (V35.65)!", "flux");
                            };
                            restoredImg.src = finalImgSrc;
                        } else { throw new Error("Kh√¥ng t·∫°o ƒë∆∞·ª£c ·∫£nh."); }
                    } catch(e) { console.error(e); showToast("L·ªói: " + e.message, "error"); } 
                    finally {
                        clearInterval(termInterval);
                        processBtn.disabled = false;
                        if(state.isFluxMode) {
                             const wf = document.getElementById('kontext-workflow').value;
                             if (wf === 'realvis_v5') processBtn.innerHTML = "T·∫†O ·∫¢NH (REALVIS V5)";
                             else if (wf === 'ancient_restore') processBtn.innerHTML = "T·∫†O ·∫¢NH (ANCIENT RESTORE)";
                             else if (wf === 'replica_pro') processBtn.innerHTML = "T·∫†O ·∫¢NH (REPLICA PRO)";
                             else processBtn.innerHTML = "T·∫†O ·∫¢NH (FLUX KONTEXT)";
                        } else {
                             processBtn.innerHTML = "T·∫†O ·∫¢NH (ENTER)";
                        }
                        document.getElementById('ai-terminal-overlay').classList.add('hidden');
                        document.getElementById('scan-beam').classList.remove('active');
                    }
                });
            }

            const handleDownload = () => {
                if(!state.restoredObj || !state.originalImg) return showToast("Ch∆∞a c√≥ ·∫£nh ƒë·ªÉ t·∫£i!", "error");
                showToast("ƒêang chu·∫©n b·ªã ·∫£nh PNG ch·∫•t l∆∞·ª£ng g·ªëc...", "info");
                const realWidth = state.originalImg.naturalWidth;
                const realHeight = state.originalImg.naturalHeight;
                const canvas = document.createElement('canvas');
                canvas.width = realWidth;
                canvas.height = realHeight;
                const ctx = canvas.getContext('2d');
                ctx.filter = `brightness(100%) contrast(100%) saturate(100%)`;
                ctx.drawImage(state.restoredObj, 0, 0, realWidth, realHeight);
                drawLogo(ctx, realWidth, realHeight);
                canvas.toBlob((blob) => {
                    if (!blob) return showToast("L·ªói t·∫°o file ·∫£nh!", "error");
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.download = `pham-khang-v35-65-${Date.now()}.png`; 
                    link.href = url;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    setTimeout(() => URL.revokeObjectURL(url), 100);
                    showToast("ƒê√£ l∆∞u ·∫£nh PNG (Lossless)!", "success");
                }, 'image/png');
            };

            if(downloadTrigger) downloadTrigger.addEventListener('click', handleDownload);
            if(btnMobDown) {
                btnMobDown.addEventListener('click', handleDownload);
                btnMobDown.addEventListener('touchstart', (e) => { e.preventDefault(); if(!btnMobDown.disabled) handleDownload(); });
            }

            // === MOBILE SMART BAR LOGIC (NEW) ===
            const mobBar = document.getElementById('mobile-action-bar');
            const mobBtnUpload = document.getElementById('mob-btn-upload');
            const mobBtnScan = document.getElementById('mob-btn-scan');
            const mobBtnRun = document.getElementById('mob-btn-run');
            const mobBtnReset = document.getElementById('mob-btn-reset');
            const mobStatus = document.getElementById('mobile-status-text');

            // 1. Initial State
            if(mobBar) {
                setTimeout(() => {
                    mobBar.classList.remove('translate-y-24', 'opacity-0');
                }, 1000);
            }

            // 2. Proxy Events
            if(mobBtnUpload) mobBtnUpload.onclick = () => document.getElementById('image-upload').click();
            
            if(mobBtnScan) mobBtnScan.onclick = () => {
                document.getElementById('btn-auto-pilot').click();
                // UI Switch to Generate
                mobBtnScan.classList.add('hidden');
                mobBtnRun.classList.remove('hidden');
                mobBtnRun.innerHTML = `<svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> SCANNING...`;
                
                // Watch for scan complete (Simulated by checking prompt text change or toast)
                // In real implementation, we hook into the async function, but here we estimate
                setTimeout(() => {
                    mobBtnRun.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg> CH·∫†Y NGAY`;
                    mobStatus.textContent = "READY TO GENERATE";
                    mobStatus.classList.add('text-emerald-400');
                    showToast("ƒê√£ Scan xong! B·∫•m 'CH·∫†Y' ƒë·ªÉ t·∫°o ·∫£nh.", "success");
                }, 3000); // Rough estimate of scan time
            };

            if(mobBtnRun) mobBtnRun.onclick = () => {
                document.getElementById('process-image').click();
                mobBtnRun.disabled = true;
                
                // === UPDATE HERE: BETTER LOADING VISUAL ON MOBILE ===
                mobBtnRun.className = "flex-1 py-3.5 bg-amber-600 border border-amber-500/30 rounded-xl text-white font-bold text-[10px] tracking-widest flex flex-col items-center justify-center gap-1 shadow-[0_0_15px_rgba(245,158,11,0.3)] animate-pulse transition-all cursor-not-allowed";
                mobBtnRun.innerHTML = `
                    <svg class="w-5 h-5 animate-spin text-white" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span>ƒêANG T·∫†O ·∫¢NH...</span>
                `;
                
                mobStatus.textContent = "AI ƒêANG X·ª¨ L√ù (Vui l√≤ng ƒë·ª£i)...";
                mobStatus.className = "text-[8px] font-mono tracking-widest text-amber-400 font-bold animate-pulse";
                
                // Re-enable handled in process-image logic usually, but let's watch for completion
                const checkInterval = setInterval(() => {
                    const mainBtn = document.getElementById('process-image');
                    if(!mainBtn.disabled) {
                        clearInterval(checkInterval);
                        mobBtnRun.disabled = false;
                        
                        // Reset style to original Green/Teal style but indicating complete/retry
                        mobBtnRun.className = "flex-1 py-3.5 bg-gradient-to-b from-emerald-500 to-teal-600 hover:from-emerald-400 hover:to-teal-500 border border-emerald-500/30 rounded-xl text-white font-bold text-[10px] tracking-widest flex flex-col items-center justify-center gap-1 shadow-[0_0_15px_rgba(16,185,129,0.3)] active:scale-95 transition-all";
                        mobBtnRun.innerHTML = `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg> <span>L√ÄM L·∫†I</span>`;
                        
                        mobStatus.textContent = "ƒê√É HO√ÄN TH√ÄNH";
                        mobStatus.className = "text-[8px] font-mono tracking-widest text-emerald-400 font-bold";
                    }
                }, 1000);
            };

            if(mobBtnReset) mobBtnReset.onclick = () => window.location.reload();

            // 3. Hook into Load Image to switch buttons
            const originalLoadImg = loadImg; // Save ref
            // Note: We can't overwrite const, but we defined loadImg as const. 
            // In the fileInput listener, we can inject logic.
            if(fileInput) fileInput.addEventListener('change', (e) => {
                 if (e.target.files.length > 0) {
                     mobBtnUpload.classList.add('hidden');
                     mobBtnScan.classList.remove('hidden');
                     mobStatus.textContent = "IMAGE LOADED - PRESS SCAN";
                     mobStatus.classList.add('text-violet-400');
                 }
            });

            if(btnReset) {
                const performReset = (e) => {
                    if(e.cancelable) e.preventDefault();
                    // UPDATED: ROBUST RESET LOGIC
                    showToast("ƒêang l√†m m·ªõi h·ªá th·ªëng...", "info");
                    setTimeout(() => { 
                         // Th√™m timestamp ƒë·ªÉ √©p tr√¨nh duy·ªát t·∫£i l·∫°i trang m·ªõi (tr√°nh cache)
                         const url = window.location.href.split('?')[0] + '?t=' + new Date().getTime();
                         window.location.href = url;
                    }, 300);
                };
                btnReset.addEventListener('click', performReset);
                btnReset.addEventListener('touchend', performReset);
            }
            
            if(idSlider && idVal) idSlider.addEventListener('input', (e) => { idVal.textContent = e.target.value + '%'; });
            if(creativitySlider && creativityVal) {
                creativitySlider.addEventListener('input', (e) => {
                    const val = parseInt(e.target.value);
                    creativityVal.textContent = `M·ª©c ${val}% (LZP Style)`;
                });
            }
            if(grainSlider && grainVal) grainSlider.addEventListener('input', (e) => { grainVal.textContent = e.target.value + '% (Kontext)'; });
            if(exposureSlider && exposureVal) exposureSlider.addEventListener('input', (e) => { exposureVal.textContent = parseFloat(e.target.value).toFixed(1); });
            if(structureSlider && structureVal) structureSlider.addEventListener('input', (e) => { structureVal.textContent = "M·∫°nh (" + (e.target.value/100).toFixed(1) + ")"; });
        });
    </script>
</body>
</html>