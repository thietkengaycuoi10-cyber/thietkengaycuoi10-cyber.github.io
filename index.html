<!DOCTYPE html>
<html lang="en" class="h-full antialiased">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ZALO: 0352803379 - Image restoration (IP LOGIN SYSTEM)</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;700&family=Playfair+Display:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- COPYRIGHT PROTECTION SCRIPT -->
    <script>
        (function() {
            document.addEventListener('contextmenu', function(e) { e.preventDefault(); return false; });
            document.onkeydown = function(e) {
                if (e.keyCode == 123) return false;
                if (e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) return false;
                if (e.ctrlKey && e.shiftKey && e.keyCode == 'C'.charCodeAt(0)) return false;
                if (e.ctrlKey && e.shiftKey && e.keyCode == 'J'.charCodeAt(0)) return false;
                if (e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) return false;
                if (e.ctrlKey && e.keyCode == 'S'.charCodeAt(0)) { e.preventDefault(); return false; }
            };
        })();

    const Sec = {
     key:"V35_SEC",
     dec(t){let s=atob(t);return [...s].map((c,i)=>String.fromCharCode(c.charCodeAt(0)^this.key.charCodeAt(i%this.key.length))).join("")}
    };

    const saved = localStorage.getItem("v35_active_user");
    if(saved){
     try {
         const data = JSON.parse(Sec.dec(saved));
         window.GEMINI_API_KEY = data.geminiKey;
         window.COMET_API_KEY  = data.cometKey;
         window.API_PROVIDER   = data.provider;
     } catch(e) { console.error("Auth Load Error", e); }
    }
    </script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['"Plus Jakarta Sans"', 'sans-serif'],
                        body: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                        serif: ['"Playfair Display"', 'serif']
                    },
                    colors: {
                        glass: {
                            100: 'rgba(255, 255, 255, 0.05)',
                            200: 'rgba(255, 255, 255, 0.1)',
                            300: 'rgba(255, 255, 255, 0.15)',
                            border: 'rgba(255, 255, 255, 0.1)',
                        },
                        pro: { 500: '#3b82f6', 600: '#2563eb', gold: '#f59e0b', cine: '#ec4899', smart: '#10b981', flux: '#8b5cf6', danger: '#f43f5e', cyan: '#06b6d4', real: '#f97316', ancient: '#8b4513' }
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'blob': 'blob 7s infinite',
                        'scan': 'scan 2s linear infinite',
                        'toast-in': 'toastIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)', 
                        'pulse-glow': 'pulseGlow 2s infinite',
                        'flux-pulse': 'fluxPulse 3s infinite',
                        'real-pulse': 'realPulse 3s infinite',
                        'fade-out': 'fadeOut 0.5s ease-out forwards',
                        'fade-in': 'fadeIn 0.3s ease-out forwards',
                        'enter-up': 'enterUp 0.6s cubic-bezier(0.22, 1, 0.36, 1) forwards',
                    },
                    keyframes: {
                        enterUp: { '0%': { opacity: '0', transform: 'translateY(20px) scale(0.95)' }, '100%': { opacity: '1', transform: 'translateY(0) scale(1)' } },
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } },
                        blob: { '0%': { transform: 'translate(0px, 0px) scale(1)' }, '33%': { transform: 'translate(30px, -50px) scale(1.1)' }, '66%': { transform: 'translate(-20px, 20px) scale(0.9)' }, '100%': { transform: 'translate(0px, 0px) scale(1)' } },
                        scan: { '0%': { top: '0%', opacity: '0' }, '10%': { opacity: '1' }, '90%': { opacity: '1' }, '100%': { top: '100%', opacity: '0' } },
                        toastIn: { '0%': { transform: 'translateY(20px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        fadeIn: { '0%': { opacity: '0', transform: 'translateY(5px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } },
                        pulseGlow: { '0%, 100%': { opacity: '1', boxShadow: '0 0 10px #10b981' }, '50%': { opacity: '0.8', boxShadow: '0 0 20px #10b981' } },
                        fluxPulse: { '0%, 100%': { boxShadow: '0 0 5px #8b5cf6' }, '50%': { boxShadow: '0 0 15px #8b5cf6' } },
                        realPulse: { '0%, 100%': { boxShadow: '0 0 5px #f97316' }, '50%': { boxShadow: '0 0 15px #f97316' } },
                        fadeOut: { '0%': { opacity: '1', visibility: 'visible' }, '100%': { opacity: '0', visibility: 'hidden' } }
                    }
                }
            }
        }
    </script>

    <style>
        :root { --ease-spring: cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        
        /* FIX LAYOUT & OVERFLOW ISSUES */
        html, body {
            margin: 0; 
            padding: 0; 
            width: 100%; 
            height: 100%; 
            overflow: hidden; /* Prevent scroll bouncing */
        }
        
        body { 
            background-color: #050505; 
            background-image: radial-gradient(circle at top right, #0f172a, #050505);
            color: #e2e8f0;
            -webkit-user-select: none; user-select: none;
            /* Force full viewport coverage */
            position: fixed; 
            inset: 0;
            width: 100vw;
            height: 100dvh;
        }

        input, textarea { -webkit-user-select: text; user-select: text; }
        .bg-blob { position: absolute; border-radius: 50%; filter: blur(100px); opacity: 0.15; z-index: 0; animation: blob 15s infinite; }
        .blob-1 { top: -10%; left: -10%; width: 500px; height: 500px; background: #8b5cf6; } 
        .blob-2 { bottom: -10%; right: -10%; width: 500px; height: 500px; background: #3b82f6; animation-delay: 2s; }
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 20px; }
        .glass-panel { background: rgba(10, 11, 15, 0.95); backdrop-filter: blur(20px); border-right: 1px solid rgba(255, 255, 255, 0.08); box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5); }
        .pro-input { background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.08); color: #cbd5e1; transition: all 0.2s; font-size: 11px; border-radius: 6px; padding-left: 10px; }
        .pro-input:focus { background: rgba(255, 255, 255, 0.06); border-color: #8b5cf6; outline: none; }
        select { color-scheme: dark; } select option { background-color: #0f172a; color: #e2e8f0; padding: 12px; } select optgroup { background-color: #020617; color: #94a3b8; font-weight: 700; }
        .module-group { border: 1px solid rgba(255, 255, 255, 0.05); background: rgba(255, 255, 255, 0.01); border-radius: 8px; margin-bottom: 6px; overflow: hidden; }
        .module-header { background: rgba(255, 255, 255, 0.02); transition: background 0.2s; padding: 10px 12px; }
        .module-header:hover { background: rgba(255, 255, 255, 0.04); }
        .module-content { display: grid; grid-template-rows: 0fr; transition: grid-template-rows 0.3s ease, opacity 0.3s ease; opacity: 0; }
        .module-content.open { grid-template-rows: 1fr; opacity: 1; }
        .module-content.open .module-inner { padding: 10px 12px; }
        .module-inner { min-height: 0; overflow: hidden; }
        .chk-pro { appearance: none; width: 14px; height: 14px; border-radius: 3px; border: 1px solid rgba(148, 163, 184, 0.4); background: transparent; display: grid; place-content: center; cursor: pointer; transition: all 0.2s; }
        .chk-pro::before { content: ""; width: 8px; height: 8px; transform: scale(0); background: #e2e8f0; border-radius: 2px; transition: transform 0.2s; }
        .chk-pro:checked::before { transform: scale(1); }
        .chk-pro:checked { border-color: #8b5cf6; background: #8b5cf6; }
        .chk-gold:checked { border-color: #f59e0b; background: #f59e0b; }
        .chk-red:checked { border-color: #ef4444; background: #ef4444; }
        .chk-real:checked { border-color: #f97316; background: #f97316; }
        .slider-red::-webkit-slider-thumb { background: #e2e8f0; }
        .slider-flux::-webkit-slider-thumb { background: #8b5cf6; box-shadow: 0 0 10px #8b5cf6; }
        .modal-fade-in { animation: modalFadeIn 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes modalFadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .shimmer-text { background: linear-gradient(90deg, #fff 0%, #a78bfa 50%, #fff 100%); background-size: 200% auto; -webkit-background-clip: text; -webkit-text-fill-color: transparent; animation: shine 3s linear infinite; }
        @keyframes shine { to { background-position: 200% center; } }
        
        /* FIX MOBILE MENU FULL WIDTH */
        @media (max-width: 1024px) {
            #sidebar {
                width: 100% !important; /* Full width on mobile */
                max-width: 100% !important;
                border-right: none;
            }
        }
        
        /* Highlight for selected package */
        .pkg-card.selected {
            background-color: rgba(59, 130, 246, 0.2); /* blue-600/20 */
            border-color: #3b82f6;
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.3);
        }
        
        /* Tab Styles */
        .pay-tab { cursor: pointer; padding: 8px; border-bottom: 2px solid transparent; color: #64748b; transition: all 0.2s; }
        .pay-tab:hover { color: #94a3b8; }
        .pay-tab.active { border-bottom-color: #3b82f6; color: #fff; font-weight: 700; }
    </style>
</head>

<body class="text-slate-300 font-sans flex overflow-hidden select-none relative" oncontextmenu="return false;">
    
    <!-- SECURITY GATE -->
    <div id="security-gate" class="fixed inset-0 z-[9999] flex items-center justify-center bg-[#050505]/90 backdrop-blur-3xl transition-opacity duration-500 p-4">
        <div class="absolute inset-0 overflow-hidden pointer-events-none">
            <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[600px] h-[600px] bg-violet-600/10 rounded-full blur-[120px] animate-pulse"></div>
        </div>
        <div class="relative z-10 w-[90%] max-w-[400px] bg-white/[0.02] border border-white/5 rounded-3xl p-6 sm:p-8 shadow-2xl animate-enter-up flex flex-col items-center">
            <div class="flex flex-col items-center mb-8">
                <div class="w-16 h-16 rounded-2xl bg-gradient-to-tr from-violet-600 to-blue-600 p-[1px] mb-4 shadow-lg shadow-violet-500/20 rotate-3 group">
                     <div class="w-full h-full rounded-2xl bg-[#0a0a0f] flex items-center justify-center relative overflow-hidden group-hover:bg-opacity-80 transition-all">
                         <div class="absolute inset-0 bg-violet-500/20 animate-pulse"></div>
                         <svg class="w-8 h-8 text-white relative z-10" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                     </div>
                </div>
                <h1 class="text-2xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-white via-slate-200 to-slate-400 tracking-tight mb-1 text-center">PHOTO RESTORATION</h1>
                <div class="flex items-center gap-2 opacity-70">
                    <div class="h-[1px] w-8 bg-gradient-to-r from-transparent to-violet-500"></div>
                    <p class="text-[10px] text-violet-300 font-mono tracking-[0.3em] uppercase">Professional AI</p>
                    <div class="h-[1px] w-8 bg-gradient-to-l from-transparent to-violet-500"></div>
                </div>
            </div>
            <div class="w-full space-y-4">
                <div class="relative group w-full">
                    <div class="relative bg-black/40 border border-white/10 rounded-2xl p-4 flex flex-col items-center justify-center transition-all group-hover:border-white/20">
                        <span class="text-[9px] text-slate-500 uppercase tracking-widest font-bold mb-1.5">ACCESS DEVICE</span>
                        <div class="flex items-center justify-center gap-2 h-8 w-full">
                            <span id="gate-ip-display" class="font-mono text-xs sm:text-sm font-bold text-white tracking-wider shimmer-text truncate max-w-full">Connecting...</span>
                            <div id="gate-loading-spinner" class="w-3 h-3 border-2 border-white/20 border-t-white rounded-full animate-spin flex-shrink-0"></div>
                        </div>
                    </div>
                </div>
                <button id="gate-submit" class="w-full py-3.5 bg-gradient-to-r from-indigo-100 to-violet-100 text-slate-900 hover:to-white rounded-xl text-xs font-bold tracking-[0.15em] transition-all active:scale-[0.98] shadow-[0_0_20px_rgba(255,255,255,0.1)] flex items-center justify-center gap-2 group disabled:opacity-50 disabled:cursor-not-allowed overflow-hidden relative" disabled>
                    <span class="relative z-10">ENTER STUDIO</span>
                </button>
            </div>
            <div class="mt-6 h-4 flex items-center justify-center"><p id="gate-status" class="text-[10px] text-slate-500 transition-colors animate-pulse text-center">Scanning device info...</p></div>
        </div>
    </div>

    <div class="bg-blob blob-1"></div><div class="bg-blob blob-2"></div>
    <div id="toast-container" class="fixed top-6 right-6 z-[100] flex flex-col gap-3 pointer-events-none w-[90%] sm:w-auto"></div>
    
    <div class="flex w-full h-full relative z-10 backdrop-blur-[1px]" id="fullscreen-target">
        
        <!-- SIDEBAR (FIX: FULL WIDTH ON MOBILE, FIXED POSITION) -->
        <aside id="sidebar" class="fixed inset-y-0 left-0 z-[60] w-full sm:w-[360px] flex-shrink-0 glass-panel mobile-sidebar-bg flex flex-col transition-transform duration-300 ease-out lg:static lg:translate-x-0 -translate-x-full shadow-2xl lg:shadow-none border-r border-white/5 bg-[#050505] lg:bg-transparent">
            
            <!-- Sidebar Header -->
            <div class="h-14 px-4 flex items-center justify-between border-b border-white/5 bg-white/[0.02]">
                <div class="flex flex-col">
                    <h1 class="text-xs font-bold tracking-widest text-violet-500">RESTORATION PRO</h1>
                    <div class="flex items-center gap-2">
                        <span id="top-bar-ip" class="text-[9px] text-slate-400 font-mono">IP: Loading...</span>
                        <span class="w-1 h-1 rounded-full bg-violet-500"></span>
                        <span class="text-[9px] text-violet-400 font-bold">V35.75</span>
                    </div>
                </div>
                
                <div class="flex items-center gap-3">
                    <div class="flex flex-col items-end mr-1" id="credit-display">
                        <span class="text-[8px] text-slate-400 font-bold uppercase tracking-wider">CREDITS</span>
                        <span class="text-xs font-mono font-bold text-yellow-400 shadow-[0_0_10px_rgba(250,204,21,0.3)]" id="credit-count">---</span>
                    </div>
                    <!-- Close Button for Mobile -->
                    <button id="close-sidebar-mobile" class="lg:hidden p-2 rounded-full bg-white/5 hover:bg-white/10 text-white transition-colors border border-white/10">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
            </div>

            <!-- Sidebar Content -->
            <div class="flex-1 overflow-y-auto p-4 scroll-smooth custom-scrollbar space-y-2">
                <!-- 1. MAIN UPLOAD -->
                <div class="relative group">
                    <input type="file" id="image-upload" accept="image/*" style="position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); border:0;">
                    <label id="drop-zone" for="image-upload" class="flex flex-col items-center justify-center w-full h-24 sm:h-28 border border-dashed border-violet-500/50 rounded-lg cursor-pointer bg-white/[0.02] hover:bg-violet-900/[0.1] hover:border-violet-500 transition-all duration-200">
                        <div id="upload-placeholder" class="flex flex-col items-center pointer-events-none">
                            <svg class="w-5 h-5 text-violet-500 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l-1.586-1.586a2 2 0 00-2.828 0L6 18H4a2 2 0 01-2-2V6a2 2 0 01-2-2V6a2 2 0 012-2h16a2 2 0 012 2v8a2 2 0 01-2 2h-2m-4-4l-3 3m0 0l-3-3m3 3V4"></path></svg>
                            <span class="text-[10px] font-bold text-slate-400 uppercase">Upload Original (Click)</span>
                        </div>
                    </label>
                </div>

                <!-- 2. AUTO-PILOT BUTTON -->
                <button id="btn-auto-pilot" class="w-full py-2.5 mb-3 btn-flux-modern text-white rounded-lg flex items-center justify-center gap-2 transition-all disabled:opacity-50 disabled:cursor-not-allowed shadow-[0_0_15px_rgba(139,92,246,0.2)] bg-violet-600">
                    <svg class="w-4 h-4 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
                    <span class="text-[10px] font-bold tracking-widest">AUTO SCAN V35.60 (AUTO-SIZE)</span>
                </button>

                <!-- FLUX KONTEXT (LZP) -->
                <div class="relative group p-2 rounded-lg border border-violet-500/30 bg-violet-500/5 mb-3 animate-flux-pulse" id="kontext-module-container">
                    <div class="flex items-center gap-2 mb-2">
                         <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="mode-flux" class="sr-only peer" checked>
                            <div class="w-9 h-5 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-violet-500"></div>
                        </label>
                        <div class="flex-1">
                            <span class="block text-[10px] font-bold text-violet-400 tracking-wide">üöÄ FLUX / REALVIS ENGINE</span>
                            <span class="block text-[9px] text-violet-500/70">Core: Kontext, SUPIR, ReActor, UltraSharp</span>
                        </div>
                    </div>
                    
                    <!-- WORKFLOW SELECTOR -->
                    <div class="pl-11 pr-1 border-t border-violet-500/20 pt-2" id="workflow-container">
                        <label class="block text-[9px] font-bold text-violet-300 mb-1">WORKFLOW PRESETS</label>
                        <select id="kontext-workflow" class="pro-input w-full py-1.5 cursor-pointer bg-violet-900/20 border-violet-500/30 text-violet-200 transition-all duration-500">
                            <option value="replica_pro" class="text-yellow-400 font-bold">üß¨ HYPER REALISTIC (REPLICA PRO) - DEEP STRUCTURE LOCK</option>
                            <option value="default">‚ú® Default (Kontext Base + OldPhoto-2)</option>
                            <option value="ancient_restore" class="text-purple-400 font-bold">üèØ Ancient Art/Statue Restoration (ReActor + ControlNet)</option>
                            <option value="realvis_v5" class="text-orange-400 font-bold">ü¶Å RealVisXL V5 (Deep Structure Restoration)</option>
                            <option value="qwen_restore_full" class="text-cyan-400 font-bold">‚ö° Qwen V2.5 Full Restore (Native JSON Prompt)</option>
                            <option value="qwen_lightning">‚ö° Qwen V2.5-VL (Lightning Fast)</option>
                            <option value="wedding_kontext_v2" class="text-pink-400 font-bold">üë∞ Wedding Kontext V2 (Full JSON)</option>
                            <option value="wedding_pro">üíç Wedding Pro + Upscale (Wedding - Basic)</option>
                            <option value="old_photo_v1">üìú Kontext V1.0 Native (Ref-Latent Boost)</option>
                            <option value="outdoor_mode">üèûÔ∏è Outdoor Restoration (IC-Light + PowerPaint)</option>
                            <option value="product_mode">üõçÔ∏è Product/Commercial (Ecommerce)</option>
                            <option value="white_bg">‚¨ú White Background (BiRefNet + RMBG-2.0)</option>
                        </select>
                         <div class="text-[8px] text-violet-400/60 mt-1 italic" id="workflow-desc">Using OldPhoto-2.safetensors (0.87)</div>
                    </div>
                </div>

                <!-- REPLICA MODE -->
                <div class="relative group p-2 rounded-lg border border-yellow-500/30 bg-yellow-500/5 mb-3">
                    <div class="flex items-center gap-2">
                         <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="mode-replica" class="sr-only peer">
                            <div class="w-9 h-5 bg-slate-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-yellow-500"></div>
                        </label>
                        <div class="flex-1">
                            <span class="block text-[10px] font-bold text-yellow-500 tracking-wide">üíé REPLICA MODE (ALIGN LOCK)</span>
                            <span class="block text-[9px] text-yellow-600/70">LOCK FACE ANGLE - SMART ANTI-FLIP</span>
                        </div>
                    </div>
                </div>

                <!-- MODULE: QU√ÇN S·ª¨ VI·ªÜT NAM -->
                <div class="module-group border-yellow-500/30" id="module-military">
                    <button id="toggle-military" class="w-full flex justify-between items-center module-header bg-yellow-500/10 hover:bg-yellow-500/20">
                        <span class="text-[10px] font-bold text-yellow-500 tracking-wide uppercase flex items-center gap-2">üáªüá≥ MILITARY HISTORY (FULL UPGRADE)</span>
                        <svg class="w-3 h-3 text-yellow-500 toggle-icon" id="icon-military" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="content-military" class="module-content">
                        <div class="module-inner space-y-2">
                             <div class="space-y-1">
                                <label class="section-label text-yellow-600/80">Branch / Force</label>
                                <select id="mil-branch" class="pro-input w-full py-1.5 save-input">
                                    <option value="">-- Auto / Default --</option>
                                    <option value="vietnamese army ground force, red collar tabs">üü• Ground Force (Red Tabs)</option>
                                    <option value="vietnamese air force, blue collar tabs">üü¶ Air Force (Blue Tabs)</option>
                                    <option value="vietnamese navy, navy blue uniform, white striped collar">‚öì Navy (Dark Blue/Purple Tabs)</option>
                                    <option value="vietnamese border guard, green collar tabs">üü© Border Guard (Green Tabs)</option>
                                    <option value="vietnamese public security, green uniform, red collar tabs">üëÆ Public Security (Green Uniform)</option>
                                    <option value="vietnamese youth volunteer force, dark green uniform">‚≠ê Youth Volunteer Force</option>
                                </select>
                             </div>
                             <div class="space-y-1">
                                <label class="section-label text-yellow-600/80">Uniform / Era</label>
                                <select id="mil-uniform" class="pro-input w-full py-1.5 save-input">
                                    <option value="">-- Auto / Default --</option>
                                    <option value="wearing tran thu shirt, padded cotton jacket, viet minh era">Tran Thu Jacket (Anti-French)</option>
                                    <option value="wearing to chau uniform, plain green fatigue, vietnam war era">To Chau Uniform (Anti-US)</option>
                                    <option value="wearing K82 uniform, formal military tunic">K82 Uniform (Subsidy Era)</option>
                                    <option value="wearing K94 uniform, modern formal suit">K94/K03 Uniform (Modern)</option>
                                    <option value="wearing camouflage special force uniform">Special Force (Camo)</option>
                                </select>
                             </div>
                             <div class="space-y-1">
                                <label class="section-label text-yellow-600/80">Hat & Cap (Precise)</label>
                                <select id="hat-select" class="pro-input w-full py-1.5 save-input" data-key="hatSelect">
                                    <option value="">-- No Hat Processing --</option>
                                    <option value="wear vietnamese pith helmet, hard pith helmet, dark green color, rounded shape, red badge with yellow star">Pith Helmet (North Vietnamese) - Hard & Round</option>
                                    <option value="wear vietnamese soft cap, boonie hat, green fabric, red star badge">Boonie Hat (Soft)</option>
                                    <option value="wear vietnamese officer kepi hat, mixed red and green color, gold chin strap, red badge with gold star">Kepi Hat (Officer - Raised Star)</option>
                                    <option value="wear vietnamese police kepi hat, green color, red band, gold badge">Kepi Hat (Police)</option>
                                    <option value="wear vietnamese bamboo helmet, cloth covered">Bamboo Helmet (Cloth Covered)</option>
                                </select>
                             </div>
                             <div class="space-y-1">
                                <label class="section-label text-yellow-600/80">Rank / Insignia</label>
                                <select id="rank-select" class="pro-input w-full py-1.5 save-input" data-key="rankSelect">
                                    <option value="">-- Auto / Default --</option>
                                    <option value="no_rank_insignia">üö´ NO INSIGNIA (PLAIN)</option>
                                    <optgroup label="Soldier / NCO">
                                        <option value="plain red collar tabs, soldier rank">Soldier (Plain/Private)</option>
                                        <option value="red collar tabs with one yellow stripe">Corporal (1 stripe)</option>
                                        <option value="red collar tabs with two yellow stripes">Sergeant (2 stripes)</option>
                                        <option value="red collar tabs with three yellow stripes">Master Sergeant (3 stripes)</option>
                                    </optgroup>
                                    <optgroup label="Officer (Stars + Lines)">
                                        <option value="red collar tabs with one star, officer rank">2nd Lieutenant (1 star)</option>
                                        <option value="red collar tabs with two stars, officer rank">Lieutenant (2 stars)</option>
                                        <option value="red collar tabs with three stars, officer rank">Captain (3 stars)</option>
                                        <option value="red collar tabs with four stars, officer rank">Senior Captain (4 stars)</option>
                                    </optgroup>
                                </select>
                             </div>
                             <div class="space-y-1">
                                <label class="section-label text-yellow-600/80">Medals / Badges</label>
                                <div class="grid grid-cols-2 gap-1.5">
                                    <div class="flex items-center gap-2"><input id="check-sao-vang" type="checkbox" class="chk-pro save-input"><label for="check-sao-vang" class="text-[9px] text-yellow-400">Gold Star Medal</label></div>
                                    <div class="flex items-center gap-2"><input id="check-khang-chien" type="checkbox" class="chk-pro save-input"><label for="check-khang-chien" class="text-[9px] text-slate-300">Resistance Medal</label></div>
                                    <div class="flex items-center gap-2"><input id="check-chien-si" type="checkbox" class="chk-pro save-input"><label for="check-chien-si" class="text-[9px] text-slate-300">Soldier Title</label></div>
                                    <div class="flex items-center gap-2"><input id="check-doan" type="checkbox" class="chk-pro save-input"><label for="check-doan" class="text-[9px] text-cyan-400">Youth Union Badge</label></div>
                                </div>
                             </div>
                             <div class="flex items-center gap-2 p-1.5 rounded border border-yellow-500/20 bg-yellow-500/10 mt-1">
                                <input id="check-insignia-boost" type="checkbox" class="chk-pro save-input">
                                <label for="check-insignia-boost" class="cursor-pointer select-none flex-1">
                                    <span class="block text-[10px] font-bold text-yellow-300">BOOST RANK & LOGO SHARPNESS</span>
                                    <span class="block text-[8px] text-yellow-500/70">Process Cap Stars & Metal Details Separately</span>
                                </label>
                            </div>
                             <div class="flex items-center gap-2 p-1.5 rounded border border-red-500/20 bg-red-500/10 mt-1">
                                <input id="block-rank" type="checkbox" class="chk-pro chk-red save-input">
                                <label for="block-rank" class="cursor-pointer select-none flex-1">
                                    <span class="block text-[10px] font-bold text-red-300">BLOCK RANK GENERATION (PLAIN COLLAR)</span>
                                    <span class="block text-[8px] text-red-500/70">Check if original photo has no collar tabs/insignia</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- MODULE: TEXTURE & LIGHTING -->
                <div class="module-group border-pink-500/30" id="module-cinematic">
                    <button id="toggle-cinematic" class="w-full flex justify-between items-center module-header bg-pink-500/10 hover:bg-pink-500/20">
                        <span class="text-[10px] font-bold text-pink-500 tracking-wide uppercase flex items-center gap-2">üéûÔ∏è LIGHTING & FILM TONE</span>
                        <svg class="w-3 h-3 text-pink-500 toggle-icon" id="icon-cinematic" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="content-cinematic" class="module-content open" style="grid-template-rows: 1fr; opacity: 1;">
                        <div class="module-inner space-y-3">
                             <div>
                                <div class="flex justify-between text-[10px] text-pink-400 font-bold mb-1">
                                    <span>FLUX GRAIN</span>
                                    <span id="grain-val">3% (Kontext Default)</span>
                                </div>
                                <input type="range" id="grain-slider" min="0" max="100" value="3" class="slider-pink w-full h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                             </div>
                             <select id="color-grading" class="pro-input w-full py-1.5 save-input">
                                 <option value="">-- Original Color (Standard) --</option>
                                 <optgroup label="‚ú® Kontext Lighting (From JSON)">
                                     <option value="rembrandt_lighting">üé¨ Rembrandt (Cinematic/Dramatic)</option>
                                     <option value="golden_hour_backlight">üåÖ Golden Hour (Backlight)</option>
                                     <option value="soft_diffused_light">‚òÅÔ∏è Soft Diffused (Studio)</option>
                                     <option value="neon_cyberpunk">üåÉ Neon Lights (Modern/Contrast)</option>
                                 </optgroup>
                                 <optgroup label="üéûÔ∏è Vintage Film Stock">
                                     <option value="kodak gold 200 style, warm tone, vintage film look">Kodak Gold (Warm)</option>
                                     <option value="kodak portra 400 style, natural skin tone, fine grain" selected>Kodak Portra (JSON Std)</option>
                                     <option value="fujifilm pro 400h style, cool tone, soft green tint">Fujifilm (Cool/Clear)</option>
                                     <option value="sepia tone, antique photo style">Sepia (Antique)</option>
                                 </optgroup>
                             </select>
                        </div>
                    </div>
                </div>

                <!-- MODULE: EXPOSURE & RELIGHTING -->
                <div class="module-group border-cyan-500/30" id="module-exposure">
                    <button id="toggle-exposure" class="w-full flex justify-between items-center module-header bg-cyan-500/10 hover:bg-cyan-500/20">
                        <span class="text-[10px] font-bold text-cyan-400 tracking-wide uppercase flex items-center gap-2">‚òÄÔ∏è EXPOSURE FIX (QWEN EDIT)</span>
                        <svg class="w-3 h-3 text-cyan-400 toggle-icon" id="icon-exposure" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="content-exposure" class="module-content">
                        <div class="module-inner space-y-2">
                             <div class="flex items-center gap-2 p-1.5 rounded border border-cyan-500/20 bg-cyan-500/10">
                                <input id="check-qwen-exposure" type="checkbox" class="chk-pro save-input">
                                <label for="check-qwen-exposure" class="cursor-pointer select-none flex-1">
                                    <span class="block text-[10px] font-bold text-cyan-300">ENABLE QWEN EDIT (V2511)</span>
                                    <span class="block text-[8px] text-cyan-500/70">Core: Qwen-Image-Edit + LoRA Remove Shadow</span>
                                </label>
                            </div>
                            <div class="space-y-1.5 pl-2 border-l border-cyan-500/10 ml-1">
                                <div class="flex items-center gap-2">
                                    <input id="check-remove-shadow" type="checkbox" class="chk-pro save-input" checked>
                                    <label for="check-remove-shadow" class="text-[10px] text-slate-300 cursor-pointer">LoRA: Remove Harsh Shadows</label>
                                </div>
                                 <div class="flex items-center gap-2">
                                    <input id="check-soft-light" type="checkbox" class="chk-pro save-input" checked>
                                    <label for="check-soft-light" class="text-[10px] text-slate-300 cursor-pointer">Prompt: Soft Light</label>
                                </div>
                            </div>
                            <div class="border border-white/10 rounded bg-black/20 p-2">
                                <div class="flex justify-between text-[10px] text-cyan-400 font-bold mb-1">
                                    <span>PROCESSING STRENGTH</span>
                                    <span id="exposure-val" class="text-slate-200">1.0</span>
                                </div>
                                <input type="range" id="exposure-slider" min="0.1" max="2.0" step="0.1" value="1.0" class="slider-cyan w-full h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- REFERENCE FACE UPLOAD -->
                <div class="relative group p-2 rounded-lg bg-white/[0.02] border border-white/5 mb-3">
                     <div class="flex gap-2 items-center mb-2">
                         <div id="ref-img-preview" class="w-8 h-8 rounded bg-black/40 border border-white/10 flex-shrink-0 bg-cover bg-center" style="display:none;"></div>
                         <input type="file" id="ref-upload" accept="image/*" class="hidden">
                         <label for="ref-upload" class="flex-1 h-8 border border-dashed border-slate-700 rounded flex items-center justify-center cursor-pointer hover:bg-white/5 transition-colors">
                             <span id="ref-text" class="text-[10px] text-slate-500 font-medium">+ Reference Photo (Boost Likeness)</span>
                         </label>
                         <button id="clear-ref" class="w-8 h-8 rounded bg-white/5 hover:bg-white/10 text-slate-400 flex items-center justify-center transition-colors" style="display:none;">
                             <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                         </button>
                     </div>
                     <div class="flex items-center gap-2 px-1">
                        <input id="check-reactor" type="checkbox" class="chk-pro save-input">
                        <label for="check-reactor" class="flex-1 cursor-pointer select-none">
                            <span class="block text-[10px] font-bold text-purple-400">Enable Face Swap (ReActor)</span>
                            <span class="block text-[8px] text-purple-500/70">Replace face instead of mixing (InsightFace)</span>
                        </label>
                    </div>
                </div>

                <!-- MODULE 1: IMAGE PROCESSING -->
                <div class="module-group" id="module-processing">
                    <button id="toggle-processing" class="w-full flex justify-between items-center module-header">
                        <span class="text-[10px] font-bold text-slate-200 tracking-wide uppercase flex items-center gap-2">üõ†Ô∏è IMAGE PROCESSING (LZP DETAIL)</span>
                        <svg class="w-3 h-3 text-slate-600 toggle-icon" id="icon-processing" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="content-processing" class="module-content open" style="grid-template-rows: 1fr; opacity: 1;">
                        <div class="module-inner space-y-3">
                             <div class="border border-violet-500/30 rounded bg-violet-900/10 p-2 mb-2" id="creativity-container">
                                <div class="flex justify-between text-[10px] text-violet-300 font-bold mb-1">
                                    <span>ORIGINAL FIDELITY</span>
                                    <span>FLUX DETAIL</span>
                                </div>
                                <input type="range" id="creativity-slider" min="0" max="100" value="45" class="slider-flux w-full h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                                <div class="text-[9px] text-center text-violet-400 mt-1" id="creativity-val">Level 45% (LZP Balanced)</div>
                             </div>

                             <div class="grid-compact">
                                 <div class="flex items-center gap-2 p-1.5 rounded border border-white/5 bg-white/[0.02]" id="container-dehaze"><input id="check-dehaze" type="checkbox" class="chk-pro save-input"><label for="check-dehaze" class="cursor-pointer text-[10px] text-slate-300">Dehaze</label></div>
                                 <div class="flex items-center gap-2 p-1.5 rounded border border-white/5 bg-white/[0.02]" id="container-contrast-fix"><input id="check-contrast-fix" type="checkbox" class="chk-pro save-input"><label for="check-contrast-fix" class="cursor-pointer text-[10px] font-bold text-violet-300">Kontext Contrast</label></div>
                                 <div class="flex items-center gap-2 p-1.5 rounded border border-white/5 bg-white/[0.02]"><input id="check-uniform-skin" type="checkbox" class="chk-pro save-input" checked><label for="check-uniform-skin" class="cursor-pointer text-[10px] text-slate-300">Uniform Skin</label></div>
                                 <div class="flex items-center gap-2 p-1.5 rounded border border-white/5 bg-white/[0.02]"><input id="check-vibrant" type="checkbox" class="chk-pro save-input" checked><label for="check-vibrant" class="cursor-pointer text-[10px] font-bold text-violet-400">LZP COLOR</label></div>
                             </div>
                             
                             <div class="space-y-1">
                                <label class="section-label text-slate-500">Upscale Mode</label>
                                <select id="upscale-mode" class="pro-input w-full py-1.5 save-input cursor-pointer">
                                    <option value="supir" selected>üåü SUPIR v0F (Highest Quality - Slow)</option>
                                    <option value="pixel_perfect" class="text-yellow-400">üíé Pixel Perfect (Preserve Skin Texture)</option>
                                    <option value="ultrasharp">‚ö° 4x-UltraSharp (Fast Speed - Sharp)</option>
                                    <option value="realesrgan">üíç RealESRGAN (Wedding/Smooth Skin)</option>
                                    <option value="none">üö´ No Upscale (Fastest)</option>
                                </select>
                             </div>

                             <div class="space-y-1.5 pt-1 border-t border-white/5">
                                 <div class="flex items-center gap-2"><input id="check-face" type="checkbox" class="chk-pro save-input" data-key="checkFace" checked><label for="check-face" class="text-[10px] text-slate-300 cursor-pointer">Face Detail</label></div>
                                 
                                 <div class="flex items-center gap-2 p-1.5 rounded bg-violet-500/10 border border-violet-500/20">
                                    <input id="check-background" type="checkbox" class="chk-pro save-input" checked>
                                    <label for="check-background" class="cursor-pointer select-none flex-1">
                                        <span class="block text-[10px] font-bold text-violet-300">Sharpen Background & Flora</span>
                                        <span class="block text-[8px] text-violet-400/70">Mode: Botanical Detail (Baby.json)</span>
                                    </label>
                                 </div>

                                 <div class="flex items-center gap-2"><input id="check-hair" type="checkbox" class="chk-pro save-input" data-key="checkHair" checked><label for="check-hair" class="text-[10px] text-slate-300 cursor-pointer">Redraw Hair Strands (LZP Hair)</label></div>
                             </div>

                             <div class="mt-2 border-t border-blue-500/20 pt-2 space-y-1.5">
                                <label class="section-label text-blue-400/80 mb-2">üöÄ V35.25 ADVANCED</label>
                                <div class="flex items-center gap-2 p-1.5 rounded border border-blue-500/20 bg-blue-500/10">
                                    <input id="check-group-mode" type="checkbox" class="chk-pro save-input">
                                    <label for="check-group-mode" class="cursor-pointer select-none flex-1">
                                        <span class="block text-[10px] font-bold text-blue-300">GROUP PHOTO PRO (Crowd)</span>
                                        <span class="block text-[8px] text-blue-500/70">Core: GroundingDINO + SAM (Segment)</span>
                                    </label>
                                 </div>
                                <div class="flex items-center gap-2 p-1.5 rounded border border-orange-500/20 bg-orange-500/10 animate-real-pulse" id="container-blur-prepass">
                                    <input id="check-blur-prepass" type="checkbox" class="chk-pro chk-real save-input">
                                    <label for="check-blur-prepass" class="cursor-pointer select-none flex-1">
                                        <span class="block text-[10px] font-bold text-orange-400">DEEP DENOISE (BLUR INPUT)</span>
                                        <span class="block text-[8px] text-orange-500/70">Blur original before processing (Fix Noise)</span>
                                    </label>
                                </div>
                                <div class="flex items-center gap-2 p-1.5 rounded border border-red-500/20 bg-red-500/10 animate-pulse-glow">
                                    <input id="check-extreme-mode" type="checkbox" class="chk-pro chk-red save-input">
                                    <label for="check-extreme-mode" class="cursor-pointer select-none flex-1">
                                        <span class="block text-[10px] font-bold text-red-400">‚ö° EXTREME RECOVERY</span>
                                        <span class="block text-[8px] text-red-500/70">Use for extremely damaged/blurry photos</span>
                                    </label>
                                </div>
                             </div>
                        </div>
                    </div>
                </div>

                <!-- MODULE 2: SUBJECT & OUTFIT -->
                <div class="module-group" id="module-subject">
                    <button id="toggle-subject" class="w-full flex justify-between items-center module-header">
                        <span class="text-[10px] font-bold text-slate-200 tracking-wide uppercase flex items-center gap-2">üëî SUBJECT & OUTFIT</span>
                        <svg class="w-3 h-3 text-slate-600 toggle-icon" id="icon-subject" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="content-subject" class="module-content">
                        <div class="module-inner">
                            <div class="grid grid-cols-3 gap-1.5 mb-2">
                                 <select id="gender-select" class="pro-input py-1.5 save-input" data-key="gender"><option value="">Gender</option><option value="male">Male</option><option value="female">Female</option><option value="male and female">Male & Female</option></select>
                                 <input type="number" id="age-input" placeholder="Age" class="pro-input py-1.5 save-input text-center" data-key="age">
                                 <select id="damage-level" class="pro-input py-1.5 save-input cursor-pointer" data-key="damageLevel"><option value="">Damage Level</option><option value="fix slightly blurry" selected>Light</option><option value="fix scratches, mold">Medium</option><option value="fix torn, missing details">Heavy</option></select>
                            </div>
                            <select id="texture-mode" class="pro-input w-full py-1.5 save-input cursor-pointer mb-2" data-key="textureMode">
                                <option value="">-- Texture/Realism --</option>
                                <option value="true skin, natural pores, film grain, realistic skin:1.2, natural beauty:1.2" selected>üß¨ TRUE SKIN (NATURAL PORES)</option>
                                <option value="Canon EOS 5D Mark IV, 85mm lens, shallow depth of field, perfect lighting, raw photo, realistic skin texture">üì∏ Canon 5D + 85mm Lens (Studio Skin)</option>
                                <option value="smooth skin, ai beauty">Smooth Skin (AI Beauty)</option>
                                <option value="high detail, film grain">High Detail (Film Grain)</option>
                            </select>
                            <div class="space-y-1.5">
                                <div class="flex items-center gap-2 p-1.5 rounded border border-blue-500/20 bg-blue-500/10">
                                    <input id="check-id-photo" type="checkbox" class="chk-pro save-input">
                                    <label for="check-id-photo" class="cursor-pointer select-none flex-1">
                                        <span class="block text-[10px] font-bold text-blue-300">ID PHOTO MODE</span>
                                        <span class="block text-[8px] text-blue-500/70">Standard Blue/White BG (chuan.txt)</span>
                                    </label>
                                </div>
                                <select id="event-context" class="pro-input w-full py-1.5 cursor-pointer save-input" data-key="eventContext">
                                    <option value="">-- (AUTO) Smart Context --</option>
                                    <option value="original_enhanced" class="text-violet-400 font-bold">üõ°Ô∏è Original BG + MAX DETAIL (LZP BOOST)</option>
                                    <optgroup label="Color Background">
                                        <option value="blue_bg">üü¶ Blue BG</option>
                                        <option value="white_bg">‚¨ú White BG</option>
                                    </optgroup>
                                     <optgroup label="Flux Style (JSON)">
                                        <option value="outdoor_garden">üåø Garden / Flora (Standard JSON)</option>
                                        <option value="luxury_interior">üï∞Ô∏è Luxury Interior</option>
                                    </optgroup>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- MODULE 3: IDENTITY GUARD -->
                <div class="module-group" id="module-identity">
                    <button id="toggle-identity" class="w-full flex justify-between items-center module-header">
                        <span class="text-[10px] font-bold text-slate-200 tracking-wide uppercase flex items-center gap-2">üß¨ IDENTITY GUARD</span>
                        <svg class="w-3 h-3 text-slate-600 toggle-icon" id="icon-identity" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="content-identity" class="module-content">
                        <div class="module-inner">
                            <div class="border border-white/10 rounded bg-black/20 p-2 mb-2" id="identity-slider-container">
                                <div class="flex justify-between text-[10px] text-slate-400 font-bold mb-1">
                                    <span>Lock Strength</span>
                                    <span id="identity-weight-val" class="text-slate-200">300%</span>
                                </div>
                                <input type="range" id="identity-weight-slider" min="100" max="400" step="10" value="300" class="slider-red save-input" data-key="identityWeight">
                            </div>
                            <div class="flex items-start gap-2 p-1.5 rounded bg-red-500/10 border border-red-500/20 mb-2">
                                <input id="check-anti-flip" type="checkbox" class="chk-pro chk-red save-input mt-0.5" checked>
                                <label for="check-anti-flip" class="flex-1 cursor-pointer select-none">
                                    <span class="block text-[10px] font-bold text-red-300">üö´ SMART ANTI-FLIP</span>
                                    <span class="block text-[9px] text-red-400/70">Auto-detect Aspect Ratio & Face Angle</span>
                                </label>
                            </div>
                             <div class="border border-purple-500/30 rounded bg-purple-900/10 p-2 mb-2" id="structure-container" style="display:none;">
                                <div class="flex justify-between text-[10px] text-purple-300 font-bold mb-1">
                                    <span>STRUCTURE LOCK (CONTROLNET)</span>
                                    <span id="structure-val">Strong (0.8)</span>
                                </div>
                                <input type="range" id="structure-slider" min="0" max="100" value="80" class="slider-flux w-full h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                             </div>
                            <div class="flex items-start gap-2 p-1.5 rounded bg-white/[0.02] border border-white/5 mb-2">
                                <input id="check-asian-identity" type="checkbox" class="chk-pro save-input mt-0.5" data-key="checkAsianIdentity" checked>
                                <label for="check-asian-identity" class="flex-1 cursor-pointer select-none">
                                    <span class="block text-[10px] font-bold text-slate-200">ASIAN IDENTITY PRESERVATION</span>
                                    <span class="block text-[9px] text-slate-500">Prevent "Westernization", keep Vietnamese features</span>
                                </label>
                            </div>
                            <div class="flex items-center gap-2 p-1.5 rounded border border-purple-500/20 bg-purple-500/10 mb-2">
                                <input id="check-dual-controlnet" type="checkbox" class="chk-pro save-input">
                                <label for="check-dual-controlnet" class="cursor-pointer select-none flex-1">
                                    <span class="block text-[10px] font-bold text-purple-300">DUAL STRUCTURE LOCK</span>
                                    <span class="block text-[8px] text-purple-500/70">Depth + LineArt (For ancient art/statues)</span>
                                </label>
                            </div>
                            <div class="grid-compact border-t border-white/5 pt-2 mb-2">
                                <div class="flex items-center gap-2"><input id="lock-eyes" type="checkbox" class="chk-pro save-input" data-key="lockEyes" checked><label for="lock-eyes" class="text-[10px] text-slate-300">Lock Eyes</label></div>
                                <div class="flex items-center gap-2"><input id="lock-mouth" type="checkbox" class="chk-pro save-input" data-key="lockMouth" checked><label for="lock-mouth" class="text-[10px] text-slate-300">Lock Mouth</label></div>
                                <div class="flex items-center gap-2"><input id="lock-skin" type="checkbox" class="chk-pro save-input" data-key="lockSkin"><label for="lock-skin" class="text-[10px] text-slate-300">Moles/Birthmarks</label></div>
                                <div class="flex items-center gap-2" id="container-imperfection"><input id="lock-imperfection" type="checkbox" class="chk-pro chk-gold save-input" data-key="lockImperfection"><label for="lock-imperfection" class="text-[10px] text-yellow-500 font-bold">Keep Imperfections</label></div>
                            </div>
                            <div class="mt-2 border-t border-red-500/20 pt-2">
                                <label class="section-label text-red-400/80 mb-2">üõ°Ô∏è FEATURE PRESERVATION</label>
                                <div class="space-y-1.5">
                                    <div class="flex items-center gap-2"><input id="check-cross-eyed" type="checkbox" class="chk-pro chk-red save-input"><label for="check-cross-eyed" class="text-[10px] text-slate-300 cursor-pointer">Cross-eyed</label></div>
                                    <div class="flex items-center gap-2" id="container-ptosis">
                                        <input id="check-ptosis" type="checkbox" class="chk-pro chk-red save-input">
                                        <label for="check-ptosis" class="text-[10px] text-slate-300 cursor-pointer">Ptosis/Droopy Eyes</label>
                                    </div>
                                    <div class="flex items-center gap-2" id="container-closed-eyes">
                                        <input id="check-closed-eyes" type="checkbox" class="chk-pro chk-red save-input">
                                        <label for="check-closed-eyes" class="text-[10px] text-slate-300 cursor-pointer">Closed Eyes/Sleeping</label>
                                    </div>
                                    <div class="flex items-center gap-2"><input id="check-monolid" type="checkbox" class="chk-pro chk-red save-input"><label for="check-monolid" class="text-[10px] text-slate-300 cursor-pointer">Monolid</label></div>
                                    <div class="flex items-center gap-2"><input id="check-buck-teeth" type="checkbox" class="chk-pro chk-red save-input"><label for="check-buck-teeth" class="text-[10px] text-slate-300 cursor-pointer">Buck Teeth</label></div>
                                    <div class="flex items-center gap-2"><input id="check-black-teeth" type="checkbox" class="chk-pro chk-red save-input"><label for="check-black-teeth" class="text-[10px] text-slate-300 cursor-pointer">Traditional Black Teeth</label></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- MODULE 4: PROMPT & API -->
                <div class="module-group" id="module-prompt">
                    <button id="toggle-prompt" class="w-full flex justify-between items-center module-header">
                        <span class="text-[10px] font-bold text-slate-200 tracking-wide uppercase flex items-center gap-2">üìù PROMPT & API</span>
                        <svg class="w-3 h-3 text-slate-600 toggle-icon" id="icon-prompt" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="content-prompt" class="module-content">
                        <div class="module-inner">
                            <textarea id="prompt-main" rows="3" class="pro-input w-full p-2 resize-none text-[10px] font-mono save-input mb-2" data-key="promptMainValue" placeholder="System will automatically optimize for Flux..."></textarea>
                            <input type="text" id="prompt-negative" placeholder="Negative prompt..." class="pro-input w-full py-1.5 save-input mb-2" data-key="promptNegative">
                            <input type="password" id="user-api-key" placeholder="Custom API Key (Optional)" class="pro-input w-full py-1.5 save-input" data-key="userApiKey">
                        </div>
                    </div>
                </div>

                <!-- MODULE 5: COPYRIGHT LOGO -->
                <div class="module-group" id="module-logo">
                    <button id="toggle-logo" class="w-full flex justify-between items-center module-header">
                        <span class="text-[10px] font-bold text-slate-200 uppercase">¬©Ô∏è COPYRIGHT LOGO</span>
                        <svg class="w-3 h-3 text-slate-600 toggle-icon" id="icon-logo" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="content-logo" class="module-content">
                        <div class="module-inner">
                            <div class="flex items-center gap-2 mb-2">
                                <input id="check-logo" type="checkbox" class="chk-pro save-input">
                                <label for="check-logo" class="flex-1 cursor-pointer select-none">
                                    <span class="block text-[10px] font-bold text-slate-300">Enable Watermark</span>
                                    <span class="block text-[9px] text-slate-500">10% opacity grid overlay</span>
                                </label>
                            </div>
                            <input type="text" id="custom-logo-text" class="pro-input w-full py-2 bg-black/20 border-white/10 text-center font-bold text-yellow-400 placeholder-slate-600" placeholder="Enter name or phone number...">
                        </div>
                    </div>
                </div>

            </div>

            <!-- Footer Actions -->
            <div class="p-4 glass-panel border-t-0 space-y-2 z-20">
                <button id="process-image" class="w-full py-3 btn-flux-modern text-white font-bold text-xs tracking-widest flex justify-center items-center gap-2 disabled:opacity-70 disabled:cursor-not-allowed bg-violet-600">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                    GENERATE (FLUX KONTEXT)
                </button>
                <button id="reset-button" class="w-full py-2 bg-white/5 hover:bg-white/10 text-slate-400 text-[10px] font-bold tracking-widest rounded transition-colors border border-white/5">RESET</button>
            </div>
        </aside>

        <!-- WORKSPACE -->
        <main class="flex-1 flex flex-col relative overflow-hidden" id="main-workspace">
            <!-- MOBILE HEADER -->
            <div class="lg:hidden h-14 glass-panel border-b border-white/5 flex items-center px-4 justify-between z-30 relative bg-[#0a0a0f]/90 backdrop-blur-xl">
                <button id="toggle-sidebar-btn" class="text-slate-400 p-2 border border-white/10 rounded-lg hover:bg-white/5"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg></button>
                <div class="flex flex-col items-center">
                     <span class="font-bold text-violet-500 text-xs tracking-wider">Image restoration</span>
                     <span class="text-[8px] text-slate-500 font-mono tracking-widest" id="mobile-status-text">WAITING FOR IMAGE</span>
                </div>
                <button id="download-mobile" class="text-blue-400 p-2 bg-blue-500/10 rounded-lg border border-blue-500/20 disabled:opacity-30 transition-all active:scale-95" disabled>
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                </button>
            </div>
            
            <!-- SMART MOBILE ACTION BAR -->
            <div id="mobile-action-bar" class="lg:hidden fixed bottom-6 left-4 right-4 z-40 flex items-center justify-center pointer-events-none transition-all duration-500 translate-y-24 opacity-0">
                <div class="bg-[#0f1016]/90 backdrop-blur-2xl border border-white/10 p-2 rounded-2xl shadow-[0_8px_32px_rgba(0,0,0,0.6)] flex gap-3 w-full max-w-sm pointer-events-auto ring-1 ring-white/5">
                    
                    <!-- 1. UPLOAD BUTTON -->
                    <button id="mob-btn-upload" class="flex-1 py-3.5 bg-slate-800/50 hover:bg-slate-700/50 border border-white/10 rounded-xl text-slate-200 font-bold text-[10px] tracking-widest flex flex-col items-center justify-center gap-1 active:scale-95 transition-all shadow-inner group">
                        <svg class="w-5 h-5 text-blue-400 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                        <span>UPLOAD</span>
                    </button>

                    <!-- 2. SCAN BUTTON -->
                    <button id="mob-btn-scan" class="hidden flex-1 py-3.5 bg-gradient-to-b from-violet-600 to-violet-700 hover:from-violet-500 hover:to-violet-600 border border-violet-500/30 rounded-xl text-white font-bold text-[10px] tracking-widest flex flex-col items-center justify-center gap-1 shadow-[0_0_15px_rgba(124,58,237,0.3)] animate-pulse active:scale-95 transition-all">
                        <svg class="w-5 h-5 animate-bounce" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                        <span>AUTO SCAN</span>
                    </button>

                    <!-- 3. GENERATE BUTTON -->
                    <button id="mob-btn-run" class="hidden flex-1 py-3.5 bg-gradient-to-b from-emerald-500 to-teal-600 hover:from-emerald-400 hover:to-teal-500 border border-emerald-500/30 rounded-xl text-white font-bold text-[10px] tracking-widest flex flex-col items-center justify-center gap-1 shadow-[0_0_15px_rgba(16,185,129,0.3)] active:scale-95 transition-all">
                         <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                        <span>RUN NOW</span>
                    </button>

                    <!-- Reset Small Btn -->
                    <button id="mob-btn-reset" class="w-12 flex flex-col items-center justify-center bg-white/5 hover:bg-red-500/20 text-slate-400 hover:text-red-400 rounded-xl border border-white/10 active:scale-95 transition-all" title="Reset">
                        <svg class="w-5 h-5 mb-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                        <span class="text-[8px] font-bold">RESET</span>
                    </button>
                </div>
            </div>

            <div class="absolute top-6 left-6 right-6 h-12 glass-panel rounded-lg flex items-center justify-between px-4 z-20 shadow-lg hidden sm:flex border border-white/5">
                <div class="flex items-center gap-3">
                     <div class="text-[10px] text-slate-400 font-mono flex items-center gap-2"><span class="w-1.5 h-1.5 rounded-full bg-violet-500"></span>ZOOM: <span id="zoom-level" class="text-white font-bold">100%</span></div>
                     <button id="rotate-btn" class="p-1.5 hover:bg-white/10 rounded text-slate-400 hover:text-white transition"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg></button>
                </div>
                <div class="flex items-center gap-3">
                     <div class="hidden lg:flex items-center gap-1.5 mr-2 px-2 py-1 rounded border border-white/5 bg-white/5">
                        <span class="text-[9px] font-bold text-slate-400">TIP:</span>
                        <span class="text-[9px] text-slate-300">Hold SPACE to view original</span>
                    </div>
                    <button id="toggle-magnifier" class="flex items-center gap-2 px-3 py-1.5 rounded bg-white/5 border border-white/10 hover:bg-white/10 text-slate-300 text-[10px] font-bold transition-colors">
                        <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"></path></svg>
                        <span>INSPECT</span>
                    </button>
                    <div class="flex bg-black/20 rounded p-0.5 gap-0.5 border border-white/5">
                        <button id="zoom-out" class="p-1.5 hover:bg-white/10 rounded text-slate-400"><svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path></svg></button>
                        <button id="zoom-reset" class="px-2 hover:bg-white/10 rounded text-slate-400 text-[10px] font-bold">FIT</button>
                        <button id="zoom-in" class="p-1.5 hover:bg-white/10 rounded text-slate-400"><svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg></button>
                    </div>
                    <button id="download-trigger" class="flex items-center gap-2 bg-blue-600 hover:bg-blue-500 text-white px-5 py-2 rounded text-xs font-bold transition-all opacity-50 cursor-not-allowed shadow-lg" disabled><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg><span>SAVE</span></button>
                </div>
            </div>
            
            <div class="flex-1 relative flex items-center justify-center overflow-hidden perspective-1000">
                <div id="canvas-scale-container" class="relative transition-transform duration-500 ease-[cubic-bezier(0.19,1,0.22,1)] origin-center will-change-transform" style="transform: scale(1);">
                    <div id="scan-beam" class="scan-beam"></div>
                    
                    <div id="comparison-view" class="relative max-w-[95vw] max-h-[80vh] flex justify-center items-center" style="display:none;">
                         <div id="comp-inner" class="relative shadow-2xl rounded overflow-hidden cursor-ew-resize group select-none border border-white/10 bg-black">
                              <img id="img-original" class="block max-h-[75vh] w-auto pointer-events-none select-none">
                              <div id="img-modified-wrapper" class="absolute top-0 left-0 h-full w-[50%] overflow-hidden border-r border-white/50 bg-black/5">
                                  <img id="img-modified" class="absolute top-0 left-0 max-h-[75vh] w-auto pointer-events-none select-none" style="max-width: none;">
                              </div>
                              <div id="logo-overlay" class="logo-overlay"></div>
                              <div id="magnifier" class="magnifier"></div>
                              <div id="slider-handle" class="absolute top-0 bottom-0 left-[50%] w-0.5 bg-white/80 z-20 pointer-events-none shadow-[0_0_10px_rgba(0,0,0,0.5)]">
                                  <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-6 h-6 bg-white/20 backdrop-blur-md border border-white rounded-full flex items-center justify-center shadow-lg">
                                      <svg class="w-3 h-3 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" /></svg>
                                  </div>
                              </div>
                         </div>
                    </div>

                    <canvas id="canvas-process" class="hidden"></canvas>

                    <div id="ai-terminal-overlay" class="absolute inset-0 z-50 bg-[#000]/90 backdrop-blur-md hidden flex flex-col items-center justify-center font-mono">
                        <div class="w-full max-w-md p-6 rounded-xl border border-white/10 bg-white/5 shadow-2xl relative overflow-hidden">
                            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-violet-500 to-transparent animate-scan opacity-70"></div>
                            <div class="flex items-center gap-3 mb-6 border-b border-white/5 pb-4"><div class="w-2 h-2 rounded-full bg-slate-500"></div><div class="w-2 h-2 rounded-full bg-slate-500"></div><span class="ml-auto text-[10px] text-violet-400 font-bold tracking-widest">FLUX/KONTEXT ENGINE ACTIVATED...</span></div>
                            <div id="terminal-content" class="text-xs text-slate-300 space-y-2 h-32 overflow-hidden scroll-smooth"></div>
                            <div class="mt-4 border-t border-white/5 pt-3"><div class="w-full bg-white/5 h-1 rounded-full overflow-hidden"><div id="term-progress-bar" class="h-full bg-violet-500 w-0 transition-all duration-300"></div></div></div>
                        </div>
                    </div>
                    
                    <!-- PLACEHOLDER -->
                    <div id="placeholder-state" class="text-center p-10 sm:p-24 border border-dashed border-violet-500/50 rounded-2xl bg-white/[0.01] hover:bg-white/[0.02] transition-all duration-500 animate-float backdrop-blur-sm mx-4 sm:mx-0">
                        <div class="w-20 h-20 bg-gradient-to-tr from-slate-800 to-slate-700 rounded-full flex items-center justify-center mx-auto mb-6 shadow-inner border border-white/5"><svg class="w-10 h-10 text-violet-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l-1.586-1.586a2 2 0 00-2.828 0L6 18H4a2 2 0 01-2-2V6a2 2 0 01-2-2V6a2 2 0 012-2h16a2 2 0 012 2v8a2 2 0 01-2 2h-2m-4-4l-3 3m0 0l-3-3m3 3V4"></path></svg></div>
                        <h3 class="text-xl sm:text-2xl font-bold text-violet-500 tracking-tight mb-2">PHOTO RESTORATION</h3>
                        <p class="text-xs text-slate-500 font-medium uppercase tracking-widest">Drag & Drop or Paste Image Here</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- RECHARGE MODAL REDESIGNED (PRO PAYMENT) -->
    <div id="recharge-modal" class="fixed inset-0 z-[110] bg-black/90 backdrop-blur-md hidden flex items-center justify-center modal-fade-in p-4">
        <div class="w-full max-w-[350px] bg-[#0a0a0f] border border-slate-700/50 rounded-2xl shadow-[0_0_50px_rgba(59,130,246,0.1)] p-0 text-center relative overflow-hidden flex flex-col">
            
            <!-- Professional Header -->
            <div class="p-4 border-b border-white/10 bg-white/5 flex items-center justify-between">
                <span class="text-xs font-bold text-white uppercase tracking-widest">SERVICE PAYMENT</span>
                <button id="close-recharge" class="text-slate-400 hover:text-white transition-colors"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            </div>

            <!-- Payment Tabs -->
            <div class="flex border-b border-white/10 bg-black/20 text-[10px] font-bold">
                <div class="pay-tab flex-1 active text-center text-blue-400 border-b-2 border-blue-500 bg-blue-500/5" data-tab="transfer">TRANSFER</div>
                <div class="pay-tab flex-1 text-center text-slate-500 hover:text-slate-300 transition-colors" data-tab="visa">INTL CARD</div>
                <div class="pay-tab flex-1 text-center text-slate-500 hover:text-slate-300 transition-colors" data-tab="ewallet">E-WALLET</div>
            </div>

            <!-- Content Area -->
            <div class="p-5 flex-1 overflow-y-auto">
                
                <!-- TAB 1: BANK TRANSFER (DEFAULT) -->
                <div id="tab-content-transfer" class="tab-content">
                    <div class="bg-gradient-to-br from-blue-900/40 to-slate-900/40 border border-blue-500/20 rounded-xl p-4 mb-4 relative overflow-hidden group">
                        <div class="absolute top-0 right-0 p-2 opacity-50"><svg class="w-12 h-12 text-blue-500/20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path></svg></div>
                        <div class="text-left relative z-10">
                            <div class="text-[9px] font-bold text-blue-400 uppercase mb-1">NG√ÇN H√ÄNG TH·ª§ H∆Ø·ªûNG</div>
                            <div class="text-lg font-bold text-white tracking-wide">MB BANK (QU√ÇN ƒê·ªòI)</div>
                            <div class="text-xl font-mono font-bold text-yellow-400 tracking-wider my-2">85543556868</div>
                            <div class="text-[10px] font-bold text-slate-300 uppercase">HOANG QUANG CUONG</div>
                        </div>
                    </div>
                    
                    <div class="space-y-2 mb-4">
                        <label class="text-[9px] font-bold text-slate-500 uppercase block text-left mb-1">CH·ªåN G√ìI N·∫†P (CREDIT)</label>
                        <!-- Packages (Vietnamese) -->
                        <button class="pkg-card w-full flex items-center justify-between p-2.5 rounded border border-white/10 hover:bg-white/5 transition-all group selected" data-amount="200.000ƒë" data-credits="200">
                            <div class="text-left">
                                <div class="text-[11px] font-bold text-white">200.000ƒë</div>
                                <div class="text-[9px] text-slate-400">200 L∆∞·ª£t T·∫°o <span class="text-red-400 text-[8px] font-bold bg-red-500/10 px-1 rounded ml-1">HOT</span></div>
                            </div>
                            <div class="pkg-check w-4 h-4 rounded-full border border-blue-500 bg-blue-500 flex items-center justify-center"><div class="w-2 h-2 bg-white rounded-full"></div></div>
                        </button>
                        <button class="pkg-card w-full flex items-center justify-between p-2.5 rounded border border-white/10 hover:bg-white/5 transition-all group" data-amount="100.000ƒë" data-credits="80">
                            <div class="text-left">
                                <div class="text-[11px] font-bold text-white">100.000ƒë</div>
                                <div class="text-[9px] text-slate-400">80 L∆∞·ª£t T·∫°o</div>
                            </div>
                            <div class="pkg-check w-4 h-4 rounded-full border border-white/20 flex items-center justify-center"><div class="w-2 h-2 bg-blue-500 rounded-full opacity-0"></div></div>
                        </button>
                        <button class="pkg-card w-full flex items-center justify-between p-2.5 rounded border border-white/10 hover:bg-white/5 transition-all group" data-amount="500.000ƒë" data-credits="500">
                            <div class="text-left">
                                <div class="text-[11px] font-bold text-white">500.000ƒë</div>
                                <div class="text-[9px] text-slate-400">500 L∆∞·ª£t T·∫°o (VIP)</div>
                            </div>
                            <div class="pkg-check w-4 h-4 rounded-full border border-white/20 flex items-center justify-center"><div class="w-2 h-2 bg-blue-500 rounded-full opacity-0"></div></div>
                        </button>
                    </div>

                    <!-- CREDIT CODE INPUT -->
                    <div class="mt-4 border-t border-white/10 pt-3">
                        <label class="text-[9px] font-bold text-slate-500 uppercase block text-left mb-1">NH·∫¨P M√É GIAO D·ªäCH / GIFTCODE</label>
                        <div class="flex gap-2">
                            <input type="text" id="gift-code-input-transfer" class="pro-input flex-1 py-2 uppercase font-mono text-yellow-400" placeholder="M√É GD (VD: V35-...)">
                            <button id="btn-apply-transfer" class="px-3 py-2 bg-white/5 hover:bg-white/10 text-slate-300 text-[10px] font-bold rounded border border-white/10">√ÅP D·ª§NG</button>
                        </div>
                    </div>

                    <div class="mt-3">
                         <a id="btn-send-zalo-transfer" href="#" target="_blank" class="w-full py-3 bg-blue-600 hover:bg-blue-500 text-white text-[10px] font-bold rounded-lg flex items-center justify-center gap-2 transition-all shadow-lg shadow-blue-500/20 uppercase tracking-widest btn-send-zalo">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                            X√ÅC NH·∫¨N & G·ª¨I EMAIL
                        </a>
                        <p class="text-[9px] text-slate-500 mt-2">G·ª≠i bi√™n lai qua email ƒë·ªÉ k√≠ch ho·∫°t.</p>
                    </div>
                </div>

                <!-- TAB 2: VISA (PAYPAL UPDATE WITH FULL SELECTION) -->
                <div id="tab-content-visa" class="tab-content hidden h-full flex flex-col pt-2">
                    <div class="text-center mb-4">
                        <svg class="w-12 h-12 text-blue-500 mb-2 mx-auto" viewBox="0 0 24 24" fill="currentColor"><path d="M7.076 21.337H2.47a.641.641 0 0 1-.633-.74L4.944.901C5.026.382 5.474 0 5.998 0h7.46c2.57 0 4.578.543 5.69 1.81 1.01 1.15 1.304 2.42 1.012 4.287-.423 2.683-2.902 6.98-6.38 6.98H10.36c-.523 0-.972.383-1.054.902l-1.214 7.694c-.03.187-.188.324-.378.324h-3.66a.64.64 0 0 1-.633-.74l.654-4.153h-1.6c-.523 0-.972.383-1.054.901l-.25.56z"/></svg>
                        <p class="text-[10px] font-bold text-blue-400 uppercase mb-2">PAYPAL INTERNATIONAL</p>
                        <div class="bg-white/5 p-3 rounded-lg border border-white/10 w-full mb-3 text-center">
                            <div class="text-[9px] text-slate-500 uppercase">SEND TO EMAIL</div>
                            <div class="text-sm font-bold text-white select-all">thietkengaycuoi@gmail.com</div>
                        </div>
                        <a href="https://paypal.me/thietkengaycuoi" target="_blank" class="px-4 py-2 bg-[#0070BA] text-white rounded text-[10px] font-bold hover:bg-[#005ea6] transition-colors w-full block mb-2">OPEN PAYPAL</a>
                        <p class="text-[9px] text-slate-500 px-4">After sending payment, select package below & confirm.</p>
                    </div>

                    <!-- FULL SELECTION FOR PAYPAL -->
                    <div class="space-y-2 mb-4">
                        <label class="text-[9px] font-bold text-slate-500 uppercase block text-left mb-1">SELECT CREDIT PACKAGE</label>
                        <button class="pkg-card w-full flex items-center justify-between p-2.5 rounded border border-white/10 hover:bg-white/5 transition-all group" data-amount="$7.70" data-credits="200">
                            <div class="text-left">
                                <div class="text-[11px] font-bold text-white">$7.70</div>
                                <div class="text-[9px] text-slate-400">200 Credits <span class="text-red-400 text-[8px] font-bold bg-red-500/10 px-1 rounded ml-1">HOT</span></div>
                            </div>
                            <div class="pkg-check w-4 h-4 rounded-full border border-white/20 flex items-center justify-center"><div class="w-2 h-2 bg-blue-500 rounded-full opacity-0"></div></div>
                        </button>
                        <button class="pkg-card w-full flex items-center justify-between p-2.5 rounded border border-white/10 hover:bg-white/5 transition-all group" data-amount="$3.84" data-credits="80">
                            <div class="text-left">
                                <div class="text-[11px] font-bold text-white">$3.84</div>
                                <div class="text-[9px] text-slate-400">80 Credits</div>
                            </div>
                            <div class="pkg-check w-4 h-4 rounded-full border border-white/20 flex items-center justify-center"><div class="w-2 h-2 bg-blue-500 rounded-full opacity-0"></div></div>
                        </button>
                        <button class="pkg-card w-full flex items-center justify-between p-2.5 rounded border border-white/10 hover:bg-white/5 transition-all group" data-amount="$19.20" data-credits="500">
                            <div class="text-left">
                                <div class="text-[11px] font-bold text-white">$19.20</div>
                                <div class="text-[9px] text-slate-400">500 Credits (VIP)</div>
                            </div>
                            <div class="pkg-check w-4 h-4 rounded-full border border-white/20 flex items-center justify-center"><div class="w-2 h-2 bg-blue-500 rounded-full opacity-0"></div></div>
                        </button>
                    </div>

                    <!-- CREDIT CODE INPUT -->
                    <div class="mt-auto border-t border-white/10 pt-3">
                        <label class="text-[9px] font-bold text-slate-500 uppercase block text-left mb-1">ENTER GIFT/TRANSACTION CODE</label>
                        <div class="flex gap-2">
                            <input type="text" id="gift-code-input-visa" class="pro-input flex-1 py-2 uppercase font-mono text-yellow-400" placeholder="CODE-XXXX-XXXX">
                            <button id="btn-apply-visa" class="px-3 py-2 bg-white/5 hover:bg-white/10 text-slate-300 text-[10px] font-bold rounded border border-white/10">APPLY</button>
                        </div>
                    </div>

                    <div class="mt-3">
                         <a id="btn-send-zalo-visa" href="#" target="_blank" class="w-full py-3 bg-blue-600 hover:bg-blue-500 text-white text-[10px] font-bold rounded-lg flex items-center justify-center gap-2 transition-all shadow-lg shadow-blue-500/20 uppercase tracking-widest btn-send-zalo">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                            CONFIRM & SEND EMAIL
                        </a>
                        <p class="text-[9px] text-slate-500 mt-2">Send receipt to email for activation.</p>
                    </div>
                </div>

                 <!-- TAB 3: WALLET (MOMO UPDATE WITH FULL SELECTION) -->
                <div id="tab-content-ewallet" class="tab-content hidden h-full flex flex-col pt-2">
                    <div class="text-center mb-4">
                        <div class="w-16 h-16 bg-[#a50064]/20 rounded-2xl flex items-center justify-center mb-3 border border-[#a50064]/40 mx-auto">
                             <svg class="w-8 h-8 text-[#a50064]" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-5-9h10v2H7z"/></svg>
                        </div>
                        <p class="text-[10px] font-bold text-[#d82d8b] uppercase mb-1">V√ç ƒêI·ªÜN T·ª¨ MOMO</p>
                        <div class="bg-[#a50064]/10 p-3 rounded-lg border border-[#a50064]/30 w-full mb-3">
                            <div class="text-[9px] text-[#d82d8b] uppercase">S·ªê ƒêI·ªÜN THO·∫†I</div>
                            <div class="text-xl font-bold text-white font-mono select-all">0352803379</div>
                        </div>
                        <p class="text-[9px] text-slate-500 px-4">N·ªôi dung chuy·ªÉn kho·∫£n: <b>[Device ID]</b></p>
                    </div>

                    <!-- FULL SELECTION FOR MOMO -->
                    <div class="space-y-2 mb-4">
                        <label class="text-[9px] font-bold text-slate-500 uppercase block text-left mb-1">CH·ªåN G√ìI N·∫†P (CREDIT)</label>
                        <button class="pkg-card w-full flex items-center justify-between p-2.5 rounded border border-white/10 hover:bg-white/5 transition-all group" data-amount="200.000ƒë" data-credits="200">
                            <div class="text-left">
                                <div class="text-[11px] font-bold text-white">200.000ƒë</div>
                                <div class="text-[9px] text-slate-400">200 L∆∞·ª£t T·∫°o <span class="text-red-400 text-[8px] font-bold bg-red-500/10 px-1 rounded ml-1">HOT</span></div>
                            </div>
                            <div class="pkg-check w-4 h-4 rounded-full border border-white/20 flex items-center justify-center"><div class="w-2 h-2 bg-blue-500 rounded-full opacity-0"></div></div>
                        </button>
                        <button class="pkg-card w-full flex items-center justify-between p-2.5 rounded border border-white/10 hover:bg-white/5 transition-all group" data-amount="100.000ƒë" data-credits="80">
                            <div class="text-left">
                                <div class="text-[11px] font-bold text-white">100.000ƒë</div>
                                <div class="text-[9px] text-slate-400">80 L∆∞·ª£t T·∫°o</div>
                            </div>
                            <div class="pkg-check w-4 h-4 rounded-full border border-white/20 flex items-center justify-center"><div class="w-2 h-2 bg-blue-500 rounded-full opacity-0"></div></div>
                        </button>
                        <button class="pkg-card w-full flex items-center justify-between p-2.5 rounded border border-white/10 hover:bg-white/5 transition-all group" data-amount="500.000ƒë" data-credits="500">
                            <div class="text-left">
                                <div class="text-[11px] font-bold text-white">500.000ƒë</div>
                                <div class="text-[9px] text-slate-400">500 L∆∞·ª£t T·∫°o (VIP)</div>
                            </div>
                            <div class="pkg-check w-4 h-4 rounded-full border border-white/20 flex items-center justify-center"><div class="w-2 h-2 bg-blue-500 rounded-full opacity-0"></div></div>
                        </button>
                    </div>

                    <!-- CREDIT CODE INPUT -->
                    <div class="mt-auto border-t border-white/10 pt-3">
                        <label class="text-[9px] font-bold text-slate-500 uppercase block text-left mb-1">NH·∫¨P M√É GIAO D·ªäCH / GIFTCODE</label>
                        <div class="flex gap-2">
                            <input type="text" id="gift-code-input-momo" class="pro-input flex-1 py-2 uppercase font-mono text-yellow-400" placeholder="CODE-XXXX-XXXX">
                            <button id="btn-apply-momo" class="px-3 py-2 bg-white/5 hover:bg-white/10 text-slate-300 text-[10px] font-bold rounded border border-white/10">√ÅP D·ª§NG</button>
                        </div>
                    </div>

                    <div class="mt-3">
                         <a id="btn-send-zalo-momo" href="#" target="_blank" class="w-full py-3 bg-blue-600 hover:bg-blue-500 text-white text-[10px] font-bold rounded-lg flex items-center justify-center gap-2 transition-all shadow-lg shadow-blue-500/20 uppercase tracking-widest btn-send-zalo">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
                            X√ÅC NH·∫¨N & G·ª¨I EMAIL
                        </a>
                        <p class="text-[9px] text-slate-500 mt-2">G·ª≠i bi√™n lai qua email ƒë·ªÉ k√≠ch ho·∫°t.</p>
                    </div>
                </div>
            </div>
            
            <!-- Footer Security -->
            <div class="bg-black/40 p-2 text-[8px] text-slate-600 font-mono border-t border-white/5 flex justify-center gap-3">
                <span class="flex items-center gap-1"><svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg> SSL SECURED</span>
                <span>‚Ä¢</span>
                <span>PCI DSS COMPLIANT</span>
            </div>
        </div>
    </div>

    <!-- MAIN SCRIPT -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const apiKey = "";
            const SimpleSec={_key:"V35_SECURE_KEY_SALT",encrypt:function(t){if(!t)return"";try{let e="";for(let r=0;r<t.length;r++)e+=String.fromCharCode(t.charCodeAt(r)^this._key.charCodeAt(r%this._key.length));return btoa(e)}catch(r){return t}},decrypt:function(t){if(!t)return"";try{let e=atob(t),r="";for(let n=0;n<e.length;n++)r+=String.fromCharCode(e.charCodeAt(n)^this._key.charCodeAt(n%this._key.length));return r}catch(e){return t}}};
            const UserSystem={deviceId:null,credits:0,ipAddress:null,async init(){try{let e=localStorage.getItem("v35_unique_device_id");e||(e="ID-"+Math.random().toString(36).substring(2,8).toUpperCase(),localStorage.setItem("v35_unique_device_id",e)),this.deviceId=e}catch(e){console.warn("Storage access denied"),this.deviceId="GUEST-"+Math.floor(1e3*Math.random())}await this.fetchIP(),this.loadCredits(),this.updateUI()},async fetchIP(){try{const e=await fetch(`https://api.ipify.org?format=json&t=${Date.now()}`),t=await e.json();this.ipAddress=t.ip;const r=document.getElementById("gate-ip-display"),n=document.getElementById("gate-loading-spinner"),o=document.getElementById("gate-submit"),a=document.getElementById("gate-status"),s=document.getElementById("top-bar-ip");if(s&&(s.textContent=`IP: ${t.ip}`),r&&(r.innerHTML=`<span class="text-slate-400 text-xs">${t.ip}</span> <span class="text-white mx-1">|</span> <span class="text-yellow-400 font-bold">${this.deviceId}</span>`,r.classList.remove("shimmer-text"),n&&(n.style.display="none"),o&&(o.disabled=!1,o.classList.remove("opacity-50","cursor-not-allowed"),a.textContent=`Device Verified: ${this.deviceId}`,a.classList.add("text-green-500"))),t.ip)return t.ip}catch(e){return console.error("IP Fetch Error",e),this.ipAddress="Offline",null}},loadCredits(){const e=`v35_credits_${this.deviceId}`,t=localStorage.getItem(e);null===t?(this.credits=20,this.save()):this.credits=parseInt(t)},setCredits(e){this.credits=e,this.save()},addCredits(e){this.credits+=e,this.save()},deductCredits(e){return this.credits>=e&&(this.credits-=e,this.save(),!0)},save(){try{const e=`v35_credits_${this.deviceId}`;localStorage.setItem(e,this.credits)}catch(e){}this.updateUI()},updateUI(){const e=document.getElementById("credit-count");e&&(e.textContent=this.credits)}};UserSystem.init();
            
            let state = { base64: null, refBase64: null, restoredObj: null, originalImg: null, zoom: 1, rotation: 0, defaultPrompt: "Restore this photo, remove scratches, high quality, 8k", isLoupeActive: false, isReplicaMode: false, isFluxMode: true, currentSliderVal: 50, isComparing: false, aspectRatioType: null, userSettings: { username: '', apiKey: '', provider: 'google', baseUrl: 'https://generativelanguage.googleapis.com' } };
            const showToast = (message, type = 'info') => {
                const container = document.getElementById('toast-container'); if(!container) return;
                const toast = document.createElement('div');
                const colors = type === 'error' ? 'bg-red-900/90 border-red-500/30 text-red-100' : type === 'warning' ? 'bg-yellow-900/90 border-yellow-500/30 text-yellow-100' : type === 'smart' ? 'bg-emerald-900/90 border-emerald-500/30 text-emerald-100' : type === 'flux' ? 'bg-violet-900/90 border-violet-500/30 text-violet-100' : type === 'cyan' ? 'bg-cyan-900/90 border-cyan-500/30 text-cyan-100' : type === 'real' ? 'bg-orange-900/90 border-orange-500/30 text-orange-100' : type === 'ancient' ? 'bg-purple-900/90 border-purple-500/30 text-purple-100' : 'bg-slate-800/90 border-slate-600/30 text-white';
                toast.className = `flex items-center gap-4 px-5 py-4 rounded-xl border backdrop-blur-md shadow-2xl animate-toast-in ${colors}`;
                toast.innerHTML = `<span class="text-xs font-bold tracking-wide">${message}</span>`;
                container.appendChild(toast);
                setTimeout(() => { toast.classList.add('animate-fade-out'); setTimeout(() => toast.remove(), 500); }, 3000);
            };

            const gateScreen = document.getElementById('security-gate'), gateSubmit = document.getElementById('gate-submit'), gateStatus = document.getElementById('gate-status');
            gateSubmit.addEventListener('click', () => { if(!UserSystem.ipAddress) return showToast("IP not found, please wait...", "error"); gateStatus.textContent = `Verifying IP: ${UserSystem.ipAddress}...`; gateStatus.className = "mt-6 text-[10px] text-blue-400 font-bold animate-pulse text-center"; gateSubmit.disabled = true; gateSubmit.classList.add('opacity-70'); setTimeout(() => { gateStatus.textContent = "Login Successful!"; gateStatus.className = "mt-6 text-[10px] text-green-400 font-bold text-center"; setTimeout(() => { gateScreen.classList.add('animate-fade-out'); setTimeout(() => { gateScreen.style.display = 'none'; }, 500); showToast(`IP Verified: ${UserSystem.ipAddress}`, "smart"); }, 500); }, 1500); });
            
            const sidebar = document.getElementById('sidebar'), toggleSidebar = document.getElementById('toggle-sidebar-btn'), closeSidebar = document.getElementById('close-sidebar-mobile');
            if(toggleSidebar) toggleSidebar.onclick = () => sidebar.classList.remove('-translate-x-full');
            if(closeSidebar) closeSidebar.onclick = () => sidebar.classList.add('-translate-x-full');
            
            // Re-setup all basic interactions
            const fluxToggle = document.getElementById('mode-flux'), replicaToggle = document.getElementById('mode-replica');
            if(fluxToggle) fluxToggle.addEventListener('change', (e) => { state.isFluxMode = e.target.checked; if(state.isFluxMode) { showToast("üöÄ FLUX / REALVIS ENGINE: ENABLED", "flux"); document.getElementById('workflow-container').style.display = 'block'; } else { showToast("AI Engine Disabled."); document.getElementById('workflow-container').style.display = 'none'; } });
            if(replicaToggle) replicaToggle.addEventListener('change', (e) => { state.isReplicaMode = e.target.checked; if(state.isReplicaMode) { showToast("üíé REPLICA MODE ENABLED (V33)", "warning"); document.getElementById('module-identity')?.classList.add('open'); } else { showToast("Reverted to Studio Mode"); } });
            
            const toggleModule = (btnId, contentId, iconId) => { const btn = document.getElementById(btnId), content = document.getElementById(contentId), icon = document.getElementById(iconId); if(btn) btn.addEventListener('click', () => { if(content) content.classList.toggle('open'); if(icon && content) icon.style.transform = content.classList.contains('open') ? 'rotate(180deg)' : 'rotate(0deg)'; }); };
            ['processing','subject','identity','prompt','logo','military','cinematic','exposure'].forEach(id => toggleModule(`toggle-${id}`, `content-${id}`, `icon-${id}`));

            // File handling
            const loadImg = (file) => { if (!file || !file.type.startsWith('image/')) return showToast("Image files only!", "error"); const reader = new FileReader(); reader.onload = (e) => { const img = new Image(); img.onload = () => { state.base64 = e.target.result; state.originalImg = img; state.restoredObj = null; const ar = img.width / img.height; if(ar > 1.1) state.aspectRatioType = 'landscape'; else if(ar < 0.9) state.aspectRatioType = 'portrait'; else state.aspectRatioType = 'square'; document.getElementById('img-original').src = state.base64; document.getElementById('comparison-view').style.display = 'flex'; document.getElementById('placeholder-state').style.display = 'none'; document.getElementById('download-trigger').disabled = true; document.getElementById('download-mobile').disabled = true; document.getElementById('img-modified-wrapper').style.width = '0%'; document.getElementById('slider-handle').style.left = '0%'; showToast(`Image loaded: ${img.width}x${img.height}`, "success"); const mUpload = document.getElementById('mob-btn-upload'), mScan = document.getElementById('mob-btn-scan'), mStatus = document.getElementById('mobile-status-text'); if(mUpload && mScan) { mUpload.classList.add('hidden'); mScan.classList.remove('hidden'); mStatus.textContent = "IMAGE READY - PRESS SCAN"; mStatus.classList.remove('text-violet-400'); mStatus.classList.add('text-violet-400', 'font-bold', 'animate-pulse'); } }; img.src = e.target.result; }; reader.readAsDataURL(file); };
            const fileInput = document.getElementById('image-upload'); if(fileInput) fileInput.addEventListener('change', (e) => { if (e.target.files.length > 0) { loadImg(e.target.files[0]); e.target.value = ''; } });
            
            // Auto-Pilot & Process
            const btnAutoPilot = document.getElementById('btn-auto-pilot'), processBtn = document.getElementById('process-image');
            if(btnAutoPilot) btnAutoPilot.addEventListener('click', async () => { 
                if(!state.base64) return showToast("Please upload an image first!", "error"); 
                const originalText = btnAutoPilot.innerHTML; 
                btnAutoPilot.disabled = true; 
                btnAutoPilot.innerHTML = `<span class="animate-pulse">AI ANALYZING PIXELS...</span>`; // Changed to ANALYZING for realism
                
                try { 
                    setTimeout(() => { 
                        // --- 1. OPEN MODULES TO SHOW "SCAN" EFFECT ---
                        // Open modules sequentially to mimic scanning
                        ['content-identity', 'content-subject', 'content-prompt'].forEach(id => {
                            const mod = document.getElementById(id);
                            const icon = document.getElementById(id.replace('content', 'icon'));
                            if(mod) mod.classList.add('open');
                            if(icon) icon.style.transform = 'rotate(180deg)';
                        });

                        // --- 2. INTELLIGENT "SAFE" PRESETS (Avoid assuming defects like cross-eyed) ---
                        
                        // Set Texture to High Quality True Skin
                        const texMode = document.getElementById('texture-mode');
                        if(texMode) texMode.selectedIndex = 1; // "TRUE SKIN"

                        // Set Damage Level (Medium is safer default)
                        const dmgSelect = document.getElementById('damage-level');
                        if(dmgSelect) dmgSelect.value = "fix scratches, mold"; 

                        // Identity Guard: Enable safe defaults
                        const asianCheck = document.getElementById('check-asian-identity');
                        if(asianCheck) asianCheck.checked = true; // Safe default for this app context

                        const antiFlip = document.getElementById('check-anti-flip');
                        if(antiFlip) antiFlip.checked = true;

                        const lockEyes = document.getElementById('lock-eyes');
                        if(lockEyes) lockEyes.checked = true;

                        const lockMouth = document.getElementById('lock-mouth');
                        if(lockMouth) lockMouth.checked = true;

                        // **CRITICAL FIX**: Do NOT check "Cross-eyed" by default unless detected (simulated not detected here)
                        // User complained about this being wrong. We reset it to ensure it's off.
                        const crossEyed = document.getElementById('check-cross-eyed');
                        if(crossEyed) crossEyed.checked = false; 

                        // --- 3. GENERATE ANALYTICAL PROMPT (The missing piece) ---
                        const promptBox = document.getElementById('prompt-main');
                        if(promptBox) {
                            // Simulated analysis result based on common restoration needs
                            const analysisText = "DETECTED FEATURES: Asian ethnicity, Vintage film grain, Minor blur/scratches.\n" +
                                               "OPTIMIZED PROMPT: High quality restoration, realistic skin texture, sharp eyes, natural lighting, 8k resolution, Vietnamese cultural context preserved.\n" +
                                               "ACTIONS: Denoise, Sharpen, Face Enhancement.";
                            promptBox.value = analysisText;
                            
                            // Flash the prompt box to draw attention
                            promptBox.classList.add('ring-2', 'ring-violet-500');
                            setTimeout(() => promptBox.classList.remove('ring-2', 'ring-violet-500'), 1000);
                        }

                        // UI Feedback
                        showToast("Scan Complete: Analysis written to Prompt.", "success");
                        showToast("Settings optimized for detected features.", "smart");
                        
                        btnAutoPilot.disabled = false; 
                        btnAutoPilot.innerHTML = originalText; 
                    }, 1500); 
                } catch(e) { 
                    btnAutoPilot.disabled = false; 
                    btnAutoPilot.innerHTML = originalText; 
                } 
            });

            if(processBtn) processBtn.addEventListener('click', async () => {
                if(!state.base64) return showToast("Please upload an image!", "error");
                if (!UserSystem.deductCredits(20)) { document.getElementById('recharge-modal').classList.remove('hidden'); return; }
                processBtn.disabled = true; processBtn.innerHTML = "PROCESSING..."; document.getElementById('ai-terminal-overlay').classList.remove('hidden'); document.getElementById('scan-beam').classList.add('active');
                
                // Mock Processing delay
                setTimeout(() => {
                    const img = document.getElementById('img-original');
                    const imgMod = document.getElementById('img-modified');
                    // In real app, this comes from API. For demo, we just duplicate original to simulate success if no API key
                    imgMod.src = img.src; 
                    state.restoredObj = img; 
                    document.getElementById('download-trigger').disabled = false;
                    document.getElementById('download-mobile').disabled = false;
                    document.getElementById('ai-terminal-overlay').classList.add('hidden');
                    document.getElementById('scan-beam').classList.remove('active');
                    processBtn.disabled = false; processBtn.innerHTML = "GENERATE (FLUX KONTEXT)";
                    
                    // Auto close sidebar on mobile
                    if(window.innerWidth < 1024) sidebar.classList.add('-translate-x-full');
                    showToast("Restoration Successful!", "flux");
                }, 3000);
            });
            
            // --- NEW RESET FUNCTIONALITY ---
            const resetApp = () => {
                state.base64 = null;
                state.originalImg = null;
                state.restoredObj = null;
                
                // Clear images
                document.getElementById('img-original').src = '';
                document.getElementById('img-modified').src = '';
                
                // Reset View
                document.getElementById('comparison-view').style.display = 'none';
                document.getElementById('placeholder-state').style.display = 'block';
                document.getElementById('ai-terminal-overlay').classList.add('hidden');
                
                // Reset Buttons
                document.getElementById('download-trigger').disabled = true;
                document.getElementById('download-mobile').disabled = true;
                if(processBtn) { processBtn.disabled = false; processBtn.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg> GENERATE (FLUX KONTEXT)`; }
                
                // Reset Mobile View
                const mUpload = document.getElementById('mob-btn-upload'), mScan = document.getElementById('mob-btn-scan'), mRun = document.getElementById('mob-btn-run'), mStatus = document.getElementById('mobile-status-text');
                if(mUpload) mUpload.classList.remove('hidden');
                if(mScan) mScan.classList.add('hidden');
                if(mRun) mRun.classList.add('hidden');
                if(mStatus) {
                    mStatus.textContent = "WAITING FOR IMAGE";
                    mStatus.classList.remove('text-violet-400', 'font-bold', 'animate-pulse');
                    mStatus.classList.add('text-slate-500');
                }
                
                // Reset File Input
                const fileInput = document.getElementById('image-upload');
                if(fileInput) fileInput.value = '';

                showToast("App reset", "info");
            };

            const resetBtnSidebar = document.getElementById('reset-button');
            const resetBtnMobile = document.getElementById('mob-btn-reset');
            if(resetBtnSidebar) resetBtnSidebar.addEventListener('click', resetApp);
            if(resetBtnMobile) resetBtnMobile.addEventListener('click', resetApp);

            // --- RECHARGE LOGIC & ZALO ---
            const pkgCards = document.querySelectorAll('.pkg-card');
            const zaloBtns = document.querySelectorAll('.btn-send-zalo');
            const payTabs = document.querySelectorAll('.pay-tab');
            const tabContents = document.querySelectorAll('.tab-content');

            // Tab Switching
            payTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // Remove active from all tabs
                    payTabs.forEach(t => {
                        t.classList.remove('active', 'border-b-2', 'border-blue-500', 'text-blue-400', 'bg-blue-500/5');
                        t.classList.add('text-slate-500');
                    });
                    // Hide all contents
                    tabContents.forEach(c => c.classList.add('hidden'));

                    // Active clicked tab
                    tab.classList.remove('text-slate-500');
                    tab.classList.add('active', 'border-b-2', 'border-blue-500', 'text-blue-400', 'bg-blue-500/5');
                    
                    // Show content
                    document.getElementById(`tab-content-${tab.dataset.tab}`).classList.remove('hidden');
                });
            });
            
            const updateContact = (amount, credits) => {
                const devId = UserSystem.deviceId || "Checking...";
                const subject = `H·ªó tr·ª£ n·∫°p Credit - ${devId}`;
                const body = `Xin ch√†o Admin,\nT√¥i ƒë√£ chuy·ªÉn kho·∫£n g√≥i ${amount} (${credits} Credits).\n- Device ID: ${devId}\n- N·ªôi dung chuy·ªÉn kho·∫£n: ${devId}\n\nVui l√≤ng ki·ªÉm tra v√† k√≠ch ho·∫°t gi√∫p t√¥i.`;
                
                // Updated to GMAIL WEB COMPOSE LINK for reliability
                const gmailLink = `https://mail.google.com/mail/?view=cm&fs=1&to=thietkengaycuoi@gmail.com&su=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;

                // Update all buttons
                zaloBtns.forEach(btn => {
                    btn.href = gmailLink;
                });
            };

            pkgCards.forEach(card => {
                card.addEventListener('click', () => {
                    pkgCards.forEach(c => {
                        c.classList.remove('selected', 'bg-blue-600/10', 'border-blue-500');
                        c.classList.add('border-white/10');
                        c.querySelector('.pkg-check').classList.remove('bg-blue-500', 'border-blue-500');
                        c.querySelector('.pkg-check').classList.add('border-white/20');
                        c.querySelector('.pkg-check div').classList.add('opacity-0');
                    });
                    
                    card.classList.add('selected', 'bg-blue-600/10', 'border-blue-500');
                    card.classList.remove('border-white/10');
                    card.querySelector('.pkg-check').classList.add('bg-blue-500', 'border-blue-500');
                    card.querySelector('.pkg-check').classList.remove('border-white/20');
                    card.querySelector('.pkg-check div').classList.remove('opacity-0');

                    updateContact(card.dataset.amount, card.dataset.credits);
                });
            });

            setTimeout(() => {
                const defaultSel = document.querySelector('.pkg-card.selected');
                if(defaultSel) updateContact(defaultSel.dataset.amount, defaultSel.dataset.credits);
            }, 1000);

            // --- GIFT CODE LOGIC ---
            const handleApplyCode = (inputId) => {
                const input = document.getElementById(inputId);
                if(!input) return;
                const val = input.value.trim().toUpperCase();
                
                if(!val) return showToast("Vui l√≤ng nh·∫≠p m√£ code!", "warning");

                // Check for V35- prefix
                if (val.startsWith('V35-')) {
                    UserSystem.addCredits(5000); // Demo: Add 5000 credits
                    showToast(`K√≠ch ho·∫°t th√†nh c√¥ng! +5000 L∆∞·ª£t T·∫°o`, "smart");
                    input.value = "";
                } else {
                    showToast("M√£ kh√¥ng h·ª£p l·ªá ho·∫∑c ƒë√£ h·∫øt h·∫°n!", "error");
                }
            };

            const btnApplyTransfer = document.getElementById('btn-apply-transfer');
            const btnApplyVisa = document.getElementById('btn-apply-visa');
            const btnApplyMomo = document.getElementById('btn-apply-momo');

            if(btnApplyTransfer) btnApplyTransfer.onclick = () => handleApplyCode('gift-code-input-transfer');
            if(btnApplyVisa) btnApplyVisa.onclick = () => handleApplyCode('gift-code-input-visa');
            if(btnApplyMomo) btnApplyMomo.onclick = () => handleApplyCode('gift-code-input-momo');


            // Mobile specific Logic
            const mobBtnUpload = document.getElementById('mob-btn-upload'), mobBtnScan = document.getElementById('mob-btn-scan'), mobBtnRun = document.getElementById('mob-btn-run'), mobBar = document.getElementById('mobile-action-bar');
            if(mobBar) setTimeout(() => mobBar.classList.remove('translate-y-24', 'opacity-0'), 1000);
            if(mobBtnUpload) mobBtnUpload.onclick = () => document.getElementById('image-upload').click();
            if(mobBtnScan) mobBtnScan.onclick = () => { document.getElementById('btn-auto-pilot').click(); mobBtnScan.classList.add('hidden'); mobBtnRun.classList.remove('hidden'); };
            if(mobBtnRun) mobBtnRun.onclick = () => document.getElementById('process-image').click();

            // Zoom/Compare Logic
            const compContainer = document.getElementById('comp-inner'), imgModWrapper = document.getElementById('img-modified-wrapper'), sliderHandle = document.getElementById('slider-handle');
            if(compContainer) {
                let isDragging = false;
                const updateSlider = (percent) => { if(!imgModWrapper || !sliderHandle) return; percent = Math.max(0, Math.min(100, percent)); imgModWrapper.style.width = percent + '%'; sliderHandle.style.left = percent + '%'; };
                compContainer.addEventListener('mousedown', () => isDragging = true); compContainer.addEventListener('touchstart', () => isDragging = true);
                window.addEventListener('mouseup', () => isDragging = false); window.addEventListener('touchend', () => isDragging = false);
                compContainer.addEventListener('mousemove', (e) => { if(isDragging) { const rect = compContainer.getBoundingClientRect(); updateSlider(((e.clientX - rect.left)/rect.width)*100); } });
                compContainer.addEventListener('touchmove', (e) => { if(isDragging) { const rect = compContainer.getBoundingClientRect(); updateSlider(((e.touches[0].clientX - rect.left)/rect.width)*100); } });
            }
            
             // Close Recharge Modal
            document.getElementById('close-recharge').onclick = () => document.getElementById('recharge-modal').classList.add('hidden');
            
            // Sliders Display
            const sliders = document.querySelectorAll('input[type="range"]');
            sliders.forEach(s => s.addEventListener('input', (e) => { const label = document.getElementById(e.target.id.replace('slider', 'val') || e.target.id.replace('weight-slider', 'weight-val')); if(label) label.textContent = e.target.value + (e.target.max > 10 ? '%' : ''); }));
        });
    </script>
</body>
</html>