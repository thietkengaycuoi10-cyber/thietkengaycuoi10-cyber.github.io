<!DOCTYPE html>
<html lang="vi" class="h-full antialiased text-gray-100">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>PH·ª§C H·ªíI ·∫¢NH - VETERAN PRO EDITION (V36.20)</title>
    
    <!-- FONTS: Apple Style Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- COPYRIGHT PROTECTION SCRIPT -->
    <script>
        (function() {
            document.addEventListener('contextmenu', function(e) { e.preventDefault(); return false; });
            document.onkeydown = function(e) {
                if (e.keyCode == 123) return false;
                if (e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) return false;
                if (e.ctrlKey && e.shiftKey && e.keyCode == 'C'.charCodeAt(0)) return false;
                if (e.ctrlKey && e.shiftKey && e.keyCode == 'J'.charCodeAt(0)) return false;
                if (e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) return false;
                if (e.ctrlKey && e.keyCode == 'S'.charCodeAt(0)) { e.preventDefault(); return false; }
            };
            console.log("%cD·ª™NG L·∫†I!", "color: red; font-size: 50px; font-weight: bold; text-shadow: 2px 2px #000;");
            console.log("%cƒê√¢y l√† ph·∫ßn m·ªÅm c√≥ b·∫£n quy·ªÅn.", "color: white; background: red; font-size: 16px; padding: 10px; border-radius: 5px;");
        })();
    </script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 
                        sans: ['"Plus Jakarta Sans"', '-apple-system', 'BlinkMacSystemFont', 'sans-serif'],
                        mono: ['"JetBrains Mono"', 'monospace'],
                    },
                    colors: {
                        ios: {
                            bg: '#000000',
                            card: '#1c1c1e',
                            input: '#2c2c2e',
                            border: 'rgba(255, 255, 255, 0.12)',
                            blue: '#0A84FF',
                            green: '#30D158',
                            orange: '#FF9F0A',
                            red: '#FF453A',
                            purple: '#BF5AF2',
                            teal: '#64D2FF',
                            yellow: '#FFD60A'
                        }
                    },
                    animation: {
                        'float': 'float 6s ease-in-out infinite',
                        'scan': 'scan 2s linear infinite', 
                        'scan-fast': 'scan 1.5s linear infinite',
                        'toast-in': 'toastIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275)', 
                        'pulse-glow': 'pulseGlow 2s infinite',
                        'fade-out': 'fadeOut 0.5s ease-out forwards', 
                        'enter-up': 'enterUp 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards',
                        'ios-press': 'iosPress 0.2s ease-out',
                        'highlight-pulse': 'highlightPulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'blob': 'blob 10s infinite',
                        'typewriter': 'typewriter 0.5s steps(40, end)',
                        'shimmer-fast': 'shimmer 1.5s linear infinite',
                        'pop-in': 'popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards',
                        'text-cycle': 'textCycle 2s ease-in-out forwards', 
                        'spin-slow': 'spin 3s linear infinite',
                    },
                    keyframes: {
                        enterUp: { '0%': { opacity: '0', transform: 'translateY(30px) scale(0.95)' }, '100%': { opacity: '1', transform: 'translateY(0) scale(1)' } },
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-10px)' } },
                        scan: { '0%': { top: '0%', opacity: '0' }, '10%': { opacity: '1', boxShadow: '0 0 15px #0A84FF' }, '90%': { opacity: '1' }, '100%': { top: '100%', opacity: '0' } },
                        toastIn: { '0%': { transform: 'translateX(20px)', opacity: '0' }, '100%': { transform: 'translateX(0)', opacity: '1' } },
                        pulseGlow: { '0%, 100%': { opacity: '1', boxShadow: '0 0 10px #0A84FF' }, '50%': { opacity: '0.8', boxShadow: '0 0 20px #0A84FF' } },
                        fadeOut: { '0%': { opacity: '1', visibility: 'visible' }, '100%': { opacity: '0', visibility: 'hidden' } },
                        iosPress: { '0%': { transform: 'scale(1)' }, '50%': { transform: 'scale(0.97)' }, '100%': { transform: 'scale(1)' } },
                        highlightPulse: { '0%, 100%': { borderColor: 'rgba(255, 214, 10, 0.5)', backgroundColor: 'rgba(255, 214, 10, 0.1)' }, '50%': { borderColor: 'rgba(255, 214, 10, 1)', backgroundColor: 'rgba(255, 214, 10, 0.2)' } },
                        blob: { '0%': { transform: 'translate(0px, 0px) scale(1)' }, '33%': { transform: 'translate(30px, -50px) scale(1.1)' }, '66%': { transform: 'translate(-20px, 20px) scale(0.9)' }, '100%': { transform: 'translate(0px, 0px) scale(1)' } },
                        shimmer: { '0%': { backgroundPosition: '200% center' }, '100%': { backgroundPosition: '-200% center' } },
                        popIn: { '0%': { opacity: '0', transform: 'scale(0.5)' }, '100%': { opacity: '1', transform: 'scale(1)' } },
                        textCycle: { 
                            '0%': { opacity: '0', transform: 'translateY(10px)' }, 
                            '10%': { opacity: '1', transform: 'translateY(0)' }, 
                            '80%': { opacity: '1', transform: 'translateY(0)' }, 
                            '100%': { opacity: '0', transform: 'translateY(-10px)' } 
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* iOS Base Reset */
        :root { --ease-ios: cubic-bezier(0.2, 0.8, 0.2, 1); }
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; -webkit-font-smoothing: antialiased; }
        body { 
            background-color: #000000;
            color: #f2f2f7;
            -webkit-user-select: none; user-select: none;
            position: fixed; inset: 0; width: 100vw; height: 100dvh;
        }
        input, textarea { -webkit-user-select: text; user-select: text; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.4); }

        /* Glass Components */
        .glass-panel { 
            background: rgba(28, 28, 30, 0.75); 
            backdrop-filter: blur(25px); 
            -webkit-backdrop-filter: blur(25px);
            border-right: 1px solid rgba(255, 255, 255, 0.12);
        }
        
        .pro-input { 
            background: #1c1c1e; 
            border: 1px solid rgba(255, 255, 255, 0.1); 
            color: #fff; 
            transition: all 0.2s; 
            font-size: 11px; 
            border-radius: 8px; 
            padding-left: 12px;
        }
        .pro-input:focus { background: #2c2c2e; border-color: #0A84FF; outline: none; }
        
        select { 
            -webkit-appearance: none; 
            background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
        }
        select option { background-color: #1c1c1e; color: #fff; padding: 12px; } 
        select optgroup { background-color: #000; color: #8E8E93; font-weight: 700; }

        /* Module Accordion */
        .module-group { 
            background: rgba(28, 28, 30, 0.5); 
            border-radius: 12px; 
            margin-bottom: 12px; 
            overflow: hidden; 
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        .module-header { 
            background: rgba(255, 255, 255, 0.03); 
            padding: 12px 16px; 
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .module-header:active { background: rgba(255, 255, 255, 0.08); }
        .module-content { display: grid; grid-template-rows: 0fr; transition: grid-template-rows 0.3s var(--ease-ios), opacity 0.3s ease; opacity: 0; }
        .module-content.open { grid-template-rows: 1fr; opacity: 1; }
        .module-content.open .module-inner { padding: 12px 16px; border-top: 1px solid rgba(255,255,255,0.05); }
        .module-inner { min-height: 0; overflow: hidden; }

        /* iOS Switch / Checkbox */
        .chk-pro { appearance: none; width: 18px; height: 18px; border-radius: 5px; border: 1.5px solid rgba(142, 142, 147, 0.5); background: transparent; display: grid; place-content: center; cursor: pointer; transition: all 0.2s; }
        .chk-pro::before { content: ""; width: 10px; height: 10px; transform: scale(0); background: #fff; border-radius: 2px; transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .chk-pro:checked::before { transform: scale(1); }
        .chk-pro:checked { border-color: #0A84FF; background: #0A84FF; }
        
        .chk-gold:checked { border-color: #FFD60A; background: #FFD60A; }
        .chk-red:checked { border-color: #FF453A; background: #FF453A; }
        .chk-real:checked { border-color: #FF9F0A; background: #FF9F0A; }

        /* Sliders */
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 18px; width: 18px; border-radius: 50%; background: #ffffff; cursor: pointer; margin-top: -7px; box-shadow: 0 2px 6px rgba(0,0,0,0.3); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: rgba(255,255,255,0.2); border-radius: 2px; }
        .slider-red::-webkit-slider-thumb { background: #FF453A; }
        .slider-flux::-webkit-slider-thumb { background: #BF5AF2; }

        /* Animations */
        .modal-fade-in { animation: modalFadeIn 0.3s var(--ease-ios); }
        @keyframes modalFadeIn { from { opacity: 0; transform: scale(0.92); filter: blur(10px); } to { opacity: 1; transform: scale(1); filter: blur(0); } }
        
        .shimmer-text { background: linear-gradient(90deg, #8E8E93 0%, #fff 50%, #8E8E93 100%); background-size: 200% auto; -webkit-background-clip: text; -webkit-text-fill-color: transparent; animation: shine 3s linear infinite; }
        @keyframes shine { to { background-position: 200% center; } }
        
        @media (max-width: 1024px) {
            #sidebar { width: 100% !important; max-width: 100% !important; border-right: none; background: #000; }
        }
        
        /* Image Comparison Frame */
        .mobile-image-frame {
            border: 1px solid rgba(255, 255, 255, 0.15); 
            box-shadow: 0 20px 50px -12px rgba(0, 0, 0, 0.7);
            background: #000;
            border-radius: 16px;
            overflow: hidden;
            width: auto; height: auto;
            max-width: 95vw; max-height: 70vh;
            display: flex; align-items: center; justify-content: center;
            margin: 0 auto; position: relative;
        }
        #img-original, #img-modified { display: block; max-width: 100%; max-height: 70vh; object-fit: contain; width: auto; height: auto; }
        #img-modified-wrapper { position: absolute; top: 0; left: 0; height: 100%; width: 50%; overflow: hidden; border-right: 1px solid rgba(255, 255, 255, 0.8); }

        .comp-label { 
            position: absolute; bottom: 16px; padding: 6px 12px; 
            background: rgba(28, 28, 30, 0.7); color: white; 
            font-size: 11px; font-weight: 600; letter-spacing: 0.5px;
            border-radius: 20px; pointer-events: none; z-index: 25; 
            backdrop-filter: blur(10px); 
            border: 1px solid rgba(255,255,255,0.1); 
        }
        .comp-label.before { right: 16px; } 
        .comp-label.after { left: 16px; } 

        /* Button Styles ISO */
        .btn-iso-primary {
            background: #0A84FF;
            color: white;
            border-radius: 12px;
            font-weight: 600;
            transition: transform 0.1s;
        }
        .btn-iso-primary:active { transform: scale(0.97); opacity: 0.9; }
        
        .btn-iso-glass {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.1);
            color: white;
            border-radius: 12px;
        }
        .btn-iso-glass:active { background: rgba(255,255,255,0.15); transform: scale(0.97); }

        /* Tag in HUD */
        .scan-tag { 
            display: inline-flex; align-items: center; 
            padding: 4px 10px; margin: 2px;
            border-radius: 6px; 
            background: rgba(255,255,255,0.05); 
            border: 1px solid rgba(255,255,255,0.1);
            color: #fff; font-size: 9px; font-weight: 600; font-family: monospace;
            opacity: 0; animation: pop-in 0.3s forwards;
        }
        .scan-tag.highlight { border-color: #0A84FF; color: #0A84FF; background: rgba(10, 132, 255, 0.1); }

        /* Sequential Log Text */
        .sequential-log-text {
            display: block;
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            font-weight: 700;
            color: #0A84FF;
            text-shadow: 0 0 10px rgba(10, 132, 255, 0.6);
            white-space: nowrap;
            background: rgba(0,0,0,0.5);
            padding: 4px 8px;
            border-radius: 4px;
            border-left: 2px solid #0A84FF;
            animation: text-cycle 1.8s ease-in-out forwards;
        }
        .sequential-log-text.highlight { 
            color: #FFD60A; 
            border-color: #FFD60A;
            text-shadow: 0 0 10px rgba(255, 214, 10, 0.6); 
        }
        .sequential-log-text::before { content: ">> "; opacity: 0.7; }
    </style>
</head>

<body class="font-sans flex overflow-hidden select-none relative" oncontextmenu="return false;">
    
    <!-- BACKGROUND -->
    <div class="fixed inset-0 bg-black z-0">
        <div class="absolute top-[-20%] left-[-20%] w-[80vw] h-[80vw] bg-blue-900/10 rounded-full blur-[120px]"></div>
        <div class="absolute bottom-[-20%] right-[-20%] w-[80vw] h-[80vw] bg-purple-900/10 rounded-full blur-[120px]"></div>
    </div>

    <!-- SECURITY GATE -->
    <div id="security-gate" class="fixed inset-0 z-[9999] flex flex-col items-center justify-center bg-black transition-opacity duration-500">
        <div class="absolute inset-0 z-0">
            <div class="absolute top-[-10%] left-[-10%] w-[70vw] h-[70vw] bg-blue-600/20 rounded-full blur-[100px] animate-blob"></div>
            <div class="absolute bottom-[-10%] right-[-10%] w-[70vw] h-[70vw] bg-purple-600/20 rounded-full blur-[100px] animate-blob animation-delay-2000"></div>
            <div class="absolute inset-0 bg-black/40 backdrop-blur-3xl"></div>
        </div>

        <div class="relative z-10 w-full max-w-sm px-6 flex flex-col items-center justify-center h-full sm:h-auto sm:py-12">
            <div class="mb-10 flex flex-col items-center animate-enter-up">
                <div class="w-20 h-20 rounded-[28px] bg-gradient-to-br from-[#1c1c1e] to-[#2c2c2e] border border-white/10 flex items-center justify-center shadow-2xl shadow-purple-900/20 mb-6 relative group">
                    <div class="absolute inset-0 rounded-[28px] bg-white/5 blur-lg opacity-50"></div>
                    <svg class="w-8 h-8 text-white/90 drop-shadow-lg" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l-1.586-1.586a2 2 0 00-2.828 0L6 18H4a2 2 0 01-2-2V6a2 2 0 01-2-2V6a2 2 0 012-2h16a2 2 0 012 2v8a2 2 0 01-2 2h-2m-4-4l-3 3m0 0l-3-3m3 3V4"></path></svg>
                </div>
                <h1 class="text-3xl font-bold text-white tracking-tight text-center">PH·ª§C H·ªíI ·∫¢NH</h1>
                <p class="text-sm text-gray-400 mt-2 font-medium tracking-wide text-center">AI Restoration Professional (V36.20)</p>
            </div>

            <div class="w-full bg-[#1c1c1e]/80 backdrop-blur-xl border border-white/10 rounded-[24px] p-1.5 shadow-2xl mb-6 animate-enter-up" style="animation-delay: 0.1s;">
                <div class="bg-black/50 rounded-[20px] p-5 flex items-center justify-between border border-white/5">
                    <div class="flex flex-col">
                        <span class="text-[10px] text-gray-500 font-bold uppercase tracking-wider mb-1">THI·∫æT B·ªä (DEVICE ID)</span>
                        <div class="flex items-center gap-2">
                            <span id="gate-ip-display" class="font-mono text-sm font-bold text-white tracking-wider shimmer-text">Connecting...</span>
                            <div id="gate-loading-spinner" class="w-3 h-3 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>
                        </div>
                    </div>
                </div>
            </div>

            <button id="gate-submit" class="w-full py-4 bg-white text-black rounded-[20px] text-[15px] font-bold tracking-wide transition-all active:scale-95 shadow-lg shadow-white/10 disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-100 mb-8 animate-enter-up flex items-center justify-center gap-2" style="animation-delay: 0.2s;" disabled>
                <span>V√ÄO PH√íNG L√ÄM VI·ªÜC</span>
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
            </button>
            <p id="gate-status" class="text-[11px] text-gray-500 font-medium animate-pulse">ƒêang x√°c th·ª±c b·∫£o m·∫≠t...</p>
        </div>
    </div>
    
    <!-- SYSTEM NOTIFICATION AREA -->
    <div id="toast-container" class="fixed top-6 right-6 z-[100] flex flex-col gap-2 pointer-events-none w-auto max-w-sm items-end"></div>
    
    <!-- MODERN HUD OVERLAY -->
    <div id="scan-window-overlay" class="fixed inset-0 z-[100] flex flex-col items-center justify-center bg-black/60 backdrop-blur-md hidden transition-all duration-300">
        <div class="relative p-1 rounded-2xl bg-gradient-to-b from-white/10 to-white/5 shadow-2xl animate-enter-up">
            <div class="bg-[#0f0f11]/90 backdrop-blur-xl rounded-xl p-6 flex flex-col items-center min-w-[260px] border border-white/5 relative overflow-hidden">
                <div class="absolute top-[-50%] left-[-50%] w-[200%] h-[200%] bg-gradient-to-br from-blue-500/10 via-transparent to-purple-500/10 animate-spin-slow pointer-events-none"></div>
                
                <div class="relative mb-4">
                    <div class="w-14 h-14 rounded-full border-2 border-white/10"></div>
                    <div class="absolute top-0 left-0 w-14 h-14 rounded-full border-2 border-t-[#0A84FF] border-r-[#0A84FF] border-b-transparent border-l-transparent animate-spin"></div>
                    <div class="absolute inset-0 flex items-center justify-center">
                        <svg class="w-6 h-6 text-white drop-shadow-[0_0_10px_rgba(255,255,255,0.5)]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                    </div>
                </div>

                <h3 id="scan-title" class="text-xs font-bold text-white tracking-[0.2em] mb-3 uppercase relative z-10">AI PROCESSING</h3>
                <div id="scan-tags-container" class="flex flex-wrap justify-center gap-1.5 w-full relative z-10 max-w-[220px]"></div>
            </div>
        </div>
    </div>

    <div class="flex w-full h-full relative z-10" id="fullscreen-target">
        
        <!-- SIDEBAR -->
        <aside id="sidebar" class="fixed inset-y-0 left-0 z-[60] w-full sm:w-[380px] flex-shrink-0 glass-panel flex flex-col transition-transform duration-300 ease-out lg:static lg:translate-x-0 -translate-x-full shadow-2xl lg:shadow-none bg-[#000]/90 lg:bg-transparent">
            
            <!-- Sidebar Header -->
            <div class="h-14 px-5 flex items-center justify-between border-b border-white/10 bg-white/[0.02]">
                <div class="flex flex-col justify-center">
                    <h1 class="text-[14px] font-bold tracking-tight text-white uppercase">PH·ª§C H·ªíI ·∫¢NH</h1>
                    <div class="flex items-center gap-2 mt-0.5">
                        <span id="sidebar-ip-display" class="text-[9px] font-mono text-[#0A84FF] font-bold tracking-tight">IP: LOADING...</span>
                        <span class="text-[9px] text-gray-600">|</span>
                        <span id="sidebar-id-display" class="text-[9px] font-mono text-[#FFD60A] font-bold tracking-tight">ID: ...</span>
                    </div>
                </div>
                
                <div class="flex items-center gap-3">
                    <div class="flex flex-col items-end mr-1 px-3 py-1 rounded-lg bg-white/5 border border-white/5 cursor-pointer hover:bg-white/10 transition" id="credit-display">
                        <span class="text-[9px] text-gray-400 font-semibold uppercase">CREDITS</span>
                        <span class="text-[13px] font-mono font-bold text-[#FFD60A]" id="credit-count">---</span>
                    </div>
                    <button id="close-sidebar-mobile" class="lg:hidden p-2 rounded-full bg-[#2c2c2e] text-white">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto p-4 scroll-smooth space-y-4 pb-24 lg:pb-4 custom-scrollbar">
                <!-- 1. MAIN UPLOAD AREA -->
                <div class="relative group">
                    <input type="file" id="image-upload" accept="image/*" class="hidden">
                    <label id="drop-zone" for="image-upload" class="flex flex-col items-center justify-center w-full h-32 border border-dashed border-gray-600 rounded-2xl cursor-pointer bg-[#1c1c1e] hover:bg-[#2c2c2e] hover:border-[#0A84FF] transition-all duration-200 group">
                        <div id="upload-placeholder" class="flex flex-col items-center pointer-events-none group-hover:scale-105 transition-transform">
                            <div class="w-10 h-10 rounded-full bg-[#0A84FF]/20 flex items-center justify-center mb-3">
                                <svg class="w-5 h-5 text-[#0A84FF]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l-1.586-1.586a2 2 0 00-2.828 0L6 18H4a2 2 0 01-2-2V6a2 2 0 01-2-2V6a2 2 0 012-2h16a2 2 0 012 2v8a2 2 0 01-2 2h-2m-4-4l-3 3m0 0l-3-3m3 3V4"></path></svg>
                            </div>
                            <span class="text-xs font-medium text-gray-400 uppercase tracking-widest">T·∫£i ·∫£nh g·ªëc (K√©o th·∫£/Click)</span>
                        </div>
                    </label>
                </div>

                <!-- 2. AUTO-PILOT BUTTON -->
                <button id="btn-auto-pilot" class="w-full py-3.5 bg-gradient-to-r from-[#0A84FF] to-[#0062cc] text-white rounded-xl flex items-center justify-center gap-2 transition-transform active:scale-[0.98] shadow-lg shadow-blue-900/20 group">
                    <svg class="w-4 h-4 animate-pulse group-hover:rotate-180 transition-transform duration-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                    <span class="text-xs font-bold tracking-wide">AUTO SCAN V36.20 (VETERAN DETECT)</span>
                </button>

                <!-- MODULE M·ªöI: PH·ª§C H·ªíI CHI·∫æN S·ª∏ (V36.20 UPGRADE) -->
                <div class="module-group" id="module-veteran">
                    <button id="toggle-veteran" class="module-header w-full">
                        <div class="flex items-center gap-2">
                            <span class="text-[12px] font-bold text-[#FFD60A] tracking-wide uppercase">üáªüá≥ PH·ª§C H·ªíI CHI·∫æN S·ª∏ (CHUY√äN S√ÇU)</span>
                        </div>
                        <svg class="w-4 h-4 text-gray-500 transition-transform" id="icon-veteran" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="content-veteran" class="module-content open">
                        <div class="module-inner space-y-3">
                             <!-- PRESET SELECTOR (CHUY√äN NGHI·ªÜP) -->
                             <div class="space-y-1">
                                <label class="text-[10px] uppercase text-gray-500 font-bold ml-1">CH·ªåN CH·∫æ ƒê·ªò (PRESET)</label>
                                <select id="veteran-preset" class="pro-input w-full py-2 cursor-pointer font-bold text-[#FFD60A]">
                                    <option value="none">-- Kh√¥ng √°p d·ª•ng / M·∫∑c ƒë·ªãnh --</option>
                                    <option value="preset_1">1. ·∫¢NH TH·ªú LI·ªÜT S·ª∏ (TRANG NGHI√äM)</option>
                                    <option value="preset_2">2. CHI·∫æN S·ª∏ KH√ÅNG CHI·∫æN (ƒêEN TR·∫ÆNG)</option>
                                    <option value="preset_3">3. M√ÄU H√ìA CHU·∫®N QU√ÇN PH·ª§C VN</option>
                                    <option value="preset_4">4. QU√ÇN H√ÄM & SAO V√ÄNG R√ï N√âT</option>
                                    <option value="preset_5">5. C√îNG AN NH√ÇN D√ÇN (·∫¢NH H·ªí S∆†)</option>
                                </select>
                             </div>
                             
                             <!-- PRESET DESCRIPTION DISPLAY -->
                             <div id="veteran-preset-desc" class="text-[10px] text-gray-400 italic px-2 py-1 border-l-2 border-white/10">
                                 Ch∆∞a ch·ªçn ch·∫ø ƒë·ªô chuy√™n s√¢u.
                             </div>

                             <!-- CHI TI·∫æT T·ª∞ ƒê·ªòNG (GRANULAR DETAILS) -->
                             <div class="grid grid-cols-2 gap-2 mt-2 pt-2 border-t border-white/5" id="veteran-details-container">
                                <label class="flex items-center gap-2 p-2 rounded bg-white/5 border border-white/5 cursor-pointer hover:bg-white/10 transition">
                                    <input type="checkbox" id="det-hat" class="chk-pro chk-gold save-input">
                                    <span class="text-[10px] text-gray-300 select-none">M≈©/N√≥n</span>
                                </label>
                                <label class="flex items-center gap-2 p-2 rounded bg-white/5 border border-white/5 cursor-pointer hover:bg-white/10 transition">
                                    <input type="checkbox" id="det-rank" class="chk-pro chk-red save-input">
                                    <span class="text-[10px] text-gray-300 select-none">Qu√¢n H√†m</span>
                                </label>
                                <label class="flex items-center gap-2 p-2 rounded bg-white/5 border border-white/5 cursor-pointer hover:bg-white/10 transition">
                                    <input type="checkbox" id="det-star" class="chk-pro chk-gold save-input">
                                    <span class="text-[10px] text-yellow-500 font-bold select-none">Sao V√†ng</span>
                                </label>
                                <label class="flex items-center gap-2 p-2 rounded bg-white/5 border border-white/5 cursor-pointer hover:bg-white/10 transition">
                                    <input type="checkbox" id="det-medal" class="chk-pro chk-blue save-input">
                                    <span class="text-[10px] text-blue-400 select-none">Hu√¢n Ch∆∞∆°ng</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- FLUX KONTEXT (LZP) -->
                <div class="module-group" id="kontext-module-container">
                    <div class="p-4 border-b border-white/5 bg-[#2c2c2e]/50 backdrop-blur-md">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex flex-col">
                                <span class="text-[12px] font-bold text-[#BF5AF2] tracking-wide">üöÄ FLUX / QWEN / REALVIS ENGINE</span>
                                <span class="text-[10px] text-gray-400">Core: Qwen-VL, Kontext, SUPIR, InvSR</span>
                            </div>
                             <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="mode-flux" class="sr-only peer" checked>
                                <div class="w-10 h-6 bg-gray-600 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-[#BF5AF2]"></div>
                            </label>
                        </div>
                        <div id="workflow-container">
                            <label class="block text-[10px] font-bold text-gray-400 mb-1 uppercase">CH·ªåN QUY TR√åNH (WORKFLOW PRESETS)</label>
                            <select id="kontext-workflow" class="pro-input w-full py-2.5 cursor-pointer bg-black/20 text-white border-none appearance-none font-medium text-[11px]">
                                <option value="qwen_edit_pro" class="text-cyan-300 font-bold" selected>‚ö° Qwen Edit Pro (Qwen-VL + Instruction) - KHUY√äN D√ôNG</option>
                                <option value="replica_pro" class="text-yellow-400 font-bold">üß¨ SI√äU TH·ª∞C (REPLICA PRO) - KH√ìA C·∫§U TR√öC S√ÇU</option>
                                <option value="invsr_deblur" class="text-green-400 font-bold">üî™ InvSR Deblur (Chuy√™n tr·ªã ·∫¢nh M·ªù/Rung)</option>
                                <option value="ancient_restore" class="text-purple-400 font-bold">üèØ Ph·ª•c ch·∫ø Tranh/T∆∞·ª£ng C·ªï (ReActor + ControlNet)</option>
                                <option value="wedding_kontext_v2" class="text-pink-400 font-bold">üë∞ Wedding Kontext V2 (Full JSON)</option>
                                <option value="default">‚ú® M·∫∑c ƒë·ªãnh (Kontext Base + OldPhoto-2)</option>
                                <option value="realvis_v5" class="text-orange-400 font-bold">ü¶Å RealVisXL V5 (Ph·ª•c h·ªìi c·∫•u tr√∫c s√¢u)</option>
                                <option value="qwen_restore_full" class="text-blue-400 font-bold">‚ö° Qwen V2.5 Full Restore (Prompt G·ªëc JSON)</option>
                                <option value="wedding_pro">üíç Wedding Pro + Upscale (·∫¢nh C∆∞·ªõi - C∆° b·∫£n)</option>
                                <option value="outdoor_mode">üèûÔ∏è Ph·ª•c h·ªìi Ngo·∫°i C·∫£nh (IC-Light + PowerPaint)</option>
                                <option value="product_mode">üõçÔ∏è ·∫¢nh S·∫£n Ph·∫©m / Th∆∞∆°ng M·∫°i (Ecommerce)</option>
                                <option value="white_bg">‚¨ú T√°ch N·ªÅn Tr·∫Øng (BiRefNet + RMBG-2.0)</option>
                            </select>
                            <div class="text-[9px] text-gray-500 mt-1 italic">S·ª≠ d·ª•ng Qwen-Image-Edit & Kontext.safetensors</div>
                        </div>
                    </div>
                </div>

                <!-- REPLICA MODE -->
                <div class="module-group">
                    <div class="p-3 flex items-center justify-between">
                         <div class="flex flex-col">
                            <span class="text-[12px] font-bold text-[#FFD60A] tracking-wide">üíé CH·∫æ ƒê·ªò SAO Y B·∫¢N CH√çNH (ALIGN LOCK)</span>
                            <span class="text-[10px] text-gray-500">KH√ìA G√ìC M·∫∂T - CH·ªêNG B·ªä L·∫¨T H√åNH</span>
                        </div>
                         <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="mode-replica" class="sr-only peer" checked>
                            <div class="w-9 h-5 bg-gray-600 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-[#FFD60A]"></div>
                        </label>
                    </div>
                </div>

                <!-- MODULE: TEXTURE & LIGHTING -->
                <div class="module-group" id="module-cinematic">
                    <button id="toggle-cinematic" class="module-header w-full">
                        <div class="flex items-center gap-2">
                            <span class="text-[12px] font-bold text-[#FF453A] tracking-wide uppercase">üéûÔ∏è LIGHTING & M√ÄU PHIM (IC-LIGHT)</span>
                        </div>
                        <svg class="w-4 h-4 text-gray-500 transition-transform" id="icon-cinematic" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="content-cinematic" class="module-content open">
                        <div class="module-inner space-y-4">
                             <div>
                                <div class="flex justify-between text-[11px] text-gray-400 font-bold mb-2">
                                    <span>ƒê·ªò NHI·ªÑU H·∫†T (FLUX GRAIN)</span>
                                    <span id="grain-val" class="text-white">3%</span>
                                </div>
                                <input type="range" id="grain-slider" min="0" max="100" value="3" class="w-full slider-red">
                             </div>
                             <select id="color-grading" class="pro-input w-full py-2 save-input">
                                 <option value="">-- M√†u g·ªëc (Standard) --</option>
                                 <optgroup label="üé® Colorization (T√¥ m√†u AI)">
                                    <option value="colorize_bw_old_photo">üåà T√¥ m√†u ·∫£nh ƒëen tr·∫Øng (Old Photo Colorize)</option>
                                    <option value="restore_faded_color">üçÇ Ph·ª•c h·ªìi m√†u phai (Faded Repair)</option>
                                 </optgroup>
                                 <optgroup label="‚ú® TAO ANH SANG Presets (JSON Integrated)">
                                     <option value="golden_hour_blinds">üåÖ Golden Hour + Blinds (N·∫Øng xuy√™n r√®m)</option>
                                     <option value="moonlight_window">üåô Moonlight Window (TrƒÉng xanh huy·ªÅn b√≠)</option>
                                     <option value="streetlight_cozy">üí° Streetlight Cozy (ƒê√®n ƒë∆∞·ªùng ·∫•m √°p)</option>
                                     <option value="neon_cyberpunk">üåÉ Neon Vibrant (H·ªìng/Xanh T∆∞∆°ng ph·∫£n)</option>
                                     <option value="soft_diffused">‚òÅÔ∏è Soft Diffused (√Ånh s√°ng m·ªÅm Studio)</option>
                                     <option value="dappled_shade">üå≥ Dappled Shade (B√≥ng n·∫Øng d∆∞·ªõi c√¢y)</option>
                                 </optgroup>
                                 <optgroup label="üéûÔ∏è M√†u Phim C·ªï ƒêi·ªÉn">
                                     <option value="kodak portra 400 style, natural skin tone, fine grain" selected>Kodak Portra (Chu·∫©n JSON)</option>
                                     <option value="fujifilm pro 400h style, cool tone, soft green tint">Fujifilm (Trong tr·∫ªo)</option>
                                     <option value="sepia tone, antique photo style">Sepia (M√†u x∆∞a c≈©)</option>
                                 </optgroup>
                             </select>
                        </div>
                    </div>
                </div>

                <!-- MODULE: EXPOSURE & RELIGHTING -->
                <div class="module-group" id="module-exposure">
                    <button id="toggle-exposure" class="module-header w-full">
                         <div class="flex items-center gap-2">
                            <span class="text-[12px] font-bold text-[#64D2FF] tracking-wide uppercase">‚òÄÔ∏è X·ª¨ L√ù CH√ÅY S√ÅNG (QWEN EDIT)</span>
                        </div>
                        <svg class="w-4 h-4 text-gray-500 transition-transform" id="icon-exposure" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="content-exposure" class="module-content">
                        <div class="module-inner space-y-3">
                             <div class="flex items-center justify-between p-2 rounded bg-[#0A84FF]/10 border border-[#0A84FF]/20">
                                <div class="flex flex-col">
                                    <span class="text-[12px] font-bold text-[#64D2FF]">K√çCH HO·∫†T QWEN EDIT (V2511)</span>
                                    <span class="text-[9px] text-[#64D2FF]/70">Core: Qwen-Image-Edit + LoRA ÁßªÈô§ÂÖâÂΩ±</span>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="check-qwen-exposure" class="sr-only peer save-input">
                                    <div class="w-9 h-5 bg-gray-600 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-[#64D2FF]"></div>
                                </label>
                            </div>
                            <div class="space-y-2 pl-2 border-l-2 border-white/10 ml-1">
                                <div class="flex items-center gap-2">
                                    <input id="check-remove-shadow" type="checkbox" class="chk-pro save-input" checked>
                                    <label for="check-remove-shadow" class="text-[11px] text-gray-400">LoRA: ÁßªÈô§ÂÖâÂΩ± (X√≥a b√≥ng g·∫Øt)</label>
                                </div>
                                 <div class="flex items-center gap-2">
                                    <input id="check-soft-light" type="checkbox" class="chk-pro save-input" checked>
                                    <label for="check-soft-light" class="text-[11px] text-gray-400">Prompt: Soft Light (√Ånh s√°ng m·ªÅm)</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- REFERENCE FACE UPLOAD -->
                <div class="module-group">
                     <div class="p-3">
                        <div class="flex gap-2 items-center mb-2">
                             <div id="ref-img-preview" class="w-8 h-8 rounded-lg bg-black/40 border border-white/10 flex-shrink-0 bg-cover bg-center" style="display:none;"></div>
                             <input type="file" id="ref-upload" accept="image/*" class="hidden">
                             <label for="ref-upload" class="flex-1 h-9 border border-dashed border-gray-600 rounded-lg flex items-center justify-center cursor-pointer hover:bg-white/5 transition-colors">
                                 <span id="ref-text" class="text-[11px] text-gray-400 font-bold">+ ·∫¢nh tham chi·∫øu (TƒÉng gi·ªëng)</span>
                             </label>
                             <button id="clear-ref" class="w-9 h-9 rounded-lg bg-white/5 hover:bg-white/10 text-gray-400 flex items-center justify-center" style="display:none;">‚úï</button>
                        </div>
                        <div class="flex items-center justify-between mt-2">
                            <div class="flex flex-col">
                                <span class="text-[11px] font-bold text-[#BF5AF2]">K√≠ch ho·∫°t Face Swap (ReActor)</span>
                                <span class="text-[9px] text-[#BF5AF2]/70">Thay th·∫ø khu√¥n m·∫∑t thay v√¨ tr·ªôn (InsightFace)</span>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="check-reactor" class="sr-only peer save-input">
                                <div class="w-8 h-4 bg-gray-700 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-3 after:w-3 after:transition-all peer-checked:bg-[#BF5AF2]"></div>
                            </label>
                        </div>
                     </div>
                </div>

                <!-- MODULE 1: X·ª¨ L√ù H√åNH ·∫¢NH -->
                <div class="module-group" id="module-processing">
                    <button id="toggle-processing" class="module-header w-full">
                        <div class="flex items-center gap-2">
                            <span class="text-[12px] font-bold text-gray-200 tracking-wide uppercase">üõ†Ô∏è X·ª¨ L√ù H√åNH ·∫¢NH (LZP DETAIL)</span>
                        </div>
                        <svg class="w-4 h-4 text-gray-500 transition-transform" id="icon-processing" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="content-processing" class="module-content open">
                        <div class="module-inner space-y-4">
                             <div class="p-3 bg-[#BF5AF2]/10 rounded-lg border border-[#BF5AF2]/20">
                                <div class="flex justify-between text-[11px] text-[#BF5AF2] font-bold mb-2">
                                    <span>TU√ÇN TH·ª¶ G·ªêC</span>
                                    <span>CHI TI·∫æT FLUX</span>
                                </div>
                                <input type="range" id="creativity-slider" min="0" max="100" value="45" class="w-full slider-flux">
                                <div class="text-[10px] text-center text-[#BF5AF2] mt-1 font-mono" id="creativity-val">M·ª©c 45% (LZP Balanced)</div>
                             </div>

                             <div class="grid grid-cols-2 gap-2">
                                 <div class="flex items-center gap-2 p-2 rounded bg-white/5 border border-white/5"><input id="check-dehaze" type="checkbox" class="chk-pro save-input"><label for="check-dehaze" class="text-[11px] text-gray-300">Kh·ª≠ s∆∞∆°ng m√π</label></div>
                                 <div class="flex items-center gap-2 p-2 rounded bg-white/5 border border-white/5"><input id="check-contrast-fix" type="checkbox" class="chk-pro save-input"><label for="check-contrast-fix" class="text-[11px] font-bold text-[#BF5AF2]">Kontext Contrast</label></div>
                                 <div class="flex items-center gap-2 p-2 rounded bg-white/5 border border-white/5"><input id="check-uniform-skin" type="checkbox" class="chk-pro save-input" checked><label for="check-uniform-skin" class="text-[11px] text-gray-300">ƒê·ªÅu m√†u da</label></div>
                                 <div class="flex items-center gap-2 p-2 rounded bg-white/5 border border-white/5"><input id="check-vibrant" type="checkbox" class="chk-pro save-input" checked><label for="check-vibrant" class="text-[11px] font-bold text-[#BF5AF2]">LZP COLOR</label></div>
                             </div>
                             
                             <div class="space-y-1">
                                <label class="text-[10px] uppercase text-gray-500 font-bold ml-1">Ch·∫ø ƒë·ªô Ph√≥ng to (Upscale - 4K.json Integrated)</label>
                                <select id="upscale-mode" class="pro-input w-full py-2 cursor-pointer save-input">
                                    <option value="supir_tiled" selected>üåü Tiled 4K (SUPIR + Ultimate SD) - N√©t nh·∫•t</option>
                                    <option value="invsr_sharp" class="text-green-400 font-bold">üî™ InvSR Deblur (Ch·ªëng Rung/M·ªù - CHAY NET OK)</option>
                                    <option value="pixel_perfect" class="text-yellow-400">üíé Pixel Perfect (Gi·ªØ nguy√™n h·∫°t da)</option>
                                    <option value="ultrasharp">‚ö° 4x-UltraSharp (T·ªëc ƒë·ªô nhanh)</option>
                                    <option value="none">üö´ Kh√¥ng Upscale (Nhanh nh·∫•t)</option>
                                </select>
                             </div>

                             <div class="space-y-2 pt-2 border-t border-white/5">
                                 <div class="flex items-center justify-between">
                                    <span class="text-[12px] text-gray-300">Chi ti·∫øt m·∫∑t (Face Detail)</span>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="check-face" data-key="checkFace" class="sr-only peer save-input" checked>
                                        <div class="w-8 h-4 bg-gray-700 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-3 after:w-3 after:transition-all peer-checked:bg-[#0A84FF]"></div>
                                    </label>
                                 </div>
                                 <div class="flex items-center justify-between p-2 rounded bg-[#BF5AF2]/10 border border-[#BF5AF2]/20">
                                    <div class="flex flex-col">
                                        <span class="text-[12px] font-bold text-[#BF5AF2]">L√†m n√©t N·ªÅn & Hoa L√°</span>
                                        <span class="text-[9px] text-[#BF5AF2]/70">Ch·∫ø ƒë·ªô: Botanical Detail (Baby.json)</span>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="check-background" class="sr-only peer save-input" checked>
                                        <div class="w-8 h-4 bg-gray-700 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-3 after:w-3 after:transition-all peer-checked:bg-[#30D158]"></div>
                                    </label>
                                 </div>
                                 <div class="flex items-center justify-between">
                                    <span class="text-[12px] text-gray-300">V·∫Ω l·∫°i t·ª´ng s·ª£i t√≥c (LZP Hair)</span>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="check-hair" data-key="checkHair" class="sr-only peer save-input" checked>
                                        <div class="w-8 h-4 bg-gray-700 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-3 after:w-3 after:transition-all peer-checked:bg-[#0A84FF]"></div>
                                    </label>
                                 </div>
                                 <div class="flex items-center justify-between">
                                    <span class="text-[12px] text-gray-300">TƒÉng chi ti·∫øt v·∫£i/da (Texture Boost)</span>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="check-texture-boost" class="sr-only peer save-input" checked>
                                        <div class="w-8 h-4 bg-gray-700 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-3 after:w-3 after:transition-all peer-checked:bg-[#FFD60A]"></div>
                                    </label>
                                 </div>
                             </div>

                             <!-- V36 ADVANCED BLOCK -->
                             <div class="mt-2 pt-2 border-t border-white/5 space-y-2">
                                <label class="text-[10px] font-bold text-blue-400 uppercase tracking-wider mb-1 block">üöÄ V36.0 ADVANCED (ƒê·ªòC QUY·ªÄN)</label>
                                
                                <div class="flex items-center gap-2 p-2 rounded-lg bg-blue-500/10 border border-blue-500/20">
                                    <input id="check-group-mode" type="checkbox" class="chk-pro save-input">
                                    <label for="check-group-mode" class="flex-1 cursor-pointer select-none">
                                        <span class="block text-[10px] font-bold text-blue-300">GROUP PHOTO PRO (ƒê√°m ƒë√¥ng)</span>
                                        <span class="block text-[9px] text-blue-400/60">Core: GroundingDINO + SAM (Ph√¢n ƒëo·∫°n t·ª´ng ng∆∞·ªùi)</span>
                                    </label>
                                </div>

                                <div class="flex items-center gap-2 p-2 rounded-lg bg-orange-500/10 border border-orange-500/20" id="container-blur-prepass">
                                    <input id="check-blur-prepass" type="checkbox" class="chk-pro chk-real save-input">
                                    <label for="check-blur-prepass" class="flex-1 cursor-pointer select-none">
                                        <span class="block text-[10px] font-bold text-orange-400">KH·ª¨ NHI·ªÑU S√ÇU (BLUR INPUT)</span>
                                        <span class="block text-[9px] text-orange-400/60">L√†m m·ªù ·∫£nh g·ªëc tr∆∞·ªõc x·ª≠ l√Ω (Fix nhi·ªÖu h·∫°t/R·ªó n·∫∑ng)</span>
                                    </label>
                                </div>

                                <div class="flex items-center gap-2 p-2 rounded-lg bg-red-500/10 border border-red-500/20">
                                    <input id="check-extreme-mode" type="checkbox" class="chk-pro chk-red save-input">
                                    <label for="check-extreme-mode" class="flex-1 cursor-pointer select-none">
                                        <span class="block text-[10px] font-bold text-red-400">‚ö° C∆Ø·ª†NG √âP PH·ª§C H·ªíI (EXTREME)</span>
                                        <span class="block text-[9px] text-red-400/60">D√πng cho ·∫£nh qu√° n√°t/m·ªù/m·∫•t chi ti·∫øt</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- MODULE 2: ƒê·ªêI T∆Ø·ª¢NG -->
                <div class="module-group" id="module-subject">
                    <button id="toggle-subject" class="module-header w-full">
                         <div class="flex items-center gap-2">
                            <span class="text-[12px] font-bold text-gray-200 tracking-wide uppercase">üëî ƒê·ªêI T∆Ø·ª¢NG & TRANG PH·ª§C</span>
                        </div>
                        <svg class="w-4 h-4 text-gray-500 transition-transform" id="icon-subject" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="content-subject" class="module-content">
                        <div class="module-inner">
                            <div class="grid grid-cols-3 gap-2 mb-3">
                                 <select id="gender-select" class="pro-input py-2 save-input" data-key="gender"><option value="">Gi·ªõi t√≠nh</option><option value="male">Nam</option><option value="female">N·ªØ</option><option value="male and female">Nam & N·ªØ</option></select>
                                 <input type="number" id="age-input" placeholder="Tu·ªïi" class="pro-input py-2 save-input text-center" data-key="age">
                                 <select id="damage-level" class="pro-input py-2 save-input" data-key="damageLevel"><option value="">ƒê·ªô h·ªèng</option><option value="fix slightly blurry" selected>Nh·∫π</option><option value="fix scratches, mold">V·ª´a</option><option value="fix torn, missing details">N·∫∑ng</option></select>
                            </div>
                            <select id="texture-mode" class="pro-input w-full py-2 save-input mb-3" data-key="textureMode">
                                <option value="">-- ƒê·ªô ch√¢n th·ª±c (Texture) --</option>
                                <option value="true skin, natural pores, film grain, realistic skin:1.2, natural beauty:1.2" selected>üß¨ TRUE SKIN (DA TH·∫¨T - L·ªñ CH√ÇN L√îNG)</option>
                                <option value="Canon EOS 5D Mark IV, 85mm lens, shallow depth of field, perfect lighting, raw photo, realistic skin texture">üì∏ Canon 5D + 85mm Lens (Studio Skin)</option>
                                <option value="smooth skin, ai beauty">M·ªãn m√†ng (AI Beauty)</option>
                            </select>
                            <div class="space-y-3">
                                <div class="flex items-center justify-between p-2 rounded bg-[#0A84FF]/10 border border-[#0A84FF]/20">
                                    <div class="flex flex-col">
                                        <span class="text-[12px] font-bold text-[#0A84FF]">CH·∫æ ƒê·ªò ·∫¢NH TH·∫∫ (ID PHOTO)</span>
                                        <span class="text-[9px] text-[#0A84FF]/70">Ph√¥ng xanh/tr·∫Øng chu·∫©n (chuan.txt)</span>
                                    </div>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="check-id-photo" class="sr-only peer save-input">
                                        <div class="w-8 h-4 bg-gray-700 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-3 after:w-3 after:transition-all peer-checked:bg-[#0A84FF]"></div>
                                    </label>
                                </div>
                                <select id="event-context" class="pro-input w-full py-2 cursor-pointer save-input" data-key="eventContext">
                                    <option value="">-- (AUTO) Ng·ªØ c·∫£nh th√¥ng minh --</option>
                                    <option value="original_enhanced" class="text-violet-400 font-bold">üõ°Ô∏è N·ªÅn G·ªëc + MAX CHI TI·∫æT (LZP BOOST)</option>
                                    <optgroup label="Thay N·ªÅn M√†u">
                                        <option value="blue_bg">üü¶ N·ªÅn Xanh (Blue)</option>
                                        <option value="white_bg">‚¨ú N·ªÅn Tr·∫Øng (White)</option>
                                    </optgroup>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- MODULE 3: KH√ìA N√âT (IDENTITY) -->
                <div class="module-group" id="module-identity">
                    <button id="toggle-identity" class="module-header w-full">
                         <div class="flex items-center gap-2">
                            <span class="text-[12px] font-bold text-gray-200 tracking-wide uppercase">üß¨ KH√ìA N√âT (IDENTITY GUARD)</span>
                        </div>
                        <svg class="w-4 h-4 text-gray-500 transition-transform" id="icon-identity" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="content-identity" class="module-content">
                        <div class="module-inner">
                            <div class="mb-3 border border-white/10 rounded p-2 bg-black/20">
                                <div class="flex justify-between text-[11px] text-gray-400 font-bold mb-2">
                                    <span>M·ª©c ƒë·ªô kh√≥a</span>
                                    <span id="identity-weight-val" class="text-white">300%</span>
                                </div>
                                <input type="range" id="identity-weight-slider" min="100" max="400" step="10" value="300" class="w-full slider-red save-input" data-key="identityWeight">
                            </div>
                            <div class="flex items-center justify-between p-2 mb-2 bg-[#FF453A]/10 border border-[#FF453A]/20 rounded-lg">
                                <div class="flex flex-col">
                                    <span class="text-[12px] font-bold text-[#FF453A]">üö´ CH·ªêNG L·∫¨T H√åNH (SMART ANTI-FLIP)</span>
                                    <span class="text-[9px] text-[#FF453A]/70">T·ª± ƒë·ªông nh·∫≠n di·ªán T·ª∑ l·ªá ·∫£nh & G√≥c m·∫∑t</span>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="check-anti-flip" class="sr-only peer save-input" checked>
                                    <div class="w-8 h-4 bg-gray-700 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-3 after:w-3 after:transition-all peer-checked:bg-[#FF453A]"></div>
                                </label>
                            </div>
                             <div class="mb-2 p-2 border border-[#BF5AF2]/30 bg-[#BF5AF2]/10 rounded hidden" id="structure-container">
                                <div class="flex justify-between text-[11px] text-[#BF5AF2] font-bold mb-1">
                                    <span>KH√ìA C·∫§U TR√öC (CONTROLNET)</span>
                                    <span id="structure-val">M·∫°nh (0.8)</span>
                                </div>
                                <input type="range" id="structure-slider" min="0" max="100" value="80" class="w-full slider-flux">
                             </div>
                            <div class="flex items-center justify-between p-2 mb-3 bg-white/5 rounded-lg border border-white/5">
                                <div class="flex flex-col">
                                    <span class="text-[12px] font-bold text-gray-200">GI·ªÆ N√âT √Å ƒê√îNG (Asian Identity)</span>
                                    <span class="text-[9px] text-gray-500">Ch·ªëng "T√¢y h√≥a", gi·ªØ ƒë·∫∑c ƒëi·ªÉm ng∆∞·ªùi Vi·ªát</span>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="check-asian-identity" data-key="checkAsianIdentity" class="sr-only peer save-input" checked>
                                    <div class="w-8 h-4 bg-gray-700 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-3 after:w-3 after:transition-all peer-checked:bg-gray-400"></div>
                                </label>
                            </div>
                            <div class="flex items-center gap-2 p-2 rounded border border-purple-500/20 bg-purple-500/10 mb-2">
                                <input id="check-dual-controlnet" type="checkbox" class="chk-pro save-input">
                                <label for="check-dual-controlnet" class="flex-1 cursor-pointer select-none">
                                    <span class="block text-[10px] font-bold text-purple-300">KH√ìA C·∫§U TR√öC K√âP (DUAL CONTROLNET)</span>
                                    <span class="block text-[8px] text-purple-500/70">K·∫øt h·ª£p Depth + LineArt (D√πng cho tranh/t∆∞·ª£ng c·ªï)</span>
                                </label>
                            </div>
                            <div class="grid grid-cols-2 gap-2 border-t border-white/5 pt-2 mb-2">
                                <div class="flex items-center gap-2"><input id="lock-eyes" type="checkbox" class="chk-pro save-input" data-key="lockEyes" checked><label for="lock-eyes" class="text-[10px] text-gray-300">Kh√≥a M·∫Øt</label></div>
                                <div class="flex items-center gap-2"><input id="lock-mouth" type="checkbox" class="chk-pro save-input" data-key="lockMouth" checked><label for="lock-mouth" class="text-[10px] text-gray-300">Kh√≥a Mi·ªáng</label></div>
                                <div class="flex items-center gap-2"><input id="lock-skin" type="checkbox" class="chk-pro save-input" data-key="lockSkin"><label for="lock-skin" class="text-[10px] text-gray-300">N·ªët ru·ªìi/Ch√†m</label></div>
                                <div class="flex items-center gap-2" id="container-imperfection"><input id="lock-imperfection" type="checkbox" class="chk-pro chk-gold save-input" data-key="lockImperfection"><label for="lock-imperfection" class="text-[10px] text-yellow-500 font-bold">Gi·ªØ Khuy·∫øt ƒêi·ªÉm</label></div>
                            </div>
                            
                            <div class="mt-2 border-t border-[#FF453A]/20 pt-2">
                                <label class="text-[10px] uppercase text-[#FF453A]/80 font-bold mb-2 block">üõ°Ô∏è B·∫¢O T·ªíN ƒê·∫∂C ƒêI·ªÇM (CH·ªêNG AI S·ª¨A)</label>
                                <div class="grid grid-cols-2 gap-2">
                                    <div class="flex items-center gap-2"><input id="check-cross-eyed" type="checkbox" class="chk-pro chk-red save-input"><label for="check-cross-eyed" class="text-[11px] text-gray-300">M·∫Øt L√© / L√°c</label></div>
                                    <div class="flex items-center gap-2"><input id="check-ptosis" type="checkbox" class="chk-pro chk-red save-input"><label for="check-ptosis" class="text-[11px] text-gray-300">M·∫Øt S·ª•p M√≠</label></div>
                                    <div class="flex items-center gap-2"><input id="check-closed-eyes" type="checkbox" class="chk-pro chk-red save-input"><label for="check-closed-eyes" class="text-[11px] text-gray-300">M·∫Øt Nh·∫Øm / Ng·ªß</label></div>
                                    <div class="flex items-center gap-2"><input id="check-monolid" type="checkbox" class="chk-pro chk-red save-input"><label for="check-monolid" class="text-[11px] text-gray-300">M·∫Øt M·ªôt M√≠</label></div>
                                    <div class="flex items-center gap-2"><input id="check-buck-teeth" type="checkbox" class="chk-pro chk-red save-input"><label for="check-buck-teeth" class="text-[11px] text-gray-300">RƒÉng H√¥</label></div>
                                    <div class="flex items-center gap-2"><input id="check-black-teeth" type="checkbox" class="chk-pro chk-red save-input"><label for="check-black-teeth" class="text-[11px] text-gray-300">RƒÉng ƒêen</label></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- MODULE 4: PROMPT -->
                <div class="module-group" id="module-prompt">
                    <button id="toggle-prompt" class="module-header w-full">
                         <div class="flex items-center gap-2">
                            <span class="text-[12px] font-bold text-gray-200 tracking-wide uppercase">üìù PROMPT & API</span>
                        </div>
                        <svg class="w-4 h-4 text-gray-500 transition-transform" id="icon-prompt" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="content-prompt" class="module-content">
                        <div class="module-inner">
                            <textarea id="prompt-main" rows="3" class="pro-input w-full p-3 resize-none text-[11px] font-mono save-input mb-2 bg-black/30" data-key="promptMainValue" placeholder="H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông t·ªëi ∆∞u theo chu·∫©n Flux..."></textarea>
                            <input type="text" id="prompt-negative" placeholder="Lo·∫°i tr·ª´..." class="pro-input w-full py-2 save-input mb-2" data-key="promptNegative">
                        </div>
                    </div>
                </div>

                <!-- MODULE 5: B·∫¢N QUY·ªÄN (LOGO) -->
                <div class="module-group" id="module-logo">
                    <button id="toggle-logo" class="module-header w-full">
                         <div class="flex items-center gap-2">
                            <span class="text-[12px] font-bold text-gray-200 uppercase">¬©Ô∏è CH√àN LOGO B·∫¢N QUY·ªÄN</span>
                        </div>
                        <svg class="w-4 h-4 text-gray-500 transition-transform" id="icon-logo" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                    </button>
                    <div id="content-logo" class="module-content">
                        <div class="module-inner">
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex flex-col">
                                    <span class="text-[12px] font-bold text-gray-300">K√≠ch ho·∫°t ƒë√≥ng d·∫•u Logo</span>
                                    <span class="text-[9px] text-gray-500">D·∫°ng l∆∞·ªõi m·ªù 10% ph·ªß ·∫£nh</span>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="check-logo" class="sr-only peer save-input">
                                    <div class="w-8 h-4 bg-gray-700 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-3 after:w-3 after:transition-all peer-checked:bg-[#FFD60A]"></div>
                                </label>
                            </div>
                            <input type="text" id="custom-logo-text" class="pro-input w-full py-2 bg-black/20 text-center font-bold text-yellow-400 placeholder-gray-600" placeholder="Nh·∫≠p t√™n ho·∫∑c SƒêT c·ªßa b·∫°n...">
                        </div>
                    </div>
                </div>

            </div>

            <!-- Footer Actions -->
            <div class="p-4 bg-[#1c1c1e] border-t border-white/10 z-20 space-y-3">
                <button id="process-image" class="w-full py-3.5 btn-iso-primary shadow-lg shadow-blue-500/20 text-[13px] flex justify-center items-center gap-2 disabled:opacity-70 disabled:cursor-not-allowed">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                    T·∫†O ·∫¢NH (FLUX/QWEN ENGINE)
                </button>
                <button id="reset-button" class="w-full py-2.5 btn-iso-glass text-[11px] font-semibold text-gray-400 hover:text-white">L√ÄM M·ªöI</button>
            </div>
        </aside>

        <!-- WORKSPACE -->
        <main class="flex-1 flex flex-col relative overflow-hidden bg-black" id="main-workspace">
            <!-- MOBILE HEADER -->
            <div class="lg:hidden h-14 glass-panel border-b border-white/5 flex items-center px-4 justify-between z-30 relative w-full">
                <button id="toggle-sidebar-btn" class="text-gray-400 p-2 rounded-lg active:bg-white/10"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg></button>
                <div class="flex flex-col items-center">
                     <span class="font-bold text-white text-[14px] tracking-tight">PH·ª§C H·ªíI ·∫¢NH</span>
                     <div class="flex items-center gap-2 opacity-60">
                        <span class="text-[9px] font-mono">V36.20</span>
                        <span class="text-[9px]">‚Ä¢</span>
                        <span id="mobile-status-text" class="text-[9px] font-mono tracking-widest">WAITING</span>
                     </div>
                </div>
                <div class="flex items-center justify-center h-8 px-3 rounded-full bg-white/10 border border-white/10 text-[#FFD60A] font-bold font-mono text-xs cursor-pointer active:scale-95 transition-transform" id="mobile-credit-display">
                    <span id="mobile-credit-count">--</span>
                </div>
            </div>
            
            <!-- DESKTOP TOOLBAR -->
            <div class="absolute top-6 left-1/2 -translate-x-1/2 h-12 glass-panel rounded-full flex items-center px-2 z-20 shadow-2xl hidden sm:flex border border-white/10 gap-2">
                <div class="flex items-center px-3 border-r border-white/10">
                     <span class="w-1.5 h-1.5 rounded-full bg-green-500 mr-2"></span>
                     <span id="zoom-level" class="text-white text-xs font-mono font-bold">100%</span>
                </div>
                <button id="rotate-btn" class="p-2 hover:bg-white/10 rounded-full text-gray-400 transition"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg></button>
                <div class="w-[1px] h-6 bg-white/10 mx-1"></div>
                <button id="toggle-magnifier" class="px-3 py-1.5 rounded-full hover:bg-white/10 text-gray-300 text-[11px] font-semibold flex items-center gap-1 transition-colors">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"></path></svg>
                    SOI DA
                </button>
                <div class="flex gap-1">
                    <button id="zoom-out" class="p-2 hover:bg-white/10 rounded-full text-gray-400"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path></svg></button>
                    <button id="zoom-reset" class="px-2 hover:bg-white/10 rounded text-gray-400 text-[10px] font-bold">FIT</button>
                    <button id="zoom-in" class="p-2 hover:bg-white/10 rounded-full text-gray-400"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg></button>
                </div>
                <button id="download-trigger" class="ml-2 bg-white text-black hover:bg-gray-200 px-5 py-2 rounded-full text-xs font-bold transition-all opacity-50 cursor-not-allowed shadow-lg" disabled>L∆ØU ·∫¢NH</button>
            </div>
            
            <div class="flex-1 relative flex flex-col items-center justify-center overflow-hidden pb-32 lg:pb-0">
                <div id="canvas-scale-container" class="relative transition-transform duration-500 ease-[cubic-bezier(0.19,1,0.22,1)] origin-center will-change-transform" style="transform: scale(1);">
                    <div id="scan-beam" class="absolute top-0 left-0 w-full h-[5px] bg-gradient-to-b from-[#0A84FF] to-transparent shadow-[0_0_40px_#0A84FF] opacity-0 z-50 pointer-events-none transition-opacity duration-300"></div>
                    <style>.active#scan-beam { opacity: 1; animation: scan-fast 1.5s linear infinite; }</style>

                    <div id="magic-dust" class="absolute inset-0 z-40 pointer-events-none hidden">
                         <div class="absolute inset-0 bg-blue-500/10 mix-blend-screen animate-pulse"></div>
                    </div>

                    <div id="comparison-view" class="relative max-w-[95vw] max-h-[80vh] flex justify-center items-center" style="display:none;">
                         <div id="comp-inner" class="relative shadow-2xl rounded-2xl overflow-hidden cursor-ew-resize group select-none mobile-image-frame">
                              <img id="img-original" class="block max-h-[75vh] w-auto pointer-events-none select-none">
                              <div id="img-modified-wrapper" class="absolute top-0 left-0 h-full w-[50%] overflow-hidden border-r border-white/50 bg-black/5">
                                  <img id="img-modified" class="absolute top-0 left-0 max-h-[75vh] w-auto pointer-events-none select-none" style="max-width: none;">
                              </div>
                              
                              <div class="comp-label before">TR∆Ø·ªöC</div>
                              <div class="comp-label after">SAU</div>

                              <div id="slider-handle" class="absolute top-0 bottom-0 left-[50%] w-0.5 bg-white/80 z-20 pointer-events-none shadow-[0_0_10px_rgba(0,0,0,0.5)]">
                                  <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-8 h-8 bg-white/20 backdrop-blur-md border border-white rounded-full flex items-center justify-center shadow-lg">
                                      <svg class="w-4 h-4 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" /></svg>
                                  </div>
                              </div>
                         </div>
                         
                         <div id="scan-log-overlay" class="absolute bottom-4 left-4 z-30 flex flex-col items-start pointer-events-none max-w-[200px] overflow-hidden"></div>
                    </div>

                    <canvas id="canvas-process" class="hidden"></canvas>
                    
                    <div id="placeholder-state" class="text-center p-12 md:p-24 border border-dashed border-gray-700 rounded-3xl bg-white/[0.02] hover:bg-white/[0.04] transition-all duration-500 backdrop-blur-sm cursor-pointer">
                        <div class="w-24 h-24 bg-gradient-to-tr from-gray-800 to-gray-700 rounded-full flex items-center justify-center mx-auto mb-6 shadow-inner border border-white/5"><svg class="w-10 h-10 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l-1.586-1.586a2 2 0 00-2.828 0L6 18H4a2 2 0 01-2-2V6a2 2 0 01-2-2V6a2 2 0 012-2h16a2 2 0 012 2v8a2 2 0 01-2 2h-2m-4-4l-3 3m0 0l-3-3m3 3V4"></path></svg></div>
                        <h3 class="text-xl font-bold text-white tracking-tight mb-2">Ch·∫°m ƒë·ªÉ t·∫£i ·∫£nh</h3>
                        <p class="text-xs text-gray-500 font-medium">H·ªó tr·ª£ m·ªçi ƒë·ªãnh d·∫°ng ·∫£nh</p>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- MOBILE GLASS DOCK -->
    <div id="mobile-action-bar" class="lg:hidden fixed bottom-6 left-4 right-4 z-[90] flex items-center justify-center pointer-events-none transition-all duration-500 translate-y-32 opacity-0">
        <div class="bg-[#1c1c1e]/90 backdrop-blur-xl border border-white/10 p-2 rounded-[24px] shadow-2xl flex gap-3 w-full max-w-sm pointer-events-auto ring-1 ring-white/5">
            <button id="mob-btn-upload" class="flex-1 py-4 bg-gray-800/80 rounded-[18px] text-white font-bold text-[10px] flex flex-col items-center justify-center gap-1 active:scale-95 transition-all shadow-inner">
                <svg class="w-6 h-6 text-[#0A84FF]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4 4m0 0L8 8m4-4v12"></path></svg>
                <span>T·∫¢I ·∫¢NH</span>
            </button>
            <button id="mob-btn-scan" class="hidden flex-1 py-4 bg-[#0A84FF] rounded-[18px] text-white font-bold text-[10px] flex flex-col items-center justify-center gap-1 shadow-lg active:scale-95 transition-all">
                <svg class="w-6 h-6 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                <span>SCAN</span>
            </button>
            <button id="mob-btn-run" class="hidden flex-1 py-4 bg-[#30D158] rounded-[18px] text-white font-bold text-[10px] flex flex-col items-center justify-center gap-1 shadow-lg active:scale-95 transition-all">
                 <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                <span>CH·∫†Y</span>
            </button>
            <button id="mob-btn-reset" class="w-16 flex flex-col items-center justify-center bg-white/5 text-gray-400 rounded-[18px] active:scale-95 transition-all border border-white/5">
                <svg class="w-6 h-6 mb-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
            </button>
        </div>
    </div>

    <!-- RECHARGE MODAL -->
    <div id="recharge-modal" class="fixed inset-0 z-[110] bg-black/80 backdrop-blur-2xl hidden flex items-center justify-center modal-fade-in p-4 overflow-y-auto">
        <div class="w-full max-w-[400px] bg-[#1c1c1e] border border-white/10 rounded-[32px] shadow-2xl flex flex-col relative overflow-hidden">
            <button id="close-recharge" class="absolute top-4 right-4 z-50 p-2 bg-[#2c2c2e]/80 backdrop-blur-md rounded-full text-gray-400 hover:text-white transition-all hover:scale-110 active:scale-95">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            
            <div class="p-6 pb-2">
                <span class="text-[10px] font-bold text-[#0A84FF] uppercase tracking-widest mb-1 block">STORE</span>
                <h3 class="text-2xl font-bold text-white tracking-tight">N·∫°p Credits</h3>
                <p class="text-[12px] text-gray-400 mt-1">1 Credit = 1 L·∫ßn x·ª≠ l√Ω ·∫£nh ch·∫•t l∆∞·ª£ng cao.</p>
            </div>

            <div class="px-6 space-y-3 max-h-[40vh] overflow-y-auto custom-scrollbar">
                
                <div class="recharge-pkg-card group relative p-4 rounded-[20px] bg-[#2c2c2e] border border-white/5 hover:bg-[#3a3a3c] cursor-pointer transition-all active:scale-[0.98]" data-amount="50000" data-credits="4">
                    <div class="flex justify-between items-center relative z-10">
                        <div>
                            <span class="block text-lg font-bold text-white">50k</span>
                            <span class="text-[10px] text-gray-500 uppercase font-bold">G√ìI NH·ªé</span>
                        </div>
                        <div class="bg-white/10 px-3 py-1 rounded-full">
                            <span class="text-sm font-bold text-[#FFD60A]">4 ·∫¢NH</span>
                        </div>
                    </div>
                    <div class="absolute inset-0 border-2 border-[#0A84FF] rounded-[20px] opacity-0 pkg-border transition-opacity"></div>
                </div>

                <div class="recharge-pkg-card group relative p-4 rounded-[20px] bg-[#2c2c2e] border border-white/5 hover:bg-[#3a3a3c] cursor-pointer transition-all active:scale-[0.98]" data-amount="80000" data-credits="7">
                    <div class="flex justify-between items-center relative z-10">
                        <div>
                            <span class="block text-lg font-bold text-white">80k</span>
                            <span class="text-[10px] text-gray-500 uppercase font-bold">TI·∫æT KI·ªÜM</span>
                        </div>
                        <div class="bg-white/10 px-3 py-1 rounded-full">
                            <span class="text-sm font-bold text-[#FFD60A]">7 ·∫¢NH</span>
                        </div>
                    </div>
                    <div class="absolute inset-0 border-2 border-[#0A84FF] rounded-[20px] opacity-0 pkg-border transition-opacity"></div>
                </div>

                <div class="recharge-pkg-card active group relative p-4 rounded-[20px] bg-[#0A84FF]/10 border border-[#0A84FF]/50 cursor-pointer transition-all active:scale-[0.98]" data-amount="100000" data-credits="9">
                    <div class="absolute -top-2 right-4 bg-blue-500 text-white text-[9px] font-bold px-2 py-0.5 rounded-full shadow-lg">POPULAR</div>
                    <div class="flex justify-between items-center relative z-10">
                        <div>
                            <span class="block text-xl font-bold text-white">100k</span>
                            <span class="text-[10px] text-[#0A84FF] uppercase font-bold">TI√äU CHU·∫®N</span>
                        </div>
                        <div class="text-right">
                            <span class="block text-lg font-bold text-[#FFD60A]">9 ·∫¢NH</span>
                        </div>
                    </div>
                    <div class="absolute inset-0 border-2 border-[#0A84FF] rounded-[20px] opacity-100 pkg-border"></div>
                </div>

                <div class="recharge-pkg-card group relative p-4 rounded-[20px] bg-[#2c2c2e] border border-white/5 hover:bg-[#3a3a3c] cursor-pointer transition-all active:scale-[0.98]" data-amount="200000" data-credits="19">
                    <div class="absolute -top-2 right-4 bg-purple-500 text-white text-[9px] font-bold px-2 py-0.5 rounded-full shadow-lg">HOT DEAL</div>
                    <div class="flex justify-between items-center relative z-10">
                        <div>
                            <span class="block text-lg font-bold text-white">200k</span>
                            <span class="text-[10px] text-gray-500 uppercase font-bold">CAO C·∫§P</span>
                        </div>
                        <div class="bg-purple-500/20 px-3 py-1 rounded-full">
                            <span class="text-sm font-bold text-[#FFD60A]">19 ·∫¢NH</span>
                        </div>
                    </div>
                    <div class="absolute inset-0 border-2 border-purple-500 rounded-[20px] opacity-0 pkg-border transition-opacity"></div>
                </div>

                <div class="recharge-pkg-card group relative p-4 rounded-[20px] bg-[#2c2c2e] border border-white/5 hover:bg-[#3a3a3c] cursor-pointer transition-all active:scale-[0.98]" data-amount="500000" data-credits="45">
                    <div class="absolute -top-2 right-4 bg-yellow-500 text-black text-[9px] font-bold px-2 py-0.5 rounded-full shadow-lg">VIP STUDIO</div>
                    <div class="flex justify-between items-center relative z-10">
                        <div>
                            <span class="block text-lg font-bold text-white">500k</span>
                            <span class="text-[10px] text-gray-500 uppercase font-bold">SI√äU VIP</span>
                        </div>
                        <div class="bg-yellow-500/20 px-3 py-1 rounded-full border border-yellow-500/30">
                            <span class="text-sm font-bold text-[#FFD60A]">45 ·∫¢NH</span>
                        </div>
                    </div>
                    <div class="absolute inset-0 border-2 border-[#FFD60A] rounded-[20px] opacity-0 pkg-border transition-opacity"></div>
                </div>

            </div>

            <div class="p-6 mt-2 bg-black/20 backdrop-blur-xl border-t border-white/5">
                <div class="flex justify-center mb-4">
                    <div class="bg-white p-1 rounded-xl shadow-lg relative group">
                        <img id="vietqr-image" src="" alt="QR" class="w-32 h-32 object-contain rounded-lg">
                        <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 bg-white/90 transition-opacity rounded-lg">
                            <span class="text-[10px] font-bold text-black">QU√âT ƒê·ªÇ TR·∫¢</span>
                        </div>
                    </div>
                </div>

                <div class="text-center mb-4">
                    <p class="text-[9px] text-gray-500 font-bold uppercase mb-1">N·ªòI DUNG CK (AUTO)</p>
                    <div class="inline-block bg-[#1c1c1e] px-3 py-1 rounded-lg border border-white/10">
                        <span id="qr-content-display" class="text-sm font-mono font-bold text-[#FFD60A] tracking-wider">LOADING...</span>
                    </div>
                </div>

                <div class="relative">
                    <input type="text" id="recharge-input" class="w-full bg-[#2c2c2e] text-white text-center font-mono text-sm py-3 pl-4 pr-12 rounded-xl border border-white/10 focus:border-[#0A84FF] focus:bg-[#3a3a3c] transition-all outline-none placeholder-gray-500 uppercase tracking-widest" placeholder="NH·∫¨P M√É V36...">
                    <button id="btn-submit-recharge" class="absolute right-1 top-1 bottom-1 aspect-square bg-[#30D158] hover:bg-[#28c04d] text-white rounded-lg flex items-center justify-center transition-transform active:scale-95 shadow-lg">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN SCRIPT -->
    <script>
        const DEFAULT_ENCRYPTED_CONFIG = "LRFALDY3LTQ/IH1xZxg7PigidAVWQX1/ZyIlOw46MmdjfSAqYSUjW3QnGQd0ZAU1DngybTckJQEfP1hSNgspJzAbIgofNW4bMRIfBBoCbxkrNBtkF2dzaTUrMCUoKDEkEQ99MCouMCZnc2knOCw2FD44dAkXNycxMyZoanAqNTBxMC4hMSJSRTZ9Jiw4cDg="; 
        const ALLOWED_DOMAINS = []; 
        
        // --- C·∫§U H√åNH PROMPT VETERAN CHUY√äN S√ÇU ---
        const VETERAN_PRESETS = {
            "preset_1": {
                name: "·∫¢NH TH·ªú LI·ªÜT S·ª∏ (CHU·∫®N ·∫¢NH TH·ªú)",
                desc: "Ph·ª•c h·ªìi trang nghi√™m, c√¢n ƒë·ªëi m·∫∑t, √°nh s√°ng studio, ph√¥ng n·ªÅn chu·∫©n.",
                positive: "Restore old Vietnamese fallen soldier portrait, high fidelity face restoration, keep original facial identity 100 percent, Vietnamese heroic soldier, solemn and respectful expression, balanced lighting, natural skin texture, remove scratches and noise, historical accuracy, traditional Vietnamese memorial portrait style, high resolution, clear eyes and facial structure, no beautify, no smile exaggeration, (restore existing medals only), (do not add fake medals)",
                negative: "anime, cartoon, 3d, fantasy, western face, korean face, chinese face, beauty filter, plastic skin, over sharpen, fake details, wrong uniform, wrong insignia, modern military, face change, face swap, AI artifacts, (fake medals), (fake rank)"
            },
            "preset_2": {
                name: "CHI·∫æN S·ª∏ KH√ÅNG CHI·∫æN (ƒêEN TR·∫ÆNG)",
                desc: "Gi·ªØ ch·∫•t ·∫£nh t∆∞ li·ªáu, ph·ª•c h·ªìi chi ti·∫øt b·ªã r√°ch/m·ªù, tƒÉng ƒë·ªô n√©t.",
                positive: "Vietnamese resistance war soldier, old black and white photo restoration, documentary photography style, authentic Vietnamese military uniform, natural facial reconstruction, remove cracks, dust, scratches, preserve original emotion, historical realism, film grain controlled, sharp but not modern, true identity preservation, (restore actual details only), (do not invent rank)",
                negative: "colorized, modern style, anime, CGI, AI face, smooth skin, beauty retouch, foreign military, incorrect rank, digital painting, (hallucinated details)"
            },
            "preset_3": {
                name: "M√ÄU H√ìA ·∫¢NH CHI·∫æN S·ª∏ (M√ÄU CHU·∫®N)",
                desc: "L√™n m√†u qu√¢n ph·ª•c chu·∫©n QƒêND Vi·ªát Nam, m√†u da t·ª± nhi√™n.",
                positive: "Colorize old Vietnamese soldier photo, historically accurate colors, Vietnam People's Army green uniform, natural skin tone Vietnamese, realistic lighting, no color exaggeration, authentic fabric texture, preserve original photo mood, photo restoration quality, realistic and respectful, (respect original uniform configuration)",
                negative: "vivid colors, cinematic fantasy, wrong green uniform, western color palette, over saturation, anime style, modern fashion, (added insignia)"
            },
            "preset_4": {
                name: "CHI·∫æN S·ª∏ SAO V√ÄNG - QU√ÇN H√ÄM R√ï N√âT",
                desc: "T·∫≠p trung ph·ª•c h·ªìi chi ti·∫øt M≈©, Sao v√†ng, C·∫ßu vai, Hu√¢n ch∆∞∆°ng.",
                positive: "Vietnam People's Army soldier, golden star emblem on cap, Vietnamese military rank insignia, accurate shoulder epaulettes, (restore existing medals and decorations), sharp uniform details, historical accuracy, official military portrait style, realistic fabric and metal texture, (enhance visibility of actual rank), (do not add fake rank)",
                negative: "extra stars, fake rank, foreign insignia, wrong flag, fantasy medals, cartoon, anime, plastic uniform, (hallucinated medals)"
            },
            "preset_5": {
                name: "C√îNG AN NH√ÇN D√ÇN (·∫¢NH H·ªí S∆†)",
                desc: "Ph·ª•c h·ªìi s·∫Øc n√©t, trang nghi√™m d√†nh cho l·ª±c l∆∞·ª£ng CAND.",
                positive: "Vietnam People's Public Security officer, official Vietnamese police uniform, red and yellow insignia, formal posture, serious and dignified expression, official portrait photography, clean background, high clarity face restoration, authentic Vietnamese police style, (restore actual uniform details)",
                negative: "foreign police, western uniform, beauty retouch, fashion portrait, anime, CGI, (fake badge)"
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            const apiKey = ""; 

            const Sec = {
                key: "V35_SEC_V2", 
                dec(t){
                    try {
                        if(!t) return null;
                        return [...atob(t)].map((c,i) => String.fromCharCode(c.charCodeAt(0)^this.key.charCodeAt(i%this.key.length))).join("")
                    } catch(e) { return null; }
                }
            };

            const UserSystem = {
                deviceId: null,
                credits: 0,
                ipAddress: null, 
                
                async init() {
                    try {
                        let storedId = localStorage.getItem('v35_unique_device_id');
                        if (!storedId) {
                            const randomPart = Math.random().toString(36).substring(2, 8).toUpperCase();
                            storedId = `ID-${randomPart}`;
                            localStorage.setItem('v35_unique_device_id', storedId);
                        }
                        this.deviceId = storedId;
                    } catch (e) {
                        this.deviceId = "GUEST-" + Math.floor(Math.random()*1000);
                    }
                    
                    await this.fetchIP();
                    this.loadCredits();
                    this.updateUI();
                    initRechargeSystem(this.deviceId);
                    updateMobileBtnState('upload');

                    // Default Config Load Logic (Embed)
                    let configStr = localStorage.getItem("v35_user_settings");
                    if (!configStr && DEFAULT_ENCRYPTED_CONFIG) {
                        configStr = DEFAULT_ENCRYPTED_CONFIG;
                    }

                    if (configStr) {
                         const k = "V35_SECURE_KEY_SALT";
                         try {
                            let text = atob(configStr);
                            let result = '';
                            for(let i = 0; i < text.length; i++) {
                                result += String.fromCharCode(text.charCodeAt(i) ^ k.charCodeAt(i % k.length));
                            }
                            const config = JSON.parse(result);
                            if (config && config.apiKey) {
                                window.GEMINI_API_KEY = config.apiKey || "";
                                window.API_BASE_URL = config.baseUrl || "https://generativelanguage.googleapis.com";
                            }
                        } catch(e) {}
                    }
                },

                async fetchIP() {
                    const gateIpDisplay = document.getElementById('gate-ip-display');
                    const gateLoader = document.getElementById('gate-loading-spinner');
                    const gateBtn = document.getElementById('gate-submit');
                    const gateStatus = document.getElementById('gate-status');
                    
                    const sidebarIpDisplay = document.getElementById('sidebar-ip-display');
                    const sidebarIdDisplay = document.getElementById('sidebar-id-display');

                    const updateSidebar = (ip) => {
                        if (sidebarIpDisplay) sidebarIpDisplay.textContent = `IP: ${ip}`;
                        if (sidebarIdDisplay) sidebarIdDisplay.textContent = `ID: ${this.deviceId}`;
                    };

                    const enableGate = (ip) => {
                        if (gateIpDisplay) {
                            gateIpDisplay.innerHTML = `<span class="text-gray-400 text-xs">${ip}</span> <span class="text-white mx-1">|</span> <span class="text-[#FFD60A] font-bold">${this.deviceId}</span>`; 
                            gateIpDisplay.classList.remove('shimmer-text');
                            if(gateLoader) gateLoader.style.display = 'none';
                            if(gateBtn) {
                                gateBtn.disabled = false;
                                gateBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                                gateStatus.textContent = `ƒê√£ nh·∫≠n di·ªán: ${this.deviceId}`;
                                gateStatus.classList.add('text-green-500');
                            }
                        }
                        updateSidebar(ip);
                    };

                    try {
                        const response = await fetch(`https://api.ipify.org?format=json&t=${Date.now()}`);
                        const data = await response.json();
                        this.ipAddress = data.ip;
                        enableGate(data.ip);
                        return data.ip;
                    } catch (e) {
                        this.ipAddress = "Offline Mode"; 
                        enableGate("Offline Mode");
                        return null;
                    }
                },

                loadCredits() {
                    const key = `v35_credits_${this.deviceId}`;
                    const savedCredits = localStorage.getItem(key);
                    if (savedCredits === null) {
                        this.credits = 0; 
                        this.save();
                    } else {
                        this.credits = parseInt(savedCredits);
                    }
                },

                setCredits(amount) {
                    this.credits = amount;
                    this.save();
                },

                addCredits(amount) {
                    this.credits += amount;
                    this.save();
                },

                deductCredits(amount) {
                    if (this.credits >= amount) {
                        this.credits -= amount;
                        this.save();
                        return true;
                    }
                    return false;
                },

                save() {
                    try {
                        const key = `v35_credits_${this.deviceId}`;
                        localStorage.setItem(key, this.credits);
                    } catch(e) {}
                    this.updateUI();
                },

                updateUI() {
                    const el = document.getElementById('credit-count');
                    const mobEl = document.getElementById('mobile-credit-count');
                    if (el) el.textContent = this.credits;
                    if (mobEl) mobEl.textContent = this.credits + " CR";
                }
            };

            const sidebar = document.getElementById('sidebar');
            const mobileBar = document.getElementById('mobile-action-bar');

            function openSidebar() {
                if(sidebar) sidebar.classList.remove('-translate-x-full');
                if(mobileBar) mobileBar.classList.add('translate-y-32', 'opacity-0'); 
            }

            function closeSidebar() {
                if(sidebar) sidebar.classList.add('-translate-x-full');
                if(mobileBar) mobileBar.classList.remove('translate-y-32', 'opacity-0'); 
            }
            
            const mobCredit = document.getElementById('mobile-credit-display');
            if(mobCredit) {
                mobCredit.onclick = () => document.getElementById('recharge-modal').classList.remove('hidden');
            }

            function initRechargeSystem(deviceId) {
                const pkgCards = document.querySelectorAll('.recharge-pkg-card');
                const qrImage = document.getElementById('vietqr-image');
                const contentDisplay = document.getElementById('qr-content-display');

                if(!qrImage) return;

                const bankId = 'mbbank';
                const accNo = '85543556868';
                const accName = 'HOANG QUANG CUONG';
                const template = 'compact'; 

                const updateQR = (amount) => {
                    const content = `V36 ${deviceId}`; 
                    const url = `https://img.vietqr.io/image/${bankId}-${accNo}-${template}.png?amount=${amount}&addInfo=${encodeURIComponent(content)}&accountName=${encodeURIComponent(accName)}`;
                    qrImage.src = url;
                    if(contentDisplay) contentDisplay.textContent = content;
                };

                updateQR(100000);

                pkgCards.forEach(card => {
                    card.addEventListener('click', () => {
                        pkgCards.forEach(c => {
                            c.classList.remove('active', 'border-[#0A84FF]', 'bg-[#0A84FF]/10');
                            c.classList.add('border-transparent', 'bg-[#2c2c2e]');
                            c.querySelector('.pkg-border').classList.remove('opacity-100');
                        });
                        
                        card.classList.remove('border-transparent', 'bg-[#2c2c2e]');
                        card.classList.add('active', 'border-[#0A84FF]', 'bg-[#0A84FF]/10');
                        card.querySelector('.pkg-border').classList.add('opacity-100');

                        const amount = card.dataset.amount;
                        updateQR(amount);
                    });
                });
            }

            const updateMobileBtnState = (state) => {
                const upload = document.getElementById('mob-btn-upload');
                const scan = document.getElementById('mob-btn-scan');
                const run = document.getElementById('mob-btn-run');
                const status = document.getElementById('mobile-status-text');
                
                if(upload) upload.classList.add('hidden');
                if(scan) scan.classList.add('hidden');
                if(run) run.classList.add('hidden');
                
                if (state === 'upload') {
                    if(upload) upload.classList.remove('hidden');
                    if(status) { status.textContent = "WAITING"; status.className = "text-[9px] text-gray-500 font-mono tracking-widest"; }
                } else if (state === 'scan') {
                    if(scan) {
                        scan.classList.remove('hidden');
                        scan.disabled = false;
                        scan.innerHTML = `<svg class="w-6 h-6 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg><span>SCAN</span>`;
                    }
                    if(status) {
                        status.textContent = "LOADED";
                        status.className = "text-[9px] font-mono tracking-widest text-blue-400 font-bold";
                    }
                } else if (state === 'scanning') {
                    if(scan) {
                        scan.classList.remove('hidden');
                        scan.disabled = true;
                        scan.innerHTML = `<svg class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> SCANNING...`;
                    }
                    if(status) status.textContent = "ANALYZING...";
                } else if (state === 'run') {
                    if(run) {
                        run.classList.remove('hidden');
                        run.disabled = false;
                        run.innerHTML = `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg><span>CH·∫†Y NGAY</span>`;
                    }
                    if(status) {
                        status.textContent = "READY";
                        status.className = "text-[9px] font-mono tracking-widest text-green-400 font-bold";
                    }
                } else if (state === 'running') {
                    if(run) {
                        run.classList.remove('hidden');
                        run.disabled = true;
                        run.innerHTML = `<svg class="w-5 h-5 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><span>PROCESSING...</span>`;
                    }
                    if(status) {
                        status.textContent = "RESTORING...";
                        status.className = "text-[9px] font-mono tracking-widest text-orange-400 font-bold animate-pulse";
                    }
                } else if (state === 'done') {
                    if(run) {
                        run.classList.remove('hidden');
                        run.disabled = false;
                        run.innerHTML = `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg><span>REDO</span>`;
                    }
                    if(status) {
                        status.textContent = "COMPLETED";
                        status.className = "text-[9px] font-mono tracking-widest text-green-400 font-bold";
                    }
                }
            }

            UserSystem.init();

            const creditDisplay = document.getElementById('credit-display');
            if (creditDisplay) {
                creditDisplay.onclick = () => document.getElementById('recharge-modal').classList.remove('hidden');
            }

            let state = { base64: null, refBase64: null, restoredObj: null, originalImg: null, zoom: 1, rotation: 0, defaultPrompt: "Restore this photo, remove scratches, high quality, 8k", isLoupeActive: false, isReplicaMode: false, isFluxMode: true, currentSliderVal: 50, isComparing: false, aspectRatioType: null, userSettings: { username: '', apiKey: '', provider: 'google', baseUrl: 'https://generativelanguage.googleapis.com' } };
            const showToast = (message, type = 'info') => {
                const container = document.getElementById('toast-container'); if(!container) return;
                const toast = document.createElement('div');
                const colors = type === 'error' ? 'bg-red-500 text-white shadow-red-500/20' : type === 'success' ? 'bg-green-500 text-white shadow-green-500/20' : 'bg-[#1c1c1e] text-white border border-white/10';
                toast.className = `flex items-center gap-3 px-4 py-3 rounded-xl backdrop-blur-md shadow-xl animate-toast-in ${colors} text-xs font-semibold`;
                toast.innerHTML = `<span>${message}</span>`;
                container.appendChild(toast);
                setTimeout(() => { toast.classList.add('animate-fade-out'); setTimeout(() => toast.remove(), 500); }, 3000);
            };
            
            function showScanWindow() {
                const win = document.getElementById('scan-window-overlay');
                if(win) win.classList.remove('hidden');
            }
            
            function hideScanWindow() {
                const win = document.getElementById('scan-window-overlay');
                if(win) win.classList.add('hidden');
            }
            
            function updateScanTags(messages) {
                const container = document.getElementById('scan-tags-container');
                if(!container) return;
                container.innerHTML = '';
                messages.forEach((msg) => {
                    const tag = document.createElement('span');
                    tag.className = 'scan-tag';
                    if (msg.includes('AUTO:') || msg.includes('PH√ÅT HI·ªÜN:') || msg.includes('WORKFLOW:') || msg.includes('TAG:')) {
                        tag.classList.add('highlight');
                    }
                    tag.innerText = msg;
                    container.appendChild(tag);
                });
            }

            function playSequentialLog(messages) {
                const container = document.getElementById('scan-log-overlay');
                if (!container) return;
                container.innerHTML = ''; 
                let delay = 0;
                messages.forEach((msg) => {
                    setTimeout(() => {
                        container.innerHTML = '';
                        const line = document.createElement('span');
                        line.className = 'sequential-log-text';
                        let cleanMsg = msg;
                        if (msg.includes('AUTO:') || msg.includes('PH√ÅT HI·ªÜN:') || msg.includes('WORKFLOW:') || msg.includes('TAG:')) {
                             line.classList.add('highlight');
                             cleanMsg = msg.replace('AUTO: ', '').replace('PH√ÅT HI·ªÜN: ', '').replace('WORKFLOW: ', '').replace('TAG: ', '');
                        } else {
                             cleanMsg = msg.replace('FIX: ', '');
                        }
                        line.innerText = cleanMsg;
                        container.appendChild(line);
                    }, delay);
                    delay += 1800; 
                });
                setTimeout(() => {
                    container.innerHTML = '';
                }, delay + 2000);
            }
            
            function getActiveSettings() {
                const settings = [];
                if(document.getElementById('mode-flux')?.checked) settings.push("FLUX ENGINE: ON");
                if(document.getElementById('mode-replica')?.checked) settings.push("REPLICA MODE");
                if(document.getElementById('check-face')?.checked) settings.push("FACE DETAIL");
                if(document.getElementById('check-hair')?.checked) settings.push("HAIR DRAWING");
                
                // --- VETERAN PRESET TAGS ---
                const vetPreset = document.getElementById('veteran-preset');
                if (vetPreset && vetPreset.value !== 'none' && VETERAN_PRESETS[vetPreset.value]) {
                    settings.push(`TAG: ${VETERAN_PRESETS[vetPreset.value].name.split('(')[0].trim()}`);
                }

                // --- VETERAN DETAILS TAGS ---
                if(document.getElementById('det-hat')?.checked) settings.push("TAG: M≈®/N√ìN");
                if(document.getElementById('det-rank')?.checked) settings.push("TAG: QU√ÇN H√ÄM");
                if(document.getElementById('det-star')?.checked) settings.push("TAG: SAO V√ÄNG");
                if(document.getElementById('det-medal')?.checked) settings.push("TAG: HU√ÇN CH∆Ø∆†NG");

                // --- IDENTITY TAGS ---
                if(document.getElementById('check-monolid')?.checked) settings.push("TAG: MONOLID");
                if(document.getElementById('check-cross-eyed')?.checked) settings.push("TAG: CROSS-EYED");
                if(document.getElementById('check-buck-teeth')?.checked) settings.push("TAG: BUCK TEETH");
                if(document.getElementById('check-black-teeth')?.checked) settings.push("TAG: BLACK TEETH");
                if(document.getElementById('check-asian-identity')?.checked) settings.push("TAG: ASIAN IDENTITY");

                // --- WORKFLOW TAG ---
                const workflow = document.getElementById('kontext-workflow');
                if(workflow && workflow.value !== 'default') {
                    settings.push(`WORKFLOW: ${workflow.options[workflow.selectedIndex].text.split('(')[0].trim()}`);
                }

                const upscale = document.getElementById('upscale-mode');
                if(upscale && upscale.value !== 'none') {
                    let simpleName = upscale.options[upscale.selectedIndex].text.split('(')[0].trim().replace(/^[^\w\s]+/, '');
                    settings.push(`UPSCALE: ${simpleName}`);
                }
                
                if(document.getElementById('check-logo')?.checked) settings.push("WATERMARK: ON");
                return settings;
            }

            const gateScreen = document.getElementById('security-gate'), gateSubmit = document.getElementById('gate-submit'), gateStatus = document.getElementById('gate-status');
            gateSubmit.addEventListener('click', async () => {
                if(!UserSystem.ipAddress) { UserSystem.ipAddress = "Offline Mode"; }
                gateStatus.textContent = `Verifying ID: ${UserSystem.deviceId}...`; 
                gateStatus.className = "text-[11px] text-[#0A84FF] font-bold animate-pulse flex items-center gap-2 justify-center"; 
                gateSubmit.disabled = true; 
                gateSubmit.classList.add('opacity-70');
                
                setTimeout(() => { 
                    gateStatus.textContent = "Access Granted"; 
                    gateStatus.className = "text-[11px] text-green-500 font-bold flex items-center gap-2 justify-center"; 
                    setTimeout(() => { 
                        gateScreen.classList.add('animate-fade-out'); 
                        setTimeout(() => { gateScreen.style.display = 'none'; }, 500); 
                        showToast(`Ch√†o m·ª´ng tr·ªü l·∫°i!`, "success"); 
                    }, 500); 
                }, 1000);
            });
            
            const getApiConfig = () => {
                const key = window.GEMINI_API_KEY || "";
                const base = window.API_BASE_URL || "https://generativelanguage.googleapis.com";
                return { key, base, isComet: false };
            };
            
            const resizeImage = (base64Str, maxWidth = 1536) => {
                return new Promise((resolve, reject) => { const img = new Image(); img.src = base64Str; img.onload = () => { let width = img.width; let height = img.height; if (width > maxWidth || height > maxWidth) { if (width > height) { height *= maxWidth / width; width = maxWidth; } else { width *= maxWidth / height; height = maxWidth; } } else { resolve(base64Str); return; } const canvas = document.createElement('canvas'); canvas.width = width; canvas.height = height; const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, width, height); resolve(canvas.toDataURL('image/jpeg', 0.9)); }; img.onerror = (err) => reject(new Error("L·ªói t·∫£i ·∫£nh ƒë·ªÉ Scan")); });
            };

            const toggleModule = (btnId, contentId, iconId) => { const btn = document.getElementById(btnId), content = document.getElementById(contentId), icon = document.getElementById(iconId); if(btn) btn.addEventListener('click', () => { if(content) content.classList.toggle('open'); if(icon && content) icon.style.transform = content.classList.contains('open') ? 'rotate(180deg)' : 'rotate(0deg)'; }); };
            ['processing','subject','identity','prompt','logo','veteran','cinematic','exposure'].forEach(id => toggleModule(`toggle-${id}`, `content-${id}`, `icon-${id}`));

            const toggleSidebarBtn = document.getElementById('toggle-sidebar-btn');
            if(toggleSidebarBtn) toggleSidebarBtn.onclick = openSidebar;
            
            const closeSidebarMobileBtn = document.getElementById('close-sidebar-mobile');
            if(closeSidebarMobileBtn) closeSidebarMobileBtn.onclick = closeSidebar;

            const downloadImage = () => {
                if (!state.restoredObj) return showToast("Ch∆∞a c√≥ ·∫£nh k·∫øt qu·∫£!", "error");
                const link = document.createElement('a');
                link.download = `V36-Veteran-Restored-${Date.now()}.jpg`;
                link.href = document.getElementById('img-modified').src;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };
            
            const btnDownloadDesktop = document.getElementById('download-trigger');
            if(btnDownloadDesktop) btnDownloadDesktop.onclick = downloadImage;

            const resetApp = () => {
                if(confirm("L√†m m·ªõi to√†n b·ªô?")) location.reload();
            };
            
            const btnResetSidebar = document.getElementById('reset-button');
            if(btnResetSidebar) btnResetSidebar.onclick = resetApp;
            
            const btnResetMobile = document.getElementById('mob-btn-reset');
            if(btnResetMobile) btnResetMobile.onclick = resetApp;

            const runImageProcessing = async () => {
                if(!state.base64) return showToast("Vui l√≤ng t·∫£i ·∫£nh!", "error");
                
                if (!UserSystem.deductCredits(1)) { 
                    showToast("T√†i kho·∫£n kh√¥ng ƒë·ªß Credit! Vui l√≤ng n·∫°p.", "error"); 
                    document.getElementById('recharge-modal').classList.remove('hidden'); 
                    return; 
                }
                
                updateMobileBtnState('running');
                if(processBtn) {
                    processBtn.disabled = true; 
                    processBtn.innerHTML = "T·∫†O ·∫¢NH (FLUX/QWEN ENGINE)"; 
                }
                
                showScanWindow();
                document.getElementById('scan-title').innerText = "ƒêANG X·ª¨ L√ù ·∫¢NH...";
                const activeSettings = getActiveSettings();
                updateScanTags(activeSettings);
                
                document.getElementById('scan-beam').classList.add('active');
                const magicDust = document.getElementById('magic-dust');
                if(magicDust) magicDust.classList.remove('hidden');

                closeSidebar();

                const { key: keyToUse, base: apiBase } = getApiConfig();
                try {
                    const resizedBase64 = await resizeImage(state.base64);
                    let finalPrompt = document.getElementById('prompt-main').value;
                    if(!finalPrompt) finalPrompt = "Restore this photo, remove scratches, high quality, 8k";
                    
                    const antiFlip = document.getElementById('check-anti-flip')?.checked;
                    if (antiFlip) {
                        finalPrompt += ", (maintain original composition:1.5), (do not flip:1.5), (preserve composition:1.4)";
                    }
                    
                    const replicaMode = document.getElementById('mode-replica')?.checked;
                    if (replicaMode) {
                        finalPrompt += ", (exact facial features:1.5), (same face structure:1.5)";
                    }
                    finalPrompt += ", (maintain original composition:1.5), (do not flip:1.5), (do not crop:1.4)";
                    
                    // --- VETERAN PRO PROMPT INJECTION (UPDATED LOGIC) ---
                    const veteranPreset = document.getElementById('veteran-preset').value;
                    if (veteranPreset && veteranPreset !== 'none' && VETERAN_PRESETS[veteranPreset]) {
                        // Inject Positive Prompt
                        finalPrompt += ", " + VETERAN_PRESETS[veteranPreset].positive;
                        
                        // Inject Negative Prompt (Appended to existing negative)
                        let negInput = document.getElementById('prompt-negative');
                        let currentNeg = negInput ? negInput.value : "";
                        // Prepend preset negative to ensure it takes precedence
                        if(negInput) negInput.value = VETERAN_PRESETS[veteranPreset].negative + ", " + currentNeg;
                    }

                    // --- VETERAN DETAILS INJECTION ---
                    if(document.getElementById('det-hat')?.checked) finalPrompt += ", (wearing military hat:1.3), (restore hat emblem)";
                    if(document.getElementById('det-rank')?.checked) finalPrompt += ", (clear rank insignia:1.4), (shoulder epaulettes)";
                    if(document.getElementById('det-star')?.checked) finalPrompt += ", (golden star emblem:1.4), (shiny metal texture)";
                    if(document.getElementById('det-medal')?.checked) finalPrompt += ", (military medals:1.3), (chest decorations)";

                    // --- INJECT MISSING FEATURES (IDENTITY & WORKFLOW) ---
                    
                    // 1. Workflow Injection - LU√îN √ÅP D·ª§NG C√ôNG V·ªöI VETERAN
                    const workflow = document.getElementById('kontext-workflow').value;
                    // ƒê·∫£m b·∫£o workflow ƒë∆∞·ª£c √°p d·ª•ng
                    if (workflow === 'qwen_edit_pro') finalPrompt += ", (Qwen-VL enhanced), (follow instructions perfectly), (high fidelity)"; 
                    else if (workflow === 'replica_pro') finalPrompt += ", (high fidelity replication), (strict structure:1.4)";
                    else if (workflow === 'invsr_deblur') finalPrompt += ", (deblur), (sharpen focus:1.4)";
                    else if (workflow === 'ancient_restore') finalPrompt += ", (restore ancient texture), (remove cracks)";
                    else if (workflow === 'realvis_v5') finalPrompt += ", (realistic vision), (natural lighting)";
                    else if (workflow === 'wedding_kontext_v2') finalPrompt += ", (wedding photo style), (romantic lighting)";
                    else if (workflow === 'qwen_restore_full') finalPrompt += ", (full restoration), (remove all damage)";
                    else if (workflow === 'wedding_pro') finalPrompt += ", (wedding photography), (elegant style)";
                    else if (workflow === 'outdoor_mode') finalPrompt += ", (natural outdoor lighting), (scenic background)";
                    else if (workflow === 'product_mode') finalPrompt += ", (product photography), (studio lighting)";
                    else if (workflow === 'white_bg') finalPrompt += ", (white background), (clean background)";


                    // 2. Identity Guard Injection
                    if(document.getElementById('check-monolid')?.checked) finalPrompt += ", (monolid eyes:1.4), (epicanthic fold)";
                    if(document.getElementById('check-cross-eyed')?.checked) finalPrompt += ", (cross-eyed:1.4), (strabismus)";
                    if(document.getElementById('check-buck-teeth')?.checked) finalPrompt += ", (buck teeth:1.4), (prominent teeth)";
                    if(document.getElementById('check-black-teeth')?.checked) finalPrompt += ", (black lacquered teeth:1.4), (ohaguro style)";
                    if(document.getElementById('check-asian-identity')?.checked) finalPrompt += ", (Vietnamese facial features:1.3), (Asian race)";
                    if(document.getElementById('check-ptosis')?.checked) finalPrompt += ", (ptosis:1.4), (droopy eyelid)";
                    if(document.getElementById('check-closed-eyes')?.checked) finalPrompt += ", (closed eyes:1.4), (sleeping)";

                    // --- OTHER MODES ---
                    const isIDPhoto = document.getElementById('check-id-photo')?.checked;
                    if (isIDPhoto) {
                        finalPrompt += ", (passport photo:1.5), (studio lighting:1.3), (neutral background:1.4)";
                    }

                    const upscaleMode = document.getElementById('upscale-mode');
                    if (upscaleMode && upscaleMode.value === 'invsr_sharp') {
                        finalPrompt += ", (sharp focus:1.4), (remove motion blur:1.3), (InvSR deblurring:1.2)";
                    }

                    const parts = [{ text: finalPrompt }, { inlineData: { mimeType: "image/jpeg", data: resizedBase64.split(',')[1] } }];
                    const headers = { 'Content-Type': 'application/json' };
                    const response = await fetch(`${apiBase}/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${keyToUse}`, { method: 'POST', headers: headers, body: JSON.stringify({ contents: [{ parts: parts }], generationConfig: { responseModalities: ["TEXT", "IMAGE"] } }) });
                    
                    if (!response.ok) throw new Error("L·ªói k·∫øt n·ªëi API (" + response.status + ")");

                    const data = await response.json();
                    let base64Img = null;
                    if (data.candidates && data.candidates[0].content && data.candidates[0].content.parts) {
                        for (const part of data.candidates[0].content.parts) { if (part.inlineData && part.inlineData.data) { base64Img = part.inlineData.data; break; } }
                    }
                    if(base64Img) {
                        const finalImgSrc = `data:image/jpeg;base64,${base64Img}`;
                        const restoredImg = new Image();
                        restoredImg.onload = () => {
                            state.restoredObj = restoredImg;
                            
                            const imgModified = document.getElementById('img-modified');
                            imgModified.src = finalImgSrc;
                            
                            const imgOriginal = document.getElementById('img-original');
                            if(imgOriginal) {
                                const w = imgOriginal.clientWidth;
                                const h = imgOriginal.clientHeight;
                                imgModified.style.width = w + 'px';
                                imgModified.style.height = h + 'px';
                                imgModified.style.maxWidth = 'none'; 
                            }

                            document.getElementById('comparison-view').style.display = 'flex';
                            document.getElementById('placeholder-state').style.display = 'none';
                            
                            if(btnDownloadDesktop) btnDownloadDesktop.disabled = false;
                            
                            document.getElementById('img-modified-wrapper').style.width = '50%';
                            document.getElementById('slider-handle').style.left = '50%';
                            document.getElementById('slider-handle').style.display = 'flex'; 
                            document.querySelector('.comp-label.after').style.display = 'block';
                            
                            updateMobileBtnState('done');
                            showToast("Ph·ª•c ch·∫ø th√†nh c√¥ng!", "success");
                        };
                        restoredImg.src = finalImgSrc;
                    } else { throw new Error("Kh√¥ng t·∫°o ƒë∆∞·ª£c ·∫£nh (Kh√¥ng c√≥ d·ªØ li·ªáu tr·∫£ v·ªÅ)."); }
                } catch(e) { console.error(e); showToast("L·ªói: " + e.message, "error"); updateMobileBtnState('run'); }
                finally { 
                    if(processBtn) {
                        processBtn.disabled = false; 
                        processBtn.innerHTML = "T·∫†O ·∫¢NH (FLUX/QWEN ENGINE)"; 
                    }
                    hideScanWindow();
                    document.getElementById('scan-beam').classList.remove('active'); 
                    if(magicDust) magicDust.classList.add('hidden');
                }
            };

            const btnAutoPilot = document.getElementById('btn-auto-pilot'), processBtn = document.getElementById('process-image');
            
            // --- AUTO SCAN LOGIC (N√ÇNG C·∫§P V36.20) ---
            if(btnAutoPilot) btnAutoPilot.addEventListener('click', async () => {
                if(!state.base64) return showToast("Vui l√≤ng t·∫£i ·∫£nh tr∆∞·ªõc!", "error");
                const originalText = btnAutoPilot.innerHTML;
                btnAutoPilot.disabled = true;
                btnAutoPilot.innerHTML = `<span class="animate-pulse">AUTO-SCANNING...</span>`;
                
                document.getElementById('scan-log-overlay').innerHTML = ''; 
                updateMobileBtnState('scanning');
                const { key: keyToUse, base: apiBase } = getApiConfig();
                
                try {
                    const resizedBase64 = await resizeImage(state.base64);
                    // Updated Prompt to Detect Veteran Specifics
                    const promptText = "Analyze this image for Vietnamese photo restoration. Return ONLY JSON: { \"sceneContext\": \"wedding\"|\"funeral\"|\"casual\"|\"studio\"|\"outdoor\"|\"product\"|\"painting\"|\"ancient_portrait\"|\"nature\", \"isMilitary\": boolean, \"militaryEra\": \"indochina\"|\"vietnam_war\"|\"subsidy\"|\"modern\"|\"unknown\", \"militaryBranch\": \"army\"|\"navy\"|\"airforce\"|\"police\"|\"militia_guerilla\"|\"tnxp\", \"rankLevel\": \"soldier\"|\"officer_uy\"|\"officer_ta\"|\"none\", \"hatType\": \"pith_helmet\"|\"soft_cap\"|\"kepi\"|\"bamboo\"|\"none\", \"hasMedals\": boolean, \"isAltarPortrait\": boolean, \"gender\": \"male\"|\"female\", \"age\": number, \"damageType\": \"scratches\"|\"faded\"|\"sepia\"|\"severe_damage\"|\"none\"|\"blur\", \"isOldPhoto\": boolean, \"isIDPhoto\": boolean }";
                    
                    const parts = [{ text: promptText }, { inlineData: { mimeType: "image/jpeg", data: resizedBase64.split(',')[1] } }];
                    const headers = { 'Content-Type': 'application/json' };
                    const response = await fetch(`${apiBase}/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${keyToUse}`, { method: 'POST', headers: headers, body: JSON.stringify({ contents: [{ parts: parts }] }) });
                    
                    if (!response.ok) throw new Error("L·ªói Scan (" + response.status + ")");

                    const data = await response.json();
                    let text = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    if(text) {
                        text = text.replace(/```json/g, '').replace(/```/g, '').trim();
                        const result = JSON.parse(text);
                        const autoReport = [];
                        const setChecked = (id, val) => { const el = document.getElementById(id); if(el) el.checked = val; };

                        // --- MAPPING LOGIC SANG PRESET M·ªöI ---
                        const vetSelect = document.getElementById('veteran-preset');
                        
                        // 1. Logic ·∫¢nh Th·ªù / Li·ªát S·ªπ
                        if(result.isAltarPortrait) { 
                            vetSelect.value = "preset_1";
                            autoReport.push("PH√ÅT HI·ªÜN: ·∫¢NH TH·ªú LI·ªÜT S·ª∏");
                        }
                        
                        // 2. Logic Qu√¢n s·ª± / C√¥ng An
                        else if(result.isMilitary) {
                            const contentVeteran = document.getElementById('content-veteran');
                            if(contentVeteran) contentVeteran.classList.add('open');
                            autoReport.push("PH√ÅT HI·ªÜN: QU√ÇN NH√ÇN");

                            if(result.militaryBranch === 'police') {
                                vetSelect.value = "preset_5"; // C√¥ng an
                                autoReport.push("AUTO: C√îNG AN NH√ÇN D√ÇN");
                            } else if (result.hasMedals || result.rankLevel !== 'none' || result.hatType !== 'none') {
                                vetSelect.value = "preset_4"; // C√≥ sao/h√†m/hu√¢n ch∆∞∆°ng
                                autoReport.push("AUTO: QU√ÇN H√ÄM R√ï N√âT");
                            } else if (result.isOldPhoto && result.damageType !== 'none') {
                                vetSelect.value = "preset_2"; // Kh√°ng chi·∫øn c≈©
                                autoReport.push("AUTO: CHI·∫æN S·ª∏ KH√ÅNG CHI·∫æN");
                            } else {
                                vetSelect.value = "preset_3"; // M·∫∑c ƒë·ªãnh m√†u h√≥a
                                autoReport.push("AUTO: M√ÄU H√ìA QU√ÇN PH·ª§C");
                            }

                            // --- AUTO-TICK DETECTED DETAILS ---
                            if (result.hatType !== 'none') {
                                setChecked('det-hat', true);
                                autoReport.push("PH√ÅT HI·ªÜN: M≈®/N√ìN");
                                if (result.hatType === 'pith_helmet' || result.hatType === 'kepi') {
                                    setChecked('det-star', true); // Often implies star
                                }
                            }
                            if (result.rankLevel !== 'none') {
                                setChecked('det-rank', true);
                                autoReport.push("PH√ÅT HI·ªÜN: QU√ÇN H√ÄM");
                            }
                            if (result.hasMedals) {
                                setChecked('det-medal', true);
                                autoReport.push("PH√ÅT HI·ªÜN: HU√ÇN CH∆Ø∆†NG");
                            }
                        }

                        // Trigger change event to update description
                        vetSelect.dispatchEvent(new Event('change'));

                        if(result.isIDPhoto) { setChecked('check-id-photo', true); autoReport.push("CH·∫æ ƒê·ªò: ·∫¢NH TH·∫∫"); }
                        if(result.gender && document.getElementById('gender-select')) document.getElementById('gender-select').value = result.gender;

                        let smartPrompt = `Restore this ${result.sceneContext} photo. (high resolution:1.5), (masterpiece:1.4), (detailed skin texture:1.5). `;
                        const promptMain = document.getElementById('prompt-main');
                        if(promptMain) promptMain.value = smartPrompt;
                        
                        if (window.innerWidth >= 1024) { openSidebar(); } 
                        playSequentialLog(autoReport); 
                        updateMobileBtnState('run');
                    }
                } catch(e) { 
                    console.error(e); 
                    showToast("L·ªói Smart Scan: " + e.message, "error"); 
                    updateMobileBtnState('scan'); 
                } 
                finally { btnAutoPilot.disabled = false; btnAutoPilot.innerHTML = originalText; }
            });

            if(processBtn) processBtn.addEventListener('click', runImageProcessing);
            
            const mobRunBtn = document.getElementById('mob-btn-run');
            if(mobRunBtn) {
                mobRunBtn.onclick = runImageProcessing;
            }

            const compContainer = document.getElementById('comp-inner'), imgModWrapper = document.getElementById('img-modified-wrapper'), sliderHandle = document.getElementById('slider-handle');
            if(compContainer) { let isDragging = false; const updateSlider = (percent) => { if(!imgModWrapper || !sliderHandle) return; percent = Math.max(0, Math.min(100, percent)); imgModWrapper.style.width = percent + '%'; sliderHandle.style.left = percent + '%'; }; compContainer.addEventListener('mousedown', () => isDragging = true); compContainer.addEventListener('touchstart', () => isDragging = true); window.addEventListener('mouseup', () => isDragging = false); window.addEventListener('touchend', () => isDragging = false); compContainer.addEventListener('mousemove', (e) => { if(isDragging) { const rect = compContainer.getBoundingClientRect(); updateSlider(((e.clientX - rect.left)/rect.width)*100); } }); compContainer.addEventListener('touchmove', (e) => { if(isDragging) { const rect = compContainer.getBoundingClientRect(); updateSlider(((e.touches[0].clientX - rect.left)/rect.width)*100); } }); }
        });
    </script>
</body>
</html>