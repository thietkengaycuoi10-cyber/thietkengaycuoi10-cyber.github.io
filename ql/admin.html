<!DOCTYPE html>
<html lang="vi" class="antialiased">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>V35 ADMIN SYSTEM (CLOUD SYNC)</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>

<!-- Firebase SDK -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Khởi tạo các biến môi trường từ hệ thống
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    // Hàm khởi tạo xác thực tuân thủ RULE 3 (Đã fix lỗi login)
    const initAuth = async () => {
        try {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                try {
                    // Cố gắng đăng nhập bằng Token hệ thống cấp
                    await signInWithCustomToken(auth, __initial_auth_token);
                } catch (tokenError) {
                    console.warn("Token lỗi, chuyển sang đăng nhập Ẩn danh...", tokenError);
                    // Nếu token lỗi, Force đăng nhập ẩn danh ngay lập tức
                    await signInAnonymously(auth);
                }
            } else {
                await signInAnonymously(auth);
            }
        } catch (error) {
            console.error("Lỗi khởi tạo Auth nghiêm trọng:", error);
        }
    };

    // Theo dõi trạng thái để đảm bảo user luôn sẵn sàng
    onAuthStateChanged(auth, (user) => {
        if (user) {
            console.log("Admin System Connected: ", user.uid);
        } else {
            // Mất kết nối thì thử kết nối lại
            initAuth();
        }
    });

    // Chạy init auth ngay khi tải trang
    initAuth();

    window.saveVoucherToCloud = async (code, amount) => {
        try {
            // Đảm bảo đã login trước khi truy vấn
            if (!auth.currentUser) {
                await initAuth();
            }
            
            // Chờ một chút để state được cập nhật nếu vừa login xong
            if (!auth.currentUser) {
                // Thử đợi thêm 1s nếu mạng chậm
                await new Promise(r => setTimeout(r, 1000));
            }

            // Guard operation final check
            if (!auth.currentUser) {
                console.error("Mất kết nối Auth, không thể lưu.");
                alert("Lỗi kết nối Server! Vui lòng tải lại trang.");
                return false;
            }

            // Lưu vào đường dẫn public tuân thủ RULE 1
            const voucherRef = doc(db, 'artifacts', appId, 'public', 'data', 'vouchers', code);
            await setDoc(voucherRef, {
                code: code,
                amount: amount,
                isUsed: false,
                createdAt: serverTimestamp(),
                usedAt: null,
                usedBy: null
            });
            return true;
        } catch (e) {
            console.error("Lỗi lưu Cloud chi tiết:", e);
            alert("Lỗi lưu dữ liệu: " + e.message);
            return false;
        }
    };
</script>

<script>
    tailwind.config = {
        theme: {
            extend: {
                fontFamily: { sans: ['Inter', 'sans-serif'], mono: ['JetBrains Mono', 'monospace'] },
                colors: {
                    glass: { surface: 'rgba(255, 255, 255, 0.03)', border: 'rgba(255, 255, 255, 0.08)', highlight: 'rgba(255, 255, 255, 0.1)' }
                }
            }
        }
    }
</script>

<style>
    body { background-color: #09090b; color: #e4e4e7; background-image: radial-gradient(at 0% 0%, rgba(56, 189, 248, 0.1) 0px, transparent 50%); background-attachment: fixed; }
    .glass-card { background: rgba(18, 18, 23, 0.7); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.08); }
    .input-field { background: rgba(0, 0, 0, 0.2); border: 1px solid rgba(255, 255, 255, 0.1); outline: none; transition: all 0.2s; }
    .input-field:focus { border-color: #8b5cf6; background: rgba(0, 0, 0, 0.4); }
</style>
</head>

<body class="min-h-screen flex items-center justify-center p-6">

    <!-- LOGIN PANEL -->
    <div id="loginBox" class="w-full max-w-sm glass-card rounded-2xl p-8 text-center animate-fade-in">
        <h1 class="text-xl font-bold text-white mb-6">V35 ADMIN CLOUD</h1>
        <input id="adminPass" type="password" placeholder="Mật khẩu..." class="input-field w-full px-4 py-3 rounded-xl text-center mb-4">
        <button onclick="adminLogin()" class="w-full py-3 bg-white text-black font-bold rounded-xl hover:bg-gray-200 transition-all active:scale-95">ĐĂNG NHẬP</button>
        <p id="loginStatus" class="text-xs text-red-400 mt-2 h-4"></p>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard" class="hidden w-full max-w-4xl space-y-6">
        <div class="flex justify-between items-center">
            <h2 class="text-xl font-bold text-white">Quản lý Voucher (Đồng bộ Cloud)</h2>
            <button onclick="logout()" class="text-xs bg-red-500/10 text-red-400 px-4 py-2 rounded-full border border-red-500/20 hover:bg-red-500/20 transition-all">Đăng xuất</button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- CẤU HÌNH API -->
            <div class="glass-card rounded-3xl p-6">
                <h3 class="text-sm font-bold text-blue-400 mb-4 uppercase">Cài đặt API Web</h3>
                <div class="space-y-4">
                    <input id="userKey" class="input-field w-full px-4 py-3 rounded-xl text-sm" placeholder="ID khách (không bắt buộc)">
                    <select id="provider" class="input-field w-full px-4 py-3 rounded-xl text-sm text-white">
                        <option value="google">Google Gemini AI</option>
                        <option value="comet">Comet Service</option>
                    </select>
                    <input id="geminiKey" class="input-field w-full px-4 py-3 rounded-xl text-xs font-mono" placeholder="Gemini Key...">
                    <button onclick="saveUser()" class="w-full py-3 bg-blue-600 text-white font-bold rounded-xl hover:bg-blue-500 transition-all">LƯU & ĐỒNG BỘ WEB</button>
                    <button onclick="exportEmbedCode()" class="w-full py-2 bg-purple-500/10 text-purple-400 border border-purple-500/20 rounded-xl text-xs font-bold">LẤY MÃ NHÚNG INDEX</button>
                </div>
            </div>

            <!-- TẠO CODE -->
            <div class="glass-card rounded-3xl p-6">
                <h3 class="text-sm font-bold text-green-400 mb-4 uppercase">Tạo mã nạp (One-time)</h3>
                <div class="grid grid-cols-3 gap-2 mb-4">
                    <button onclick="setAmount(100)" class="py-2 bg-white/5 rounded-lg text-xs hover:bg-white/10 transition-all">100 CR</button>
                    <button onclick="setAmount(200)" class="py-2 bg-white/5 rounded-lg text-xs hover:bg-white/10 transition-all">200 CR</button>
                    <button onclick="setAmount(500)" class="py-2 bg-white/5 rounded-lg text-xs hover:bg-white/10 transition-all">500 CR</button>
                </div>
                <input id="customAmount" type="number" class="input-field w-full px-4 py-3 rounded-xl mb-4 text-center" placeholder="Số Credit...">
                <button id="btnGen" onclick="generateCode()" class="w-full py-4 bg-gradient-to-r from-green-600 to-emerald-600 text-white font-bold rounded-xl shadow-lg hover:from-green-500 hover:to-emerald-500 transition-all active:scale-95">TẠO MÃ CLOUD</button>
                
                <div id="resultBox" class="hidden mt-4">
                    <input id="generatedCode" readonly class="w-full bg-black/40 border border-green-500/30 rounded-xl py-3 text-center font-mono text-green-400 font-bold cursor-pointer" onclick="copyCode()">
                    <p class="text-[10px] text-center text-gray-500 mt-1">Mã đã được lưu lên Cloud, khách chỉ dùng được 1 lần.</p>
                </div>

                <div class="mt-4 border-t border-white/5 pt-4">
                    <span class="text-[10px] font-bold text-gray-500 uppercase">Lịch sử vừa tạo</span>
                    <div id="historyList" class="mt-2 space-y-2 max-h-32 overflow-y-auto custom-scrollbar"></div>
                </div>
            </div>
        </div>
    </div>

<script>
const ADMIN_PASS = "admin123";
const Sec = {
    key: "V35_SECURE_KEY_SALT", 
    enc(t){
        try { if(!t) return ''; let result = ''; for(let i=0; i<t.length; i++) result += String.fromCharCode(t.charCodeAt(i) ^ this.key.charCodeAt(i % this.key.length)); return btoa(result); } catch(e) { return ''; }
    },
    dec(t){
        try { if(!t) return null; let text = atob(t); let result = ''; for(let i=0; i<text.length; i++) result += String.fromCharCode(text.charCodeAt(i) ^ this.key.charCodeAt(i % this.key.length)); return result; } catch(e) { return null; }
    }
};

function adminLogin() {
    if (document.getElementById('adminPass').value === ADMIN_PASS) {
        sessionStorage.setItem("v35_admin_logged", "true");
        showDash();
    } else {
        const status = document.getElementById('loginStatus');
        status.innerText = "Sai mật khẩu!";
        setTimeout(() => status.innerText = "", 2000);
    }
}

function showDash() {
    document.getElementById('loginBox').style.display = "none";
    document.getElementById('dashboard').classList.remove("hidden");
    renderHistory();
}

if (sessionStorage.getItem("v35_admin_logged") === "true") showDash();
function logout() { sessionStorage.removeItem("v35_admin_logged"); location.reload(); }
function setAmount(v) { document.getElementById('customAmount').value = v; }

async function generateCode() {
    const amount = parseInt(document.getElementById('customAmount').value);
    if (!amount) return alert("Nhập số tiền!");

    const btn = document.getElementById('btnGen');
    btn.disabled = true;
    const originalText = btn.innerText;
    btn.innerText = "ĐANG LƯU CLOUD...";

    const code = `V35-${amount}-PRO-${Math.random().toString(36).substr(2, 6).toUpperCase()}-${Date.now().toString().slice(-4)}`;
    
    // ĐỒNG BỘ LÊN CLOUD
    const success = await window.saveVoucherToCloud(code, amount);

    if (success) {
        document.getElementById('resultBox').classList.remove("hidden");
        document.getElementById('generatedCode').value = code;
        saveHistory(code, amount);
    } else {
        // Alert đã được xử lý bên trong saveVoucherToCloud để chi tiết hơn
        console.error("Lỗi khi lưu");
    }

    btn.disabled = false;
    btn.innerText = originalText;
}

function saveHistory(code, amount) {
    let h = JSON.parse(localStorage.getItem('v35_code_history') || '[]');
    h.unshift({ code, amount, time: new Date().toLocaleTimeString() });
    localStorage.setItem('v35_code_history', JSON.stringify(h));
    renderHistory();
}

function renderHistory() {
    let h = JSON.parse(localStorage.getItem('v35_code_history') || '[]');
    document.getElementById('historyList').innerHTML = h.map(i => `<div class="flex justify-between items-center text-[10px] bg-white/5 p-2 rounded border border-white/5"><span>${i.code}</span><span class="text-green-400 font-bold">+${i.amount}</span></div>`).join('');
}

function copyCode() {
    const el = document.getElementById('generatedCode');
    navigator.clipboard.writeText(el.value);
    const old = el.value; el.value = "ĐÃ COPY!"; setTimeout(()=>el.value=old, 1000);
}

function saveUser() {
    const geminiKey = document.getElementById('geminiKey').value.trim();
    if(!geminiKey) return alert("Vui lòng nhập Key!");
    const data = { username: "Admin Set", apiKey: geminiKey, provider: document.getElementById('provider').value, baseUrl: document.getElementById('provider').value === 'comet' ? "https://api.cometapi.com" : "https://generativelanguage.googleapis.com" };
    localStorage.setItem("v35_user_settings", Sec.enc(JSON.stringify(data)));
    alert("Đã lưu cấu hình API!");
}

function exportEmbedCode() {
    const s = localStorage.getItem("v35_user_settings");
    if(!s) return alert("Hãy lưu API trước!");
    navigator.clipboard.writeText(s);
    alert("Đã copy mã nhúng! Hãy dán vào index.html");
}

document.getElementById('adminPass').addEventListener('keypress', (e) => { if(e.key === 'Enter') adminLogin(); });
</script>
</body>
</html>