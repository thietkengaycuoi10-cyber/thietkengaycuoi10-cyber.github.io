<!DOCTYPE html>
<html lang="vi" class="antialiased">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>V35 ADMIN SYSTEM (CLOUD CONNECTED)</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>

<!-- Firebase SDK cho Admin -->
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // 1. Cấu hình Firebase (Tự động lấy từ môi trường)
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

    // 2. Đăng nhập Admin vào Cloud
    const initAuth = async () => {
        try {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
            console.log("Admin Cloud: Connected");
            document.getElementById('cloudStatus').innerHTML = '<span class="text-green-400">● Cloud Online</span>';
        } catch (e) {
            console.error(e);
            document.getElementById('cloudStatus').innerHTML = '<span class="text-red-400">● Cloud Error</span>';
        }
    };
    initAuth();

    // 3. Hàm tạo Voucher đẩy lên Cloud (Export ra window để dùng ở dưới)
    window.createCloudVoucher = async (code, amount) => {
        try {
            // RULE 1: Đúng đường dẫn artifacts/{appId}/public/data/vouchers/{code}
            // Khớp hoàn toàn với code Client bạn gửi
            const voucherRef = doc(db, 'artifacts', appId, 'public', 'data', 'vouchers', code);
            
            await setDoc(voucherRef, {
                amount: parseInt(amount),
                isUsed: false, // Quan trọng: Đánh dấu chưa dùng
                createdAt: serverTimestamp(),
                createdBy: "admin_v35",
                valid: true
            });
            return true;
        } catch (error) {
            console.error("Lỗi tạo mã:", error);
            alert("Lỗi kết nối Cloud: " + error.message);
            return false;
        }
    };
</script>

<script>
    tailwind.config = {
        theme: {
            extend: {
                fontFamily: { sans: ['Inter', 'sans-serif'], mono: ['JetBrains Mono', 'monospace'] },
                colors: {
                    glass: {
                        surface: 'rgba(255, 255, 255, 0.03)',
                        border: 'rgba(255, 255, 255, 0.08)',
                        highlight: 'rgba(255, 255, 255, 0.1)',
                    }
                },
                animation: {
                    'fade-in': 'fadeIn 0.5s ease-out forwards',
                    'slide-up': 'slideUp 0.4s ease-out forwards',
                },
                keyframes: {
                    fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                    slideUp: { '0%': { opacity: '0', transform: 'translateY(10px)' }, '100%': { opacity: '1', transform: 'translateY(0)' } }
                }
            }
        }
    }
</script>

<style>
    body {
        background-color: #09090b;
        background-image: 
            radial-gradient(at 0% 0%, rgba(56, 189, 248, 0.1) 0px, transparent 50%),
            radial-gradient(at 100% 0%, rgba(139, 92, 246, 0.15) 0px, transparent 50%),
            radial-gradient(at 100% 100%, rgba(236, 72, 153, 0.1) 0px, transparent 50%);
        background-attachment: fixed;
        color: #e4e4e7;
    }
    
    .glass-card {
        background: rgba(18, 18, 23, 0.7);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.08);
        box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
    }

    .input-field {
        background: rgba(0, 0, 0, 0.2);
        border: 1px solid rgba(255, 255, 255, 0.1);
        transition: all 0.2s ease;
    }
    .input-field:focus {
        background: rgba(0, 0, 0, 0.4);
        border-color: #8b5cf6;
        box-shadow: 0 0 0 1px #8b5cf6;
        outline: none;
    }

    .btn-action {
        transition: all 0.2s ease;
    }
    .btn-action:active { transform: scale(0.98); }

    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.1); border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(255, 255, 255, 0.2); }
</style>
</head>

<body class="min-h-screen flex items-center justify-center p-4 sm:p-6">

    <!-- LOGIN PANEL -->
    <div id="loginBox" class="w-full max-w-sm glass-card rounded-2xl p-8 animate-fade-in text-center relative overflow-hidden">
        <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500"></div>
        
        <div class="mb-8">
            <div class="w-16 h-16 bg-gradient-to-br from-white/10 to-transparent rounded-2xl border border-white/10 flex items-center justify-center mx-auto mb-4 shadow-lg">
                <svg class="w-8 h-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>
            </div>
            <h1 class="text-xl font-bold tracking-tight text-white">V35 ADMIN</h1>
            <p class="text-xs text-gray-500 mt-1 uppercase tracking-widest">Cloud System Access</p>
        </div>

        <div class="space-y-4">
            <input id="adminPass" type="password" placeholder="Nhập mật khẩu..." class="input-field w-full px-4 py-3 rounded-xl text-center text-sm placeholder-gray-600 tracking-wider">
            <button onclick="adminLogin()" class="btn-action w-full py-3 bg-white text-black font-bold rounded-xl text-sm hover:bg-gray-200 shadow-lg shadow-white/10">
                ĐĂNG NHẬP
            </button>
            <p id="loginStatus" class="text-xs text-red-400 font-medium h-4"></p>
        </div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard" class="hidden w-full max-w-5xl animate-slide-up">
        
        <!-- Top Bar -->
        <div class="flex items-center justify-between mb-6 px-2">
            <div class="flex items-center gap-3">
                <div class="w-2 h-8 bg-gradient-to-b from-blue-500 to-purple-500 rounded-full"></div>
                <div>
                    <h2 class="font-bold text-lg text-white leading-tight">Admin Dashboard</h2>
                    <div class="flex items-center gap-2">
                        <p class="text-[11px] text-gray-400 font-medium">Quản lý mã nạp V35</p>
                        <span id="cloudStatus" class="text-[10px] font-bold">● Connecting...</span>
                    </div>
                </div>
            </div>
            
            <button onclick="logout()" class="group flex items-center gap-2 px-4 py-2 rounded-full bg-white/5 hover:bg-red-500/10 border border-white/5 hover:border-red-500/30 transition-all">
                <span class="text-xs font-bold text-gray-300 group-hover:text-red-400">Thoát</span>
                <svg class="w-4 h-4 text-gray-400 group-hover:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
            </button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            
            <!-- CỘT 1: VOUCHER GENERATOR (ĐÃ NÂNG CẤP CLOUD) -->
            <div class="glass-card rounded-3xl p-1 overflow-hidden flex flex-col h-full">
                <div class="px-6 py-4 border-b border-white/5 bg-white/[0.01] flex items-center gap-3">
                    <div class="p-2 rounded-lg bg-purple-500/10 text-purple-400"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z"></path></svg></div>
                    <h3 class="text-sm font-bold text-gray-200">Tạo Mã Code (Lưu Cloud)</h3>
                </div>

                <div class="p-6 space-y-6 flex-1 flex flex-col">
                    <!-- Quick Select -->
                    <div class="space-y-2">
                        <label class="text-[10px] font-bold text-gray-500 uppercase tracking-wider">Chọn Mệnh Giá Nạp</label>
                        <div class="grid grid-cols-3 gap-3">
                            <button onclick="setAmount(100)" class="btn-action py-3 rounded-xl bg-white/5 border border-white/5 hover:border-purple-500/50 hover:bg-purple-500/10 text-xs font-bold text-gray-300 transition-colors group">
                                <span class="block text-white group-hover:text-purple-300">100 CR</span>
                                <span class="text-[9px] opacity-50">100K</span>
                            </button>
                            <button onclick="setAmount(200)" class="btn-action py-3 rounded-xl bg-purple-500/10 border border-purple-500/20 hover:bg-purple-500/20 text-xs font-bold text-purple-200 transition-colors">
                                <span class="block text-white">200 CR</span>
                                <span class="text-[9px] opacity-70">200K</span>
                            </button>
                            <button onclick="setAmount(500)" class="btn-action py-3 rounded-xl bg-blue-500/10 border border-blue-500/20 hover:bg-blue-500/20 text-xs font-bold text-blue-200 transition-colors">
                                <span class="block text-white">500 CR</span>
                                <span class="text-[9px] opacity-70">VIP</span>
                            </button>
                        </div>
                    </div>

                    <!-- Custom Input -->
                    <div class="relative">
                        <input id="customAmount" type="number" placeholder="Nhập số tùy ý (vd: -100 để trừ)" class="input-field w-full px-4 py-3 rounded-xl text-sm font-mono text-white placeholder-gray-600 focus:bg-purple-900/10">
                        <span class="absolute right-4 top-3.5 text-xs font-bold text-gray-500">CREDITS</span>
                    </div>

                    <!-- Generate Button -->
                    <button id="btnGen" onclick="generateCode()" class="btn-action w-full py-4 rounded-xl font-bold text-sm text-white bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500 shadow-lg shadow-purple-500/25 border border-white/10 flex items-center justify-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                        <span>LƯU MÃ LÊN CLOUD & HIỂN THỊ</span>
                    </button>

                    <!-- Result Area -->
                    <div id="resultBox" class="hidden animate-fade-in pt-2">
                        <label class="text-[10px] font-bold text-green-400 uppercase tracking-wider mb-1 block">Mã đã lưu thành công:</label>
                        <div class="relative group">
                            <input id="generatedCode" readonly class="w-full bg-black/40 border border-green-500/30 rounded-xl py-4 px-4 text-center font-mono text-sm font-bold text-green-400 tracking-widest cursor-pointer hover:bg-green-500/5 transition-colors" onclick="copyCode()">
                            <div class="absolute right-4 top-1/2 -translate-y-1/2">
                                <span class="text-[9px] font-bold bg-green-500/20 text-green-400 px-2 py-1 rounded opacity-50 group-hover:opacity-100 transition-opacity">COPY</span>
                            </div>
                        </div>
                        <p id="codeValueConfirm" class="text-center text-[10px] mt-2 font-medium"></p>
                    </div>
                </div>
            </div>

            <!-- CỘT 2: LỊCH SỬ (LOCAL - CHỈ ĐỂ THAM KHẢO) -->
            <div class="glass-card rounded-3xl p-1 overflow-hidden flex flex-col h-full">
                <div class="px-6 py-4 border-b border-white/5 bg-white/[0.01] flex items-center gap-3">
                    <div class="p-2 rounded-lg bg-blue-500/10 text-blue-400"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></div>
                    <h3 class="text-sm font-bold text-gray-200">Lịch Sử Tạo Mã (Gần đây)</h3>
                </div>

                <div class="p-6 flex-1 flex flex-col">
                    <div class="flex justify-between items-center mb-4">
                        <span class="text-[10px] font-bold text-gray-500 uppercase">Danh sách mã</span>
                        <button onclick="clearHistory()" class="text-[10px] text-red-400/70 hover:text-red-400">Xóa</button>
                    </div>
                    <div id="historyList" class="space-y-2 overflow-y-auto max-h-[300px] custom-scrollbar pr-1 flex-1">
                        <!-- Items will be here -->
                    </div>
                </div>
            </div>

        </div>
    </div>

<script>
// ===== CONFIG =====
const ADMIN_PASS = "admin123";

// ===== DOM ELEMENTS =====
const els = {
    loginBox: document.getElementById('loginBox'),
    dashboard: document.getElementById('dashboard'),
    adminPass: document.getElementById('adminPass'),
    loginStatus: document.getElementById('loginStatus'),
    customAmount: document.getElementById('customAmount'),
    resultBox: document.getElementById('resultBox'),
    generatedCode: document.getElementById('generatedCode'),
    codeValueConfirm: document.getElementById('codeValueConfirm'),
    historyList: document.getElementById('historyList'),
    btnGen: document.getElementById('btnGen')
};

// ===== CORE FUNCTIONS =====
function adminLogin() {
    if (els.adminPass.value.trim() === ADMIN_PASS) {
        sessionStorage.setItem("v35_admin_logged", "true");
        showDash();
    } else {
        showError(els.loginStatus, "Mật khẩu không đúng");
    }
}

function showDash() {
    els.loginBox.style.display = "none";
    els.dashboard.classList.remove("hidden");
    renderHistory();
}

if (sessionStorage.getItem("v35_admin_logged") === "true") showDash();

function logout() { sessionStorage.removeItem("v35_admin_logged"); location.reload(); }

// --- VOUCHER LOGIC ---
function setAmount(val) { 
    els.customAmount.value = val;
    els.customAmount.focus();
}

async function generateCode() {
    const amount = parseInt(els.customAmount.value);
    if (!amount || amount === 0) return alert("Nhập số Credit hợp lệ!");

    // Disable button
    els.btnGen.disabled = true;
    const oldText = els.btnGen.innerHTML;
    els.btnGen.innerHTML = `<span>ĐANG LƯU LÊN CLOUD...</span>`;

    // 1. Generate String
    const code = `V35-${amount}-PRO-${Math.random().toString(36).substr(2, 6).toUpperCase()}-${Date.now().toString().slice(-4)}`;
    
    // 2. CALL FIREBASE FUNCTION (Đẩy lên Cloud)
    // Hàm này được định nghĩa ở script module phía trên
    if (window.createCloudVoucher) {
        const success = await window.createCloudVoucher(code, amount);
        
        if (success) {
            // Show result only if cloud save success
            els.resultBox.classList.remove("hidden");
            els.generatedCode.value = code;
            
            const isNeg = amount < 0;
            els.codeValueConfirm.className = `text-center text-[10px] mt-2 font-bold py-1.5 rounded border ${isNeg ? 'text-red-400 bg-red-500/10 border-red-500/20' : 'text-green-400 bg-green-500/10 border-green-500/20'}`;
            els.codeValueConfirm.innerHTML = `<span>${isNeg ? '⚠ CODE TRỪ' : '✅ ĐÃ LƯU CLOUD'}</span>: <span class="font-mono">${amount > 0 ? '+' : ''}${amount} CR</span>`;

            saveHistory(code, amount);
        }
    } else {
        alert("Lỗi: Không tìm thấy module Cloud. Vui lòng tải lại trang.");
    }

    // Restore button
    els.btnGen.disabled = false;
    els.btnGen.innerHTML = oldText;
}

function copyCode() {
    els.generatedCode.select(); 
    try {
        document.execCommand('copy');
        const oldVal = els.generatedCode.value;
        els.generatedCode.value = "ĐÃ COPY!";
        setTimeout(() => els.generatedCode.value = oldVal, 1000);
    } catch(e) {
        alert("Copy thủ công!");
    }
}

function saveHistory(code, amount) {
    let h = JSON.parse(localStorage.getItem('v35_code_history') || '[]');
    h.unshift({ code, amount, time: new Date().toLocaleTimeString('vi-VN', {hour:'2-digit', minute:'2-digit'}) });
    if(h.length > 50) h.pop();
    localStorage.setItem('v35_code_history', JSON.stringify(h));
    renderHistory();
}

function renderHistory() {
    let h = JSON.parse(localStorage.getItem('v35_code_history') || '[]');
    els.historyList.innerHTML = h.length ? h.map(i => `
        <div class="flex items-center justify-between p-3 rounded-lg bg-white/5 border border-white/5 hover:bg-white/10 transition-colors group">
            <div class="flex flex-col">
                <span class="text-[10px] font-mono font-medium text-gray-300 select-all tracking-wide group-hover:text-white transition-colors">${i.code}</span>
                <span class="text-[9px] text-gray-600">${i.time}</span>
            </div>
            <span class="text-[11px] font-bold ${i.amount < 0 ? 'text-red-400' : 'text-green-400'}">${i.amount > 0 ? '+' : ''}${i.amount}</span>
        </div>
    `).join('') : '<div class="text-center text-gray-600 text-[10px] py-4">Chưa có lịch sử</div>';
}

function clearHistory() { if(confirm("Xóa lịch sử?")) { localStorage.removeItem('v35_code_history'); renderHistory(); } }

// Utils
function showError(el, msg) { el.classList.remove('text-green-400'); el.classList.add('text-red-400'); el.innerText = msg; setTimeout(() => el.innerText = "", 3000); }
els.adminPass.addEventListener("keypress", (e) => { if (e.key === "Enter") adminLogin(); });

</script>
</body>
</html>